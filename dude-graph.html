<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
-->
<!--suppress HtmlUnknownTarget -->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../dude-style/dude-style.html">
<!-- javascript dependencies -->
<script src="../lodash/dist/lodash.min.js"></script>
<script src="../d3/d3.min.js"></script>
<script src="../eventEmitter/EventEmitter.min.js"></script>
<!-- dude-graph dependency -->
<script src="dude-graph.js"></script>
<!-- dude-graph sidebar panels -->
<link rel="import" href="panels/dude-stack.html">
<link rel="import" href="panels/dude-graph-create.html">
<link rel="import" href="panels/dude-graph-edit-block.html">
<!--
`dude-graph` is a Polymer element which creates a dude-graph SVG renderer.
-->
<dom-module id="dude-graph">
    <style>
        .container {
            @apply(--layout-horizontal);
            @apply(--layout-flex);
            background: var(--dude-primary-background-color);
            height: 100%;
        }
        #svg {
            @apply(--layout-flex-3);
        }
        #sidebar[opened] {
            @apply(--layout-flex);
            min-width: 300px;
        }
        #sidebar {
            background: var(--dude-secondary-background-color);
            width: 0;
            height: 100%;
        }
        #button {
            position: fixed;
            bottom: 0;
            right: 0;
        }
    </style>
    <style>
        /**
         * Typography
         */
        ::content text {
            fill: var(--dude-content-text-color);
            font-family: var(--dude-primary-text-font);
        }
        ::content .dude-graph-title {
            fill: var(--dude-title-text-color);
            font-weight: bold;
        }
        /**
         * Select brush
         */
        ::content .dude-graph-select {
            fill: hsla(0, 0%, 80%, 0.1);
            stroke: hsla(0, 0%, 80%, 0.2);
        }
        /**
         * Blocks
         */
        ::content .dude-graph-block > rect {
            @apply(--dude-graph-block);
        }
        ::content .dude-graph-block:hover > rect {
            @apply(--dude-graph-block-hover);
        }
        ::content .dude-graph-block.dude-graph-selected > rect {
            @apply(--dude-graph-block-selected);
        }
        /**
         * Groups
         */
        ::content .dude-graph-group > rect {
            @apply(--dude-graph-group);
        }
        ::content .dude-graph-group:hover > rect {
            @apply(--dude-graph-group-hover)
        }
        ::content .dude-graph-group.dude-graph-selected > rect,
        ::content .dude-graph-group.dude-graph-active > rect {
            @apply(--dude-graph-group-selected);
        }
        /**
         * Connections
         */
        ::content .dude-graph-connection {
            stroke-width: 2px;
            fill: transparent;
        }
        /**
         * Cursors block, groups and points
         */
        ::content .dude-graph-block,
        ::content .dude-graph-group {
            cursor: move;
        }
        ::content .dude-graph-point,
        ::content .dude-graph-point {
            cursor: pointer;
        }
    </style>
    <template>
        <div class="container">
            <!-- dude-graph SVG renderer -->
            <svg id="svg"></svg>
            <!-- dude-graph sidebar -->
            <div id="sidebar" hidden$="[[ !sidebarOpened ]]">
                <dude-stack id="stack" data="{{ dudeGraphElement }}"></dude-stack>
            </div>
        </div>
        <!-- Toggle sidebar visibility -->
        <input id="button"
               type="button"
               value="Toggle Sidebar"
               on-click="toggleSidebar">
    </template>
    <script>
        Polymer({
            is: "dude-graph",
            properties: {
                /**
                 * The dudeGraph element
                 */
                "dudeGraphElement": {
                    "type": "DudeGraphElement"
                },

                /**
                 * The graph
                 */
                "graph": {
                    "type": dudeGraph.Graph
                },

                /**
                 * The renderer
                 */
                "renderer": {
                    "type": dudeGraph.Renderer
                },

                /**
                 * The graph loader
                 */
                "loader": {
                    "type": dudeGraph.GraphLoader,
                    "value": null
                },
                /**
                 * The graph saver
                 */
                "saver": {
                    "type": dudeGraph.GraphSaver,
                    "value": null
                },

                /**
                 * The graph data
                 */
                "graphData": {
                    "type": Object,
                    "value": {}
                },
                /**
                 * The renderer data
                 */
                "rendererData": {
                    "type": Object,
                    "value": {}
                },
                /**
                 * The model data
                 */
                "models": {
                    "type": Array,
                    "value": []
                },
                /**
                 * The block types handled by the graph loader
                 */
                "blockTypes": {
                    "type": Array,
                    "value": dudeGraph.defaultBlocks
                },
                /**
                 * The point types handled by the graph loader
                 */
                "pointTypes": {
                    "type": Array,
                    "value": dudeGraph.defaultPoints
                },
                /**
                 * Assign custom renderBlocks to blocks
                 */
                "renderBlockTypes": {
                    "type": Array,
                    "value": dudeGraph.defaultRenderBlocks
                },
                /**
                 * Assign custom renderPoints to points
                 */
                "renderPointTypes": {
                    "type": Array,
                    "value": dudeGraph.defaultRenderPoints
                },

                /**
                 * Whether the sidebar is opened
                 */
                "sidebarOpened": {
                    "type": Boolean,
                    "value": true,
                    "observer": "_sidebarOpenedChanged"
                }
            },

            /**
             * Creates the dude-graph and the SVG renderer
             */
            attached: function () {
                this.set("dudeGraphElement", this);
                this.set("graph", new dudeGraph.Graph());
                this.set("renderer", new dudeGraph.Renderer());
                this.set("loader", new dudeGraph.GraphLoader());
                this.set("saver", new dudeGraph.GraphSaver());
                this.get("renderer").initialize(this.get("graph"), this.$.svg);
                _.forEach(this.get("blockTypes"), function (blockType) {
                    this.get("loader").registerBlockType(blockType.block, blockType.type);
                }.bind(this));
                _.forEach(this.get("pointTypes"), function (pointType) {
                    this.get("loader").registerPointType(pointType.point, pointType.type);
                }.bind(this));
                _.forEach(this.get("renderBlockTypes"), function (renderBlockType) {
                    this.get("renderer").registerRenderBlock(renderBlockType.renderBlock, renderBlockType.type);
                }.bind(this));
                _.forEach(this.get("renderPointTypes"), function (renderPointType) {
                    this.get("renderer").registerRenderPoint(renderPointType.renderPoint, renderPointType.type);
                }.bind(this));
                this.$.stack.pushStack("dude-graph-create");
            },

            /**
             * Creates a block and a renderBlock from the given blockData
             * @param {Object} blockData
             * @returns {dudeGraph.RenderBlock}
             */
            createBlock: function (blockData) {
                var block = this.get("loader").loadBlock(this.get("graph"), _.merge(blockData, {
                    "blockId": dudeGraph.uuid()
                }));
                return this.renderer.createRenderBlock({
                    "id": block.blockId,
                    "block": block.blockId
                }, true);
            },


            /**
             * Toggles the sidebar visibility
             */
            toggleSidebar: function () {
                this.set("sidebarOpened", !this.get("sidebarOpened"));
            },

            /**
             * Shows or hides the sidebar when sidebarOpened changes
             * @param sidebarOpened
             * @private
             */
            _sidebarOpenedChanged: function (sidebarOpened) {
                if (sidebarOpened) {
                    this.$.sidebar.setAttribute("opened", sidebarOpened);
                } else {
                    this.$.sidebar.removeAttribute("opened");
                }
            }

            /**
             * @typedef {Element} DudeGraphElement
             * @property {dudeGraph.Graph} graph
             * @property {dudeGraph.Renderer} renderer
             * @property {Function} createBlock
             */
        });
    </script>
</dom-module>