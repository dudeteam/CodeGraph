<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="dude-graph-editor.html">
<link rel="import" href="panels/dude-graph-create.html">
<link rel="import" href="panels/dude-graph-create-group.html">
<link rel="import" href="panels/dude-graph-create-function.html">
<link rel="import" href="panels/dude-graph-create-variable.html">
<link rel="import" href="panels/dude-graph-edit-group.html">
<link rel="import" href="panels/dude-graph-edit-block.html">
<link rel="import" href="../dude-toolbar/dude-toolbar.html">
<link rel="import" href="../dude-seed/dude-sidebar.html">
<!--
`demo-dude` is a Polymer element to wrap a dude-graph demo
-->
<dom-module id="dude-graph">
    <style>
        #wrapper {
            background: var(--dude-primary-background-color);
        }
        #error {
            color: var(--text-primary-color);
            background: var(--paper-red-500);
        }
        #content {
            position: relative;
        }
        dude-sidebar {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
        }
    </style>
    <template>
        <div id="wrapper" class="layout horizontal fit">
            <div class="layout vertical flex">
                <div id="content" class="layout horizontal flex">
                    <dude-sidebar id="createPanel"
                                  panel-title="Create"
                                  panel-element="dude-graph-create"
                                  data="{{ _context }}"
                                  on-dude-panel-close="_resetPanel">
                    </dude-sidebar>
                    <dude-sidebar id="createGroupPanel"
                                  panel-title="Create group"
                                  panel-element="dude-graph-create-group"
                                  data="{{ _context }}"
                                  on-dude-panel-close="_resetPanel">
                    </dude-sidebar>
                    <dude-sidebar id="createVariablePanel"
                                  panel-title="Create variable"
                                  panel-element="dude-graph-create-variable"
                                  data="{{ _context }}"
                                  on-dude-panel-close="_resetPanel">
                    </dude-sidebar>
                    <dude-sidebar id="createFunctionPanel"
                                  panel-title="Create function"
                                  panel-element="dude-graph-create-function"
                                  data="{{ _context }}"
                                  on-dude-panel-close="_resetPanel">
                    </dude-sidebar>
                    <dude-sidebar id="editBlockPanel"
                                  panel-title="{{ _selectedRenderBlock.block.cgName }}"
                                  panel-element="dude-graph-edit-block"
                                  data="{{ _selectedRenderBlock }}"
                                  on-dude-panel-close="_resetPanel">
                    </dude-sidebar>
                    <dude-sidebar id="editGroupPanel"
                                  panel-title="Edit group"
                                  panel-element="dude-graph-edit-group"
                                  data="{{ _selectedRenderGroup }}"
                                  on-dude-panel-close="_resetPanel">
                    </dude-sidebar>
                    <paper-toast id="error"></paper-toast>
                    <dude-graph-editor id="editor"
                                       class="layout horizontal flex-3"
                                       models="{{ models }}"
                                       on-dude-graph-editor-error="_error">
                    </dude-graph-editor>
                </div>
                <dude-toolbar id="toolbar"></dude-toolbar>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: "dude-graph",
            properties: {
                /**
                 * The graph data
                 */
                "graphData": {
                    "type": Object,
                    "value": {}
                },

                /**
                 * The renderer config
                 */
                "rendererConfig": {
                    "type": Object,
                    "value": {}
                },

                /**
                 * The renderer data
                 */
                "rendererData": {
                    "type": Object,
                    "value": {}
                },

                /**
                 * The model data
                 */
                "models": {
                    "type": Array,
                    "value": {}
                }
            },

            /**
             * Called when the demo-dude element is attached
             * LocalStorage data needs to be loaded before this gets called
             */
            attached: function () {
                this.set("_context", this);
                this.$.editor.start();
                this.$.editor.load(this.get("graphData"), this.get("rendererData"));
                this.$.editor.get("renderer").on("select", function (renderNode) {
                    this.openPanel(renderNode instanceof dudeGraph.RenderBlock ? "editBlockPanel" : "editGroupPanel");
                    this.set("_selectedRenderBlock", renderNode instanceof dudeGraph.RenderBlock ? renderNode : null);
                    this.set("_selectedRenderGroup", renderNode instanceof dudeGraph.RenderGroup ? renderNode : null);
                }.bind(this));
                this.$.editor.get("renderer").on("unselect", function (renderNode) {
                    this.set("_selectedRenderBlock", renderNode instanceof dudeGraph.RenderBlock ? null : this.get("_selectedRenderBlock"));
                    this.set("_selectedRenderGroup", renderNode instanceof dudeGraph.RenderGroup ? null : this.get("_selectedRenderGroup"));
                }.bind(this));
                this.$.editor.get("renderer").on("unselect-all", function () {
                    this.set("_selectedRenderBlock", null);
                    this.set("_selectedRenderGroup", null);
                }.bind(this));
                this._lastPanelOpen = null;
            },

            /**
             * Add a new command within the toolbar.
             */
            addCommand: function (options) {
                this.$.toolbar.addCommand(options);
            },

            /**
             * Save command.
             */
            save: function () {
                return this.$.editor.save();
            },

            /**
             * RemoveSelection command.
             */
            removeSelection: function () {
                this.$.editor.get("renderer").removeSelection();
            },

            /**
             * Zoom to fit command.
             */
            zoomToFit: function () {
                this.$.editor.get("renderer").zoomToFit();
            },

            /**
             * Zoom to selection command.
             */
            zoomFitToSelection: function () {
                this.$.editor.get("renderer").zoomToFitSelection();
            },

            /**
             * Select all groups command.
             */
            selectAllGroups: function () {
                this.$.editor.get("renderer").selectAll(true, false);
            },

            /**
             * Select all blocks command.
             */
            selectAllBlocks: function () {
                this.$.editor.get("renderer").selectAll(false, true);
            },

            /**
             * Select all command.
             */
            selectAll: function () {
                this.$.editor.get("renderer").selectAll(false, false);
            },

            createBlock: function (blockData) {
                var toRenderBlock = this.$.editor.createBlock(blockData);
                this.$.editor.focusBlock(toRenderBlock);
            },

            createVariable: function (name, type, value) {
                this.push("models.0.group.items", {
                    "item": {
                        "name": name,
                        "icon": "fa fa-circle",
                        "data": {
                            "cgType": "Variable",
                            "cgValueType": type,
                            "cgValue": value,
                            "cgName": name,
                            "cgInputs": [],
                            "cgOutputs": [
                                {
                                    "cgType": "Point",
                                    "cgValueType": type,
                                    "cgName": "value"
                                }
                            ]
                        }
                    }
                });
            },

            /**
             * Open a panel from its id.
             */
            openPanel: function (id) {
                if (this._lastPanelOpen !== null && this._lastPanelOpen !== this.$[id]) {
                    this._lastPanelOpen.close(function () {
                        this.$[id].open();
                        this._lastPanelOpen = this.$[id];
                    }.bind(this));
                } else {
                    this.$[id].open();
                    this._lastPanelOpen = this.$[id];
                }
            },

            /**
             * Reset the last panel open variable.
             */
            _resetPanel: function () {
                this._lastPanelOpen = null;
            },

            /**
             * Called when a error occurs in the editor
             * @param {CustomEvent} e
             * @private
             */
            _error: function (e) {
                this.$.error.text = e.detail.error;
                this.$.error.show();
            }
        });
    </script>
</dom-module>