<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
-->
<!--suppress HtmlUnknownTarget, HtmlUnknownTag, CssUnusedSymbol, JSUnusedGlobalSymbols -->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../dude-style/dude-style.html">
<link rel="import" href="../dude-popup/dude-popup.html">
<link rel="import" href="../dude-hierarchy/dude-hierarchy.html">
<!-- javascript dependencies -->
<script src="../lodash/dist/lodash.min.js"></script>
<script src="../d3/d3.min.js"></script>
<script src="../eventEmitter/EventEmitter.min.js"></script>
<script src="../jwerty/jwerty.js"></script>
<!-- dude-graph dependency -->
<script src="dude-graph.js"></script>
<!-- dude-graph sidebar panels -->
<link rel="import" href="panels/dude-inspector.html">
<link rel="import" href="panels/dude-graph-create.html">
<link rel="import" href="panels/dude-graph-create-function.html">
<link rel="import" href="panels/dude-graph-create-variable.html">
<link rel="import" href="panels/dude-graph-edit-block.html">
<link rel="import" href="panels/dude-graph-edit-group.html">
<link rel="import" href="panels/dude-graph-edit-variable.html">
<link rel="import" href="panels/dude-graph-select-resource.html">
<!--
`dude-graph` is a Polymer element which creates a dude-graph SVG renderer.
-->
<dom-module id="dude-graph">
    <style>
        .container {
            @apply(--layout-horizontal);
            @apply(--layout-flex);
            background: var(--dude-background1-color);
            height: 100%;
        }

        #svg {
            @apply(--layout-flex-3);
        }

        #inspector {
            @apply(--layout-flex);
            background-color: var(--dude-background2-color);
        }

        /**
         * Typography
         */
        ::content text {
            font-family: var(--dude-font-content);
            fill: var(--dude-light1-color);
        }

        ::content .dude-graph-block-title {
            fill: var(--dude-light1-color);
            font-weight: bold;
        }

        ::content .dude-graph-group-title {
            fill: var(--dude-dark1-color);
            font-weight: bold;
        }

        /**
         * Select brush
         */
        ::content .dude-graph-select {
            stroke: var(--dude-status-info-color);
            fill: var(--dude-status-info-color);
            fill-opacity: 0.1;
        }

        /**
         * Blocks
         */
        ::content .dude-graph-block > rect {
            transition-duration: .2s;
            transition-property: stroke;
        }

        ::content .dude-graph-block:hover > rect {
            stroke: var(--dude-status-info-color);
            stroke-width: 2px;
        }

        ::content .dude-graph-block.dude-graph-selected > rect {
            stroke: var(--dude-status-info-color);
            stroke-width: 2px;
        }

        /**
         * Groups
         */
        ::content .dude-graph-group > rect {
            transition-duration: .2s;
            transition-property: stroke;
            fill: var(--dude-background2-color);
            stroke: var(--dude-background2-color);
        }

        ::content .dude-graph-group:hover > rect {
            stroke: var(--dude-status-info-color);
            stroke-width: 2px;
        }

        ::content .dude-graph-group.dude-graph-selected > rect,
        ::content .dude-graph-group.dude-graph-active > rect {
            stroke: var(--dude-status-info-color);
            stroke-width: 2px;
        }

        /**
         * Connections
         */
        ::content .dude-graph-connection {
            stroke-width: 2px;
            fill: transparent;
        }

        /**
         * Cursors block, groups and points
         */
        ::content .dude-graph-block,
        ::content .dude-graph-group {
            cursor: move;
        }

        ::content .dude-graph-point,
        ::content .dude-graph-point {
            cursor: pointer;
        }
    </style>
    <template>
        <div class="container">
            <svg id="svg"></svg>
            <dude-inspector id="inspector"
                            data="{{ dudeGraphElement }}"
                            root-panel="dude-graph-create">
            </dude-inspector>
            <dude-popup id="autocompletePopup">
                <dude-hierarchy
                        id="autocomplete"
                        placeholder="Search block..."
                        items="[[ autocompleteModels ]]"
                        on-dude-hierarchy-item-submit="_autocomplete"
                        on-dude-hierarchy-blur="_closeAutocomplete">
                </dude-hierarchy>
            </dude-popup>
        </div>
    </template>
    <script>
        Polymer({
            is: "dude-graph",
            properties: {
                /**
                 * The dudeGraph element
                 */
                "dudeGraphElement": {
                    "type": "DudeGraphElement"
                },
                /**
                 * The graph
                 */
                "graph": {
                    "type": dudeGraph.Graph
                },
                /**
                 * The renderer
                 */
                "renderer": {
                    "type": dudeGraph.Renderer
                },
                /**
                 * The graph loader
                 */
                "loader": {
                    "type": dudeGraph.GraphLoader,
                    "value": null
                },
                /**
                 * The graph saver
                 */
                "saver": {
                    "type": dudeGraph.GraphSaver,
                    "value": null
                },
                /**
                 * The graph data
                 */
                "graphData": {
                    "type": Object,
                    "value": {}
                },
                /**
                 * The renderer data
                 */
                "rendererData": {
                    "type": Object,
                    "value": {}
                },
                /**
                 * The renderer config
                 */
                "rendererConfig": {
                    "type": Object,
                    "value": dudeGraph.defaultRendererConfig
                },
                /**
                 * The model data
                 */
                "models": {
                    "type": Array,
                    "value": []
                },
                /**
                 * The block types handled by the graph
                 */
                "blockTypes": {
                    "type": Array,
                    "value": dudeGraph.defaultBlocks
                },
                /**
                 * The point types handled by the graph
                 */
                "pointTypes": {
                    "type": Array,
                    "value": dudeGraph.defaultPoints
                },
                /**
                 * The graph value types handled by the graph
                 */
                "graphValueTypes": {
                    "type": Array,
                    "value": []
                },
                /**
                 * Assign custom renderBlocks to blocks
                 */
                "renderBlockTypes": {
                    "type": Array,
                    "value": dudeGraph.defaultRenderBlocks
                },
                /**
                 * Assign custom renderPoints to points
                 */
                "renderPointTypes": {
                    "type": Array,
                    "value": dudeGraph.defaultRenderPoints
                },
                /**
                 * The render connection involved in the autocomplete
                 */
                "autocompleteRenderConnection": {
                    "type": dudeGraph.RenderConnection,
                    "value": null,
                    "readonly": true
                },
                /**
                 * The models eligible for the autocomplete render connection
                 */
                "autocompleteModels": {
                    "type": "dudeGraph.Models.modelTypedef",
                    "value": [],
                    "readonly": true
                }
            },

            /**
             * Creates the dude-graph and the SVG renderer
             */
            initialize: function () {
                this.set("dudeGraphElement", this);
                this.set("graph", new dudeGraph.Graph());
                this.set("renderer", new dudeGraph.Renderer());
                this.set("loader", new dudeGraph.GraphLoader());
                this.set("saver", new dudeGraph.GraphSaver());
                this.get("renderer").initialize(this.get("graph"), this.$.svg, this._rendererConfig());
                _.forEach(this.get("graphValueTypes"), function (graphValueType) {
                    this.get("graph").addGraphValueType(graphValueType);
                }.bind(this));
                _.forEach(this.get("blockTypes"), function (blockType) {
                    this.get("graph").registerCustomBlock(blockType.block, blockType.type);
                }.bind(this));
                _.forEach(this.get("pointTypes"), function (pointType) {
                    this.get("graph").registerCustomPoint(pointType.point, pointType.type);
                }.bind(this));
                _.forEach(this.get("renderBlockTypes"), function (renderBlockType) {
                    this.get("renderer").registerRenderBlock(renderBlockType.renderBlock, renderBlockType.type);
                }.bind(this));
                _.forEach(this.get("renderPointTypes"), function (renderPointType) {
                    this.get("renderer").registerRenderPoint(renderPointType.renderPoint, renderPointType.type);
                }.bind(this));
                this.get("loader").load(this.get("graph"), this.get("graphData") || {});
                this.get("renderer").load(this.get("rendererData") || {});
                this.get("graph").graphModels = this.get("models");
                this._listenDudeGraphEvents();
                this.$.inspector.updateDudeGraphElement();
            },

            /**
             * Creates a block and a renderBlock from the given blockData
             * @param {Object} blockData
             * @returns {dudeGraph.RenderBlock}
             */
            createBlock: function (blockData) {
                var dudeGraphElement = this;
                var createGraphBlock = function () {
                    return dudeGraphElement.get("loader").loadBlock(dudeGraphElement.get("graph"), _.merge(blockData, {
                        "blockId": dudeGraphElement.get("graph").nextBlockId()
                    }));
                };
                var createRenderBlock = function (block) {
                    return dudeGraphElement.renderer.createRenderBlock({
                        "id": dudeGraphElement.get("graph").nextBlockId(),
                        "block": block.blockId
                    }, true);
                };
                var blockType = blockData.blockType;
                if (blockType === "VariableBlock") {
                    var variablesFound = this.get("graph").blocksByName(blockData.blockName);
                    var variableFound = _.find(variablesFound, function (variable) {
                                return variable instanceof dudeGraph.VariableBlock;
                            }) || null;
                    if (variableFound) {
                        return createRenderBlock(variableFound);
                    }
                }
                return createRenderBlock(createGraphBlock());
            },

            /**
             * Creates a variable from the given variableData
             * @param {Object} variableData
             */
            createVariable: function (variableData) {
                var variable = new dudeGraph.Variable(variableData);
                this.get("graph").addVariable(variable);
                this.fire("dude-graph-success", "Variable " + variable.variableName + " created");
            },

            /**
             * Saves the graph data
             * @returns {Object}
             */
            saveGraphData: function () {
                return this.get("saver").save(this.get("graph"));
            },

            /**
             * Saves the renderer data
             * @returns {Object}
             */
            saveRendererData: function () {
                return this.get("renderer").save();
            },

            /**
             * Saves the graph and renderer data
             * @returns {Object}
             */
            save: function () {
                return {
                    "graphData": this.saveGraphData(),
                    "rendererData": this.saveRendererData()
                }
            },

            /**
             * Emits the save event
             * @emit {Object} dude-graph-save
             */
            emitSave: function () {
                this.fire("dude-graph-save", this.save());
            },

            /**
             * Emits the save event
             * @emit {Object} dude-graph-build
             */
            emitBuild: function () {
                this.fire("dude-graph-build");
            },

            /**
             * Returns the renderer configuration
             * @returns {dudeGraph.defaultRendererConfig}
             */
            _rendererConfig: function () {
                var config = this.get("rendererConfig");
                config.typeColors.Stream = this.getComputedStyleValue("--dude-type-stream-color");
                config.typeColors.String = this.getComputedStyleValue("--dude-type-string-color");
                config.typeColors.Number = this.getComputedStyleValue("--dude-type-number-color");
                config.typeColors.Boolean = this.getComputedStyleValue("--dude-type-boolean-color");
                config.typeColors.Object = this.getComputedStyleValue("--dude-type-object-color");
                config.typeColors.Array = this.getComputedStyleValue("--dude-type-array-color");
                config.typeColors.Resource = this.getComputedStyleValue("--dude-type-resource-color");

                config.blockColors.Start = this.getComputedStyleValue("--dude-block-start-color");
                config.blockColors.Step = this.getComputedStyleValue("--dude-block-step-color");
                config.blockColors.End = this.getComputedStyleValue("--dude-block-end-color");
                config.blockColors.GoBlock = this.getComputedStyleValue("--dude-block-go-color");
                config.blockColors.RepeatBlock = this.getComputedStyleValue("--dude-block-repeat-color");
                config.blockColors.AssignBlock = this.getComputedStyleValue("--dude-block-assign-color");
                config.blockColors.ConditionBlock = this.getComputedStyleValue("--dude-block-condition-color");
                config.blockColors.PrintBlock = this.getComputedStyleValue("--dude-block-print-color");
                config.blockColors.FormatBlock = this.getComputedStyleValue("--dude-block-format-color");
                config.blockColors.ExpressionBlock = this.getComputedStyleValue("--dude-block-expression-color");
                config.blockColors.RandomRangeBlock = this.getComputedStyleValue("--dude-block-random-range-color");
                config.blockColors.TrophyBlock = this.getComputedStyleValue("--dude-block-trophy-color");

                return config;
            },

            /**
             * Listens on the graph and renderer events
             * @private
             */
            _listenDudeGraphEvents: function () {
                var dudeGraphElement = this;
                this.get("renderer").on("error", function (error) {
                    dudeGraphElement.fire("dude-graph-error", {"error": error, "message": error.message});
                });
                this.get("renderer").on("select", function (renderNode) {
                    if (renderNode instanceof dudeGraph.RenderGroup) {
                        dudeGraphElement.set("selectedRenderBlock", null);
                        dudeGraphElement.set("selectedRenderGroup", renderNode);
                        dudeGraphElement.$["inspector"].pushStack("dude-graph-edit-group");
                    } else if (renderNode instanceof dudeGraph.RenderBlock) {
                        dudeGraphElement.set("selectedRenderBlock", renderNode);
                        dudeGraphElement.set("selectedRenderGroup", null);
                        dudeGraphElement.$["inspector"].pushStack(renderNode.customPanel || "dude-graph-edit-block");
                    }
                });
                this.get("renderer").on("unselect-all", function () {
                    dudeGraphElement.set("selectedRenderBlock", null);
                    dudeGraphElement.set("selectedRenderGroup", null);
                    dudeGraphElement.$["inspector"].clearStack();
                });
                this.get("renderer").on("drop-connection", function (renderConnection, __, position) {
                    var fromRenderPoint = renderConnection.realRenderPoint;
                    var queryModels = dudeGraphElement.get("graph").queryModels(fromRenderPoint.point);
                    if (!_.isEmpty(queryModels)) {
                        dudeGraphElement.set("autocompleteRenderConnection", renderConnection);
                        dudeGraphElement.set("autocompleteModels", queryModels);
                        dudeGraphElement.$["autocompletePopup"].open(position[0], position[1]);
                        dudeGraphElement.$["autocomplete"].focus();
                    }
                });
            },

            /**
             * Performs an autocomplete
             * @param {CustomEvent} e
             * @private
             */
            _autocomplete: function (e) {
                var model = e.detail;
                var draggingRenderPoint = this.get("autocompleteRenderConnection").draggingRenderPoint;
                var fromRenderPoint = this.get("autocompleteRenderConnection").realRenderPoint;
                var fromRenderBlock = fromRenderPoint.renderBlock;
                var toRenderBlock = this.createBlock(model.item.data);
                toRenderBlock.nodePosition = _.clone(draggingRenderPoint.pointAbsolutePosition);
                toRenderBlock.update();
                var toRenderPoint = fromRenderPoint.point.pointOutput ?
                        toRenderBlock.block.inputByName(model.item.data.modelPointName) :
                        toRenderBlock.block.outputByName(model.item.data.modelPointName);
                var connection = fromRenderPoint.point.connect(toRenderPoint);
                this.get("renderer").createRenderConnection({
                    connection: connection,
                    outputRenderBlock: fromRenderPoint.point.pointOutput ? fromRenderBlock : toRenderBlock,
                    inputRenderBlock: fromRenderPoint.point.pointOutput ? toRenderBlock : fromRenderBlock
                }, true);
                this.set("autocompleteRenderConnection", null);
                this.set("autocompleteModels", []);
                this._closeAutocomplete();
            },

            /**
             * Closes the autocomplete popup
             * @private
             */
            _closeAutocomplete: function () {
                this.$["autocompletePopup"].close();
            }

            /**
             * @typedef {Element} DudeGraphElement
             * @property {dudeGraph.Graph} graph
             * @property {dudeGraph.Renderer} renderer
             * @property {Function} createBlock
             * @property {Function} saveGraphData
             * @property {Function} saveRendererData
             * @property {Function} save
             * @property {Function} emitSave
             * @property {Function} emitBuild
             * @property {Function} get
             * @property {Function} set
             */
        });
    </script>
</dom-module>