<link rel="import" href="../core-menu/core-menu.html">
<link rel="import" href="../core-collapse/core-collapse.html">
<link rel="import" href="../core-icon/core-icon.html">
<link rel="import" href="../polymer/polymer.html">
<polymer-element name="cg-dropdown" attributes="valueattr value">
    <template>
        <div id="header" layout horizontal>
            <span flex id="selected"></span>
            <core-icon icon="{{_arrow}}"></core-icon>
        </div>
        <core-collapse id="collapse">
            <core-menu id="menu" on-core-select="{{_change}}">
                <content id="content" select="*"></content>
            </core-menu>
        </core-collapse>
    </template>
    <script>
        Polymer('cg-dropdown', {
            publish: {
                /**
                 * Specifies the attribute to be used for "selected" attribute.
                 * @attribute valueattr
                 * @type string
                 * @default "name"
                 */
                valueattr: "name",

                /**
                 * Specifies the selected value of that dropdown.
                 * @attribute value
                 * @type {undefined|String}
                 * @default undefined
                 */
                value: undefined
            },

            /**
             * Selected element.
             * @private
             * @type {Element}
             **/
            _selected: null,

            /**
             * Return the arrow icon to use according whether the dropdown is opened or not.
             * @private
             */
            _arrow: "arrow-drop-down",

            /**
             * Select the element.
             * @param element
             * @method
             * @private
             */
            _select: function (element) {
                var oldValue = this.value;
                var newValue = element.getAttribute(this.valueattr);
                this.value = newValue;
                this.$.selected.innerHTML = newValue;
                //noinspection JSPrimitiveTypeWrapperUsage
                this.$.menu.selected = newValue;
                if (oldValue !== newValue) {
                    this.fire("change", {oldValue: oldValue, newValue: newValue});
                }
            },

            /**
             * Toggle the dropdown visibility.
             * @method
             * @private
             */
            _toggleDropdown: function () {
                this.$.collapse.toggle();
                this._arrow = this.$.collapse.opened ? "arrow-drop-up" : "arrow-drop-down";
            },

            /**
             * Triggered when an element is clicked.
             * @param e {Event}
             * @param element {Object}
             * @delegate
             * @private
             */
            _change: function (e, element) {
                this._select(element.item);
                this.$.collapse.opened = false;
                this._arrow = "arrow-drop-down";
            },

            /**
             * Polymer ready delegate.
             * @delegate
             */
            ready: function () {
                this._select(this.$.content.getDistributedNodes()[1]);
                this.$.selected.addEventListener('click', this._toggleDropdown.bind(this));
            }
        });
    </script>
</polymer-element>