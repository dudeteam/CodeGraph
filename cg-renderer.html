<!--
    It's the most important polymer component of CodeGraph. It creates the SVG from JSON data and provide an API to add,
    remove or select data of this graph.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">
<link rel="import" href="../dude-gui/dude-config.html">
<polymer-element name="cg-renderer" attributes="graphUrl" extends="dude-config">
    <template>
        <style>
            #svg #selection {
                fill: rgba(255, 255, 255, 0.2);
                stroke: rgba(255, 255, 255, 0.5);
                stroke-width: 1px;
            }
            #svg .group, #svg .block {
                cursor: move;
            }
            #svg .action .title {
                text-anchor: middle;
            }
            #svg .input, #svg .output {
                cursor: pointer;
            }
            .connection {
                stroke-linecap: round;
            }
        </style>
        <core-ajax id="graphData"
                   url="{{graphUrl}}"
                   handleAs="json"
                   on-core-response="{{_loadGraph}}"
                   auto>
        </core-ajax>
        <div id="shadow-dom-bug" layout horizontal flex>
            <svg id="svg" flex></svg>
        </div>
    </template>
    <!-- Vendors -->
    <script src="../d3/d3.js"></script>
    <script src="../jwerty/jwerty.js"></script>
    <script src="../pandora/lib/pandora.js"></script>
    <!-- CodeGraph library -->
   <script src="codegraph.js"></script>
    <!-- Polymer element -->
    <script>
        Polymer({
            publish: {

                /**
                 * This is the url of the graph data to load.
                 * @attribute url
                 * @type {String}
                 */
                graphUrl: null

            },
            data: null,
            config: null,

            _isReady: false,
            get isReady() { return this._isReady; },

            handleErrors: function () {
                this.loader.on("error", function (error) { this.fire("error", {error: error}); }.bind(this));
                this.saver.on("error", function (error) { this.fire("error", {error: error}); }.bind(this));
                this.graph.on("error", function (error) { this.fire("error", {error: error}); }.bind(this));
                this.renderer.on("error", function (error) { this.fire("error", {error: error}); }.bind(this));
            },

            createGroup: function (name) {
                var _id = graph.getNextGroupId();
                renderer.createSmartGroup(_id, name);
            },

            createBlock: function (model, position) {
                this.graph.addEntity(new cg.Block(this.graph.getNextBlockId(), model, position), this.graph);
            },

            removeSelection: function () {
                this.renderer.removeSelection();
            },

            hasSelectedEntities: function () {
                return this.renderer.hasSelectedEntities();
            },

            zoomToFit: function () {
                this.renderer.zoomToFit();
            },

            findModels: function (options) {
                return this.graph.findModels(options);
            },

            getLastSelectedEntity: function() {
                return this.renderer.getLastSelectedEntity();
            },

            /**
             * Create the graph when its config and data are loaded.
             * @private
             */
            _createGraph: function () {
                this.graph = new cg.Graph();
                this.loader = new cg.JSONLoader();
                this.saver = new cg.JSONSaver();
                this.renderer = new cg.Renderer(this.graph, this.$.svg, this.config);
                window.graph = this.graph;
                window.renderer = this.renderer;
                window.loader = this.loader;
                window.saver = this.saver;
                this.handleErrors();
                this.renderer.on("picker.edit", function (picker) {
                    this.fire("picker.edit", {picker: picker});
                }.bind(this));
                this.loader.load(this.graph, this._graphData);
                this.renderer.render();
                this._isReady = true;
                this.fire("ready");
            },

            /**
             * Load the graph data from an external JSON file.
             * @private
             */
            _loadGraph: function () {
                this._graphData = this.$.graphData.response;
                if (this.config !== null) {
                    this._createGraph();
                }
            },

            ready: function () {
                this.addEventListener("dude-config-ready", function () {
                    if (this._graphData !== undefined) {
                        this._createGraph();
                    }
                });
            }
        });
    </script>
</polymer-element>