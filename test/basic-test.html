<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>dude-graph - Basic test</title>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../d3/d3.min.js"></script>
    <script src="../../eventEmitter/EventEmitter.min.js"></script>
    <script src="../../dude-graph/dude-graph.js"></script>
</head>
<body>
<script>
    suite("basic", function () {
        test("create graph", function () {
            var graph = new dudeGraph.Graph();
        });
        test("create block", function () {
            var block = new dudeGraph.Block({
                "blockId": "testId",
                "blockName": "Test",
                "blockTemplates": {
                    "ValueType": ["Number", "String"]
                }
            });
            expect(block.blockId).to.be.equal("testId");
            expect(block.blockType).to.be.equal("Block");
            expect(block.blockName).to.be.equal("Test");
            expect(block.blockTemplates).to.be.eql({
                "ValueType": ["Number", "String"]
            });
            // Different ways of creating a block
            new dudeGraph.Block();
            new dudeGraph.Block({
                "blockId": "testId"
            });
            new dudeGraph.Block({
                "blockName": "testId"
            });
            new dudeGraph.Block({
                "blockTemplates": {
                    "ValueType": ["Number", "String"]
                }
            });
        });
        test("create graph block", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            expect(block.blockId).to.be.null;
            graph.addBlock(block);
            expect(block.blockId).to.be.not.null;
            expect(graph.graphBlocks[0]).to.be.equal(block);
            // Cannot add the same block again
            expect(function () {
                graph.addBlock(block);
            }).to.throw();
        });
        test("create point", function () {
            var outputPoint = new dudeGraph.Point(true, {
                "pointName": "output",
                "pointValueType": "Whatever" // pointValueType is enforced only when adding to a block
            });
            expect(outputPoint.pointBlock).to.be.null;
            expect(outputPoint.pointOutput).to.be.true;
            expect(outputPoint.pointType).to.be.equal("Point");
            expect(outputPoint.pointName).to.be.equal("output");
            expect(outputPoint.pointValueType).to.be.equal("Whatever");
            var inputPoint = new dudeGraph.Point(false, {
                "pointName": "input",
                "pointValueType": "WhateverAgain", // pointValueType is enforced only when adding to a block
                "pointValue": {"whatever": true} // pointValue is enforced to valueType only when adding to a block
            });
            expect(inputPoint.pointBlock).to.be.null;
            expect(inputPoint.pointOutput).to.be.false;
            expect(inputPoint.pointType).to.be.equal("Point");
            expect(inputPoint.pointName).to.be.equal("input");
            expect(inputPoint.pointValueType).to.be.equal("WhateverAgain");
            expect(inputPoint.pointValue).to.be.eql({"whatever": true});
            // Ill-formed points
            expect(function () {
                //noinspection JSCheckFunctionSignatures
                new dudeGraph.Point(true, {
                    "pointName": "output"
                    // pointValueType is mandatory
                });
            }).to.throw();
            expect(function () {
                //noinspection JSCheckFunctionSignatures
                new dudeGraph.Point(true, {
                    // pointName is mandatory
                    "pointValueType": "Whatever"
                });
            }).to.throw();
            expect(function () {
                //noinspection JSCheckFunctionSignatures
                new dudeGraph.Point(true, {
                    "pointName": false, // pointName must be a String
                    "pointValueType": "Whatever"
                });
            }).to.throw();
            expect(function () {
                //noinspection JSCheckFunctionSignatures
                new dudeGraph.Point(true, {
                    "pointName": "output",
                    "pointValueType": new dudeGraph.Graph() // pointValueType must be a String
                });
            }).to.throw();
        });
        test("create block point", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            var outputPoint = new dudeGraph.Point(true, {
                "pointName": "output",
                "pointValueType": "String"
            });
            expect(function () {
                block.addPoint(outputPoint); // The block must be added to the graph to accept points
            }).to.throw();
            graph.addBlock(block);
            block.addPoint(outputPoint);
            expect(block.blockOutputPoints).to.have.length(1);
            expect(block.blockInputPoints).to.have.length(0);
            expect(function () {
                block.addPoint(new dudeGraph.Point(true, {
                    "pointName": "output", // Cannot add 2 outputs with the same name
                    "pointValueType": "String"
                }));
            }).to.throw();
            block.addPoint(new dudeGraph.Point(false, {
                "pointName": "output", // But can add an input with the same name as an output
                "pointValueType": "String"
            }));
            expect(block.blockOutputPoints).to.have.length(1);
            expect(block.blockInputPoints).to.have.length(1);
            expect(function () {
                block.addPoint(new dudeGraph.Point(false, {
                    "pointName": "output", // But still cannot add 2 inputs with the same name
                    "pointValueType": "String"
                }));
            }).to.throw();
        });
        test("create block point at positions", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            graph.addBlock(block);
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out1",
                "pointValueType": "Number"
            });
            var outputPoint2 = new dudeGraph.Point(true, {
                "pointName": "out2",
                "pointValueType": "Number"
            });
            var outputPoint3 = new dudeGraph.Point(true, {
                "pointName": "out3",
                "pointValueType": "Number"
            });
            var outputPoint4 = new dudeGraph.Point(true, {
                "pointName": "out4",
                "pointValueType": "Number"
            });
            var outputPoint5 = new dudeGraph.Point(true, {
                "pointName": "out5",
                "pointValueType": "Number"
            });
            block.addPoint(outputPoint4); // Add to end [4]
            block.addPoint(outputPoint2, 0); // Add to start [2, 4]
            block.addPoint(outputPoint1, 0); // Add to start [1, 2, 4]
            block.addPoint(outputPoint5); // Add to end [1, 2, 4, 5]
            block.addPoint(outputPoint3, 2); // Add to 2nd position [1, 2, 3, 4, 5]
            block.validate(); // Block should be validated when the basic points are created
            expect(block.blockOutputPoints[0]).to.be.equal(outputPoint1);
            expect(block.blockOutputPoints[1]).to.be.equal(outputPoint2);
            expect(block.blockOutputPoints[2]).to.be.equal(outputPoint3);
            expect(block.blockOutputPoints[3]).to.be.equal(outputPoint4);
            expect(block.blockOutputPoints[4]).to.be.equal(outputPoint5);
        });
        test("connect points of same type", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var block2 = new dudeGraph.Block();
            graph.addBlock(block1);
            graph.addBlock(block2);
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var inputPoint2 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            expect(function () {
                outputPoint1.connect(inputPoint2); // The points are not bound to blocks
            }).to.throw();
            block1.addPoint(outputPoint1);
            expect(function () {
                outputPoint1.connect(inputPoint2); // inputPoint2 is not bound to a block
            }).to.throw();
            block2.addPoint(inputPoint2);
            var connection = outputPoint1.connect(inputPoint2);
            expect(outputPoint1.pointConnections).to.have.length(1);
            expect(graph.graphConnections[0]).to.be.equal(connection);
            expect(outputPoint1.pointConnections[0]).to.be.equal(connection);
            expect(inputPoint2.pointConnections[0]).to.be.equal(connection);
            expect(connection.connectionOutputPoint).to.be.equal(outputPoint1);
            expect(connection.connectionInputPoint).to.be.equal(inputPoint2);
        });
        test("disconnect points of same type", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var block2 = new dudeGraph.Block();
            graph.addBlock(block1);
            graph.addBlock(block2);
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var inputPoint2 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            expect(function () {
                outputPoint1.disconnect(inputPoint2); // The points are not bound to blocks
            }).to.throw();
            block1.addPoint(outputPoint1);
            expect(function () {
                outputPoint1.disconnect(inputPoint2); // inputPoint2 is not bound to a block
            }).to.throw();
            block2.addPoint(inputPoint2);
            expect(function () {
                outputPoint1.disconnect(inputPoint2); // Cannot disconnect non connected points
            }).to.throw();
            expect(function () {
                inputPoint2.disconnect(outputPoint1); // Cannot disconnect non connected points
            }).to.throw();
            outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(1);
            outputPoint1.disconnect(inputPoint2);
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            expect(inputPoint2.pointConnections).to.have.length(0);
        });
        test("connect/disconnect commutativity", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var block2 = new dudeGraph.Block();
            graph.addBlock(block1);
            graph.addBlock(block2);
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var inputPoint2 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            block1.addPoint(outputPoint1);
            block2.addPoint(inputPoint2);
            outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
            expect(inputPoint2.pointConnections).to.have.length(1);
            outputPoint1.disconnect(inputPoint2);
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            expect(inputPoint2.pointConnections).to.have.length(0);
            inputPoint2.connect(outputPoint1);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
            expect(inputPoint2.pointConnections).to.have.length(1);
            inputPoint2.disconnect(outputPoint1);
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            expect(inputPoint2.pointConnections).to.have.length(0);
            outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
            expect(inputPoint2.pointConnections).to.have.length(1);
            inputPoint2.disconnect(outputPoint1);
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            expect(inputPoint2.pointConnections).to.have.length(0);
            inputPoint2.connect(outputPoint1);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
            expect(inputPoint2.pointConnections).to.have.length(1);
            outputPoint1.disconnect(inputPoint2);
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            expect(inputPoint2.pointConnections).to.have.length(0);
        });
        test("point value", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            var inputPoint = new dudeGraph.Point(true, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            graph.addBlock(block);
            block.addPoint(inputPoint);
            // Test value of type `Number`
            inputPoint.pointValue = 42;
            expect(inputPoint.pointValue).to.be.equal(42);
            inputPoint.pointValue = NaN;
            expect(inputPoint.pointValue).to.be.NaN;
            inputPoint.pointValue = Infinity;
            expect(inputPoint.pointValue).to.be.equal(Infinity);
            inputPoint.pointValue = -Infinity;
            expect(inputPoint.pointValue).to.be.equal(-Infinity);
            // Test compatible pointValue
            inputPoint.pointValue = "32.444";
            expect(inputPoint.pointValue).to.be.equal(32.444);
            inputPoint.pointValue = true;
            expect(inputPoint.pointValue).to.be.equal(1);
            // Test non compatible pointValue
            expect(function () {
                inputPoint.pointValue = "1234.435.12";
            }).to.throw();
            expect(function () {
                inputPoint.pointValue = [3, true, {}];
            }).to.throw();
            // Test to create a point with a number pointValue convertible to String
            var inputPoint2 = new dudeGraph.Point(true, {
                "pointName": "in2",
                "pointValueType": "String",
                "pointValue": 42
            });
            block.addPoint(inputPoint2);
            expect(inputPoint2.pointValue).to.be.equal("42");
            inputPoint2.pointValue = 32;
            expect(inputPoint2.pointValue).to.be.equal("32");
            inputPoint2.pointValue = true;
            expect(inputPoint2.pointValue).to.be.equal("true");
            // Test non compatible inline pointValue
            expect(function () {
                block.addPoint(new dudeGraph.Point(false, {
                    "pointName": "in2",
                    "pointValueType": "Number",
                    "pointValue": "NaN"
                }));
            }).to.throw();
        });
        /*
        test("points connect with types", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            graph.addBlock(block1);
            block1.addPoint(outputPoint1);
            block1.validate();
            var block2 = new dudeGraph.Block();
            var inputPoint2_1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            var inputPoint2_2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointValueType": "Object"
            });
            graph.addBlock(block2);
            block2.addPoint(inputPoint2_1);
            block2.addPoint(inputPoint2_2);
            block2.validate();
            outputPoint1.connect(inputPoint2_1);
            outputPoint1.disconnect(inputPoint2_1);
            expect(function () {
                outputPoint1.connect(inputPoint2_2);
            }).to.throw();
        });
        test("block points connect and singleConnection and disconnectAll", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number",
                "pointSingleConnection": false
            });
            expect(outputPoint1.pointSingleConnection).to.be.false;
            var outputPoint2 = new dudeGraph.Point(true, {
                "pointName": "out2",
                "pointValueType": "Number",
                "pointSingleConnection": true
            });
            expect(outputPoint2.pointSingleConnection).to.be.true;
            graph.addBlock(block1);
            block1.addPoint(outputPoint1);
            block1.validate();
            var block2 = new dudeGraph.Block();
            var inputPoint1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            expect(inputPoint1.pointSingleConnection).to.be.true;
            var inputPoint2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointValueType": "Number"
            });
            expect(inputPoint2.pointSingleConnection).to.be.true;
            graph.addBlock(block2);
            block2.addPoint(inputPoint1);
            block2.addPoint(inputPoint2);
            block2.validate();
            outputPoint1.connect(inputPoint1);
            outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(2);
            expect(outputPoint1.pointConnections).to.have.length(2);
            expect(function () {
                inputPoint2.connect(outputPoint2);
            }).to.throw();
            outputPoint1.disconnectAll();
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            outputPoint1.connect(inputPoint1);
            outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(2);
            expect(outputPoint1.pointConnections).to.have.length(2);
            outputPoint1.disconnect(inputPoint2);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
        });
        test("block points values", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            graph.addBlock(block);
            var inputPoint = new dudeGraph.Point(false, {
                "pointName": "test",
                "pointValueType": "Number",
                "pointValue": 32
            });
            block.addPoint(inputPoint);
            expect(inputPoint.pointValueType).to.be.equal("Number");
            expect(inputPoint.pointValue).to.be.equal(32);
            // _.isNumber(NaN) => true
            inputPoint.pointValue = NaN;
            expect(inputPoint.pointValue).to.be.NaN;
            // _.isNumber(Infinity) => true
            inputPoint.pointValue = Infinity;
            expect(inputPoint.pointValue).to.be.equal(Infinity);
            // _.isNumber(-Infinity) => true
            inputPoint.pointValue = -Infinity;
            expect(inputPoint.pointValue).to.be.equal(-Infinity);
            expect(function () {
                var outputPoint = new dudeGraph.Point(true, {
                    "pointName": "test",
                    "pointValueType": "Number",
                    "pointValue": 32 // Outputs cannot have value
                });
            }).to.throw();
        });
        test("mix point values and point connections", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            graph.addBlock(block1);
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number",
                "pointSingleConnection": false
            });
            block1.addPoint(outputPoint1);
            var block2 = new dudeGraph.Block();
            graph.addBlock(block2);
            var inputPoint2_1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            var inputPoint2_2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointValueType": "Number",
                "pointValue": 32,
                "pointSingleConnection": false
            });
            var inputPoint2_3 = new dudeGraph.Point(false, {
                "pointName": "in3",
                "pointValueType": "Number",
                "pointValue": 32
            });
            block2.addPoint(inputPoint2_1);
            block2.addPoint(inputPoint2_2);
            block2.addPoint(inputPoint2_3);
            outputPoint1.connect(inputPoint2_1);
            expect(function () {
                outputPoint1.connect(inputPoint2_2); // cannot have a pointValue and pointConnections at same time
            }).to.throw();
            expect(function () {
                outputPoint1.connect(inputPoint2_3); // even if !pointSingleConnection
            }).to.throw();
        });
        test("change point value type and conversion", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            graph.addBlock(block);
            // var inputPoint =
        });
        test("custom block and custom point", function () {

        });
        test("add/remove of points", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            var outputPoint = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var inputPoint = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            graph.addBlock(block);
            block.addPoint(outputPoint);
            block.addPoint(inputPoint);
            block.validate();
            expect(block.blockInputPoints).to.have.length(1);
            expect(block.blockInputPoints).to.have.length(1);
            expect(block.blockInputPoints[0]).to.be.equal(outputPoint);
            expect(block.blockInputPoints[0]).to.be.equal(inputPoint);
            expect(block.outputByName("out")).to.be.equal(outputPoint);
            expect(block.inputByName("in")).to.be.equal(inputPoint);
            block.removePoint(inputPoint);
            expect(block.blockInputPoints).to.have.length(0);
            expect(block.inputByName("in")).to.be.null;
            block.addPoint(inputPoint);
            expect(block.blockInputPoints).to.have.length(1);
            expect(block.blockInputPoints[0]).to.be.equal(inputPoint);
        });
        test("ill-formed templated point", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block({
                "blockTemplates": {
                    "ValueType": ["String", "Boolean"]
                }
            });
            graph.addBlock(block);
            expect(function () {
                var point = new dudeGraph.Point(false, {
                    "pointName": "in",
                    "pointValueType": "Number",
                    "pointTemplate": "ValueType"
                });
                block.addPoint(point);
                block.validate();
            }).to.throw();
        });
        test("templated types", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            graph.addBlock(block1);
            var outputPoint1_1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "String"
            });
            block1.addPoint(outputPoint1_1);
            var outputPoint1_2 = new dudeGraph.Point(true, {
                "pointName": "out2",
                "pointValueType": "String"
            });
            block1.addPoint(outputPoint1_2);
            block1.validate();
            var block2 = new dudeGraph.Block({
                "blockTemplates": {
                    "ValueType": [
                        "Number",
                        "String"
                    ]
                }
            });
            graph.addBlock(block2);
            var inputPoint2_1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number",
                "pointTemplate": "ValueType"
            });
            block2.addPoint(inputPoint2_1);
            var inputPoint2_2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointValueType": "Number",
                "pointTemplate": "ValueType"
            });
            block2.addPoint(inputPoint2_2);
            block2.validate();
            outputPoint1_1.connect(inputPoint2_1);
            outputPoint1_2.connect(inputPoint2_2);
        });
        test("template mismatch", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            graph.addBlock(block1);
            var outputPoint1_1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "String"
            });
            block1.addPoint(outputPoint1_1);
            var outputPoint1_2 = new dudeGraph.Point(true, {
                "pointName": "out2",
                "pointValueType": "Number"
            });
            block1.addPoint(outputPoint1_2);
            block1.validate();
            var block2 = new dudeGraph.Block({
                "blockTemplates": {
                    "ValueType": [
                        "Number",
                        "String"
                    ]
                }
            });
            graph.addBlock(block2);
            var inputPoint2_1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number",
                "pointTemplate": "ValueType"
            });
            block2.addPoint(inputPoint2_1);
            var inputPoint2_2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointValueType": "Number",
                "pointTemplate": "ValueType"
            });
            block2.addPoint(inputPoint2_2);
            block2.validate();
            outputPoint1_1.connect(inputPoint2_1);
            expect(function () {
                outputPoint1_2.connect(inputPoint2_2);
            }).to.throw();
         });
         */
    });
</script>
</body>
</html>