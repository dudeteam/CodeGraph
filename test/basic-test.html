<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>dude-graph - Basic test</title>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../d3/d3.min.js"></script>
    <script src="../../eventEmitter/EventEmitter.min.js"></script>
    <script src="../../dude-graph/dude-graph.js"></script>
</head>
<body>
<script>
    suite("basic", function () {
        test("create graph", function () {
            var graph = new dudeGraph.Graph();
            expect(graph.graphBlocks).to.have.length(0);
            expect(graph.graphConnections).to.have.length(0);
            expect(graph.hasType("Number")).to.be.true;
            expect(graph.hasType("String")).to.be.true;
            expect(graph.hasType("Boolean")).to.be.true;
            expect(graph.hasType("Object")).to.be.true;
            expect(graph.hasType("Array")).to.be.true;
        });
        test("create block", function () {
            var block = new dudeGraph.Block({
                "blockId": "testId",
                "blockName": "Test",
                "blockTemplates": {
                    "ValueType": ["Number", "String"]
                }
            });
            expect(block.blockId).to.be.equal("testId");
            expect(block.blockType).to.be.equal("Block");
            expect(block.blockName).to.be.equal("Test");
            expect(block.blockTemplates).to.be.eql({
                "ValueType": ["Number", "String"]
            });
            // Different ways of creating a block
            new dudeGraph.Block();
            new dudeGraph.Block({
                "blockId": "testId"
            });
            new dudeGraph.Block({
                "blockName": "testId"
            });
            new dudeGraph.Block({
                "blockTemplates": {
                    "ValueType": ["Number", "String"]
                }
            });
        });
        test("create graph block", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            expect(block.blockId).to.be.null;
            graph.addBlock(block);
            expect(block.blockId).to.be.not.null;
            expect(graph.graphBlocks[0]).to.be.equal(block);
            // Cannot add the same block again
            expect(function () {
                graph.addBlock(block);
            }).to.throw();
        });
        test("create point", function () {
            var outputPoint = new dudeGraph.Point(true, {
                "pointName": "output",
                "pointValueType": "Whatever" // pointValueType is enforced only when adding to a block
            });
            expect(outputPoint.pointBlock).to.be.null;
            expect(outputPoint.pointOutput).to.be.true;
            expect(outputPoint.pointType).to.be.equal("Point");
            expect(outputPoint.pointName).to.be.equal("output");
            expect(outputPoint.pointValueType).to.be.equal("Whatever");
            var inputPoint = new dudeGraph.Point(false, {
                "pointName": "input",
                "pointValueType": "WhateverAgain", // pointValueType is enforced only when adding to a block
                "pointValue": {"whatever": true} // pointValue is enforced to valueType only when adding to a block
            });
            expect(inputPoint.pointBlock).to.be.null;
            expect(inputPoint.pointOutput).to.be.false;
            expect(inputPoint.pointType).to.be.equal("Point");
            expect(inputPoint.pointName).to.be.equal("input");
            expect(inputPoint.pointValueType).to.be.equal("WhateverAgain");
            expect(inputPoint.pointValue).to.be.eql({"whatever": true});
            // Ill-formed points
            expect(function () {
                //noinspection JSCheckFunctionSignatures
                new dudeGraph.Point(); // pointOutput is required
            }).to.throw();
            expect(function () {
                //noinspection JSCheckFunctionSignatures
                new dudeGraph.Point(true, {
                    "pointName": "output"
                    // pointValueType is required
                });
            }).to.throw();
            expect(function () {
                //noinspection JSCheckFunctionSignatures
                new dudeGraph.Point(true, {
                    // pointName is required
                    "pointValueType": "Whatever"
                });
            }).to.throw();
            expect(function () {
                //noinspection JSCheckFunctionSignatures
                new dudeGraph.Point(true, {
                    "pointName": false, // pointName must be a String
                    "pointValueType": "Whatever"
                });
            }).to.throw();
            expect(function () {
                //noinspection JSCheckFunctionSignatures
                new dudeGraph.Point(true, {
                    "pointName": "output",
                    "pointValueType": new dudeGraph.Graph() // pointValueType must be a String
                });
            }).to.throw();
        });
        test("create block point", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            var outputPoint = new dudeGraph.Point(true, {
                "pointName": "output",
                "pointValueType": "String"
            });
            expect(function () {
                block.addPoint(outputPoint); // The block must be added to the graph to accept points
            }).to.throw();
            graph.addBlock(block);
            block.addPoint(outputPoint);
            expect(block.blockOutputs).to.have.length(1);
            expect(block.blockInputs).to.have.length(0);
            expect(function () {
                block.addPoint(new dudeGraph.Point(true, {
                    "pointName": "output", // Cannot add 2 outputs with the same name
                    "pointValueType": "String"
                }));
            }).to.throw();
            block.addPoint(new dudeGraph.Point(false, {
                "pointName": "output", // But can add an input with the same name as an output
                "pointValueType": "String"
            }));
            expect(block.blockOutputs).to.have.length(1);
            expect(block.blockInputs).to.have.length(1);
            expect(function () {
                block.addPoint(new dudeGraph.Point(false, {
                    "pointName": "output", // But still cannot add 2 inputs with the same name
                    "pointValueType": "String"
                }));
            }).to.throw();
        });
        test("create block point at positions", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            graph.addBlock(block);
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out1",
                "pointValueType": "Number"
            });
            var outputPoint2 = new dudeGraph.Point(true, {
                "pointName": "out2",
                "pointValueType": "Number"
            });
            var outputPoint3 = new dudeGraph.Point(true, {
                "pointName": "out3",
                "pointValueType": "Number"
            });
            var outputPoint4 = new dudeGraph.Point(true, {
                "pointName": "out4",
                "pointValueType": "Number"
            });
            var outputPoint5 = new dudeGraph.Point(true, {
                "pointName": "out5",
                "pointValueType": "Number"
            });
            block.addPoint(outputPoint4); // Add to end [4]
            block.addPoint(outputPoint2, 0); // Add to start [2, 4]
            block.addPoint(outputPoint1, 0); // Add to start [1, 2, 4]
            block.addPoint(outputPoint5); // Add to end [1, 2, 4, 5]
            block.addPoint(outputPoint3, 2); // Add to 2nd position [1, 2, 3, 4, 5]
            expect(block.blockOutputs[0]).to.be.equal(outputPoint1);
            expect(block.blockOutputs[1]).to.be.equal(outputPoint2);
            expect(block.blockOutputs[2]).to.be.equal(outputPoint3);
            expect(block.blockOutputs[3]).to.be.equal(outputPoint4);
            expect(block.blockOutputs[4]).to.be.equal(outputPoint5);
        });
        test("point value", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            var inputPoint = new dudeGraph.Point(true, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            graph.addBlock(block);
            block.addPoint(inputPoint);
            // Test value of type `Number`
            inputPoint.pointValue = 42;
            expect(inputPoint.pointValue).to.be.equal(42);
            inputPoint.pointValue = NaN;
            expect(inputPoint.pointValue).to.be.NaN;
            inputPoint.pointValue = null;
            expect(inputPoint.pointValue).to.be.null;
            inputPoint.pointValue = Infinity;
            expect(inputPoint.pointValue).to.be.equal(Infinity);
            inputPoint.pointValue = -Infinity;
            expect(inputPoint.pointValue).to.be.equal(-Infinity);
            // Test compatible pointValue "32.444" with `Number`
            inputPoint.pointValue = "32.444";
            expect(inputPoint.pointValue).to.be.equal(32.444);
            inputPoint.pointValue = true;
            expect(inputPoint.pointValue).to.be.equal(1);
            expect(function () {
                inputPoint.pointValue = "1234.435.12"; // Test non compatible pointValue "1234.435.12" with `Number`
            }).to.throw();
            expect(function () {
                inputPoint.pointValue = [3, true, {}];
            }).to.throw();
            var inputPoint2 = new dudeGraph.Point(true, {
                "pointName": "in2",
                "pointValueType": "String",
                "pointValue": 42 // 42 is convertible to `String`
            });
            block.addPoint(inputPoint2);
            expect(inputPoint2.pointValue).to.be.equal("42");
            inputPoint2.pointValue = 32;
            expect(inputPoint2.pointValue).to.be.equal("32");
            inputPoint2.pointValue = true;
            expect(inputPoint2.pointValue).to.be.equal("true");
            expect(function () {
                block.addPoint(new dudeGraph.Point(false, {
                    "pointName": "in2",
                    "pointValueType": "Number",
                    "pointValue": "NaN" // Non compatible inline pointValue "NaN" with `Number`
                }));
            }).to.throw();
        });
        test("point value type", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            var inputPoint = new dudeGraph.Point(true, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            graph.addBlock(block);
            block.addPoint(inputPoint);
            inputPoint.pointValue = 32;
            inputPoint.pointValueType = "String";
            expect(inputPoint.pointValueType).to.be.equal("String");
            expect(inputPoint.pointValue).to.be.equal("32");
            expect(function () {
                inputPoint.pointValueType = "Array";
            }).to.throw();
            inputPoint.pointValue = null;
            inputPoint.pointValueType = "Array";
            expect(inputPoint.pointValueType).to.be.equal("Array");
            inputPoint.pointValue = [32, [], {}];
            expect(inputPoint.pointValue).to.be.eql([32, [], {}]);
            expect(function () {
                block.addPoint(new dudeGraph.Point(true, {
                    "pointName": "in2",
                    "pointValueType": "UnknownValueType" // Unknown type
                }));
            }).to.throw();
            graph.addType("NewType", {
                "convert": function (value) {
                    if (value === "NewValue") {
                        return "ThisIsACorrectNewValue";
                    }
                    return undefined;
                }
            });
            expect(function () {
                graph.addType("NewType", _.noop); // Cannot add twice the same type name
            }).to.throw();
            inputPoint.pointValue = null;
            inputPoint.pointValueType = "NewType";
            inputPoint.pointValue = "NewValue";
            expect(inputPoint.pointValueType).to.be.equal("NewType");
            expect(inputPoint.pointValue).to.be.equal("ThisIsACorrectNewValue");
            expect(function () {
                inputPoint.pointValue = "NewNewValue"; // Only "NewValue" is accepted for `NewType`
            }).to.throw();
            // Reconvert to `String` as "ThisIsACorrectNewValue" is convertible to `String`
            inputPoint.pointValueType = "String";
            expect(inputPoint.pointValue).to.be.equal("ThisIsACorrectNewValue");
            inputPoint.pointValue = "NewValue";
            expect(inputPoint.pointValue).to.be.equal("NewValue");
            // Reconvert to `NewType` as "NewValue" is acceptable as `NewType`
            inputPoint.pointValueType = "NewType";
            expect(inputPoint.pointValueType).to.be.equal("NewType");
            expect(inputPoint.pointValue).to.be.equal("ThisIsACorrectNewValue");
        });
        test("connect points of same type", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var block2 = new dudeGraph.Block();
            graph.addBlock(block1);
            graph.addBlock(block2);
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var inputPoint2 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            expect(function () {
                outputPoint1.connect(inputPoint2); // The points are not bound to blocks
            }).to.throw();
            block1.addPoint(outputPoint1);
            expect(function () {
                outputPoint1.connect(inputPoint2); // inputPoint2 is not bound to a block
            }).to.throw();
            block2.addPoint(inputPoint2);
            var connection = outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
            expect(inputPoint2.pointConnections).to.have.length(1);
            expect(graph.graphConnections[0]).to.be.equal(connection);
            expect(outputPoint1.pointConnections[0]).to.be.equal(connection);
            expect(inputPoint2.pointConnections[0]).to.be.equal(connection);
            expect(connection.connectionOutputPoint).to.be.equal(outputPoint1);
            expect(connection.connectionInputPoint).to.be.equal(inputPoint2);
        });
        test("disconnect points of same type", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var block2 = new dudeGraph.Block();
            graph.addBlock(block1);
            graph.addBlock(block2);
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var inputPoint2 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            expect(function () {
                outputPoint1.disconnect(inputPoint2); // The points are not bound to blocks
            }).to.throw();
            block1.addPoint(outputPoint1);
            expect(function () {
                outputPoint1.disconnect(inputPoint2); // inputPoint2 is not bound to a block
            }).to.throw();
            block2.addPoint(inputPoint2);
            expect(function () {
                outputPoint1.disconnect(inputPoint2); // Cannot disconnect non connected points
            }).to.throw();
            expect(function () {
                inputPoint2.disconnect(outputPoint1); // Cannot disconnect non connected points
            }).to.throw();
            outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(1);
            outputPoint1.disconnect(inputPoint2);
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            expect(inputPoint2.pointConnections).to.have.length(0);
        });
        test("connect/disconnect commutativity", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var block2 = new dudeGraph.Block();
            graph.addBlock(block1);
            graph.addBlock(block2);
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var inputPoint2 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            block1.addPoint(outputPoint1);
            block2.addPoint(inputPoint2);
            outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
            expect(inputPoint2.pointConnections).to.have.length(1);
            outputPoint1.disconnect(inputPoint2);
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            expect(inputPoint2.pointConnections).to.have.length(0);
            inputPoint2.connect(outputPoint1);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
            expect(inputPoint2.pointConnections).to.have.length(1);
            inputPoint2.disconnect(outputPoint1);
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            expect(inputPoint2.pointConnections).to.have.length(0);
            outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
            expect(inputPoint2.pointConnections).to.have.length(1);
            inputPoint2.disconnect(outputPoint1);
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            expect(inputPoint2.pointConnections).to.have.length(0);
            inputPoint2.connect(outputPoint1);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
            expect(inputPoint2.pointConnections).to.have.length(1);
            outputPoint1.disconnect(inputPoint2);
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            expect(inputPoint2.pointConnections).to.have.length(0);
        });
        test("connect compatible types", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var block2 = new dudeGraph.Block();
            graph.addBlock(block1);
            graph.addBlock(block2);
            var outputPoint1_1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var outputPoint1_2 = new dudeGraph.Point(true, {
                "pointName": "out2",
                "pointValueType": "Boolean"
            });
            var outputPoint1_3 = new dudeGraph.Point(true, {
                "pointName": "out3",
                "pointValueType": "Number"
            });
            var outputPoint1_4 = new dudeGraph.Point(true, {
                "pointName": "out4",
                "pointValueType": "String"
            });
            var inputPoint2_1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Boolean"
            });
            var inputPoint2_2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointValueType": "Number"
            });
            var inputPoint2_3 = new dudeGraph.Point(false, {
                "pointName": "in3",
                "pointValueType": "String"
            });
            var inputPoint2_4 = new dudeGraph.Point(false, {
                "pointName": "in3",
                "pointValueType": "Number"
            });
            block1.addPoint(outputPoint1_1);
            block1.addPoint(outputPoint1_2);
            block1.addPoint(outputPoint1_3);
            block2.addPoint(inputPoint2_1);
            block2.addPoint(inputPoint2_2);
            block2.addPoint(inputPoint2_3);
            outputPoint1_1.connect(inputPoint2_1); // `Number` => `Boolean`
            outputPoint1_1.disconnect(inputPoint2_1);
            inputPoint2_1.connect(outputPoint1_1); // `Number` => `Boolean`
            inputPoint2_1.disconnect(outputPoint1_1);
            outputPoint1_2.connect(inputPoint2_2); // `Boolean` => `Number`
            outputPoint1_2.disconnect(inputPoint2_2);
            inputPoint2_2.connect(outputPoint1_2); // `Boolean` => `Number`
            inputPoint2_2.disconnect(outputPoint1_2);
            outputPoint1_3.connect(inputPoint2_3); // `String` => `Number`
            outputPoint1_3.disconnect(inputPoint2_3);
            inputPoint2_3.connect(outputPoint1_3); // `String` => `Number`
            inputPoint2_3.disconnect(outputPoint1_3);
            expect(function () {
                outputPoint1_4.connect(inputPoint2_4); // `Number` =/=> `String`
            }).to.throw();
            expect(function () {
                inputPoint2_4.connect(outputPoint1_4); // `Number` =/=> `String`
            }).to.throw();
        });
        test("cannot mix connect and point value", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var block2 = new dudeGraph.Block();
            graph.addBlock(block1);
            graph.addBlock(block2);
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var inputPoint2 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Boolean"
            });
            block1.addPoint(outputPoint1);
            block2.addPoint(inputPoint2);
            inputPoint2.pointValue = false;
            expect(function () {
                outputPoint1.connect(inputPoint2); // Cannot connect a point with a non-null pointValue
            }).to.throw();
            expect(function () {
                inputPoint2.connect(outputPoint1); // Cannot connect a point with a non-null pointValue (commutativity)
            }).to.throw();
            inputPoint2.pointValue = null;
            outputPoint1.connect(inputPoint2);
            outputPoint1.disconnect(inputPoint2);
            inputPoint2.connect(outputPoint1);
            inputPoint2.disconnect(outputPoint1);
        });
        test("connect and value type", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var block2 = new dudeGraph.Block();
            graph.addBlock(block1);
            graph.addBlock(block2);
            var outputPoint1_1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number",
                "pointSingleConnection": false
            });
            var inputPoint2_1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            var inputPoint2_2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointValueType": "Boolean"
            });
            block1.addPoint(outputPoint1_1);
            block2.addPoint(inputPoint2_1);
            block2.addPoint(inputPoint2_2);
            outputPoint1_1.connect(inputPoint2_1); // `Number` => `Boolean`
        });
        test("connect multiple points and disconnectAll", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number",
                "pointSingleConnection": false
            });
            expect(outputPoint1.pointSingleConnection).to.be.false;
            var outputPoint2 = new dudeGraph.Point(true, {
                "pointName": "out2",
                "pointValueType": "Number",
                "pointSingleConnection": true
            });
            expect(outputPoint2.pointSingleConnection).to.be.true;
            graph.addBlock(block1);
            block1.addPoint(outputPoint1);
            var block2 = new dudeGraph.Block();
            var inputPoint1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            expect(inputPoint1.pointSingleConnection).to.be.true;
            var inputPoint2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointValueType": "Number"
            });
            expect(inputPoint2.pointSingleConnection).to.be.true;
            graph.addBlock(block2);
            block2.addPoint(inputPoint1);
            block2.addPoint(inputPoint2);
            outputPoint1.connect(inputPoint1);
            outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(2);
            expect(outputPoint1.pointConnections).to.have.length(2);
            expect(function () {
                inputPoint2.connect(outputPoint2);
            }).to.throw();
            outputPoint1.disconnectAll();
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            outputPoint1.connect(inputPoint1);
            outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(2);
            expect(outputPoint1.pointConnections).to.have.length(2);
            outputPoint1.disconnect(inputPoint2);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
        });
        test("remove points", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var block2 = new dudeGraph.Block();
            graph.addBlock(block1);
            graph.addBlock(block2);
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var inputPoint2 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            block1.addPoint(outputPoint1);
            block2.addPoint(inputPoint2);
            expect(function () {
                block1.removePoint(inputPoint2); // inputPoint2 is not in block1
            }).to.throw();
            expect(function () {
                block2.removePoint(outputPoint1); // outputPoint1 is not in block2
            }).to.throw();
            block1.removePoint(outputPoint1);
            block2.removePoint(inputPoint2);
            block1.addPoint(outputPoint1);
            block2.addPoint(inputPoint2);
            var connection = outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
            expect(inputPoint2.pointConnections).to.have.length(1);
            expect(graph.graphConnections[0]).to.be.equal(connection);
            expect(outputPoint1.pointConnections[0]).to.be.equal(connection);
            expect(inputPoint2.pointConnections[0]).to.be.equal(connection);
            expect(connection.connectionOutputPoint).to.be.equal(outputPoint1);
            expect(connection.connectionInputPoint).to.be.equal(inputPoint2);
            block1.removePoint(outputPoint1);
            expect(graph.graphConnections).to.have.length(0);
            expect(inputPoint2.pointConnections).to.have.length(0);
        });
        test("block templates", function () {
            var graph = new dudeGraph.Graph();
            expect(function () {
                var badBlock = new dudeGraph.Block({
                    "blockTemplates": {
                        "TemplateName": {} // `valueType` is required, `templates` is required
                    }
                });
                graph.addBlock(badBlock);
            }).to.throw();
            expect(function () {
                var badBlock = new dudeGraph.Block({
                    "blockTemplates": {
                        "TemplateName": {
                            "valueType": "Number"
                            // `templates` is required
                        }
                    }
                });
                graph.addBlock(badBlock);
            }).to.throw();
            expect(function () {
                var badBlock = new dudeGraph.Block({
                    "blockTemplates": {
                        "TemplateName": {
                            // `valueType` is required
                            "templates": ["Number"]
                        }
                    }
                });
                graph.addBlock(badBlock);
            }).to.throw();
            expect(function () {
                var badBlock = new dudeGraph.Block({
                    "blockTemplates": {
                        "TemplateName": {
                            "valueType": "String",
                            "templates": ["Number", "Boolean"] // `valueType` must be included in `templates`
                        }
                    }
                });
                graph.addBlock(badBlock);
            }).to.throw();
            expect(function () {
                var badBlock = new dudeGraph.Block({
                    "blockTemplates": {
                        "TemplateName": {
                            "valueType": "UnknownType", // `valueType` must be a graph known type
                            "templates": ["UnknownType"]
                        }
                    }
                });
                graph.addBlock(badBlock);
            }).to.throw();
            var block = new dudeGraph.Block({
                "blockTemplates": {
                    "TemplateTest": {
                        "valueType": "Number",
                        "templates": ["Number", "String"]
                    }
                }
            });
            expect(function () {
                block.template("TemplateTest"); // Cannot manipulate templates while not bound to a graph
            }).to.throw();
            expect(function () {
                block.updateTemplate("TemplateTest", "String"); // Cannot manipulate templates while not bound to a graph
            }).to.throw();
            graph.addBlock(block);
            block.updateTemplate("TemplateTest", "String");
            expect(block.template("TemplateTest").valueType).to.equals("String");
            expect(block.template("TemplateTest").templates).to.eql(["Number", "String"]);
            block.updateTemplate("TemplateTest", "Number");
            expect(block.template("TemplateTest").valueType).to.equals("Number");
            expect(block.template("TemplateTest").templates).to.eql(["Number", "String"]);
            block.updateTemplate("TemplateTest", "String");
            expect(block.template("TemplateTest").valueType).to.equals("String");
            expect(block.template("TemplateTest").templates).to.eql(["Number", "String"]);
            expect(function () {
                block.updateTemplate("TemplateTest", "Boolean"); // `TemplateTest` has no template `Boolean`
            }).to.throw();
        });
        test("point templates", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block({
                "blockTemplates": {
                    "TemplateTest": {
                        "valueType": "Number",
                        "templates": ["Number", "String"]
                    }
                }
            });
            graph.addBlock(block1);
            var inputPoint1_1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointTemplate": "TemplateTest",
                "pointValueType": null
            });
            var inputPoint1_2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointTemplate": "TemplateTest",
                "pointValueType": null
            });
            block1.addPoint(inputPoint1_1);
            block1.addPoint(inputPoint1_2);
            expect(inputPoint1_1.pointValueType).to.be.equals("Number");
            expect(inputPoint1_2.pointValueType).to.be.equals("Number");
            block1.updateTemplate("TemplateTest", "String");
            expect(inputPoint1_1.pointValueType).to.be.equals("String");
            expect(inputPoint1_2.pointValueType).to.be.equals("String");
            inputPoint1_1.pointValue = "I'm a String, and NotANumber";
            inputPoint1_2.pointValue = "Me neither";
            expect(function () {
                block1.updateTemplate("TemplateTest", "Number"); // All points cannot safely be transformed to `Number`
            }).to.throw();
            inputPoint1_1.pointValue = "64";
            inputPoint1_2.pointValue = "32";
            block1.updateTemplate("TemplateTest", "Number"); // Now they can be transformed to `Number`
            expect(inputPoint1_1.pointValue);
        });
        test("point templates and connections", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block({
                "blockTemplates": {
                    "TemplateTest": {
                        "valueType": "Number",
                        "templates": ["Number", "String", "Boolean"]
                    }
                }
            });
            graph.addBlock(block1);
            var inputPoint1_1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointTemplate": "TemplateTest"
            });
            var inputPoint1_2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointTemplate": "TemplateTest"
            });
            var inputPoint1_3 = new dudeGraph.Point(false, {
                "pointName": "in3",
                "pointTemplate": "TemplateTest"
            });
            block1.addPoint(inputPoint1_1);
            expect(inputPoint1_1.pointValueType).to.be.equals("Number");
            block1.addPoint(inputPoint1_2);
            expect(inputPoint1_2.pointValueType).to.be.equals("Number");
            block1.addPoint(inputPoint1_3);
            expect(inputPoint1_3.pointValueType).to.be.equals("Number");
            var block2 = new dudeGraph.Block();
            graph.addBlock(block2);
            var outputPoint2_1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var outputPoint2_2 = new dudeGraph.Point(true, {
                "pointName": "out2",
                "pointValueType": "String"
            });
            var outputPoint2_3 = new dudeGraph.Point(true, {
                "pointName": "out3",
                "pointValueType": "Boolean"
            });
            block2.addPoint(outputPoint2_1);
            block2.addPoint(outputPoint2_2);
            block2.addPoint(outputPoint2_3);
            outputPoint2_1.connect(inputPoint1_1); // `Number` ===> `Number`
            expect(function () {
                outputPoint2_2.connect(inputPoint1_2); // `String` =/=> `Number`
            }).to.throw();
            expect(block1.template("TemplateTest").valueType).to.be.equals("Number");
            expect(inputPoint1_1.pointValueType).to.be.equals("Number");
            expect(inputPoint1_2.pointValueType).to.be.equals("Number");
            expect(inputPoint1_3.pointValueType).to.be.equals("Number");
            block1.updateTemplate("TemplateTest", "String");
            expect(block1.template("TemplateTest").valueType).to.be.equals("String");
            expect(inputPoint1_1.pointValueType).to.be.equals("String");
            expect(inputPoint1_2.pointValueType).to.be.equals("String");
            expect(inputPoint1_3.pointValueType).to.be.equals("String");
        });
        /*
        test("custom block and custom point", function () {

        });
        test("ill-formed templated point", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block({
                "blockTemplates": {
                    "ValueType": ["String", "Boolean"]
                }
            });
            graph.addBlock(block);
            expect(function () {
                var point = new dudeGraph.Point(false, {
                    "pointName": "in",
                    "pointValueType": "Number",
                    "pointTemplate": "ValueType"
                });
                block.addPoint(point);
            }).to.throw();
        });
        test("templated types", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            graph.addBlock(block1);
            var outputPoint1_1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "String"
            });
            block1.addPoint(outputPoint1_1);
            var outputPoint1_2 = new dudeGraph.Point(true, {
                "pointName": "out2",
                "pointValueType": "String"
            });
            block1.addPoint(outputPoint1_2);
            var block2 = new dudeGraph.Block({
                "blockTemplates": {
                    "ValueType": [
                        "Number",
                        "String"
                    ]
                }
            });
            graph.addBlock(block2);
            var inputPoint2_1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number",
                "pointTemplate": "ValueType"
            });
            block2.addPoint(inputPoint2_1);
            var inputPoint2_2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointValueType": "Number",
                "pointTemplate": "ValueType"
            });
            block2.addPoint(inputPoint2_2);
            outputPoint1_1.connect(inputPoint2_1);
            outputPoint1_2.connect(inputPoint2_2);
        });
        test("template mismatch", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            graph.addBlock(block1);
            var outputPoint1_1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "String"
            });
            block1.addPoint(outputPoint1_1);
            var outputPoint1_2 = new dudeGraph.Point(true, {
                "pointName": "out2",
                "pointValueType": "Number"
            });
            block1.addPoint(outputPoint1_2);
            var block2 = new dudeGraph.Block({
                "blockTemplates": {
                    "ValueType": [
                        "Number",
                        "String"
                    ]
                }
            });
            graph.addBlock(block2);
            var inputPoint2_1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number",
                "pointTemplate": "ValueType"
            });
            block2.addPoint(inputPoint2_1);
            var inputPoint2_2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointValueType": "Number",
                "pointTemplate": "ValueType"
            });
            block2.addPoint(inputPoint2_2);
            outputPoint1_1.connect(inputPoint2_1);
            expect(function () {
                outputPoint1_2.connect(inputPoint2_2);
            }).to.throw();
         });
         */
    });
</script>
</body>
</html>