<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>dude-graph - Basic test</title>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../d3/d3.min.js"></script>
    <script src="../../eventEmitter/EventEmitter.min.js"></script>
    <script src="../../dude-graph/dude-graph.js"></script>
</head>
<body>
<script>
    suite("basic", function () {
        test("create graph and an empty block", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            graph.addBlock(block);
            expect(graph.graphBlocks[0]).to.be.equal(block);
            expect(graph.blockById(block.blockId)).to.be.equal(block);
        });
        test("block with one input and one output", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            graph.addBlock(block);
            var outputPoint = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var inputPoint = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "String"
            });
            var i = 0;
            graph.on("block-point-add", function (contextBlock, point) {
                expect(contextBlock).to.be.equal(block);
                expect(point === outputPoint || point === inputPoint).to.be.equal(true);
                i++;
            });
            block.addPoint(outputPoint);
            block.addPoint(inputPoint);
            block.validate();
            expect(i).to.be.equal(2);
            expect(block.outputByName("out")).to.be.equal(outputPoint);
            expect(block.blockOutputPoints[0]).to.be.equal(outputPoint);
            expect(block.inputByName("in")).to.be.equal(inputPoint);
            expect(block.blockInputPoints[0]).to.be.equal(inputPoint);
            expect(block.outputByName("out").pointValueType).to.be.equal("Number");
            expect(block.inputByName("in").pointValueType).to.be.equal("String");
        });
        test("add points at positions", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            graph.addBlock(block);
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out1",
                "pointValueType": "Number"
            });
            var outputPoint2 = new dudeGraph.Point(true, {
                "pointName": "out2",
                "pointValueType": "Number"
            });
            var outputPoint3 = new dudeGraph.Point(true, {
                "pointName": "out3",
                "pointValueType": "Number"
            });
            var outputPoint4 = new dudeGraph.Point(true, {
                "pointName": "out4",
                "pointValueType": "Number"
            });
            var outputPoint5 = new dudeGraph.Point(true, {
                "pointName": "out5",
                "pointValueType": "Number"
            });
            block.addPoint(outputPoint4);
            block.addPoint(outputPoint3, 0);
            block.addPoint(outputPoint1, 0);
            block.addPoint(outputPoint5);
            block.addPoint(outputPoint2, 1);
            block.validate();
            expect(block.blockOutputPoints[0]).to.be.equal(outputPoint1);
            expect(block.blockOutputPoints[1]).to.be.equal(outputPoint2);
            expect(block.blockOutputPoints[2]).to.be.equal(outputPoint3);
            expect(block.blockOutputPoints[3]).to.be.equal(outputPoint4);
            expect(block.blockOutputPoints[4]).to.be.equal(outputPoint5);
        });
        test("block points connect and disconnect", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            graph.addBlock(block1);
            block1.addPoint(outputPoint1);
            block1.validate();
            var block2 = new dudeGraph.Block();
            var inputPoint2_1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            var inputPoint2_2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointValueType": "Object"
            });
            graph.addBlock(block2);
            block2.addPoint(inputPoint2_1);
            block2.addPoint(inputPoint2_2);
            block2.validate();
            // Test connect/disconnect
            outputPoint1.connect(inputPoint2_1);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
            expect(inputPoint2_1.pointConnections).to.have.length(1);
            expect(outputPoint1.pointConnections[0]).to.be.equal(graph.graphConnections[0]);
            expect(inputPoint2_1.pointConnections[0]).to.be.equal(graph.graphConnections[0]);
            expect(outputPoint1.pointConnections[0]).to.be.equal(inputPoint2_1.pointConnections[0]);
            expect(function () {
                outputPoint1.connect(inputPoint2_1);
            }).to.throw();
            outputPoint1.disconnect(inputPoint2_1);
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            expect(inputPoint2_1.pointConnections).to.have.length(0);
            // Test associativity point1.(dis)connect(point2) === point2.(dis)connect(point1)
            inputPoint2_1.connect(outputPoint1);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
            expect(inputPoint2_1.pointConnections).to.have.length(1);
            expect(outputPoint1.pointConnections[0]).to.be.equal(graph.graphConnections[0]);
            expect(inputPoint2_1.pointConnections[0]).to.be.equal(graph.graphConnections[0]);
            expect(outputPoint1.pointConnections[0]).to.be.equal(inputPoint2_1.pointConnections[0]);
            expect(function () {
                inputPoint2_1.connect(outputPoint1);
            }).to.throw();
            inputPoint2_1.disconnect(outputPoint1);
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            expect(inputPoint2_1.pointConnections).to.have.length(0);
        });
        test("block points connect and singleConnection and disconnectAll", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number",
                "pointSingleConnection": false
            });
            expect(outputPoint1.pointSingleConnection).to.be.false;
            var outputPoint2 = new dudeGraph.Point(true, {
                "pointName": "out2",
                "pointValueType": "Number",
                "pointSingleConnection": true
            });
            expect(outputPoint2.pointSingleConnection).to.be.true;
            graph.addBlock(block1);
            block1.addPoint(outputPoint1);
            block1.validate();
            var block2 = new dudeGraph.Block();
            var inputPoint1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            expect(inputPoint1.pointSingleConnection).to.be.true;
            var inputPoint2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointValueType": "Number"
            });
            expect(inputPoint2.pointSingleConnection).to.be.true;
            graph.addBlock(block2);
            block2.addPoint(inputPoint1);
            block2.addPoint(inputPoint2);
            block2.validate();
            outputPoint1.connect(inputPoint1);
            outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(2);
            expect(outputPoint1.pointConnections).to.have.length(2);
            expect(function () {
                inputPoint2.connect(outputPoint2);
            }).to.throw();
            outputPoint1.disconnectAll();
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            outputPoint1.connect(inputPoint1);
            outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(2);
            expect(outputPoint1.pointConnections).to.have.length(2);
            outputPoint1.disconnect(inputPoint2);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
        });
        test("block points values", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            graph.addBlock(block);
            var inputPoint = new dudeGraph.Point(false, {
                "pointName": "test",
                "pointValueType": "Number",
                "pointValue": 32
            });
            block.addPoint(inputPoint);
            expect(inputPoint.pointValueType).to.be.equal("Number");
            expect(inputPoint.pointValue).to.be.equal(32);
            expect(function () {
                inputPoint.pointValue = "NaN";
            }).to.throw();
            expect(function () {
                inputPoint.pointValue = NaN;
                inputPoint.pointValue = Infinity;
                inputPoint.pointValue = -Infinity;
                inputPoint.pointValue = 32;
            }).to.not.throw();
            expect(function () {
                var badPoint = new dudeGraph.Point(false, {
                    "pointName": "test1",
                    "pointValueType": "String",
                    "pointValue": 32
                });
                block.addPoint(badPoint);
            }).to.throw();
            expect(function () {
                var badPoint = new dudeGraph.Point(false, {
                    "pointName": "test2",
                    "pointValueType": "UnknownType",
                    "pointValue": NaN
                });
                block.addPoint(badPoint);
            }).to.throw();
        });
        test("mix point values and point connections", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            graph.addBlock(block1);
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number",
                "pointSingleConnection": false
            });
            block1.addPoint(outputPoint1);
            var block2 = new dudeGraph.Block();
            graph.addBlock(block2);
            var inputPoint2_1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            var inputPoint2_2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointValueType": "Number",
                "pointValue": 32,
                "pointSingleConnection": false
            });
            var inputPoint2_3 = new dudeGraph.Point(false, {
                "pointName": "in3",
                "pointValueType": "Number",
                "pointValue": 32
            });
            block2.addPoint(inputPoint2_1);
            block2.addPoint(inputPoint2_2);
            block2.addPoint(inputPoint2_3);
            outputPoint1.connect(inputPoint2_1);
            expect(function () {
                outputPoint1.connect(inputPoint2_2); // cannot pointValue and pointConnections
            }).to.throw();
            expect(function () {
                outputPoint1.connect(inputPoint2_3); // cannot pointValue and pointConnections, even if !pointSingleConnection
            }).to.throw();
        });
        /*
        test("custom block and custom point", function () {

        });
        test("add/remove of points", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            var outputPoint = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var inputPoint = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            graph.addBlock(block);
            block.addPoint(outputPoint);
            block.addPoint(inputPoint);
            block.validate();
            expect(block.blockInputPoints).to.have.length(1);
            expect(block.blockInputPoints).to.have.length(1);
            expect(block.blockInputPoints[0]).to.be.equal(outputPoint);
            expect(block.blockInputPoints[0]).to.be.equal(inputPoint);
            expect(block.outputByName("out")).to.be.equal(outputPoint);
            expect(block.inputByName("in")).to.be.equal(inputPoint);
            block.removePoint(inputPoint);
            expect(block.blockInputPoints).to.have.length(0);
            expect(block.inputByName("in")).to.be.null;
            block.addPoint(inputPoint);
            expect(block.blockInputPoints).to.have.length(1);
            expect(block.blockInputPoints[0]).to.be.equal(inputPoint);
        });
        test("ill-formed templated point", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block({
                "blockTemplates": {
                    "ValueType": ["String", "Boolean"]
                }
            });
            graph.addBlock(block);
            expect(function () {
                var point = new dudeGraph.Point(false, {
                    "pointName": "in",
                    "pointValueType": "Number",
                    "pointTemplate": "ValueType"
                });
                block.addPoint(point);
                block.validate();
            }).to.throw();
        });
        test("templated types", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            graph.addBlock(block1);
            var outputPoint1_1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "String"
            });
            block1.addPoint(outputPoint1_1);
            var outputPoint1_2 = new dudeGraph.Point(true, {
                "pointName": "out2",
                "pointValueType": "String"
            });
            block1.addPoint(outputPoint1_2);
            block1.validate();
            var block2 = new dudeGraph.Block({
                "blockTemplates": {
                    "ValueType": [
                        "Number",
                        "String"
                    ]
                }
            });
            graph.addBlock(block2);
            var inputPoint2_1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number",
                "pointTemplate": "ValueType"
            });
            block2.addPoint(inputPoint2_1);
            var inputPoint2_2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointValueType": "Number",
                "pointTemplate": "ValueType"
            });
            block2.addPoint(inputPoint2_2);
            block2.validate();
            outputPoint1_1.connect(inputPoint2_1);
            outputPoint1_2.connect(inputPoint2_2);
        });
        test("template mismatch", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            graph.addBlock(block1);
            var outputPoint1_1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "String"
            });
            block1.addPoint(outputPoint1_1);
            var outputPoint1_2 = new dudeGraph.Point(true, {
                "pointName": "out2",
                "pointValueType": "Number"
            });
            block1.addPoint(outputPoint1_2);
            block1.validate();
            var block2 = new dudeGraph.Block({
                "blockTemplates": {
                    "ValueType": [
                        "Number",
                        "String"
                    ]
                }
            });
            graph.addBlock(block2);
            var inputPoint2_1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number",
                "pointTemplate": "ValueType"
            });
            block2.addPoint(inputPoint2_1);
            var inputPoint2_2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointValueType": "Number",
                "pointTemplate": "ValueType"
            });
            block2.addPoint(inputPoint2_2);
            block2.validate();
            outputPoint1_1.connect(inputPoint2_1);
            expect(function () {
                outputPoint1_2.connect(inputPoint2_2);
            }).to.throw();
         });
         */
    });
</script>
</body>
</html>