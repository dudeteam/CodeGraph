<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>dude-graph - Basic test</title>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../d3/d3.min.js"></script>
    <script src="../../eventEmitter/EventEmitter.min.js"></script>
    <script src="../../dude-graph/dude-graph.js"></script>
</head>
<body>
<script>
    suite("basic", function () {
        /**
         *  Connection typing system (always output to input)
         *
         * `Number` ===> `Number` - Direct connection
         * `Number` =~=> `String` - Compatible connection
         * `String` =/=> `Number` - Impossible connection
         * `Template:String` =#=> `Number` - Template connection
         * `Template:String` =/=> `Array` - Impossible template connection
         */
        /**
         *  Value typing system
         *  `Number` ===> `Number` - Direct assignation
         *  `Number` =~=> `Number` - Conversion and assignation
         *  `Number` =/=> `Number` - Impossible assignation
         */
        test("create graph", function () {
            var graph = new dudeGraph.Graph();
            expect(graph.graphBlocks).to.have.length(0);
            expect(graph.graphConnections).to.have.length(0);
            expect(graph.graphValueTypeByName("Number")).to.be.not.null;
            expect(graph.graphValueTypeByName("String")).to.be.not.null;
            expect(graph.graphValueTypeByName("Boolean")).to.be.not.null;
            expect(graph.graphValueTypeByName("Object")).to.be.not.null;
            expect(graph.graphValueTypeByName("Array")).to.be.not.null;
        });
        test("create block", function () {
            var block = new dudeGraph.Block({
                "blockId": "testId",
                "blockName": "Test",
                "blockTemplates": {
                    "ValueType": ["Number", "String"]
                }
            });
            expect(block.blockId).to.be.equal("testId");
            expect(block.blockType).to.be.equal("Block");
            expect(block.blockName).to.be.equal("Test");
            expect(block.blockTemplates).to.be.eql({
                "ValueType": ["Number", "String"]
            });
            // Different ways of creating a block
            new dudeGraph.Block();
            new dudeGraph.Block({
                "blockId": "testId"
            });
            new dudeGraph.Block({
                "blockName": "testId"
            });
            new dudeGraph.Block({
                "blockTemplates": {
                    "ValueType": ["Number", "String"]
                }
            });
        });
        test("graph query", function () {
            var graph = new dudeGraph.Graph();
            expect(graph.blocksByName("AssignationBlock")).to.have.length(0);
            expect(graph.blocksByType(dudeGraph.AssignationBlock)).to.have.length(0);
            var block = new dudeGraph.AssignationBlock();
            graph.addBlock(block);
            expect(graph.blocksByName("AssignationBlock")).to.have.length(1);
            expect(graph.blocksByType(dudeGraph.AssignationBlock)).to.have.length(1);
        });
        test("create block unique ids", function () {
            var graph = new dudeGraph.Graph();
            var ids = {};
            for (var i = 0; i < 5000; i++) {
                var id = graph.nextBlockId();
                if (typeof ids[id] !== "undefined") {
                    throw new Error();
                }
                ids[id] = true;
            }
        });
        test("create graph block", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            expect(block.blockId).to.be.null;
            graph.addBlock(block);
            expect(block.blockId).to.be.not.null;
            expect(graph.graphBlocks[0]).to.be.equal(block);
            // Cannot add the same block again
            expect(function () {
                graph.addBlock(block);
            }).to.throw();
        });
        test("create point", function () {
            var outputPoint = new dudeGraph.Point(true, {
                "pointName": "output",
                "pointValueType": "Whatever" // pointValueType is enforced only when adding to a block
            });
            expect(outputPoint.pointBlock).to.be.null;
            expect(outputPoint.pointOutput).to.be.true;
            expect(outputPoint.pointType).to.be.equal("Point");
            expect(outputPoint.pointName).to.be.equal("output");
            expect(outputPoint.pointValueType).to.be.equal("Whatever");
            var inputPoint = new dudeGraph.Point(false, {
                "pointName": "input",
                "pointValueType": "WhateverAgain", // pointValueType is enforced only when adding to a block
                "pointValue": {"whatever": true} // pointValue is enforced to valueType only when adding to a block
            });
            expect(inputPoint.pointBlock).to.be.null;
            expect(inputPoint.pointOutput).to.be.false;
            expect(inputPoint.pointType).to.be.equal("Point");
            expect(inputPoint.pointName).to.be.equal("input");
            expect(inputPoint.pointValueType).to.be.equal("WhateverAgain");
            expect(inputPoint.pointValue).to.be.eql({"whatever": true});
            // Ill-formed points
            expect(function () {
                //noinspection JSCheckFunctionSignatures
                new dudeGraph.Point(); // pointOutput is required
            }).to.throw();
            expect(function () {
                //noinspection JSCheckFunctionSignatures
                new dudeGraph.Point(true, {
                    "pointName": "output"
                    // pointValueType is required
                });
            }).to.throw();
            expect(function () {
                //noinspection JSCheckFunctionSignatures
                new dudeGraph.Point(true, {
                    // pointName is required
                    "pointValueType": "Whatever"
                });
            }).to.throw();
            expect(function () {
                //noinspection JSCheckFunctionSignatures
                new dudeGraph.Point(true, {
                    "pointName": false, // pointName must be a String
                    "pointValueType": "Whatever"
                });
            }).to.throw();
            expect(function () {
                //noinspection JSCheckFunctionSignatures
                new dudeGraph.Point(true, {
                    "pointName": "output",
                    "pointValueType": new dudeGraph.Graph() // pointValueType must be a String
                });
            }).to.throw();
        });
        test("create block point", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            var outputPoint = new dudeGraph.Point(true, {
                "pointName": "output",
                "pointValueType": "String"
            });
            expect(function () {
                block.addPoint(outputPoint); // The block must be added to the graph to accept points
            }).to.throw();
            graph.addBlock(block);
            block.addPoint(outputPoint);
            expect(block.blockOutputs).to.have.length(1);
            expect(block.blockInputs).to.have.length(0);
            expect(function () {
                block.addPoint(new dudeGraph.Point(true, {
                    "pointName": "output", // Cannot add 2 outputs with the same name
                    "pointValueType": "String"
                }));
            }).to.throw();
            block.addPoint(new dudeGraph.Point(false, {
                "pointName": "output", // But can add an input with the same name as an output
                "pointValueType": "String"
            }));
            expect(block.blockOutputs).to.have.length(1);
            expect(block.blockInputs).to.have.length(1);
            expect(function () {
                block.addPoint(new dudeGraph.Point(false, {
                    "pointName": "output", // But still cannot add 2 inputs with the same name
                    "pointValueType": "String"
                }));
            }).to.throw();
            expect(function () {
                block.addPoint(new dudeGraph.Point(false, {
                    "pointName": "unknown_type", // But still cannot add 2 inputs with the same name
                    "pointValueType": "UnknownType"
                }));
            }).to.throw();
        });
        test("create block point at positions", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            graph.addBlock(block);
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out1",
                "pointValueType": "Number"
            });
            var outputPoint2 = new dudeGraph.Point(true, {
                "pointName": "out2",
                "pointValueType": "Number"
            });
            var outputPoint3 = new dudeGraph.Point(true, {
                "pointName": "out3",
                "pointValueType": "Number"
            });
            var outputPoint4 = new dudeGraph.Point(true, {
                "pointName": "out4",
                "pointValueType": "Number"
            });
            var outputPoint5 = new dudeGraph.Point(true, {
                "pointName": "out5",
                "pointValueType": "Number"
            });
            block.addPoint(outputPoint4); // Add to end [4]
            block.addPoint(outputPoint2, 0); // Add to start [2, 4]
            block.addPoint(outputPoint1, 0); // Add to start [1, 2, 4]
            block.addPoint(outputPoint5); // Add to end [1, 2, 4, 5]
            block.addPoint(outputPoint3, 2); // Add to 2nd position [1, 2, 3, 4, 5]
            expect(block.blockOutputs[0]).to.be.equal(outputPoint1);
            expect(block.blockOutputs[1]).to.be.equal(outputPoint2);
            expect(block.blockOutputs[2]).to.be.equal(outputPoint3);
            expect(block.blockOutputs[3]).to.be.equal(outputPoint4);
            expect(block.blockOutputs[4]).to.be.equal(outputPoint5);
        });
        test("point value", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            var inputPoint = new dudeGraph.Point(true, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            graph.addBlock(block);
            block.addPoint(inputPoint);
            // Test value of type `Number`
            inputPoint.pointValue = 42;
            expect(inputPoint.pointValue).to.be.equal(42);
            inputPoint.pointValue = NaN;
            expect(inputPoint.pointValue).to.be.NaN;
            inputPoint.pointValue = null;
            expect(inputPoint.pointValue).to.be.null;
            inputPoint.pointValue = Infinity;
            expect(inputPoint.pointValue).to.be.equal(Infinity);
            inputPoint.pointValue = -Infinity;
            expect(inputPoint.pointValue).to.be.equal(-Infinity);
            // Test compatible pointValue "32.444" with `Number`
            inputPoint.pointValue = "32.444";
            expect(inputPoint.pointValue).to.be.equal(32.444);
            inputPoint.pointValue = true;
            expect(inputPoint.pointValue).to.be.equal(1);
            expect(function () {
                inputPoint.pointValue = "1234.435.12"; // "1234.435.12" =/=> `Number`
            }).to.throw();
            expect(function () {
                inputPoint.pointValue = [3, true, {}];
            }).to.throw();
            var inputPoint2 = new dudeGraph.Point(true, {
                "pointName": "in2",
                "pointValueType": "String",
                "pointValue": 42 // 42 =~=> `String`
            });
            block.addPoint(inputPoint2);
            expect(inputPoint2.pointValue).to.be.equal("42");
            inputPoint2.pointValue = 32;
            expect(inputPoint2.pointValue).to.be.equal("32");
            inputPoint2.pointValue = true;
            expect(inputPoint2.pointValue).to.be.equal("true");
            expect(function () {
                block.addPoint(new dudeGraph.Point(false, {
                    "pointName": "in2",
                    "pointValueType": "Number",
                    "pointValue": "NaN" // "NaN" =/=> `Number`
                }));
            }).to.throw();
        });
        test("point value type", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            var inputPoint = new dudeGraph.Point(true, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            graph.addBlock(block);
            block.addPoint(inputPoint);
            inputPoint.pointValue = 32;
            inputPoint.pointValueType = "String";
            expect(inputPoint.pointValueType).to.be.equal("String");
            expect(inputPoint.pointValue).to.be.equal("32");
            expect(function () {
                inputPoint.pointValueType = "Array";
            }).to.throw();
            inputPoint.pointValue = null;
            inputPoint.pointValueType = "Array";
            expect(inputPoint.pointValueType).to.be.equal("Array");
            inputPoint.pointValue = [32, [], {}];
            expect(inputPoint.pointValue).to.be.eql([32, [], {}]);
            expect(function () {
                block.addPoint(new dudeGraph.Point(true, {
                    "pointName": "in2",
                    "pointValueType": "UnknownValueType" // Unknown type
                }));
            }).to.throw();
            graph.addGraphValueType({
                "typeName": "NewType",
                "typeConvert": function (value) {
                    if (value === "NewValue") {
                        return "ThisIsACorrectNewValue";
                    }
                    return undefined;
                }
            });
            expect(function () {
                graph.addGraphValueType({
                    "typeName": "NewType", // Cannot add twice the same type name
                    "typeConvert": _.noop
                });
            }).to.throw();
            inputPoint.pointValue = null;
            inputPoint.pointValueType = "NewType";
            inputPoint.pointValue = "NewValue";
            expect(inputPoint.pointValueType).to.be.equal("NewType");
            expect(inputPoint.pointValue).to.be.equal("ThisIsACorrectNewValue");
            expect(function () {
                inputPoint.pointValue = "NewNewValue"; // Only "NewValue" is accepted for `NewType`
            }).to.throw();
            // Reconvert to `String` as "ThisIsACorrectNewValue" is convertible to `String`
            inputPoint.pointValueType = "String";
            expect(inputPoint.pointValue).to.be.equal("ThisIsACorrectNewValue");
            inputPoint.pointValue = "NewValue";
            expect(inputPoint.pointValue).to.be.equal("NewValue");
            // Reconvert to `NewType` as "NewValue" is acceptable as `NewType`
            inputPoint.pointValueType = "NewType";
            expect(inputPoint.pointValueType).to.be.equal("NewType");
            expect(inputPoint.pointValue).to.be.equal("ThisIsACorrectNewValue");
        });
        test("connect points of same type", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var block2 = new dudeGraph.Block();
            graph.addBlock(block1);
            graph.addBlock(block2);
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var inputPoint2 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            expect(function () {
                outputPoint1.connect(inputPoint2); // The points are not bound to blocks
            }).to.throw();
            block1.addPoint(outputPoint1);
            expect(function () {
                outputPoint1.connect(inputPoint2); // inputPoint2 is not bound to a block
            }).to.throw();
            block2.addPoint(inputPoint2);
            var connection = outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
            expect(inputPoint2.pointConnections).to.have.length(1);
            expect(graph.graphConnections[0]).to.be.equal(connection);
            expect(outputPoint1.pointConnections[0]).to.be.equal(connection);
            expect(inputPoint2.pointConnections[0]).to.be.equal(connection);
            expect(connection.connectionOutputPoint).to.be.equal(outputPoint1);
            expect(connection.connectionInputPoint).to.be.equal(inputPoint2);
        });
        test("disconnect points of same type", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var block2 = new dudeGraph.Block();
            graph.addBlock(block1);
            graph.addBlock(block2);
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var inputPoint2 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            expect(function () {
                outputPoint1.disconnect(inputPoint2); // The points are not bound to blocks
            }).to.throw();
            block1.addPoint(outputPoint1);
            expect(function () {
                outputPoint1.disconnect(inputPoint2); // inputPoint2 is not bound to a block
            }).to.throw();
            block2.addPoint(inputPoint2);
            expect(function () {
                outputPoint1.disconnect(inputPoint2); // Cannot disconnect non connected points
            }).to.throw();
            expect(function () {
                inputPoint2.disconnect(outputPoint1); // Cannot disconnect non connected points
            }).to.throw();
            outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(1);
            outputPoint1.disconnect(inputPoint2);
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            expect(inputPoint2.pointConnections).to.have.length(0);
        });
        test("connect/disconnect commutativity", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var block2 = new dudeGraph.Block();
            graph.addBlock(block1);
            graph.addBlock(block2);
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var inputPoint2 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            block1.addPoint(outputPoint1);
            block2.addPoint(inputPoint2);
            outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
            expect(inputPoint2.pointConnections).to.have.length(1);
            outputPoint1.disconnect(inputPoint2);
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            expect(inputPoint2.pointConnections).to.have.length(0);
            inputPoint2.connect(outputPoint1);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
            expect(inputPoint2.pointConnections).to.have.length(1);
            inputPoint2.disconnect(outputPoint1);
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            expect(inputPoint2.pointConnections).to.have.length(0);
            outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
            expect(inputPoint2.pointConnections).to.have.length(1);
            inputPoint2.disconnect(outputPoint1);
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            expect(inputPoint2.pointConnections).to.have.length(0);
            inputPoint2.connect(outputPoint1);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
            expect(inputPoint2.pointConnections).to.have.length(1);
            outputPoint1.disconnect(inputPoint2);
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            expect(inputPoint2.pointConnections).to.have.length(0);
        });
        test("connect compatible types", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var block2 = new dudeGraph.Block();
            graph.addBlock(block1);
            graph.addBlock(block2);
            var outputPoint1_Number = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var outputPoint1_Boolean = new dudeGraph.Point(true, {
                "pointName": "out3",
                "pointValueType": "Boolean"
            });
            var outputPoint1_String = new dudeGraph.Point(true, {
                "pointName": "out4",
                "pointValueType": "String"
            });
            var inputPoint2_Number = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            var inputPoint2_Boolean = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointValueType": "Boolean"
            });
            var inputPoint2_String = new dudeGraph.Point(false, {
                "pointName": "in3",
                "pointValueType": "String"
            });
            block1.addPoint(outputPoint1_Number);
            block1.addPoint(outputPoint1_Boolean);
            block1.addPoint(outputPoint1_String);
            block2.addPoint(inputPoint2_Number);
            block2.addPoint(inputPoint2_Boolean);
            block2.addPoint(inputPoint2_String);
            // Direct connection
            outputPoint1_Number.connect(inputPoint2_Number); // `Number` ===> `Number`
            outputPoint1_Number.disconnect(inputPoint2_Number);
            outputPoint1_Boolean.connect(inputPoint2_Boolean); // `Boolean` ===> `Boolean`
            outputPoint1_Boolean.disconnect(inputPoint2_Boolean);
            outputPoint1_String.connect(inputPoint2_String); // `String` ===> `String`
            outputPoint1_String.disconnect(inputPoint2_String);
            // Convert connection
            outputPoint1_Number.connect(inputPoint2_String); // `Number` =~=> `String`
            outputPoint1_Number.disconnect(inputPoint2_String);
            outputPoint1_Boolean.connect(inputPoint2_Number); // `Boolean` =~=> `Number`
            outputPoint1_Boolean.disconnect(inputPoint2_Number);
            outputPoint1_Number.connect(inputPoint2_Boolean); // `Number` =~=> `Boolean`
            outputPoint1_Number.disconnect(inputPoint2_Boolean);
            // Impossible connection
            expect(function () {
                outputPoint1_String.connect(inputPoint2_Number); // `String` =/=> `Number`
            }).to.throw();
            expect(function () {
                outputPoint1_String.connect(inputPoint2_Boolean); // `String` =/=> `Boolean`
            }).to.throw();
        });
        test("cannot mix connect and point value", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var block2 = new dudeGraph.Block();
            graph.addBlock(block1);
            graph.addBlock(block2);
            var outputPoint = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var inputPoint = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            block1.addPoint(outputPoint);
            block2.addPoint(inputPoint);
            inputPoint.pointValue = 32;
            expect(function () {
                outputPoint.connect(inputPoint); // Cannot connect a point with a non-null pointValue
            }).to.throw();
            expect(function () {
                inputPoint.connect(outputPoint); // Cannot connect a point with a non-null pointValue (commutativity)
            }).to.throw();
            inputPoint.pointValue = null;
            outputPoint.connect(inputPoint);
            expect(function () {
                inputPoint.pointValue = 32; // Cannot assign pointValue when a point is connected
            }).to.throw();
            outputPoint.disconnect(inputPoint);
            inputPoint.connect(outputPoint);
            expect(function () {
                outputPoint.pointValue = 32; // Cannot assign pointValue when a point is connected (commutativity)
            }).to.throw();
            inputPoint.disconnect(outputPoint);
        });
        test("connect and value type", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var block2 = new dudeGraph.Block();
            graph.addBlock(block1);
            graph.addBlock(block2);
            var outputPoint1_1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number",
                "pointSingleConnection": false
            });
            var inputPoint2_1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            var inputPoint2_2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointValueType": "Boolean"
            });
            block1.addPoint(outputPoint1_1);
            block2.addPoint(inputPoint2_1);
            block2.addPoint(inputPoint2_2);
            outputPoint1_1.connect(inputPoint2_1); // `Number` => `Boolean`
        });
        test("connect multiple points and disconnectAll", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number",
                "pointSingleConnection": false
            });
            expect(outputPoint1.pointSingleConnection).to.be.false;
            var outputPoint2 = new dudeGraph.Point(true, {
                "pointName": "out2",
                "pointValueType": "Number",
                "pointSingleConnection": true
            });
            expect(outputPoint2.pointSingleConnection).to.be.true;
            graph.addBlock(block1);
            block1.addPoint(outputPoint1);
            var block2 = new dudeGraph.Block();
            var inputPoint1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            expect(inputPoint1.pointSingleConnection).to.be.true;
            var inputPoint2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointValueType": "Number"
            });
            expect(inputPoint2.pointSingleConnection).to.be.true;
            graph.addBlock(block2);
            block2.addPoint(inputPoint1);
            block2.addPoint(inputPoint2);
            outputPoint1.connect(inputPoint1);
            outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(2);
            expect(outputPoint1.pointConnections).to.have.length(2);
            expect(function () {
                inputPoint2.connect(outputPoint2);
            }).to.throw();
            outputPoint1.disconnectAll();
            expect(graph.graphConnections).to.have.length(0);
            expect(outputPoint1.pointConnections).to.have.length(0);
            outputPoint1.connect(inputPoint1);
            outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(2);
            expect(outputPoint1.pointConnections).to.have.length(2);
            outputPoint1.disconnect(inputPoint2);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
        });
        test("remove block points", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block();
            var block2 = new dudeGraph.Block();
            graph.addBlock(block1);
            graph.addBlock(block2);
            var outputPoint1 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var inputPoint2 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            });
            block1.addPoint(outputPoint1);
            block2.addPoint(inputPoint2);
            expect(function () {
                block1.removePoint(inputPoint2); // inputPoint2 is not in block1
            }).to.throw();
            expect(function () {
                block2.removePoint(outputPoint1); // outputPoint1 is not in block2
            }).to.throw();
            block1.removePoint(outputPoint1);
            block2.removePoint(inputPoint2);
            block1.addPoint(outputPoint1);
            block2.addPoint(inputPoint2);
            var connection = outputPoint1.connect(inputPoint2);
            expect(graph.graphConnections).to.have.length(1);
            expect(outputPoint1.pointConnections).to.have.length(1);
            expect(inputPoint2.pointConnections).to.have.length(1);
            expect(graph.graphConnections[0]).to.be.equal(connection);
            expect(outputPoint1.pointConnections[0]).to.be.equal(connection);
            expect(inputPoint2.pointConnections[0]).to.be.equal(connection);
            expect(connection.connectionOutputPoint).to.be.equal(outputPoint1);
            expect(connection.connectionInputPoint).to.be.equal(inputPoint2);
            block1.removePoint(outputPoint1);
            expect(graph.graphConnections).to.have.length(0);
            expect(inputPoint2.pointConnections).to.have.length(0);
        });
        test("remove all block points", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block();
            graph.addBlock(block);
            block.addPoint(new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            }));
            block.addPoint(new dudeGraph.Point(true, {
                "pointName": "out2",
                "pointValueType": "Number"
            }));
            block.addPoint(new dudeGraph.Point(true, {
                "pointName": "out3",
                "pointValueType": "Number"
            }));
            block.addPoint(new dudeGraph.Point(true, {
                "pointName": "out4",
                "pointValueType": "Number"
            }));
            block.addPoint(new dudeGraph.Point(true, {
                "pointName": "out5",
                "pointValueType": "Number"
            }));
            block.addPoint(new dudeGraph.Point(false, {
                "pointName": "in",
                "pointValueType": "Number"
            }));
            block.addPoint(new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointValueType": "Number"
            }));
            block.addPoint(new dudeGraph.Point(false, {
                "pointName": "in3",
                "pointValueType": "Number"
            }));
            expect(block.blockOutputs).to.have.length(5);
            expect(block.blockInputs).to.have.length(3);
            block.removeAllPoints();
            expect(block.blockOutputs).to.have.length(0);
            expect(block.blockInputs).to.have.length(0);
        });
        test("block templates", function () {
            var graph = new dudeGraph.Graph();
            expect(function () {
                var badBlock = new dudeGraph.Block({
                    "blockTemplates": {
                        "TemplateName": {} // `valueType` is required, `templates` is required
                    }
                });
                graph.addBlock(badBlock);
            }).to.throw();
            expect(function () {
                var badBlock = new dudeGraph.Block({
                    "blockTemplates": {
                        "TemplateName": {
                            "valueType": "Number"
                            // `templates` is required
                        }
                    }
                });
                graph.addBlock(badBlock);
            }).to.throw();
            expect(function () {
                var badBlock = new dudeGraph.Block({
                    "blockTemplates": {
                        "TemplateName": {
                            // `valueType` is required
                            "templates": ["Number"]
                        }
                    }
                });
                graph.addBlock(badBlock);
            }).to.throw();
            expect(function () {
                var badBlock = new dudeGraph.Block({
                    "blockTemplates": {
                        "TemplateName": {
                            "valueType": "String",
                            "templates": ["Number", "Boolean"] // `valueType` must be included in `templates`
                        }
                    }
                });
                graph.addBlock(badBlock);
            }).to.throw();
            expect(function () {
                var badBlock = new dudeGraph.Block({
                    "blockTemplates": {
                        "TemplateName": {
                            "valueType": "UnknownType", // `valueType` must be a graph known type
                            "templates": ["UnknownType"]
                        }
                    }
                });
                graph.addBlock(badBlock);
            }).to.throw();
            var block = new dudeGraph.Block({
                "blockTemplates": {
                    "TemplateTest": {
                        "valueType": "Number",
                        "templates": ["Number", "String"]
                    }
                }
            });
            expect(function () {
                block.template("TemplateTest"); // Cannot manipulate templates while not bound to a graph
            }).to.throw();
            expect(function () {
                block.updateTemplate("TemplateTest", "String"); // Cannot manipulate templates while not bound to a graph
            }).to.throw();
            graph.addBlock(block);
            block.updateTemplate("TemplateTest", "String");
            expect(block.template("TemplateTest").valueType).to.equals("String");
            expect(block.template("TemplateTest").templates).to.eql(["Number", "String"]);
            block.updateTemplate("TemplateTest", "Number");
            expect(block.template("TemplateTest").valueType).to.equals("Number");
            expect(block.template("TemplateTest").templates).to.eql(["Number", "String"]);
            block.updateTemplate("TemplateTest", "String");
            expect(block.template("TemplateTest").valueType).to.equals("String");
            expect(block.template("TemplateTest").templates).to.eql(["Number", "String"]);
            expect(function () {
                block.updateTemplate("TemplateTest", "Boolean"); // `TemplateTest` has no template `Boolean`
            }).to.throw();
        });
        test("point templates", function () {
            var graph = new dudeGraph.Graph();
            var block = new dudeGraph.Block({
                "blockTemplates": {
                    "TemplateTest": {
                        "valueType": "Number",
                        "templates": ["Number", "String"]
                    }
                }
            });
            graph.addBlock(block);
            var inputPoint1_1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointTemplate": "TemplateTest",
                "pointValueType": null
            });
            var inputPoint1_2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointTemplate": "TemplateTest",
                "pointValueType": null
            });
            block.addPoint(inputPoint1_1);
            block.addPoint(inputPoint1_2);
            expect(inputPoint1_1.pointValueType).to.be.equals("Number");
            expect(inputPoint1_2.pointValueType).to.be.equals("Number");
            block.updateTemplate("TemplateTest", "String");
            expect(inputPoint1_1.pointValueType).to.be.equals("String");
            expect(inputPoint1_2.pointValueType).to.be.equals("String");
            inputPoint1_1.pointValue = "I'm a String, and NotANumber";
            inputPoint1_2.pointValue = "Me neither";
            expect(function () {
                block.updateTemplate("TemplateTest", "Number"); // All points cannot safely be transformed to `Number`
            }).to.throw();
            inputPoint1_1.pointValue = "64";
            inputPoint1_2.pointValue = "32";
            block.updateTemplate("TemplateTest", "Number"); // Now they can be transformed to `Number`
            expect(inputPoint1_1.pointValue);
        });
        test("point templates and connections", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block({
                "blockTemplates": {
                    "TemplateTest": {
                        "valueType": "Number",
                        "templates": ["Number", "String", "Boolean"]
                    }
                }
            });
            graph.addBlock(block1);
            var inputPoint1_1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointTemplate": "TemplateTest"
            });
            var inputPoint1_2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointTemplate": "TemplateTest"
            });
            var inputPoint1_3 = new dudeGraph.Point(false, {
                "pointName": "in3",
                "pointTemplate": "TemplateTest"
            });
            block1.addPoint(inputPoint1_1);
            expect(inputPoint1_1.pointValueType).to.be.equals("Number");
            block1.addPoint(inputPoint1_2);
            expect(inputPoint1_2.pointValueType).to.be.equals("Number");
            block1.addPoint(inputPoint1_3);
            expect(inputPoint1_3.pointValueType).to.be.equals("Number");
            var block2 = new dudeGraph.Block();
            graph.addBlock(block2);
            var outputPointNumber = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            var outputPointString = new dudeGraph.Point(true, {
                "pointName": "out2",
                "pointValueType": "String"
            });
            var outputPointBoolean = new dudeGraph.Point(true, {
                "pointName": "out3",
                "pointValueType": "Boolean"
            });
            var outputPointArray = new dudeGraph.Point(true, {
                "pointName": "out4",
                "pointValueType": "Array"
            });
            block2.addPoint(outputPointNumber);
            block2.addPoint(outputPointString);
            block2.addPoint(outputPointBoolean);
            block2.addPoint(outputPointArray);
            expect(function () {
                outputPointArray.connect(inputPoint1_1); // `Array` =/=> `TemplateTest:Number`
            }).to.throw();
            outputPointNumber.connect(inputPoint1_1); // `Number` ===> `TemplateTest:Number`
            outputPointNumber.disconnect(inputPoint1_1);
            inputPoint1_2.pointValue = 32;
            block1.updateTemplate("TemplateTest", "String"); // inputPoint1_2 `TemplateTest:Number` =~=> `String`
            expect(inputPoint1_1.pointValueType).to.be.equal("String");
            expect(inputPoint1_2.pointValueType).to.be.equal("String");
            expect(inputPoint1_3.pointValueType).to.be.equal("String");
            expect(inputPoint1_2.pointValue).to.be.equal("32");
            inputPoint1_2.pointValue = null;
            outputPointBoolean.connect(inputPoint1_1); // inputPoint1_1 `Boolean` =~=> `TemplateTest:String`
            inputPoint1_2.pointValue = false;
            inputPoint1_3.pointValue = true;
            expect(inputPoint1_1.pointValueType).to.be.equal("String");
            expect(inputPoint1_2.pointValueType).to.be.equal("String");
            expect(inputPoint1_3.pointValueType).to.be.equal("String");
            expect(inputPoint1_2.pointValue).to.be.equal("false");
            expect(inputPoint1_3.pointValue).to.be.equal("true");
        });
        test("point templates and connections and pointCanConvert = false", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block({
                "blockTemplates": {
                    "TemplateTest": {
                        "valueType": "String",
                        "templates": ["Number", "String", "Boolean"]
                    }
                }
            });
            graph.addBlock(block1);
            var inputPoint1_1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointTemplate": "TemplateTest"
            });
            var inputPoint1_2 = new dudeGraph.Point(false, {
                "pointName": "in2",
                "pointTemplate": "TemplateTest"
            });
            var inputPoint1_3 = new dudeGraph.Point(false, {
                "pointName": "in3",
                "pointTemplate": "TemplateTest"
            });
            block1.addPoint(inputPoint1_1);
            expect(inputPoint1_1.pointValueType).to.be.equals("String");
            block1.addPoint(inputPoint1_2);
            expect(inputPoint1_2.pointValueType).to.be.equals("String");
            block1.addPoint(inputPoint1_3);
            expect(inputPoint1_3.pointValueType).to.be.equals("String");
            var block2 = new dudeGraph.Block();
            graph.addBlock(block2);
            var outputPointString = new dudeGraph.Point(true, {
                "pointName": "out1",
                "pointValueType": "Number"
            });
            var outputPointStringNoConvert = new dudeGraph.Point(true, {
                "pointName": "out2",
                "pointValueType": "Number",
                "pointCanConvert": false
            });
            var outputPointString3 = new dudeGraph.Point(true, {
                "pointName": "out3",
                "pointValueType": "Array",
                "pointCanConvert": false
            });
            block2.addPoint(outputPointString);
            expect(outputPointString.pointValueType).to.be.equals("Number");
            block2.addPoint(outputPointStringNoConvert);
            expect(outputPointStringNoConvert.pointValueType).to.be.equals("Number");
            outputPointString.connect(inputPoint1_1);
            expect(outputPointString.pointValueType).to.be.equals("Number");
            expect(inputPoint1_1.pointValueType).to.be.equals("String");
            outputPointStringNoConvert.connect(inputPoint1_2);
            expect(outputPointString.pointValueType).to.be.equals("Number");
            expect(inputPoint1_1.pointValueType).to.be.equals("Number");
            expect(outputPointStringNoConvert.pointValueType).to.be.equals("Number");
            expect(inputPoint1_2.pointValueType).to.be.equals("Number");
            expect(inputPoint1_3.pointValueType).to.be.equals("Number");
            outputPointString.disconnect(inputPoint1_1);
            outputPointStringNoConvert.disconnect(inputPoint1_2);
            expect(function () {
                outputPointString3.connect(inputPoint1_3);
            }).to.throw();
        });
        test("remove block", function () {
            var graph = new dudeGraph.Graph();
            var block1 = new dudeGraph.Block({
                "blockTemplates": {
                    "TemplateTest": {
                        "valueType": "Number",
                        "templates": ["Number", "String"]
                    }
                }
            });
            var block2 = new dudeGraph.Block();
            graph.addBlock(block1);
            graph.addBlock(block2);
            var inputPoint1 = new dudeGraph.Point(false, {
                "pointName": "in",
                "pointTemplate": "TemplateTest",
                "pointValueType": null
            });
            block1.addPoint(inputPoint1);
            var outputPoint2 = new dudeGraph.Point(true, {
                "pointName": "out",
                "pointValueType": "Number"
            });
            block2.addPoint(outputPoint2);
            outputPoint2.connect(inputPoint1);
            expect(graph.graphBlocks).to.have.length(2);
            expect(graph.blockById(block1.blockId)).to.be.equals(block1);
            expect(graph.blockById(block2.blockId)).to.be.equals(block2);
            expect(graph.graphConnections).to.have.length(1);
            expect(block1.blockInputs).to.have.length(1);
            expect(block2.blockOutputs).to.have.length(1);
            expect(outputPoint2.pointConnections).to.have.length(1);
            graph.removeBlock(block1);
            expect(graph.graphBlocks).to.have.length(1);
            expect(graph.blockById(block1.blockId)).to.be.null;
            expect(graph.blockById(block2.blockId)).to.be.equals(block2);
            expect(graph.graphConnections).to.have.length(0);
            expect(block1.blockInputs).to.have.length(0);
            expect(block2.blockOutputs).to.have.length(1);
            expect(outputPoint2.pointConnections).to.have.length(0);
        });
        test("custom block and custom point", function () {
            var graph = new dudeGraph.Graph();
            var assignationBlock = new dudeGraph.AssignationBlock();
            graph.addBlock(assignationBlock);
            assignationBlock.addPoint(new dudeGraph.StreamPoint(false, {"pointName": "in", "pointValueType": "Stream"}));
            assignationBlock.addPoint(new dudeGraph.Point(false, {"pointName": "variable", "pointValueType": "Object"}));
            assignationBlock.addPoint(new dudeGraph.Point(false, {"pointName": "value", "pointValueType": "Object"}));
            expect(function () {
                assignationBlock.validatePoints(); // Missing output "out `StreamPoint`"
            }).to.throw();
            assignationBlock.addPoint(new dudeGraph.StreamPoint(true, {"pointName": "out", "pointValueType": "Stream"}));
            assignationBlock.validatePoints();
            expect(graph.blockById(assignationBlock.blockId) instanceof dudeGraph.AssignationBlock).to.be.true;
            expect(assignationBlock.inputByName("in") instanceof dudeGraph.StreamPoint).to.be.true;
            var pointValueChangedSpy = sinon.spy();
            var blockRemovedSpy = sinon.spy();
            var CustomBlock = function () {
                dudeGraph.Block.apply(this, arguments);
            };
            CustomBlock.prototype = _.create(dudeGraph.Block.prototype, {
                "constructor": CustomBlock,
                "className": "CustomBlock"
            });
            CustomBlock.prototype.pointValueChanged = pointValueChangedSpy;
            CustomBlock.prototype.removed = blockRemovedSpy;
            var customBlock = new CustomBlock();
            graph.addBlock(customBlock);
            var point = new dudeGraph.Point(false, {"pointName": "this", "pointValueType": "Number"});
            customBlock.addPoint(point);
            point.pointValue = 32;
            sinon.assert.calledWith(pointValueChangedSpy, point, 32, null);
            graph.removeBlock(customBlock);
            sinon.assert.called(blockRemovedSpy);
        });
        test("create/remove variable", function () {
            var graph = new dudeGraph.Graph();
            var variable = new dudeGraph.Variable({
                "variableName": "Hello",
                "variableValueType": "String"
            });
            graph.addVariable(variable);
            expect(graph.graphVariables).to.have.length(1);
            expect(graph.variableByName("Hello")).to.be.equal(variable);
            expect(function () {
                graph.addVariable(variable); // Duplicate name
            }).to.throw();
            graph.removeVariable(variable);
            expect(function () {
                graph.removeVariable(variable); // Already removed
            }).to.throw();
            expect(graph.graphVariables).to.have.length(0);
            expect(graph.variableByName("Hello")).to.be.null;
            expect(function () {
                //noinspection JSCheckFunctionSignatures
                graph.addVariable(new dudeGraph.Variable({
                    // variableType is missing
                    // variableName is missing
                }));
            }).to.throw();
            expect(function () {
                //noinspection JSCheckFunctionSignatures
                graph.addVariable(new dudeGraph.Variable({
                    "variableName": "not",
                    "variableValueType": 32 // variableType is not a String
                }));
            }).to.throw();
            expect(function () {
                //noinspection JSCheckFunctionSignatures
                graph.addVariable(new dudeGraph.Variable({
                    "variableName": 32, // variableName is not a String
                    "variableValueType": "String"
                }));
            }).to.throw();
            expect(function () {
                //noinspection JSCheckFunctionSignatures
                graph.addVariable(new dudeGraph.Variable({
                    // variableName is missing
                    "variableValueType": "String"
                }));
            }).to.throw();
            expect(function () {
                //noinspection JSCheckFunctionSignatures
                graph.addVariable(new dudeGraph.Variable({
                    "variableName": "no_type"
                    // variableType is missing


                }));
            }).to.throw();
            expect(function () {
                graph.addVariable(new dudeGraph.Variable({
                    "variableType": "UnknownType",
                    "variableName": "no_type"
                }));
            }).to.throw();
        });
        test("variable value", function () {
            var graph = new dudeGraph.Graph();
            var variable = new dudeGraph.Variable({
                "variableName": "Hello",
                "variableValueType": "String"
            });
            expect(function (){
                variable.variableValue = 32; // Cannot change variableValue when not bound to graph
            }).to.throw();
            graph.addVariable(variable);
            variable.variableValue = "Hello"; // `String` ===> `String`
            expect(variable.variableValue).to.be.equal("Hello");
            variable.variableValue = 32; // `Number` =~=> `String`
            expect(variable.variableValue).to.be.equal("32");
            expect(function () {
                variable.variableValue = {}; // `Object` =/=> `String`
            }).to.throw();
        });
        test("bind VariableBlock to graph variable", function () {
            var graph = new dudeGraph.Graph();
            var variable = new dudeGraph.Variable({
                "variableName": "Hello",
                "variableValueType": "String"
            });
            graph.addVariable(variable);
            var variableBlock = new dudeGraph.VariableBlock({
                "blockName": "Hello"
            });
            graph.addBlock(variableBlock);
            expect(variable.variableBlock).to.be.equal(variableBlock);
            expect(function () {
                graph.addBlock(new dudeGraph.VariableBlock({
                    "blockName": "Hello" // Duplicate VariableBlock for Hello
                }));
            }).to.throw();
            graph.removeBlock(variableBlock);
            expect(variable.variableBlock).to.be.null;
            variableBlock = new dudeGraph.VariableBlock({
                "blockName": "Hello"
            });
            graph.addBlock(variableBlock);
            expect(graph.graphBlocks).to.have.length(1);
            expect(variable.variableBlock).to.be.equal(variableBlock);
            graph.removeVariable(variable); // Should remove all related blocks
            expect(graph.graphBlocks).to.have.length(0);
        });
        suite("dude-graph events", function () {
            test("block-add", function () {
                var spy = sinon.spy();
                var graph = new dudeGraph.Graph();
                var block = new dudeGraph.Block();
                graph.on("block-add", spy);
                graph.addBlock(block);
                sinon.assert.calledWith(spy, block);
            });
            test("block-remove", function () {
                var spy = sinon.spy();
                var graph = new dudeGraph.Graph();
                var block = new dudeGraph.Block();
                graph.on("block-remove", spy);
                graph.addBlock(block);
                graph.removeBlock(block);
                sinon.assert.calledWith(spy, block);
            });
            test("point-add", function () {
                var graphSpy = sinon.spy();
                var blockSpy = sinon.spy();
                var graph = new dudeGraph.Graph();
                var block = new dudeGraph.Block();
                var point = new dudeGraph.Point(true, {"pointName": "out", "pointValueType": "Number"});
                graph.on("block-point-add", graphSpy);
                block.on("point-add", blockSpy);
                graph.addBlock(block);
                block.addPoint(point);
                sinon.assert.calledWith(graphSpy, block, point);
                sinon.assert.calledWith(blockSpy, point);
            });
            test("point-remove", function () {
                var graphSpy = sinon.spy();
                var blockSpy = sinon.spy();
                var graph = new dudeGraph.Graph();
                var block = new dudeGraph.Block();
                var point = new dudeGraph.Point(true, {"pointName": "out", "pointValueType": "Number"});
                graph.on("block-point-remove", graphSpy);
                block.on("point-remove", blockSpy);
                graph.addBlock(block);
                block.addPoint(point);
                block.removePoint(point);
                sinon.assert.calledWith(graphSpy, block, point);
                sinon.assert.calledWith(blockSpy, point);
            });
            test("point-value-type-change", function () {
                var graphSpy = sinon.spy();
                var pointSpy = sinon.spy();
                var graph = new dudeGraph.Graph();
                var block = new dudeGraph.Block();
                var point = new dudeGraph.Point(true, {"pointName": "out", "pointValueType": "Number"});
                graph.addBlock(block);
                block.addPoint(point);
                graph.on("point-value-type-change", graphSpy);
                point.on("value-type-change", pointSpy);
                point.pointValueType = "String";
                sinon.assert.calledWith(graphSpy, point, "String", "Number");
                sinon.assert.calledWith(pointSpy, "String", "Number");
            });
            test("point-value-change", function () {
                var graphSpy = sinon.spy();
                var pointSpy = sinon.spy();
                var graph = new dudeGraph.Graph();
                var block = new dudeGraph.Block();
                var point = new dudeGraph.Point(true, {"pointName": "out", "pointValueType": "Number"});
                graph.addBlock(block);
                block.addPoint(point);
                graph.on("point-value-change", graphSpy);
                point.on("value-change", pointSpy);
                point.pointValue = 42;
                sinon.assert.calledWith(graphSpy, point, 42, null);
                sinon.assert.calledWith(pointSpy, 42, null);
            });
            test("point-connect", function () {
                var graphSpy = sinon.spy();
                var pointSpy = sinon.spy();
                var graph = new dudeGraph.Graph();
                var block1 = new dudeGraph.Block();
                var block2 = new dudeGraph.Block();
                var point1 = new dudeGraph.Point(true, {"pointName": "out", "pointValueType": "Number"});
                var point2 = new dudeGraph.Point(false, {"pointName": "in", "pointValueType": "Number"});
                graph.addBlock(block1);
                graph.addBlock(block2);
                block1.addPoint(point1);
                block2.addPoint(point2);
                graph.on("point-connect", graphSpy);
                point1.on("connect", pointSpy);
                var connection = point1.connect(point2);
                sinon.assert.calledWith(graphSpy, point1, connection);
                sinon.assert.calledWith(pointSpy, connection);
            });
            test("point-disconnect", function () {
                var graphSpy = sinon.spy();
                var pointSpy = sinon.spy();
                var graph = new dudeGraph.Graph();
                var block1 = new dudeGraph.Block();
                var block2 = new dudeGraph.Block();
                var point1 = new dudeGraph.Point(true, {"pointName": "out", "pointValueType": "Number"});
                var point2 = new dudeGraph.Point(false, {"pointName": "in", "pointValueType": "Number"});
                graph.addBlock(block1);
                graph.addBlock(block2);
                block1.addPoint(point1);
                block2.addPoint(point2);
                graph.on("point-disconnect", graphSpy);
                point1.on("disconnect", pointSpy);
                var connection = point1.connect(point2);
                point1.disconnect(point2);
                sinon.assert.calledWith(graphSpy, point1, connection);
                sinon.assert.calledWith(pointSpy, connection);
            });
            test("block-template-update", function () {
                var graphSpy = sinon.spy();
                var blockSpy = sinon.spy();
                var graph = new dudeGraph.Graph();
                var block = new dudeGraph.Block({
                    "blockTemplates": {
                        "Test": {
                            "valueType": "Number",
                            "templates": ["Number", "String"]
                        }
                    }
                });
                graph.addBlock(block);
                graph.on("block-template-update", graphSpy);
                block.on("template-update", blockSpy);
                block.updateTemplate("Test", "String");
                sinon.assert.calledWith(graphSpy, block, "Test", "String", "Number");
                sinon.assert.calledWith(blockSpy, "Test", "String", "Number");
            });
            test("variable-add", function () {
                var spy = sinon.spy();
                var graph = new dudeGraph.Graph();
                var variable = new dudeGraph.Variable({
                    "variableName": "variable",
                    "variableValueType": "String"
                });
                graph.on("variable-add", spy);
                graph.addVariable(variable);
                sinon.assert.calledWith(spy, variable);
            });
            test("variable-remove", function () {
                var spy = sinon.spy();
                var graph = new dudeGraph.Graph();
                var variable = new dudeGraph.Variable({
                    "variableName": "variable",
                    "variableValueType": "String"
                });
                graph.on("variable-remove", spy);
                graph.addVariable(variable);
                graph.removeVariable(variable);
                sinon.assert.calledWith(spy, variable);
            });
        });
    });
</script>
</body>
</html>