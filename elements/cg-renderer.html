<!--
    It's the most important polymer component of CodeGraph. It creates the SVG from JSON data and provide an API to add,
    remove or select data of this graph.
-->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/dude-gui/dude-config.html">
<polymer-element name="cg-renderer" attributes="graphUrl" extends="dude-config">
    <template>
        <style>
            #svg #selection {
                fill: rgba(255, 255, 255, 0.2);
                stroke: rgba(255, 255, 255, 0.5);
                stroke-width: 1px;
            }
            #svg .group, #svg .block {
                cursor: move;
            }
            #svg .action .title {
                text-anchor: middle;
            }
            #svg .input, #svg .output {
                cursor: pointer;
            }
            .connection {
                stroke-linecap: round;
            }
        </style>
        <core-ajax id="graphData"
                   url="{{graphUrl}}"
                   handleAs="json"
                   on-core-response="{{_loadGraph}}"
                   auto>
        </core-ajax>
        <div id="shadow-dom-bug" layout horizontal flex>
            <svg id="svg" flex></svg>
        </div>
    </template>
    <!-- Vendors -->
    <script src="../bower_components/d3/d3.js"></script>
    <script src="../bower_components/jwerty/jwerty.js"></script>
    <script src="../bower_components/pandora/lib/pandora.js"></script>
    <!-- CodeGraph library -->
    <script src="../lib/index.js"></script>
    <!-- CodeGraph graph -->
    <script src="../lib/graph/utils/graph-error.js"></script>
    <script src="../lib/graph/nodes/entity.js"></script>
    <script src="../lib/graph/utils/container.js"></script>
    <script src="../lib/graph/nodes/group.js"></script>
    <script src="../lib/graph/nodes/point.js"></script>
    <script src="../lib/graph/models/model.js"></script>
    <script src="../lib/graph/models/getter.js"></script>
    <script src="../lib/graph/models/picker.js"></script>
    <script src="../lib/graph/models/action.js"></script>
    <script src="../lib/graph/nodes/block.js"></script>
    <script src="../lib/graph/nodes/connection.js"></script>
    <script src="../lib/graph/nodes/graph.js"></script>
    <!-- CodeGraph renderer -->
    <script src="../lib/renderer/renderer.js"></script>
    <script src="../lib/renderer/utils/renderer-d3.js"></script>
    <script src="../lib/renderer/utils/renderer-error.js"></script>
    <script src="../lib/renderer/utils/renderer-position.js"></script>
    <script src="../lib/renderer/utils/renderer-point.js"></script>
    <script src="../lib/renderer/utils/renderer-collision.js"></script>
    <script src="../lib/renderer/render/render.js"></script>
    <script src="../lib/renderer/render/render-selection.js"></script>
    <script src="../lib/renderer/render/render-zoom.js"></script>
    <script src="../lib/renderer/render/render-drag.js"></script>
    <script src="../lib/renderer/render/render-block.js"></script>
    <script src="../lib/renderer/render/render-picker.js"></script>
    <script src="../lib/renderer/render/render-group.js"></script>
    <script src="../lib/renderer/render/render-connection.js"></script>
    <script src="../lib/renderer/render/render-point.js"></script>
    <!-- CodeGraph serialization -->
    <script src="../lib/serialization/json-saver.js"></script>
    <script src="../lib/serialization/json-loader.js"></script>
    <!-- CodeGraph misc -->
    <script>
        Polymer({
            publish: {

                /**
                 * This is the url of the graph data to load.
                 * @attribute url
                 * @type {String}
                 */
                graphUrl: null

            },
            data: null,
            config: null,

            handleErrors: function () {
                this.loader.on("error", function (error) { this.fire("error", {error: error}); }.bind(this));
                this.saver.on("error", function (error) { this.fire("error", {error: error}); }.bind(this));
                this.graph.on("error", function (error) { this.fire("error", {error: error}); }.bind(this));
                this.renderer.on("error", function (error) { this.fire("error", {error: error}); }.bind(this));
            },

            createGroup: function (name) {
                var _id = graph.getNextGroupId();
                renderer.createSmartGroup(_id, name);
            },

            createBlock: function (model, position) {
                this.graph.addEntity(new cg.Block(this.graph.getNextBlockId(), model, position), this.graph);
            },

            removeSelection: function () {
                this.renderer.removeSelection();
            },

            zoomToFit: function () {
                this.renderer.zoomToFit();
            },

            findModels: function (options) {
                return this.graph.findModels(options);
            },


            /**
             * Create the graph when its config and data are loaded.
             * @private
             */
            _createGraph: function () {
                this.graph = new cg.Graph();
                this.loader = new cg.JSONLoader();
                this.saver = new cg.JSONSaver();
                this.renderer = new cg.Renderer(this.graph, this.$.svg, this.config);
                window.graph = this.graph;
                window.renderer = this.renderer;
                window.loader = this.loader;
                window.saver = this.saver;
                this.handleErrors();
                this.renderer.on("picker.edit", function (picker) {
                    this.fire("picker.edit", {picker: picker});
                }.bind(this));
                this.loader.load(this.graph, this._graphData);
                this.renderer.render();
                this.fire("ready");
            },

            /**
             * Load the graph data from an external JSON file.
             * @private
             */
            _loadGraph: function () {
                this._graphData = this.$.graphData.response;
                if (this.config !== null) {
                    this._createGraph();
                }
            },

            ready: function () {
                this.addEventListener("dude-config-ready", function () {
                    if (this._graphData !== undefined) {
                        this._createGraph();
                    }
                });
            }
        });
    </script>
</polymer-element>