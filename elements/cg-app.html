<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/core-splitter/core-splitter.html">
<link rel="import" href="../bower_components/core-icons/av-icons.html">
<link rel="import" href="../bower_components/core-icons/image-icons.html">
<link rel="import" href="../bower_components/core-dropdown-menu/core-dropdown-menu.html">
<link rel="import" href="../bower_components/core-dropdown/core-dropdown.html">
<link rel="import" href="../bower_components/core-collapse/core-collapse.html">
<link rel="import" href="../bower_components/core-menu/core-menu.html">
<link rel="import" href="../bower_components/core-item/core-item.html">
<link rel="import" href="../bower_components/dude-gui/dude-panel.html">
<link rel="import" href="../bower_components/dude-gui/dude-config.html">
<link rel="import" href="../bower_components/dude-gui/dude-sidebar.html">
<link rel="import" href="../bower_components/dude-gui/dude-toolbar.html">
<link rel="import" href="../bower_components/dude-gui/dude-toolbar-command.html">
<link rel="import" href="../bower_components/dude-gui/dude-toolbar-input.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="cg-renderer.html">
<polymer-element name="cg-app" attributes="logo theme graphUrl" extends="dude-config">
    <template>
        <style>
            dude-toolbar [data-state="root"] {
                margin: auto;
                padding: 0 20px;
                max-width: 800px;
            }
            dude-sidebar [data-state] {
                width: 200px;
            }
            paper-dropdown-menu {
                width: 100%;
                box-sizing: border-box;
                outline: none;
                background: transparent;
            }
            paper-dropdown {
                border-radius: 3px;
                box-sizing: border-box;
                min-width: 200px;
            }
            paper-item {
                overflow: hidden;
                white-space: nowrap;
                color: #444;
                text-overflow: ellipsis;
            }
            .panel-splitter {
                background: rgb(243, 156, 18);
                width: 3px;
            }
        </style>
        <dude-panel id="panel"
                    name="story-editor"
                    styleUrl="themes/{{theme}}/panel.css"
                    configUrl="themes/{{theme}}/panel.json"
                    flex>
            <dude-toolbar id="toolbar">
                <div data-state="root" layout horizontal justified>
                    <template repeat="{{command in _commands}}">
                        <dude-toolbar-command name="{{command.name}}"
                                              label="{{command.label}}"
                                              icon="{{command.icon}}"
                                              on-trigger="{{runCommand}}">
                        </dude-toolbar-command>
                    </template>
                </div>
                <dude-toolbar-input name="createGroup"
                                    data-state="group"
                                    label="Group title"
                                    icon="check"
                                    on-submit="{{runCommand}}">
                </dude-toolbar-input>
                <dude-toolbar-input name="editGroup"
                                    data-state="editGroup"
                                    label="Group title"
                                    icon="check"
                                    on-submit="{{runCommand}}">
                </dude-toolbar-input>
                <dude-toolbar-input name="createAction"
                                    value="{{_actionName}}"
                                    data-state="action"
                                    label="Search action..."
                                    icon="check"
                                    on-submit="{{runCommand}}"
                                    on-close="{{hideSidebar}}">
                </dude-toolbar-input>
                <dude-toolbar-input name="createPicker"
                                    value="{{_pickerName}}"
                                    data-state="picker"
                                    label="Search by name..."
                                    icon="check"
                                    on-submit="{{runCommand}}"
                                    on-close="{{hideSidebar}}">
                </dude-toolbar-input>
            </dude-toolbar>
            <dude-sidebar id="sidebar" noroot>
                <div data-state="action">
                    <template if="{{_actionList.length === 0}}">
                        <div>No results.</div>
                    </template>
                    <template repeat="{{action in _actionList}}">
                        <div class="search-result">{{action.name}}</div>
                    </template>
                </div>
                <div data-state="picker">
                    <div>
                        <paper-dropdown-menu label="{{_pickerType}}" core-select="{{_pickerTypeChanged}}">
                            <paper-dropdown selected="{{_pickerType}}" class="dropdown">
                                <core-menu class="menu">
                                    <template repeat="{{type in _pickerTypes}}">
                                        <paper-item>{{type}}</paper-item>
                                    </template>
                                </core-menu>
                            </paper-dropdown>
                        </paper-dropdown-menu>
                        <!--<core-dropdown-menu label="{{_pickerType}}" selected="{{_pickerType}}">-->
                            <!--<core-dropdown class="dropdown">-->
                                <!--<core-menu>-->
                                    <!--<template repeat="{{type in _pickerTypes}}">-->
                                        <!--<core-item>{{type}}</core-item>-->
                                    <!--</template>-->
                                <!--</core-menu>-->
                            <!--</core-dropdown>-->
                        <!--</core-dropdown-menu>-->
                    </div>
                    <!--<div>-->
                        <!--<input is="core-input"-->
                               <!--value="{{_pickerValue}}"-->
                               <!--placeholder="Type your string..."-->
                               <!--flex>-->
                    <!--</div>-->
                    <div>
                        <template if="{{_pickerList.length === 0}}">
                            <div>No results.</div>
                        </template>
                        <template repeat="{{picker in _pickerList}}">
                            <div class="search-result">{{picker.name}}</div>
                        </template>
                    </div>
                </div>
            </dude-sidebar>
            <cg-renderer id="renderer"
                         styleUrl="themes/{{theme}}/graph.css"
                         configUrl="themes/{{theme}}/config.json"
                         graphUrl="{{graphUrl}}"
                         content>
            </cg-renderer>
        </dude-panel>
        <!--<core-splitter class="panel-splitter" direction="right"></core-splitter>-->
        <!--<dude-panel name="audio-editor" styleUrl="themes/{{theme}}/panel.css">-->
            <!--<dude-toolbar root="hello">-->
                <!--<div data-state="hello">Audio Editor</div>-->
            <!--</dude-toolbar>-->
            <!--<dude-sidebar>Here comes the tools.</dude-sidebar>-->
            <!--<div content flex>Here comes some edition content</div>-->
        <!--</dude-panel>-->
        <paper-toast class="notification" id="error"></paper-toast>
        <paper-toast class="notification" id="success"></paper-toast>
    </template>
    <script>
        Polymer({
            _commands: [
                {name: "openGraph", label: "open another graph", icon: "open-in-new"},
                {name: "saveGraph", label: "save the graph", icon: "save"},
                {name: "openGroup", label: "add a group", icon: "av:my-library-add"},
                {name: "openAction", label: "add an action", icon: "add-box"},
                {name: "openPicker", label: "add a picker", icon: "add-circle"},
                {name: "editEntity", label: "edit the selected object", icon: "create"},
                {name: "removeSelection", label: "remove all the selected objects", icon: "delete"},
                {name: "zoomToFit", label: "zoom to best fit all objects", icon: "image:crop-free"}
            ],
            _pickerTypes: ["boolean", "string", "sound"],
            _pickerList: [],
            _pickerType: "boolean",
            _pickerName: null,
            _actionList: [],
            _actionName: null,
            runCommand: function (event, detail) {
                if (this[detail.name] === undefined) {
                    console.warn("Command " + detail.name + " doesn't exist");
                    return;
                }
                this[detail.name](detail);
            },
            root: function () {
                this.$.toolbar.reset();
            },
            hideSidebar: function () {
                this.$.sidebar.reset();
            },
            openGroup: function () {
                this.$.toolbar.state = "group";
            },
            openAction: function () {
                this.$.toolbar.state = "action";
                this.$.sidebar.state = "action";
            },
            openPicker: function () {
                this.$.toolbar.state = "picker";
                this.$.sidebar.state = "picker";
            },
            removeSelection: function () {
                this.$.renderer.removeSelection();
                this.$.success.text = "Entities successfully removed!";
                this.$.success.show();
            },
            zoomToFit: function () {
                this.$.renderer.zoomToFit();
            },
            createGroup: function (detail) {
                this.$.renderer.createGroup(detail.value);
                this.$.success.text = "Group \"" + detail.value + "\" successfully created!";
                this.$.success.show();
            },
            createAction: function () {
//                var models = this.$.renderer.findModels({
//                    limit: 5,
//                    modelType: 'action',
//                    pattern: this._actionName
//                });
                if (this._actionList.length === 0) {
                    this.showError(new pandora.Exception("Action {0} doesn't exist", this._actionName));
                } else {
                    this.$.renderer.createBlock(this._actionList[0].data, new pandora.Vec2(50, 50));
                    this.$.success.text = "Action \"" + this._actionList[0].name + "\" successfully created!";
                    this.$.success.show();
                }
            },
            createPicker: function () {
//                this.$.renderer.createBlock(new cg.Picker({
//                    "value-type": this._pickerType,
//                    "default": this._pickerValue
//                }), new pandora.Vec2(50, 50));
                if (this._pickerList.length === 0) {
                    this.showError(new pandora.Exception("Getter {0} doesn't exist", this._pickerName));
                } else {
                    this.$.renderer.createBlock(new cg.Getter({
                        "value-type": this._pickerType,
                        "name": this._pickerList[0].name
                    }), new pandora.Vec2(50, 50));
                }
            },
            editEntity: function () {
                var selection = this.$.renderer.getLastSelectedEntity();
                var entity = selection ? selection.datum() : null;
                if (entity instanceof cg.Group) {
                    this.$.toolbar.state = "editGroup";
                }
            },
            editGroup: function (event) {
                var selection = this.$.renderer.getLastSelectedEntity();
                var entity = selection ? selection.datum() : null;
                if (entity instanceof cg.Group) {
                    entity.description = event.value;
                    entity.emit("update");
                }
            },
            showError: function (error) {
                this.$.error.text = error.message;
                this.$.error.show();
            },
            attached: function () {
                this.styleUrl = "themes/" + this.theme + "/app.css";
                this.$.renderer.addEventListener("error", function (e) {
                    this.showError(e.detail.error);
                }.bind(this));
                this.$.renderer.addEventListener("picker.edit", function (e) {
                    console.log("edit picker", e.detail.picker);
                });
                this.$.renderer.addEventListener("ready", function () {
                    this._pickerNameChanged();
                    this._actionNameChanged();
                }.bind(this));
                if (navigator.platform.indexOf("Mac") !== -1) {
                    jwerty.key('cmd+G', function (e) {this.openGroup(); pandora.preventCallback(e); }.bind(this));
                    jwerty.key('cmd+A', function (e) {this.openAction(); pandora.preventCallback(e); }.bind(this));
                    jwerty.key('cmd+P', function (e) {this.openPicker(); pandora.preventCallback(e); }.bind(this));
                    jwerty.key('cmd+X', function (e) {this.removeSelection(); pandora.preventCallback(e); }.bind(this));
                } else {
                    jwerty.key('ctrl+G', function (e) {this.openGroup(); pandora.preventCallback(e); }.bind(this));
                    jwerty.key('ctrl+A', function (e) {this.openAction(); pandora.preventCallback(e); }.bind(this));
                    jwerty.key('ctrl+P', function (e) {this.openPicker(); pandora.preventCallback(e); }.bind(this));
                    jwerty.key('ctrl+X', function (e) {this.removeSelection(); pandora.preventCallback(e); }.bind(this));
                }

            },
            _actionNameChanged: function () {
                this._actionList = this.$.renderer.findModels({
                    limit: 5,
                    modelType: 'action',
                    pattern: this._actionName
                });
            },
            _pickerNameChanged: function () {
                this._pickerList = this.$.renderer.findModels({
                    limit: 5,
                    modelType: 'getter',
                    pattern: this._pickerName,
                    isInput: false,
                    type: this._pickerType
                });
            },
            _pickerTypeChanged: function (event) {
                console.log(this._pickerType, event);
            }
        });
    </script>
</polymer-element>