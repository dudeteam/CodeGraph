<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-splitter/core-splitter.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/core-icons/av-icons.html">
<link rel="import" href="../bower_components/core-icons/image-icons.html">
<link rel="import" href="../bower_components/dude-gui/dude-panel.html">
<link rel="import" href="../bower_components/dude-gui/dude-config.html">
<link rel="import" href="../bower_components/dude-gui/dude-sidebar.html">
<link rel="import" href="../bower_components/dude-gui/dude-toolbar.html">
<link rel="import" href="../bower_components/dude-gui/dude-toolbar-command.html">
<link rel="import" href="../bower_components/dude-gui/dude-toolbar-input.html">
<link rel="import" href="cg-renderer.html">
<polymer-element name="cg-app" attributes="logo theme graphUrl" extends="dude-config">
    <template>
        <style>
            dude-toolbar [data-state="root"] {
                margin: auto;
                padding: 0 20px;
                max-width: 800px;
            }
        </style>
        <dude-panel id="panel"
                    name="story-editor"
                    styleUrl="themes/{{theme}}/panel.css"
                    configUrl="themes/{{theme}}/panel.json"
                    flex>
            <dude-toolbar id="toolbar">
                <div data-state="root" layout horizontal justified>
                    <dude-toolbar-command name="openGraph"
                                          label="open another graph"
                                          icon="open-in-new"
                                          on-trigger="{{runCommand}}">
                    </dude-toolbar-command>
                    <dude-toolbar-command name="save"
                                          label="save the graph"
                                          icon="save"
                                          on-trigger="{{runCommand}}">
                    </dude-toolbar-command>
                    <dude-toolbar-command name="openGroup"
                                          label="add a group"
                                          icon="av:my-library-add"
                                          on-trigger="{{runCommand}}">
                    </dude-toolbar-command>
                    <dude-toolbar-command name="openAction"
                                          label="add an action"
                                          icon="add-box"
                                          on-trigger="{{runCommand}}">
                    </dude-toolbar-command>
                    <dude-toolbar-command name="openPicker"
                                          label="add a picker"
                                          icon="add-circle"
                                          on-trigger="{{runCommand}}">
                    </dude-toolbar-command>
                    <dude-toolbar-command name="edit"
                                          label="edit the selected object"
                                          icon="create"
                                          on-trigger="{{runCommand}}">
                    </dude-toolbar-command>
                    <dude-toolbar-command name="removeSelection"
                                          label="remove the selected groups and blocks"
                                          icon="delete"
                                          on-trigger="{{runCommand}}">
                    </dude-toolbar-command>
                    <dude-toolbar-command name="zoomToFit"
                                          label="zoom to best fit all elements"
                                          icon="image:crop-free"
                                          on-trigger="{{runCommand}}">
                    </dude-toolbar-command>
                </div>
                <dude-toolbar-input name="createGroup"
                                    data-state="group"
                                    label="Group title"
                                    icon="check"
                                    on-submit="{{runCommand}}">
                </dude-toolbar-input>
                <dude-toolbar-input name="createAction"
                                    data-state="action"
                                    label="Search block"
                                    icon="check"
                                    on-submit="{{runCommand}}"
                                    on-close="{{hideSidebar}}">
                </dude-toolbar-input>
                <div data-state="picker">Add a picker</div>
            </dude-toolbar>
            <dude-sidebar id="sidebar" noroot>
                <div data-state="action">
                    <template repeat="{{model in _actionModels}}">
                        <div>{{model}}</div>
                    </template>
                </div>
                <div data-state="picker">
                    <div>Some picker content...</div>
                </div>
            </dude-sidebar>
            <cg-renderer id="renderer"
                         styleUrl="themes/{{theme}}/graph.css"
                         configUrl="themes/{{theme}}/config.json"
                         graphUrl="{{graphUrl}}"
                         content>
            </cg-renderer>
        </dude-panel>
        <!--<core-splitter class="panel-splitter" direction="right"></core-splitter>-->
        <!--<dude-panel name="audio-editor" styleUrl="themes/{{theme}}/panel.css">-->
        <!--<dude-toolbar root="hello">-->
        <!--<div data-state="hello">-->
        <!--Audio Editor-->
        <!--</div>-->
        <!--</dude-toolbar>-->
        <!--<dude-sidebar>Here comes the tools.</dude-sidebar>-->
        <!--<div content flex>Here comes some edition content</div>-->
        <!--</dude-panel>-->
        <paper-toast class="notification" id="error"></paper-toast>
        <paper-toast class="notification" id="info"></paper-toast>
        <paper-toast class="notification" id="success"></paper-toast>
    </template>
    <script>
        Polymer({
            runCommand: function (event, detail) {
                if (this[detail.name] === undefined) {
                    console.warn("Command " + detail.name + " doesn't exist");
                    return;
                }
                this[detail.name](detail);
            },
            root: function() {
                this.$.toolbar.reset();
            },
            hideSidebar: function () {
                this.$.sidebar.reset();
            },
            openGroup: function () {
                this.$.toolbar.state = "group";
            },
            openAction: function () {
                this.$.toolbar.state = "action";
                this.$.sidebar.state = "action";
            },
            openPicker: function () {
                this.$.toolbar.state = "picker";
                this.$.sidebar.state = "picker";
            },
            removeSelection: function () {
                this.$.renderer.removeSelection();
            },
            zoomToFit: function() {
                this.$.renderer.zoomToFit();
            },
            createGroup: function (detail) {
                this.$.renderer.createGroup(detail.value);
            },
            createAction: function (detail) {
                this.$.renderer.createBlock(detail.value, new pandora.Vec2(50, 50));
            },
            createPicker: function () {
                console.log("TODO: add a picker or getter");
            },
            showError: function (error) {
                this.$.error.text = error.message;
                this.$.error.show();
            },
            attached: function () {
                this.styleUrl = "themes/" + this.theme + "/app.css";
                this.$.renderer.addEventListener("error", function (e) {
                    this.showError(e.detail.error);
                }.bind(this));
                this.$.renderer.addEventListener("picker.edit", function (e) {
                    console.log("edit picker", e.detail.picker);
                });
                this.$.renderer.addEventListener("ready", function () {
                    this._actionModels = this.$.renderer.findModels({limit: 5, type: 'action'});
                }.bind(this));
                if (navigator.platform.indexOf("Mac") !== -1) {
                    jwerty.key('cmd+G', function (e) {this.openGroup(); pandora.preventCallback(e); }.bind(this));
                    jwerty.key('cmd+A', function (e) {this.openAction(); pandora.preventCallback(e); }.bind(this));
                    jwerty.key('cmd+P', function (e) {this.openPicker(); pandora.preventCallback(e); }.bind(this));
                    jwerty.key('cmd+X', function (e) {this.removeSelection(); pandora.preventCallback(e); }.bind(this));
                } else {
                    jwerty.key('ctrl+G', function (e) {this.openGroup(); pandora.preventCallback(e); }.bind(this));
                    jwerty.key('ctrl+A', function (e) {this.openAction(); pandora.preventCallback(e); }.bind(this));
                    jwerty.key('ctrl+P', function (e) {this.openPicker(); pandora.preventCallback(e); }.bind(this));
                    jwerty.key('ctrl+X', function (e) {this.removeSelection(); pandora.preventCallback(e); }.bind(this));
                }

            }
        });
    </script>
</polymer-element>