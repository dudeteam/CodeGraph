<link rel="import" href="../bower_components/polymer/polymer.html">
<polymer-element name="code-graph">
    <template>
        <link rel="stylesheet" href="../themes/base.css">
        <link rel="stylesheet" href="../themes/dude.css">
        <!--<link rel="stylesheet" href="../themes/default.css">-->
        <style>
            #area {
                width: 100%;
                height: 100%;
                overflow: hidden;
            }

            #svg {
                width: 100%;
                height: 100%;
            }
        </style>
        <div id="area">
            <svg id="svg">

            </svg>
        </div>
    </template>
    <!-- Vendors -->
    <script src="../bower_components/jwerty/jwerty.js"></script>
    <script src="../bower_components/Snap.svg/dist/snap.svg.js"></script>
    <!-- CodeGraph library -->
    <script src="../lib/index.js"></script>
    <script src="../lib/utils/vec2.js"></script>
    <script src="../lib/utils/box2.js"></script>
    <script src="../lib/utils/event-emitter.js"></script>
    <script src="../lib/utils/misc.js"></script>
    <script src="../lib/utils/graph-error.js"></script>
    <script src="../lib/nodes/node.js"></script>
    <script src="../lib/nodes/container.js"></script>
    <script src="../lib/nodes/group.js"></script>
    <script src="../lib/nodes/point.js"></script>
    <script src="../lib/nodes/model.js"></script>
    <script src="../lib/nodes/models/getter.js"></script>
    <script src="../lib/nodes/models/picker.js"></script>
    <script src="../lib/nodes/models/action.js"></script>
    <script src="../lib/nodes/block.js"></script>
    <script src="../lib/nodes/connection.js"></script>
    <script src="../lib/nodes/graph.js"></script>
    <script src="../lib/renderer/index.js"></script>
    <script src="../lib/renderer/cursor-point.js"></script>
    <script src="../lib/renderer/utils.js"></script>
    <script src="../lib/renderer/pickers.js"></script>
    <script src="../lib/renderer/zoom.js"></script>
    <script src="../lib/renderer/background-grid.js"></script>
    <script src="../lib/renderer/render-graph.js"></script>
    <script src="../lib/renderer/render-container.js"></script>
    <script src="../lib/renderer/render-group.js"></script>
    <script src="../lib/renderer/render-block.js"></script>
    <script src="../lib/renderer/render-point.js"></script>
    <script src="../lib/renderer/render-connection.js"></script>
    <script src="../lib/serialization/json-saver.js"></script>
    <script src="../lib/serialization/json-loader.js"></script>
    <script>
        Polymer({
            ready: function () {
                var themes = {
                    "default": {
                    },
                    "dude": {
                        "group": {
                            "border-radius": 5
                        },
                        "block": {
                            "border-radius": 5
                        },
                        "background-grid": {
                            "line": {
                                "stroke": "rgba(255, 255, 255, 0.05)",
                            },
                            "big-line": {
                                "stroke": "rgba(255, 255, 255, 0.2)",
                            }
                        }
                    }
                };
                var paper = Snap(this.$.svg);
                var graph = new cg.Graph();
                var loader = new cg.JSONLoader();
                var saver = new cg.JSONSaver();
                var renderer = new cg.Renderer(paper);
                renderer.initialize(graph, themes["dude"]);
                loader.load(graph, {
                    "models": {
                        "rounded_rect": {
                            "type": "action",
                            "inputs": [
                                {"type": "color", "name": "color", value: "#fff"},
                                {"type": "number", "name": "aspect_ratio", value: 1.0},
                                {"type": "number", "name": "stroke_size", value: 1.0},
                                {"type": "number", "name": "border_radius", value: 0.2},
                                {"type": "boolean", "name": "is_solid", value: true}
                            ],
                            "outputs": [
                                {"type": "color", "name": "frag_color"}
                            ]
                        },
                        "blur": {
                            "type": "action",
                            "inputs": [
                                {"type": "number", "name": "diameter"},
                                {"type": "vec2", "name": "resolution"}
                            ],
                            "outputs": [{"type": "color", "name": "frag_color"}]
                        },
                        "black_and_white": {
                            "type": "action",
                            "inputs": [],
                            "outputs": [{"type": "color", "name": "frag_color"}]
                        },
                        "mix": {
                            "type": "action",
                            "inputs": [
                                {"type": "color", "name": "x"},
                                {"type": "color", "name": "y"},
                                {"type": "number", "name": "a"}
                            ],
                            "outputs": [{"type": "color", "name": "frag_color"}]
                        },
                        "output": {
                            "type": "action",
                            "inputs": [{"type": "color", "name": "frag_color"}],
                            "outputs": []
                        },
                        "shader": {
                            "type": "action",
                            "inputs": [
                                {"type": "vec3", "name": "position", "value": {"x": 0, "y": 0, "z": 0}},
                                {"type": "vec2", "name": "uv", "value": {"x": 0, "y": 0}},
                                {"type": "string", "name": "name", "value": "default.glsl"},
                                {"type": "boolean", "name": "enabled", "value": true},
                                {"type": "resource", "name": "image"}
                            ],
                            "outputs": [
                                {"type": "color", "name": "frag_color"}
                            ]
                        },
                        "name": {"type": "getter", "value-type": "string"},
                        "delta_value": {"type": "getter", "value-type": "number"}
                    },
                    "children": [
                        {"_type": "block", "_id": 1241, "name": "blur", "position": [200, 150]},
                        {"_type": "block", "_id": 1251, "name": "black_and_white", "position": [200, 300]},
                        {"_type": "block", "_id": 120, "name": "mix", "position": [500, 200]},
                        {"_type": "block", "_id": 10, "name": "shader", "position": [300, 500]},
                        {"_type": "group", "_id": 324, "name": "The best group in the world", "position": [0, 0], "size": [200, 100], "children": []},
                        {"_type": "group", "_id": 123, "name": "My Group", "position": [700, 400], "size": [400, 300],  "children": [
                            {"_type": "block", "_id": 3, "name": "rounded_rect", "position": [30, 130]}
                        ]},
                        {"_type": "block", "_id": 211, "name": "name", "position": [20, 600]},
                        {"_type": "block", "_id": 400, "name": "delta_value", "position": [400, 350]}
                    ],
                    "connections": [
                        {"from": {"block": 10, "point": "frag_color"}, "to": {"block": 3, "point": "color"}}
                    ]
                });
                graph.on("error", function (error) {
                    alert(error.message);
                });
                renderer.render(graph);
                jwerty.key('A', function () {
                    var action = new cg.Action(prompt("_id"), graph.getModel(prompt("model")), renderer._mousePosition.clone());
                    graph.addNode(action, graph);
                });
                jwerty.key('G', function () {
                    var group = new cg.Group(prompt("_id"), prompt("name"), renderer._mousePosition.clone(), new cg.Vec2(300, 300));
                    graph.addNode(group, graph);
                    renderer.selectedNodes().forEach(function (node) {
                        if (node.parent && node.parent instanceof cg.Graph) {
                            group.addChild(node);
                        }
                    });
                });
                jwerty.key('X', function () {
                    renderer.selectedNodes().forEach(function (node) {
                        node.remove();
                    });
                });
                window.graph = graph;
                window.renderer = renderer;
                window.loader = loader;
                window.saver = saver;
            }
        });
    </script>
</polymer-element>