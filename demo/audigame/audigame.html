<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
-->
<link rel="import" href="../../../polymer/polymer.html">
<link rel="import" href="../../../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../paper-toast/paper-toast.html">
<link rel="import" href="../../../dude-style/dude-style.html">
<link rel="import" href="../../dude-graph.html">
<script src="builder.js"></script>
<script src="data.js"></script>
<!--
`audigame` is a Polymer element to wrap a dude-graph demo
-->
<dom-module id="demo-audigame">
    <style>
        .container {
            height: 100%;
        }

        #success {
            --paper-toast-background-color: var(--dude-status-success-color);
        }

        #error {
            --paper-toast-background-color: var(--dude-status-error-color);
        }

        #jumpToBlockId {
            margin-top: 10px;
        }
    </style>
    <template>
        <div class="container">
            <paper-toast id="error">
                <template is="dom-if" if="[[ jumpToBlockId ]]">
                   <div id="jumpToBlockId">
                       <button on-click="_jumpToBlockId">Jump to block</button>
                   </div>
                </template>
            </paper-toast>
            <paper-toast id="success"></paper-toast>
            <iron-localstorage
                    name="dude-graph-data"
                    value="{{ graphData }}">
            </iron-localstorage>
            <iron-localstorage
                    name="dude-graph-renderer-data"
                    value="{{ rendererData }}">
            </iron-localstorage>
            <dude-graph id="dudeGraphElement"
                        class="container"
                        models="[[ models ]]"
                        graph-data="[[ graphData ]]"
                        renderer-data="[[ rendererData ]]"
                        block-types="[[ blockTypes ]]"
                        point-types="[[ pointTypes ]]"
                        graph-value-types="[[ graphValueTypes ]]"
                        render-block-types="[[ renderBlockTypes ]]">
            </dude-graph>
        </div>
    </template>
    <script>
        Polymer({
            is: "demo-audigame",
            properties: {
                /**
                 * The graph data
                 */
                "graphData": {
                    "type": Object,
                    "value": DUDE_GRAPH_DEFAULT_GRAPH_DATA
                },

                /**
                 * The renderer data
                 */
                "rendererData": {
                    "type": Object,
                    "value": DUDE_GRAPH_DEFAULT_RENDERER_DATA
                },

                /**
                 * The model data
                 */
                "models": {
                    "type": Array,
                    "value": DUDE_GRAPH_MODELS
                },

                /**
                 * The custom block types
                 */
                "blockTypes": {
                    "type": Array,
                    "value": DUDE_GRAPH_BLOCK_TYPES
                },

                /**
                 * The custom point types
                 */
                "pointTypes": {
                    "type": Array,
                    "value": DUDE_GRAPH_POINT_TYPES
                },

                /**
                 * The graph value types
                 */
                "graphValueTypes": {
                    "type": Array,
                    "value": DUDE_GRAPH_GRAPH_VALUE_TYPES
                },

                /**
                 * The custom renderer for blocks
                 */
                "renderBlockTypes": {
                    "type": Array,
                    "value": DUDE_GRAPH_RENDER_BLOCK_TYPES
                },

                /**
                 * The blockId to jump to if there is an error
                 */
                "jumpToBlockId": {
                    "type": String
                }
            },
            listeners: {
                "dude-graph-save": "_graphSave",
                "dude-graph-build": "_graphBuild",
                "dude-graph-error": "_graphError",
                "dude-graph-success": "_graphSuccess"
            },

            /**
             * Initializes dude-graph
             */
            attached: function () {
              this.$.dudeGraphElement.initialize();
              this.$.dudeGraphElement.set("graph.graphData.resources", [
                  {"item": {"name": "image1.png", "data": {"file_name": "http://goo.gl/aT8b1W", "size": 512}}},
                  {"item": {"name": "image2.png", "data": {"file_name": "http://goo.gl/eL4sot", "size": 512}}},
                  {"item": {"name": "sound1.mp3", "data": {"file_name": "http://goo.gl/JVcU3g", "size": 2048}}},
                  {"item": {"name": "sound2.mp3", "data": {"file_name": "http://goo.gl/64THWa", "size": 2048}}}
              ]);
            },

            /**
             * Saves the graph and renderer data to local storage
             * @param {CustomEvent} e
             * @param {Object} e.detail
             * @param {Object} e.detail.graphData
             * @param {Object} e.detail.rendererData
             * @private
             */
            _graphSave: function (e) {
                this.set("graphData", e.detail.graphData);
                this.set("rendererData", e.detail.rendererData);
                this._success("Story saved!");
            },

            /**
             * Builds the graph
             * @private
             */
            _graphBuild: function () {
                try {
                    var vm = new CelestoryBuilder(this.$.dudeGraphElement.get("graph")).build();
                    this._success(JSON.stringify(vm, null, ' '));
                    console.log(JSON.stringify(vm, null, ' '));
                } catch (e) {
                    this._error(e);
                }
            },

            /**
             * Shows graph error
             * @param {CustomEvent} e
             * @param {Object} e.detail
             * @param {Error} e.detail.error
             * @param {String} e.detail.error.message
             * @private
             */
            _graphError: function (e) {
                this._error(e.detail.error.message);
            },

            /**
             * Shows graph success
             * @param {CustomEvent} e
             * @param {String} e.detail
             * @private
             */
            _graphSuccess: function (e) {
                this._success(e.detail);
            },

            /**
             * Handles the error and shows an error toast
             * @param {String} message
             * @private
             */
            _error: function (message) {
                var blockRegex = /Block \(`([\w-]+)`\)/;
                var blockIdFound = blockRegex.exec(message);
                if (blockIdFound !== null && typeof blockIdFound[1] !== "undefined") {
                    this.set("jumpToBlockId", blockIdFound[1]);
                } else {
                    this.set("jumpToBlockId", null);
                }
                this.$.error.close();
                this.$.error.text = message;
                this.$.error.open();
            },

            /**
             * Handles the success and shows a success toast
             * @param {String} message
             * @private
             */
            _success: function (message) {
                this.$.success.close();
                this.$.success.text = message;
                this.$.success.open();
            },

            /**
             * Zooms to the "jumpToBlockId" blockId
             * @private
             */
            _jumpToBlockId: function () {
                var blockId = this.get("jumpToBlockId");
                var graph = this.$.dudeGraphElement.get("graph");
                var renderer = this.$.dudeGraphElement.get("renderer");
                var block = graph.blockById(blockId);
                if (block !== null) {
                    var renderBlocks = renderer.renderBlocksByBlock(block);
                    renderer.zoomToFitRenderNodes(renderBlocks);
                }
            }
        });
    </script>
</dom-module>