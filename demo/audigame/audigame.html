<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
-->
<link rel="import" href="../../../polymer/polymer.html">
<link rel="import" href="../../../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../paper-toast/paper-toast.html">
<link rel="import" href="../../dude-graph.html">
<script src="builder.js"></script>
<script src="data.js"></script>
<!--
`audigame` is a Polymer element to wrap a dude-graph demo
-->
<dom-module id="demo-audigame">
    <style>
        .container {
            height: 100%;
        }

        #success {
            --paper-toast-background-color: var(--paper-green-500);
        }

        #error {
            --paper-toast-background-color: var(--paper-red-500);
        }
    </style>
    <template>
        <div class="container">
            <paper-toast id="success"></paper-toast>
            <paper-toast id="error"></paper-toast>
            <iron-localstorage
                    name="dude-graph-data"
                    value="{{ graphData }}">
            </iron-localstorage>
            <iron-localstorage
                    name="dude-graph-renderer-data"
                    value="{{ rendererData }}">
            </iron-localstorage>
            <dude-graph id="dudeGraphElement"
                        class="container"
                        models="[[ models ]]"
                        graph-data="[[ graphData ]]"
                        renderer-data="[[ rendererData ]]"
                        block-types="[[ blockTypes ]]"
                        point-types="[[ pointTypes ]]"
                        render-block-types="[[ renderBlockTypes ]]">
            </dude-graph>
        </div>
    </template>
    <script>
        Polymer({
            is: "demo-audigame",
            properties: {
                /**
                 * The graph data
                 */
                "graphData": {
                    "type": Object,
                    "value": DUDE_GRAPH_DEFAULT_GRAPH_DATA
                },

                /**
                 * The renderer data
                 */
                "rendererData": {
                    "type": Object,
                    "value": DUDE_GRAPH_DEFAULT_RENDERER_DATA
                },

                /**
                 * The model data
                 */
                "models": {
                    "type": Array,
                    "value": DUDE_GRAPH_MODELS
                },

                /**
                 * The custom block types
                 */
                "blockTypes": {
                    "type": Array,
                    "value": DUDE_GRAPH_BLOCK_TYPES
                },

                /**
                 * The custom point types
                 */
                "pointTypes": {
                    "type": Array,
                    "value": DUDE_GRAPH_POINT_TYPES
                },

                /**
                 * The custom renderer for blocks
                 */
                "renderBlockTypes": {
                    "type": Array,
                    "value": DUDE_GRAPH_RENDER_BLOCK_TYPES
                }
            },
            listeners: {
                "dude-graph-error": "_graphError",
                "dude-graph-success": "_graphSuccess",
                "dude-graph-save": "_graphSave",
                "dude-graph-build": "_graphBuild"
            },

            /**
             * Initializes dude-graph
             */
            attached: function () {
              this.$.dudeGraphElement.initialize();
            },

            /**
             * Shows graph error
             * @param {CustomEvent} e
             * @param {Object} e.detail
             * @param {Error} e.detail.error
             * @param {String} e.detail.error.message
             * @private
             */
            _graphError: function (e) {
                this._error(e.detail.error.message);
            },

            /**
             * Shows graph success
             * @param {CustomEvent} e
             * @param {String} e.detail
             * @private
             */
            _graphSuccess: function (e) {
                this._success(e.detail);
            },

            /**
             * Saves the graph and renderer data to local storage
             * @param {CustomEvent} e
             * @param {Object} e.detail
             * @param {Object} e.detail.graphData
             * @param {Object} e.detail.rendererData
             * @private
             */
            _graphSave: function (e) {
                this.set("graphData", e.detail.graphData);
                this.set("rendererData", e.detail.rendererData);
                this._success("Story saved!");
            },

            /**
             * Builds the graph
             * @private
             */
            _graphBuild: function () {
                try {
                    var vm = new CelestoryBuilder(this.$.dudeGraphElement.get("graph")).build();
                    this._success(JSON.stringify(vm, null, ' '));
                    console.log(JSON.stringify(vm, null, ' '));
                } catch (e) {
                    this._error(e);
                }
            },

            /**
             * Handles the error and shows an error toast
             * @param {String} message
             * @private
             */
            _error: function (message) {
                this.$.error.text = message;
                this.$.error.open();
            },

            /**
             * Handles the success and shows a success toast
             * @param {String} message
             * @private
             */
            _success: function (message) {
                this.$.success.text = message;
                this.$.success.open();
            }
        });
    </script>
</dom-module>