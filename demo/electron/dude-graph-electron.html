<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
-->
<script src="bower_components/eventEmitter/EventEmitter.min.js"></script>
<script>EventEmitter = module.exports;</script>
<script src="bower_components/d3/d3.min.js"></script>
<script>d3 = module.exports;</script>
<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">
<link rel="import" href="bower_components/dude-graph/dude-graph-editor.html">
<link rel="import" href="bower_components/dude-graph/dude-graph-inspector.html">
<link rel="import" href="bower_components/dude-toolbar/dude-toolbar.html">
<script src="data.js"></script>
<!--
`dude-graph-electron` is a Polymer element to wrap a dude-graph in an electron shell.
-->
<dom-module id="dude-graph-electron">
    <template>
        <style>
            #success {
                color: var(--text-primary-color);
                background: var(--paper-green-500);
            }
            #error {
                color: var(--text-primary-color);
                background: var(--paper-red-500);
            }
        </style>
        <div class="layout horizontal fit">
            <div class="layout vertical flex">
                <div class="layout horizontal flex">
                    <paper-toast id="success"></paper-toast>
                    <paper-toast id="error"></paper-toast>
                    <dude-graph-editor id="editor"
                                       class="layout horizontal flex-3"
                                       models="[[ models ]]"
                                       resources="[[ resources ]]"
                                       block-types="[[ blockTypes ]]"
                                       point-types="[[ pointTypes ]]"
                                       render-block-types="[[ renderBlockTypes ]]"
                                       on-dude-graph-editor-error="_error">
                    </dude-graph-editor>
                    <dude-graph-inspector id="inspector"
                                          class="layout horizontal flex"
                                          on-dude-graph-inspector-save="_save"
                                          on-dude-graph-inspector-build="_build">
                    </dude-graph-inspector>
                </div>
                <dude-toolbar id="toolbar"></dude-toolbar>
            </div>
        </div>
    </template>
    <script>
        const ipcRenderer = require("electron").ipcRenderer;
        Polymer({
            is: "dude-graph-electron",
            properties: {
                "models": {
                    "value": DUDE_GRAPH_MODELS
                },
                "resources": {
                    "value": []
                },
                "blockTypes": {
                    "value": DUDE_GRAPH_BLOCK_TYPES
                },
                "pointTypes": {
                    "value": DUDE_GRAPH_POINT_TYPES
                },
                "renderBlockTypes": {
                    "value": DUDE_GRAPH_RENDER_BLOCK_TYPES
                }
            },
            ready: function () {
                var dudeGraphElectron = this;
                this.$.editor.start();
                this.$.inspector.start(this.$.editor);
                this.$.toolbar.addCommand({
                    icon: "fa fa-save",
                    description: "Save graph",
                    shortcut: ["ctrl+s", "meta+s"],
                    action: function (e) { this.$.inspector.shortcutSave(e); }.bind(this)
                });
                this.$.toolbar.addCommand({
                    icon: "fa fa-play",
                    description: "Build graph",
                    shortcut: ["ctrl+b", "meta+b"],
                    action: function (e) { this.$.inspector.shortcutBuild(e); }.bind(this)
                });
                this.$.toolbar.addCommand({
                    icon: "fa fa-trash",
                    description: "Remove selection",
                    shortcut: ["del", "meta+backspace"],
                    action: function (e) { this.$.inspector.shortcutRemoveSelection(e); }.bind(this)
                });
                this.$.toolbar.addCommand({
                    icon: "fa fa-square-o",
                    description: "Create group",
                    shortcut: ["ctrl+g", "meta+g"],
                    action: function (e) { this.$.inspector.shortcutCreateRenderGroup(e); }.bind(this)
                });
                this.$.toolbar.addCommand({
                    icon: "fa fa-compress",
                    description: "Zoom to fit",
                    shortcut: ["ctrl+0", "meta+0"],
                    action: function (e) { this.$.inspector.shortcutZoomToFit(e); }.bind(this)
                });
                this.$.toolbar.addCommand({
                    hidden: true,
                    icon: "fa fa-compress",
                    description: "Zoom to selection",
                    shortcut: ["ctrl+shift+0", "meta+shift+0"],
                    action: function (e) { this.$.inspector.shortcutZoomToFit(e); }.bind(this)
                });
                this.$.toolbar.addCommand({
                    hidden: true,
                    icon: "fa fa-circle",
                    description: "Select blocks",
                    shortcut: ["ctrl+shift+a", "meta+shift+a"],
                    action: function (e) { this.$.inspector.shortcutSelectAll(e); }.bind(this)
                });
                this.$.toolbar.addCommand({
                    hidden: true,
                    icon: "fa fa-circle",
                    description: "Select groups",
                    shortcut: ["ctrl+alt+a", "meta+alt+a"],
                    action: function (e) { this.$.inspector.shortcutSelectAll(e); }.bind(this)
                });
                this.$.toolbar.addCommand({
                    hidden: true,
                    icon: "fa fa-circle",
                    description: "Select all",
                    shortcut: ["ctrl+shift+alt+a", "meta+shift+alt+a"],
                    action: function (e) { this.$.inspector.shortcutSelectAll(e); }.bind(this)
                });
                ipcRenderer.on("dude-graph-load", function (e, dudeGraphData) {
                    if (!_.isUndefined(dudeGraphData.models)) {
                        dudeGraphElectron.set("models", dudeGraphData.models);
                    }
                    dudeGraphElectron.set("resources", dudeGraphData.resources);
                    dudeGraphElectron.$.editor.load(
                            dudeGraphData.graphData || DUDE_GRAPH_DEFAULT_GRAPH_DATA,
                            dudeGraphData.rendererData || DUDE_GRAPH_DEFAULT_RENDERER_DATA);
                    ipcRenderer.send("dude-graph-loaded");
                });
                ipcRenderer.on("dude-graph-resource-added", function (e, resource) {
                    var resources = dudeGraphElectron.get("resources");
                    for (var i = 0; i < resources.length; ++i) {
                        if (resource.item.file_name == resources[i].item.file_name) {
                            return;
                        }
                    }
                    dudeGraphElectron.push("resources", resource);
                });
                ipcRenderer.on("dude-graph-resource-removed", function (e, resource) {
                    var resources = dudeGraphElectron.get("resources");
                    for (var i = 0; i < resources.length; ++i) {
                        if (resource.item.file_name === resources[i].item.file_name) {
                            dudeGraphElectron.splice("resources", i, 1);
                            break;
                        }
                    }
                });
                ipcRenderer.on("dude-graph-saved", function () {
                    dudeGraphElectron._success("Saved!");
                });
                ipcRenderer.on("dude-graph-built", function () {
                    dudeGraphElectron._success("Built!");
                });
                ipcRenderer.send("dude-graph-ready");
            },
            _save: function (e) {
                ipcRenderer.send("dude-graph-save", e.detail);
            },
            _build: function (e) {
                try {
                    var graphBuilt = new DUDE_GRAPH_BUILDER().build(this.$.editor.get("graph"));
                    ipcRenderer.send("dude-graph-build", graphBuilt);
                } catch (exception) {
                    this._error({
                        "detail": {
                            "error": exception
                        }
                    });
                }
            },
            _success: function (message) {
                this.$.success.text = message;
                this.$.success.show();
            },
            _error: function (e) {
                this.$.error.text = e.detail.error;
                this.$.error.show();
            }
        });
    </script>
</dom-module>