var pandora=function(){var t="undefined"==typeof Module?{}:Module;return"undefined"!=typeof exports&&("undefined"!=typeof module&&module.exports&&(exports=module.exports=t),exports.pandora=t),t}();pandora.typename=function(t){if(void 0!==t.constructor.typename)return t.constructor.typename;switch(typeof t){case"boolean":return"Boolean";case"number":return"Number";case"string":return"String";case"function":return"Function";case"object":if(t instanceof Array)return"Array";if(t instanceof Object)return"Object"}return null===t?"null":void 0===t?"undefined":"Unknown"},pandora.class_=function(){for(var t=arguments[0],e=arguments[arguments.length-1],n=1;n<arguments.length-1;++n){if("function"!=typeof arguments[n])throw new pandora.Exception("{0} is not a valid constructor type",pandora.typename(arguments[n]));var r=arguments[n].prototype;for(var o in r)r.hasOwnProperty(o)&&(e.prototype[o]=r[o])}return Object.defineProperty(e,"typename",{value:t,writable:!1}),e},pandora.polymorphic=function(t,e){var n=pandora.typename(t);if(void 0===e[n]){if(void 0===e._)throw new pandora.MissingOverloadError(n);return e._()}return e[n]()},pandora.polymorphicMethod=function(t,e,n){var r=pandora.typename(n),o=t["_"+e+r];if(void 0===o)throw new pandora.MissingOverloadError(e+r,pandora.typename(t));return o.apply(t,Array.prototype.slice.call(arguments,2))},pandora.preventCallback=function(t,e,n){void 0!==t.preventDefault&&void 0!==t.stopPropagation&&void 0!==t.stopImmediatePropagation&&(n=t),n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation()},pandora.defaultCallback=function(){},pandora.mouseWheel=function(t,e){var n=function(t){t||(t=event);var n=0;n=t.wheelDelta?t.wheelDelta/360:t.detail/-9,e(t,n)};t.addEventListener("DOMMouseScroll",n,!1),t.addEventListener("mousewheel",n,!1)},pandora.EventEmitter=function(){var t=pandora.class_("EventEmitter",function(){this._listeners={}});return t.prototype.on=function(t,e){void 0===this._listeners[t]&&(this._listeners[t]=[]),this._listeners[t].push(e)},t.prototype.off=function(t){this._listeners[t]=[]},t.prototype.emit=function(t){if(void 0!==this._listeners[t])for(var e=0;e<this._listeners[t].length;++e)this._listeners[t][e].apply(this,Array.prototype.slice.call(arguments,1))},t}(),pandora.formatString=function(){var t=arguments[0],e=arguments[1];return 1===arguments.length?t:e&&"object"==typeof e?pandora.formatDictionary.apply(this,arguments):pandora.formatArray.apply(this,arguments)},pandora.formatArray=function(){var t=Array.prototype.slice.call(arguments,1);return arguments[0].replace(/{(\d+)}/g,function(e,n){return t[n]})},pandora.formatDictionary=function(){var t=/\{([^\}]+)\}/g,e=/(?:(?:^|\.)(.+?)(?=\[|\.|$|\()|\[('|")(.+?)\2\])(\(\))?/g,n=function(t,n,r){var o=r;return n.replace(e,function(t,e,n,r,i){e=e||r,void 0!==o&&(e in o&&(o=o[e]),"function"==typeof o&&i&&(o=o()))}),o=(null===o||o===r?t:o)+""};return function(e,r){return String(e).replace(t,function(t,e){return n(t,e,r)})}}(),pandora.camelcase=function(t,e){return e=e||"-",t[0].toUpperCase()+t.replace(new RegExp("("+e+"[a-z])","g"),function(t){return t.toUpperCase().replace(e,"")}).substr(1)},pandora.uncamelcase=function(t,e){return t.replace(/([A-Z])/g,function(t){return e+t.toLowerCase()}).substr(1)},pandora.forEach=function(t,e){pandora.polymorphic(t,{Array:function(){for(var n=0;n<t.length;++n)if(e(t[n],n)===!0)return},Object:function(){for(var n in t)if(t.hasOwnProperty(n)&&e(t[n],n)===!0)return}})},pandora.mergeObjects=function(t,e,n,r){for(var o in e)e.hasOwnProperty(o)&&(n&&"object"==typeof e[o]?(t[o]=t[o]||{},pandora.mergeObjects(t[o],e[o],n)):(r||void 0===t[o])&&(t[o]=e[o]));return t},pandora.Exception=function(){return pandora.class_("Exception",function(){var t=new Error(pandora.formatString.apply(null,arguments));return t.name=pandora.typename(this),t})}(),pandora.MissingOverloadError=function(){return pandora.class_("MissingOverloadError",pandora.Exception,function(t,e){var n=void 0!==e?e+".prototype._":"_";return pandora.Exception.call(this,"{0}{1}() overload is missing",n,t)})}(),pandora.clamp=function(t,e,n){return Math.min(Math.max(t,e),n)},pandora.Box2=function(){var t=pandora.class_("Box2",function(t,e,n,r){this.assign(t,e,n,r)});return t.prototype.assign=function(){var t=arguments[0],e=arguments[1],n=arguments[2],r=arguments[3];return void 0===t?(this.x=0,this.y=0,this.width=0,this.height=0):"Number"===pandora.typename(t)&&void 0===e?(this.x=t,this.y=t,this.width=t,this.height=t):"Vec2"===pandora.typename(t)&&"Vec2"===pandora.typename(e)?(this.x=t.x,this.y=t.y,this.width=e.x,this.height=e.y):"Array"===pandora.typename(t)?(this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]):void 0!==t.x&&void 0!==t.y&&void 0!==t.width&&void 0!==t.height?(this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height):void 0!==t.left&&void 0!==t.right&&void 0!==t.top&&void 0!==t.bottom?(this.x=t.left,this.y=t.top,this.width=t.right-t.left,this.height=t.bottom-t.top):(this.x=t,this.y=e,this.width=n,this.height=r),this},t.prototype.clone=function(){return new t(this.x,this.y,this.width,this.height)},t.prototype.toArray=function(){return[this.x,this.y,this.width,this.height]},t.prototype.collide=function(t){return pandora.polymorphic(t,{Vec2:function(){return t.x>=this.x&&t.x<=this.x+this.width&&t.y>=this.y&&t.y<=this.y+this.height}.bind(this),Box2:function(){return this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.height+this.y>t.y}.bind(this)})},t.prototype.contain=function(t){return pandora.polymorphic(t,{Vec2:function(){return t.x>=this.x&&t.x<=this.x+this.width&&t.y>=this.y&&t.y<=this.y+this.height}.bind(this),Box2:function(){return t.x>this.x&&t.x+t.width<this.x+this.width&&t.y>this.y&&t.y+t.height<this.y+this.height}.bind(this)})},t}(),pandora.Vec2=function(){var t=pandora.class_("Vec2",function(t,e){this.assign(t,e)});return t.prototype.assign=function(){var t=arguments[0],e=arguments[1];return void 0===t?(this.x=0,this.y=0):"number"==typeof t&&void 0===e?(this.x=t,this.y=t):"Array"===pandora.typename(t)?(this.x=t[0],this.y=t[1]):"Vec2"===pandora.typename(t)||"number"==typeof t.x&&"number"==typeof t.y?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e),this},t.prototype.clone=function(){return new t(this.x,this.y)},t.prototype.toArray=function(){return[this.x,this.y]},t.prototype.collideCircle=function(t,e){e=e||5;var n=this.x-t.x,r=this.y-t.y;return Math.sqrt(n*n+r*r)<2*e},t.prototype.add=function(t){return pandora.polymorphic(t,{Number:function(){this.x+=t,this.y+=t}.bind(this),Vec2:function(){this.x+=t.x,this.y+=t.y}.bind(this)}),this},t.prototype.subtract=function(t){return pandora.polymorphic(t,{Number:function(){this.x-=t,this.y-=t}.bind(this),Vec2:function(){this.x-=t.x,this.y-=t.y}.bind(this)}),this},t.prototype.multiply=function(t){return pandora.polymorphic(t,{Number:function(){this.x*=t,this.y*=t}.bind(this),Vec2:function(){this.x*=t.x,this.y*=t.y}.bind(this)}),this},t.prototype.divide=function(t){return pandora.polymorphic(t,{Number:function(){this.x/=t,this.y/=t}.bind(this),Vec2:function(){this.x/=t.x,this.y/=t.y}.bind(this)}),this},t}();var dudeGraph=function(){var t={};return"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=t),exports.dudeGraph=t):window.dudeGraph=t,t}();!function(){_.mixin({clamp:function(t,e,n){return Math.min(Math.max(t,e),n)}})}(),function(){var t=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},e=t();_.mixin({uuid:function(){return e+"-"+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()}})}(),dudeGraph.Graph=function(){pandora.EventEmitter.call(this),this._cgTypes={Stream:["Stream"],Array:["Array"],String:["String"],Number:["Number","Boolean"],Boolean:["Boolean","Number"],Vec2:["Vec2"],Vec3:["Vec3"],Vec4:["Vec4"],Color:["Color","Vec4"],Texture2D:["Texture2D"],Entity:["Entity"],Resource:["Resource"]},this._validators={Array:function(t){return _.isArray(t)},String:function(t){return _.isString(t)},Number:function(t){return _.isNumber(t)||/^[0-9]+(\.[0-9]+)?$/.test(t)},Boolean:function(t){return _.isBoolean(t)||/^(true|false)/.test(t)},Resource:function(t){return _.isObject(t)}},Object.defineProperty(this,"cgBlocks",{get:function(){return this._cgBlocks}.bind(this)}),this._cgBlocks=[],Object.defineProperty(this,"cgBlocksIds",{get:function(){return this._cgBlocksIds}.bind(this)}),this._cgBlocksIds={},Object.defineProperty(this,"cgConnections",{get:function(){return this._cgConnections}.bind(this)}),this._cgConnections=[]},dudeGraph.Graph.prototype=_.create(pandora.EventEmitter.prototype,{constructor:dudeGraph.Graph}),dudeGraph.Graph.prototype.addBlock=function(t,e){var n=t.cgId;if(t.cgGraph!==this)throw new Error("This block does not belong to this graph");if(null===n||_.isUndefined(n))throw new Error("Block id is null");if(this._cgBlocksIds[n])throw new Error("Block with id `"+n+"` already exists");return t.validate(),this._cgBlocks.push(t),this._cgBlocksIds[n]=t,e||this.emit("dude-graph-block-create",t),t},dudeGraph.Graph.prototype.removeBlock=function(t){var e=this._cgBlocks.indexOf(t);if(-1===e||t.cgGraph!==this)throw new Error("This block does not belong to this graph");var n=t.cgOutputs.concat(t.cgInputs);_.forEach(n,function(t){this.disconnectPoint(t)}.bind(this)),this._cgBlocks.splice(e,1),delete this._cgBlocksIds[t.cgId],this.emit("dude-graph-block-remove",t)},dudeGraph.Graph.prototype.blockById=function(t){var e=this._cgBlocksIds[t];if(!e)throw new Error("Block not found for id `"+t+"`");return e},dudeGraph.Graph.prototype.blockByName=function(t){var e=null;return _.forEach(this.cgBlocks,function(n){n.cgName===t&&(e=n)}),e},dudeGraph.Graph.prototype.blocksByType=function(t){var e=[];return _.forEach(this.cgBlocks,function(n){n.blockType===t&&e.push(n)}),e},dudeGraph.Graph.prototype.nextBlockId=function(){return _.uuid()},dudeGraph.Graph.prototype.connectPoints=function(t,e){if(null!==this.connectionByPoints(t,e))throw new Error("Connection already exists between these two points: `"+t.cgName+"` and `"+e.cgName+"`");if(t.isOutput===e.isOutput)throw new Error("Cannot connect either two inputs or two outputs: `"+t.cgName+"` and `"+e.cgName+"`");if(!t.acceptConnect(e))throw new Error("Point `"+t.cgName+"` does not accept to connect to `"+e.cgName+"` (too many connections)");if(!e.acceptConnect(t))throw new Error("Point `"+e.cgName+"` does not accept to connect to `"+t.cgName+"` (too many connections)");if(!this.canConvert(t.cgValueType,e.cgValueType)&&!this.updateTemplate(e,t.cgValueType))throw new Error("Cannot connect two points of different value types: `"+t.cgValueType+"` and `"+e.cgValueType+"`");var n=new dudeGraph.Connection(t,e);return this._cgConnections.push(n),t._cgConnections.push(n),e._cgConnections.push(n),this.emit("dude-graph-connection-create",n),n},dudeGraph.Graph.prototype.disconnectPoints=function(t,e){var n=this.connectionByPoints(t,e);if(null===n)throw new Error("No connections between these two points: `"+t.cgName+"` and `"+e.cgName+"`");return this._cgConnections.splice(this._cgConnections.indexOf(n),1),t._cgConnections.splice(t._cgConnections.indexOf(n),1),e._cgConnections.splice(e._cgConnections.indexOf(n),1),this.emit("dude-graph-connection-remove",n),n},dudeGraph.Graph.prototype.disconnectPoint=function(t){var e=t.cgConnections;_.forEach(e,function(t){this.disconnectPoints(t.cgOutputPoint,t.cgInputPoint)}.bind(this))},dudeGraph.Graph.prototype.connectionsByBlock=function(t){var e=[];return _.forEach(this._cgConnections,function(n){(n.cgOutputPoint.cgBlock===t||n.cgInputPoint.cgBlock===t)&&e.push(n)}),e},dudeGraph.Graph.prototype.connectionByPoints=function(t,e){return _.find(this._cgConnections,function(n){return n.cgOutputPoint===t&&n.cgInputPoint===e})||null},dudeGraph.Graph.prototype.connectionsByPoint=function(t){var e=[];return _.forEach(this._cgConnections,function(n){(n.cgOutputPoint===t||n.cgInputPoint===t)&&e.push(n)}),e},dudeGraph.Graph.prototype.cloneBlocks=function(t){var e=[],n=[],r=[];return _.forEach(t,function(o){var i=this.connectionsByBlock(o),c=o.clone(this);this.addBlock(c),n.push(c),e[o.cgId]=c,_.forEach(i,function(e){-1===r.indexOf(e)&&-1!==t.indexOf(e.cgOutputPoint.cgBlock)&&-1!==t.indexOf(e.cgInputPoint.cgBlock)&&r.push(e)})}.bind(this)),_.forEach(r,function(t){try{e[t.cgOutputPoint.cgBlock.cgId].outputByName(t.cgOutputPoint.cgName).connect(e[t.cgInputPoint.cgBlock.cgId].inputByName(t.cgInputPoint.cgName))}catch(n){throw new Error("Connection duplication silenced exception: "+n)}}),n},dudeGraph.Graph.prototype.addValidator=function(t,e){this._validators[t]=e},dudeGraph.Graph.prototype.canConvert=function(t,e){return t===e||this._cgTypes[t]&&-1!==this._cgTypes[t].indexOf(e)},dudeGraph.Graph.prototype.canAssign=function(t,e){return null===t||this._validators[e]&&this._validators[e](t)},dudeGraph.Graph.prototype.updateTemplate=function(t,e){return t.cgBlock.updateTemplate(t,e)},dudeGraph.Block=function(t,e,n){if(e=e||{},Object.defineProperty(this,"cgGraph",{get:function(){return this._cgGraph}.bind(this)}),this._cgGraph=t,!t)throw new Error("Block() Cannot create a Block without a graph");Object.defineProperty(this,"blockType",{get:function(){return this._blockType}.bind(this)}),this._blockType=n||"Block",Object.defineProperty(this,"cgId",{get:function(){return this._cgId}.bind(this)}),this._cgId=e.cgId||t.nextBlockId(),Object.defineProperty(this,"cgName",{get:function(){return this._cgName}.bind(this),set:function(t){var e=this._cgName;this._cgName=t,this._cgGraph.emit("dude-graph-block-name-change",this,e,t)}.bind(this)}),this._cgName=e.cgName||this._blockType,Object.defineProperty(this,"cgTemplates",{get:function(){return this._cgTemplates}.bind(this)}),this._cgTemplates=e.cgTemplates||{},Object.defineProperty(this,"cgInputs",{get:function(){return this._cgInputs}.bind(this)}),this._cgInputs=[],Object.defineProperty(this,"cgOutputs",{get:function(){return this._cgOutputs}.bind(this)}),this._cgOutputs=[]},dudeGraph.Block.prototype.validate=function(){},dudeGraph.Block.prototype.addPoint=function(t){if(t.cgBlock!==this)throw new Error("Point `"+t.cgName+"` is not bound to this block `"+this._cgId+"`");if(t.isOutput&&this.outputByName(t.cgName)||!t.isOutput&&this.inputByName(t.cgName))throw new Error("Block `"+this._cgId+"` has already an "+(t.isOutput?"output":"input")+": `"+t.cgName+"`");return t.isOutput?this._cgOutputs.push(t):this._cgInputs.push(t),this._cgGraph.emit("cg-point-create",this,t),t},dudeGraph.Block.prototype.outputByName=function(t){return _.find(this._cgOutputs,function(e){return e.cgName===t})},dudeGraph.Block.prototype.inputByName=function(t){return _.find(this._cgInputs,function(e){return e.cgName===t})},dudeGraph.Block.prototype.updateTemplate=function(t,e){if(null===t.cgTemplate||!this.cgTemplates[t.cgTemplate]||-1===this.cgTemplates[t.cgTemplate].indexOf(e))return!1;t.cgValueType=e;var n=!1,r=function(r){if(n)return!0;if(r.cgTemplate===t.cgTemplate){if(0!==t.cgConnections.length)return n=!0,!0;r.cgValueType=e}};return _.forEach(this._cgInputs,r.bind(this)),_.forEach(this._cgOutputs,r.bind(this)),!n},dudeGraph.Block.prototype.clone=function(t){if("Block"!==this._blockType)throw new Error("Method `clone` must be overridden by `"+this._blockType+"`");var e=new dudeGraph.Block(t);return e.cgName=this._cgName,_.forEach(this._cgOutputs,function(t){var n=t.clone(e);e.addPoint(n)}),_.forEach(this._cgInputs,function(t){var n=t.clone(e);e.addPoint(n)}),e},dudeGraph.Point=function(t,e,n,r){if(Object.defineProperty(this,"cgGraph",{get:function(){return this._cgGraph}.bind(this)}),this._cgGraph=t.cgGraph,Object.defineProperty(this,"pointType",{get:function(){return this._pointType}.bind(this)}),this._pointType=r||"Point",Object.defineProperty(this,"cgBlock",{get:function(){return this._cgBlock}.bind(this)}),this._cgBlock=t,Object.defineProperty(this,"cgName",{get:function(){return this._cgName}.bind(this)}),this._cgName=e.cgName||this._pointType,Object.defineProperty(this,"isOutput",{get:function(){return this._isOutput}.bind(this)}),this._isOutput=n,Object.defineProperty(this,"cgConnections",{get:function(){return this._cgConnections}.bind(this)}),this._cgConnections=[],Object.defineProperty(this,"singleConnection",{get:function(){return this._singleConnection}.bind(this),set:function(t){this._singleConnection=t}.bind(this)}),this._singleConnection=_.isUndefined(e.singleConnection)?!0:e.singleConnection,Object.defineProperty(this,"cgTemplate",{get:function(){return this._cgTemplate}.bind(this)}),this._cgTemplate=e.cgTemplate||null,Object.defineProperty(this,"cgValueType",{get:function(){return this._cgValueType}.bind(this),set:function(t){var e=this._cgValueType;this._cgValueType=t,this._cgGraph.emit("cg-point-value-type-change",this,e,t)}.bind(this)}),this._cgValueType=e.cgValueType,_.isUndefined(e.cgValueType))throw new Error("Cannot create the point `"+this._cgName+"` in block `"+this._cgBlock.cgId+"` without specifying a value type");if(Object.defineProperty(this,"cgValue",{configurable:!0,get:function(){return this._cgValue}.bind(this),set:function(t){if(null!==t&&!this.acceptValue(t))throw new Error("Cannot set `cgValue`: Point `"+this._cgName+"` cannot accept more than one connection");if(!this._cgGraph.canAssign(t,this._cgValueType))throw new Error("Invalid value `"+String(t)+"` for `"+this._cgValueType+"` in `"+this._cgName+"`");var e=this._cgValue;this._cgValue=t,this._cgGraph.emit("cg-point-value-change",this,e,t)}.bind(this)}),this._cgValue=e.cgValue||null,!_.isUndefined(e.cgValue)&&n)throw new Error("Shouldn't create output point `"+this._cgName+"` in block `"+this._cgBlock.cgId+"` with a value.")},dudeGraph.Point.prototype.empty=function(){return 0===this._cgConnections.length&&null===this._cgValue},dudeGraph.Point.prototype.acceptConnect=function(t){return!this._singleConnection||0===this._cgConnections.length&&null===this._cgValue},dudeGraph.Point.prototype.acceptValue=function(t){return!this._singleConnection||0===this._cgConnections.length},dudeGraph.Point.prototype.connect=function(t){return this._isOutput?this._cgGraph.connectPoints(this,t):this._cgGraph.connectPoints(t,this)},dudeGraph.Point.prototype.disconnect=function(t){return this._isOutput?this._cgGraph.disconnectPoints(this,t):this._cgGraph.disconnectPoints(t,this)},dudeGraph.Point.prototype.clone=function(t){if("Point"!==this._pointType)throw new Error("Method `clone` must be overridden by `"+this._pointType+"`");return new dudeGraph.Point(t,{cgName:this._cgName,cgValueType:this._cgValueType,cgValue:this._cgValue},this._isOutput)},dudeGraph.Connection=function(t,e){if(Object.defineProperty(this,"cgOutputPoint",{get:function(){return this._cgOutputPoint}.bind(this)}),this._cgOutputPoint=t,!t.isOutput)throw new Error("outputPoint is not an output");if(Object.defineProperty(this,"cgInputPoint",{get:function(){return this._cgInputPoint}.bind(this)}),this._cgInputPoint=e,e.isOutput)throw new Error("inputPoint is not an input")},dudeGraph.Connection.prototype.otherPoint=function(t){if(t===this._cgOutputPoint)return this._cgInputPoint;if(t===this._cgInputPoint)return this._cgOutputPoint;throw new Error("Point `"+t.cgName+"` is not in this connection")},dudeGraph.Connection.prototype.remove=function(){},dudeGraph.Stream=function(t,e,n){dudeGraph.Point.call(this,t,_.merge(e,{cgName:e.cgName,cgValueType:"Stream"}),n,"Stream"),Object.defineProperty(this,"cgValue",{get:function(){throw new Error("Stream has no `cgValue`.")}.bind(this),set:function(){throw new Error("Stream has no `cgValue`.")}.bind(this)})},dudeGraph.Stream.prototype=_.create(dudeGraph.Point.prototype,{constructor:dudeGraph.Stream}),dudeGraph.Stream.prototype.clone=function(t){return new dudeGraph.Stream(t,this._cgName,this._isOutput)},dudeGraph.Assignation=function(t,e){dudeGraph.Block.call(this,t,e,"Assignation")},dudeGraph.Assignation.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Assignation}),dudeGraph.Assignation.prototype.validate=function(){if(!(this.inputByName("in")instanceof dudeGraph.Stream))throw new Error("Assignation `"+this.cgId+"` must have an input `in` of type `Stream`");if(!(this.inputByName("this")instanceof dudeGraph.Point))throw new Error("Assignation `"+this.cgId+"` must have an input `this` of type `Point`");if(!(this.inputByName("other")instanceof dudeGraph.Point))throw new Error("Assignation `"+this.cgId+"` must have an input `other` of type `Point`");if(this.inputByName("this")._cgValueType!==this.inputByName("other")._cgValueType)throw new Error("Assignation `"+this.cgId+"` inputs `this` and `other` must have the same cgValueType");if(!(this.outputByName("out")instanceof dudeGraph.Stream))throw new Error("Assignation `"+this.cgId+"` must have an output `out` of type `Stream`")},dudeGraph.Condition=function(t,e){dudeGraph.Block.call(this,t,e,"Condition")},dudeGraph.Condition.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Condition}),dudeGraph.Condition.prototype.validate=function(){if(!(this.inputByName("in")instanceof dudeGraph.Stream))throw new Error("Condition `"+this.cgId+"` must have an input `in` of type `Stream`");if(!(this.inputByName("test")instanceof dudeGraph.Point)||"Boolean"!==this.inputByName("test").cgValueType)throw new Error("Condition `"+this.cgId+"` must have an input `test` of type `Point` of cgValueType `Boolean`");if(!(this.outputByName("true")instanceof dudeGraph.Stream))throw new Error("Condition `"+this.cgId+"` must have an output `true` of type `Stream`");if(!(this.outputByName("false")instanceof dudeGraph.Stream))throw new Error("Condition `"+this.cgId+"` must have an output `false` of type `Stream`")},dudeGraph.Delegate=function(t,e){dudeGraph.Block.call(this,t,e,"Delegate")},dudeGraph.Delegate.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Delegate}),dudeGraph.Delegate.prototype.validate=function(){if(!(this.outputByName("out")instanceof dudeGraph.Stream))throw new Error("Delegate `"+this.cgId+"` must have an output `out` of type `Stream`")},dudeGraph.Each=function(t,e){dudeGraph.Block.call(this,t,e,"Each")},dudeGraph.Each.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Each}),dudeGraph.Function=function(t,e){dudeGraph.Block.call(this,t,e,"Function")},dudeGraph.Function.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Function}),dudeGraph.Getter=function(t,e){dudeGraph.Block.call(this,t,e,"Getter")},dudeGraph.Getter.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Getter}),dudeGraph.Instruction=function(t,e){dudeGraph.Block.call(this,t,e,"Instruction")},dudeGraph.Instruction.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Instruction}),dudeGraph.Instruction.prototype.validate=function(){if(!(this.inputByName("in")instanceof dudeGraph.Stream))throw new Error("Instruction `"+this.cgId+"` must have an input `in` of type `Stream`");if(!(this.outputByName("out")instanceof dudeGraph.Stream))throw new Error("Instruction `"+this.cgId+"` must have an output `out` of type `Stream`")},dudeGraph.Operator=function(t,e){dudeGraph.Block.call(this,t,e,"Operator")},dudeGraph.Operator.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Operator}),dudeGraph.Operator.prototype.validate=function(){if(2!==this.cgInputs.length)throw new Error("Operator `"+this.cgId+"` must only take 2 inputs");if(1!==this.cgOutputs.length)throw new Error("Operator `"+this.cgId+"` must return one value")},dudeGraph.Range=function(t,e){dudeGraph.Block.call(this,t,e,"Range")},dudeGraph.Range.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Range}),dudeGraph.Variable=function(t,e){dudeGraph.Block.call(this,t,e,"Variable"),Object.defineProperty(this,"cgValueType",{get:function(){return this._cgValueType}.bind(this)}),this._cgValueType=e.cgValueType,Object.defineProperty(this,"cgValue",{get:function(){return this._cgValue}.bind(this),set:function(t){this._cgValue=t,this.cgOutputs[0].cgValue=t}.bind(this)}),this._cgValue=e.cgValue},dudeGraph.Variable.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Variable}),dudeGraph.Variable.prototype.validate=function(){if(!(this.outputByName("value")instanceof dudeGraph.Point))throw new Error("Variable `"+this.cgId+"` must have an output `value` of type `Point`")},dudeGraph.Loader=function(){this._blockTypes={Block:dudeGraph.Block},this._pointTypes={Point:dudeGraph.Point}},dudeGraph.Loader.prototype.registerBlockType=function(t,e){this._blockTypes[t]=e},dudeGraph.Loader.prototype.registerPointType=function(t,e){this._pointTypes[t]=e},dudeGraph.Loader.prototype.load=function(t,e){var n=this;_.forEach(e.blocks,function(e){n.loadBlock(t,e)}),_.forEach(e.connections,function(e){n.loadConnection(t,e)})},dudeGraph.Loader.prototype.loadBlock=function(t,e){var n=this;if(!e.hasOwnProperty("cgId"))throw new Error("Block property `cgId` is required");var r=this._blockTypes[e.cgType];if(_.isUndefined(r))throw new Error("Block type `"+e.cgType+"` not registered by the loader");var o=new r(t,e,e.cgType);return _.forEach(e.cgOutputs,function(t){n.loadPoint(o,t,!0)}),_.forEach(e.cgInputs,function(t){n.loadPoint(o,t,!1)}),t.addBlock(o),o},dudeGraph.Loader.prototype.loadPoint=function(t,e,n){if(!e.cgName)throw new Error("Block `"+t.cgId+"`: Point property `cgName` is required");var r=e.cgType,o=this._pointTypes[r];if(!o)throw new Error("Point type `"+r+"` not registered by the loader");var i=new o(t,e,n);return t.addPoint(i),i},dudeGraph.Loader.prototype.loadConnection=function(t,e){var n=e.cgOutputBlockId,r=e.cgOutputName,o=e.cgInputBlockId,i=e.cgInputName,c=t.blockById(n);if(!c)throw new Error("Output block not found for id `"+n+"`");var d=t.blockById(o);if(!d)throw new Error("Input block not found for id `"+o+"`");var a=c.outputByName(r);if(!a)throw new Error("Output point `"+r+"` not found in block `"+n+"`");var u=d.inputByName(i);if(!u)throw new Error("Input point `"+i+"` not found in block `"+o+"`");a.connect(u)},dudeGraph.Saver=function(){},dudeGraph.Saver.prototype.save=function(t){var e=this;return{blocks:_.map(t.cgBlocks,function(t){return e.saveBlock(t)}),connections:_.map(t.cgConnections,function(t){return e.saveConnection(t)})}},dudeGraph.Saver.prototype.saveBlock=function(t){var e=this;return{cgType:t._blockType,cgId:t._cgId,cgName:t._cgName,cgInputs:_.map(t._cgInputs,function(t){return e.savePoint(t)}),cgOutputs:_.map(t._cgOutputs,function(t){return e.savePoint(t)})}},dudeGraph.Saver.prototype.savePoint=function(t){var e={cgType:t.pointType,cgName:t._cgName,cgValueType:t._cgValueType,singleConnection:t._singleConnection};return t._isOutput||(e.cgValue=t._cgValue),e},dudeGraph.Saver.prototype.saveConnection=function(t){return{cgOutputName:t._cgOutputPoint._cgName,cgOutputBlockId:t._cgOutputPoint._cgBlock._cgId,cgInputName:t._cgInputPoint._cgName,cgInputBlockId:t._cgInputPoint._cgBlock._cgId}},dudeGraph.Renderer=function(){this._graph=null,this._config=null,this._zoom=null,this._d3Svg=null,this._d3Root=null,this._d3Groups=null,this._d3Connections=null,this._d3Block=null,this._renderBlocks=null,this._renderGroups=null,this._renderConnections=null,this._renderBlockRenders=null,this._renderBlockIds=null,this._renderGroupIds=null,this._renderBlocksQuadtree=null,this._renderGroupsQuadtree=null,this._renderPointsQuadtree=null,Object.defineProperty(this,"d3Nodes",{get:function(){return this._d3Root.selectAll(".dude-graph-block, .dude-graph-group")}.bind(this)}),Object.defineProperty(this,"d3Blocks",{get:function(){return this._d3Block.selectAll(".dude-graph-block")}.bind(this)}),Object.defineProperty(this,"d3Groups",{get:function(){return this._d3Groups.selectAll(".dude-graph-group")}.bind(this)}),Object.defineProperty(this,"d3Connections",{get:function(){return this._d3Connections.selectAll(".dude-graph-connection")}.bind(this)})},dudeGraph.Renderer.prototype=_.create(EventEmitter.prototype,{constructor:dudeGraph.Renderer}),dudeGraph.Renderer.prototype.initialize=function(t,e,n){this._graph=t,this._d3Svg=d3.select(e),this._d3Root=this._d3Svg.append("svg:g").attr("id","dude-graph-renderer"),this._d3Groups=this._d3Root.append("svg:g").attr("id","dude-graph-groups"),this._d3Connections=this._d3Root.append("svg:g").attr("id","dude-graph-connections"),this._d3Block=this._d3Root.append("svg:g").attr("id","dude-graph-blocks"),this._renderBlocks=[],this._renderGroups=[],this._renderConnections=[],this._renderBlockTypes={Block:dudeGraph.RenderBlock},this._renderBlockIds={},this._renderGroupIds={},this._renderBlocksQuadtree=null,this._renderGroupsQuadtree=null,this._renderPointsQuadtree=null,this._config=_.defaultsDeep(n||{},dudeGraph.Renderer.defaultConfig)},dudeGraph.Renderer.prototype.registerRenderBlock=function(t,e){this._renderBlockTypes[t]=e},dudeGraph.Renderer.defaultConfig={zoom:{min:.25,max:5,margin:[10,10],transitionSpeed:800},block:{padding:10,header:40,size:[80,100]},group:{padding:10,header:30,size:[200,150]},point:{height:20,radius:3,offset:20}},dudeGraph.Renderer.defaultZoom={translate:[0,0],scale:1},dudeGraph.RenderNode=function(t){this._nodeId=t,Object.defineProperty(this,"nodeId",{configurable:!0,get:function(){return this._nodeId}.bind(this)}),this._nodeName=null,Object.defineProperty(this,"nodeName",{configurable:!0,get:function(){return this._nodeName}.bind(this),set:function(t){this._nodeName=t}.bind(this)}),Object.defineProperty(this,"nodeFancyName",{configurable:!0,get:function(){return this._nodeName+" (#"+this._nodeId+")"}.bind(this)}),this._nodeParent=null,Object.defineProperty(this,"nodeParent",{configurable:!0,get:function(){return this._nodeParent}.bind(this),set:function(t){null!==this._nodeParent&&this._nodeParent.removeChildRenderNode(this),t.addChildRenderNode(this),this._nodeParent=t}.bind(this)}),this._nodePosition=[0,0],Object.defineProperty(this,"nodePosition",{configurable:!0,get:function(){return this._nodePosition}.bind(this),set:function(t){this._nodePosition=t}.bind(this)}),this._nodeSize=[0,0],Object.defineProperty(this,"nodeSize",{configurable:!0,get:function(){return this._nodeSize}.bind(this),set:function(t){this._nodeSize=t}.bind(this)}),this._d3Node=null,Object.defineProperty(this,"d3Node",{configurable:!0,get:function(){return this._d3Node}.bind(this)})},dudeGraph.RenderNode.prototype.create=function(t){this._d3Node=t},dudeGraph.RenderNode.prototype.move=function(){this._d3Node.attr("transform","translate("+this._nodePosition+")")},dudeGraph.RenderNode.prototype.update=function(){this.move()},dudeGraph.RenderNode.prototype.remove=function(){},dudeGraph.RenderBlock=function(t,e){dudeGraph.RenderNode.call(this,t),this._block=e,Object.defineProperty(this,"block",{get:function(){return this._block}.bind(this)}),this._renderPoints=[],Object.defineProperty(this,"renderPoints",{get:function(){return this._renderPoints}.bind(this),set:function(t){this._renderPoints=t}.bind(this)}),this._d3Points=null,Object.defineProperty(this,"d3Points",{get:function(){return this._d3Points.selectAll(".dude-graph-point")}.bind(this)})},dudeGraph.RenderBlock.prototype=_.create(dudeGraph.RenderNode.prototype,{constructor:dudeGraph.RenderBlock}),dudeGraph.RenderBlock.prototype.create=function(t){dudeGraph.RenderNode.prototype.create.call(this,t),this._d3Rect=t.append("svg:rect"),this._d3Title=t.append("svg:text"),this._d3Points=t.append("svg:g").classed("dude-graph-points",!0),this.d3Points.data(this.renderPoints,function(t){return t.point.cgName}).enter().append("g").classed("dude-graph-point",!0).each(function(t){t.create(d3.select(this))})},dudeGraph.RenderBlock.prototype.update=function(){dudeGraph.RenderNode.prototype.update.call(this),this._d3Rect.attr({x:0,y:0,width:this._nodeSize[0],height:this._nodeSize[1]}),this._d3Title.text(this._nodeName),this.d3Points.each(function(t){t.update()}),this.move()},dudeGraph.RenderGroup=function(t){dudeGraph.RenderNode.call(this,t),this._childrenRenderNodes=[]},dudeGraph.RenderGroup.prototype=_.create(dudeGraph.RenderNode.prototype,{constructor:dudeGraph.RenderGroup}),dudeGraph.RenderGroup.prototype.addChildRenderNode=function(t){
var e=_.find(this._childrenRenderNodes,t);if(!_.isUndefined(e))throw new Error("`"+t.nodeFancyName+"` is already a child of `"+this.nodeFancyName+"`");this._childrenRenderNodes.push(t)},dudeGraph.RenderGroup.prototype.removeChildRenderNode=function(t){var e=_.find(this._childrenRenderNodes,t);if(_.isUndefined(e))throw new Error("`"+t.nodeFancyName+"` is not a child of `"+this.nodeFancyName+"`");_.pull(this._childrenRenderNodes,t)},dudeGraph.RenderGroup.prototype.create=function(t){dudeGraph.RenderNode.prototype.create.call(this,t)},dudeGraph.RenderPoint=function(t,e,n){this._renderBlock=t,Object.defineProperty(this,"renderBlock",{get:function(){return this._renderBlock}.bind(this)}),this._index=n,Object.defineProperty(this,"index",{get:function(){return this._index}.bind(this)}),this._point=e,Object.defineProperty(this,"point",{get:function(){return this._point}.bind(this)}),this._d3PointGroup=null,Object.defineProperty(this,"d3PointGroup",{get:function(){return this._d3PointGroup}.bind(this)})},dudeGraph.RenderPoint.prototype.create=function(t){this._d3PointGroup=t,t.append("svg:circle").attr({cx:100*this._point.isOutput,cy:20+20*this._index,r:5}),t.append("svg:text").text(this._point.cgName).attr({x:20+100*this._point.isOutput,y:20+20*this._index})},dudeGraph.RenderPoint.prototype.update=function(){},dudeGraph.RenderPoint.prototype.remove=function(){},dudeGraph.RenderVariable=function(t,e){dudeGraph.RenderBlock.call(this,t,e)},dudeGraph.RenderVariable.prototype=_.create(dudeGraph.RenderBlock.prototype,{constructor:dudeGraph.RenderBlock}),dudeGraph.Renderer.prototype._getRenderBlockById=function(t){return this._renderBlockIds[t]||null},dudeGraph.Renderer.prototype._createRenderBlock=function(t){if(!t.id)throw new Error("Cannot create a renderBlock without an id");if(null!==this._getRenderBlockById(t.id))throw new Error("Multiple renderBlocks for id `"+t.id+"`");var e=this._graph.blockById(t.cgBlock);if(!e)throw new Error("Cannot link cgBlock `"+t.cgBlock+"` to renderBlock `"+t.id+"`");var n=this._renderBlockTypes[e.blockType];if(!n)throw new Error("Render block `"+e.blockType+"` not registered in the renderer");var r=new n(t.id,e);return r.nodeName=t.description||e.cgName||"",r.nodePosition=t.position||[0,0],r.parentGroup=t.parent||null,r.renderPoints=Array.prototype.concat(_.map(e.cgOutputs,function(t,e){return new dudeGraph.RenderPoint(r,t,e)}),_.map(e.cgInputs,function(t,e){return new dudeGraph.RenderPoint(r,t,e)})),this._renderBlocks.push(r),this._renderBlockIds[r.nodeId]=r,r},dudeGraph.Renderer.prototype._getRenderGroupById=function(t){return this._renderGroupIds[t]||null},dudeGraph.Renderer.prototype._createRenderGroup=function(t){if(!t.id)throw new Error("Cannot create a renderGroup without an id");if(null!==this._getRenderGroupById(t.id))throw new Error("Multiple renderGroups for id `"+t.id+"`");var e=new dudeGraph.RenderGroup(t.id);return e.nodeName=t.description||"",e.parentGroup=t.parent||null,this._renderGroups.push(e),this._renderGroupIds[e.nodeId]=e,e},dudeGraph.Renderer.prototype._createD3Blocks=function(){this.d3Blocks.data(this._renderBlocks,function(t){return t.nodeId}).enter().append("svg:g").attr("id",function(t){return t.nodeId}).classed("dude-graph-block",!0).each(function(t){t.create(d3.select(this))}),this._updateD3Blocks()},dudeGraph.Renderer.prototype._updateD3Blocks=function(){this.d3Blocks.each(function(t){t.update()})},dudeGraph.Renderer.prototype._removeD3Blocks=function(){this.d3Blocks.data(this._renderBlocks,function(t){return t.nodeId}).exit().each(function(t){t.remove()}).remove()},dudeGraph.Renderer.prototype._createD3Groups=function(){this.d3Groups.data(this._renderGroups,function(t){return t.nodeId}).enter().append("svg:g").attr("id",function(t){return t.nodeId}).classed("dude-graph-group",!0).each(function(t){t.create(d3.select(this))}),this._updateD3Groups()},dudeGraph.Renderer.prototype._updateD3Groups=function(){this.d3Groups.each(function(t){t.update()})},dudeGraph.Renderer.prototype._removeD3Groups=function(){this.d3Groups.data(this._renderGroups,function(t){return t.nodeId}).exit().each(function(t){t.remove()}).remove()},dudeGraph.Renderer.prototype.load=function(t){var e=this;_.forEach(t.blocks,function(t){e._createRenderBlock(t)}),_.forEach(t.groups,function(t){e._createRenderGroup(t)}),this._createD3Blocks(),this._createD3Groups(),this._loadRenderNodeParents(t)},dudeGraph.Renderer.prototype._loadRenderNodeParents=function(t){var e=this;_.forEach(t.blocks,function(t){var n=e._getRenderBlockById(t.id);if(t.parent){var r=e._getRenderGroupById(t.parent);if(null===r)throw new Error("Cannot find renderBlock parent id `"+t.parent+"`");n.nodeParent=r}}),_.forEach(t.groups,function(t){var n=e._getRenderGroupById(t.id);if(t.parent){var r=e._getRenderGroupById(t.parent);if(null===r)throw new Error("Cannot find renderGroup parent id `"+t.parent+"`");n.nodeParent=r}})};