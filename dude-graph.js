function d3_dispatch_event(e){function t(){for(var t,o=n,r=-1,i=o.length;++r<i;)t=o[r].on,t&&t.apply(this,arguments);return e}var n=[],o=d3.map();return t.on=function(t,r){var i,d=o.get(t);return arguments.length<2?d&&d.on:(d&&(d.on=null,n=n.slice(0,i=n.indexOf(d)).concat(n.slice(i+1)),o.remove(t)),r&&n.push(o.set(t,{on:r})),e)},t}function d3_eventDispatch(e){for(var t=d3.dispatch(),n=0,o=arguments.length;++n<o;)t[arguments[n]]=d3_dispatch_event(t);return t.of=function(n,o){return function(r){var i;try{i=r.sourceEvent=d3.event,r.target=e,d3.event=r,t[r.type].apply(n,o)}finally{d3.event=i}}},t}var dudeGraph=function(){var e={};return"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=e),exports.dudeGraph=e):window.dudeGraph=e,e}();!function(){var e=function(){var e=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0;return e?"Opera":"undefined"!=typeof InstallTrigger?"Firefox":Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0?"Safari":-1!==navigator.userAgent.indexOf("Edge")?"Edge":window.chrome&&!e?"Chrome":document.documentMode?"IE":"Unknown"};_.mixin({browser:e,browserIf:function(t,n,o){_.contains(t,e())?(n&&n||function(){})():(o&&o||function(){})()}})}(),function(){_.mixin({clamp:function(e,t,n){return Math.min(Math.max(e,t),n)}})}(),function(){var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},t=e();_.mixin({uuid:function(){return t+"-"+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}})}(),dudeGraph.Graph=function(){this._cgTypes={Stream:["Stream"],Array:["Array"],String:["String"],Number:["Number","Boolean"],Boolean:["Boolean","Number"],Vec2:["Vec2"],Vec3:["Vec3"],Vec4:["Vec4"],Color:["Color","Vec4"],Texture2D:["Texture2D"],Entity:["Entity"],Resource:["Resource"]},this._validators={Array:function(e){return _.isArray(e)},String:function(e){return _.isString(e)},Number:function(e){return _.isNumber(e)||/^[0-9]+(\.[0-9]+)?$/.test(e)},Boolean:function(e){return _.isBoolean(e)||/^(true|false)/.test(e)},Resource:function(e){return _.isObject(e)},Choice:function(e){return _.isObject(e)}},Object.defineProperty(this,"cgBlocks",{get:function(){return this._cgBlocks}.bind(this)}),this._cgBlocks=[],Object.defineProperty(this,"cgBlocksIds",{get:function(){return this._cgBlocksIds}.bind(this)}),this._cgBlocksIds={},Object.defineProperty(this,"cgConnections",{get:function(){return this._cgConnections}.bind(this)}),this._cgConnections=[]},dudeGraph.Graph.prototype=_.create(EventEmitter.prototype,{constructor:dudeGraph.Graph}),dudeGraph.Graph.prototype.addBlock=function(e,t){var n=e.cgId;if(e.cgGraph!==this)throw new Error("This block does not belong to this graph");if(null===n||_.isUndefined(n))throw new Error("Block id is null");if(this._cgBlocksIds[n])throw new Error("Block with id `"+n+"` already exists");return e.validate(),this._cgBlocks.push(e),this._cgBlocksIds[n]=e,t||this.emit("dude-graph-block-create",e),e},dudeGraph.Graph.prototype.removeBlock=function(e){var t=this._cgBlocks.indexOf(e);if(-1===t||e.cgGraph!==this)throw new Error("This block does not belong to this graph");var n=e.cgOutputs.concat(e.cgInputs);_.forEach(n,function(e){this.disconnectPoint(e)}.bind(this)),this._cgBlocks.splice(t,1),delete this._cgBlocksIds[e.cgId],this.emit("dude-graph-block-remove",e)},dudeGraph.Graph.prototype.blockById=function(e){var t=this._cgBlocksIds[e];if(!t)throw new Error("Block not found for id `"+e+"`");return t},dudeGraph.Graph.prototype.blockByName=function(e){var t=null;return _.forEach(this.cgBlocks,function(n){n.cgName===e&&(t=n)}),t},dudeGraph.Graph.prototype.blocksByType=function(e){var t=[];return _.forEach(this.cgBlocks,function(n){n.blockType===e&&t.push(n)}),t},dudeGraph.Graph.prototype.nextBlockId=function(){return _.uuid()},dudeGraph.Graph.prototype.connectPoints=function(e,t){if(null!==this.connectionByPoints(e,t))throw new Error("Connection already exists between these two points: `"+e.cgName+"` and `"+t.cgName+"`");if(e.isOutput===t.isOutput)throw new Error("Cannot connect either two inputs or two outputs: `"+e.cgName+"` and `"+t.cgName+"`");if(!e.acceptConnect(t))throw new Error("Point `"+e.cgName+"` does not accept to connect to `"+t.cgName+"` (too many connections)");if(!t.acceptConnect(e))throw new Error("Point `"+t.cgName+"` does not accept to connect to `"+e.cgName+"` (too many connections)");if(!this.canConvert(e.cgValueType,t.cgValueType)&&!this.updateTemplate(t,e.cgValueType))throw new Error("Cannot connect two points of different value types: `"+e.cgValueType+"` and `"+t.cgValueType+"`");var n=new dudeGraph.Connection(e,t);return this._cgConnections.push(n),e._cgConnections.push(n),t._cgConnections.push(n),this.emit("dude-graph-connection-create",n),n},dudeGraph.Graph.prototype.disconnectPoints=function(e,t){var n=this.connectionByPoints(e,t);if(null===n)throw new Error("No connections between these two points: `"+e.cgName+"` and `"+t.cgName+"`");return this._cgConnections.splice(this._cgConnections.indexOf(n),1),e._cgConnections.splice(e._cgConnections.indexOf(n),1),t._cgConnections.splice(t._cgConnections.indexOf(n),1),this.emit("dude-graph-connection-remove",n),n},dudeGraph.Graph.prototype.disconnectPoint=function(e){_.forEach(e.cgConnections,function(e){this.disconnectPoints(e.cgOutputPoint,e.cgInputPoint)}.bind(this))},dudeGraph.Graph.prototype.connectionsByBlock=function(e){return _.map(this._cgConnections,function(t){return t.cgOutputPoint.cgBlock===e||t.cgInputPoint.cgBlock===e})},dudeGraph.Graph.prototype.connectionByPoints=function(e,t){return _.find(this._cgConnections,function(n){return n.cgOutputPoint===e&&n.cgInputPoint===t})||null},dudeGraph.Graph.prototype.connectionsByPoint=function(e){return _.map(this._cgConnections,function(t){return t.cgOutputPoint===e||t.cgInputPoint===e})},dudeGraph.Graph.prototype.cloneBlocks=function(e){var t=[],n=[],o=[];return _.forEach(e,function(r){var i=this.connectionsByBlock(r),d=r.clone(this);this.addBlock(d),n.push(d),t[r.cgId]=d,_.forEach(i,function(t){-1===o.indexOf(t)&&-1!==e.indexOf(t.cgOutputPoint.cgBlock)&&-1!==e.indexOf(t.cgInputPoint.cgBlock)&&o.push(t)})}.bind(this)),_.forEach(o,function(e){try{t[e.cgOutputPoint.cgBlock.cgId].outputByName(e.cgOutputPoint.cgName).connect(t[e.cgInputPoint.cgBlock.cgId].inputByName(e.cgInputPoint.cgName))}catch(n){throw new Error("Connection duplication silenced exception: "+n)}}),n},dudeGraph.Graph.prototype.addValidator=function(e,t){this._validators[e]=t},dudeGraph.Graph.prototype.canConvert=function(e,t){return e===t||this._cgTypes[e]&&-1!==this._cgTypes[e].indexOf(t)},dudeGraph.Graph.prototype.canAssign=function(e,t){return null===e||this._validators[t]&&this._validators[t](e)},dudeGraph.Graph.prototype.updateTemplate=function(e,t){return e.cgBlock.updateTemplate(e,t)},dudeGraph.Block=function(e,t){if(t=t||{},Object.defineProperty(this,"cgGraph",{get:function(){return this._cgGraph}.bind(this)}),this._cgGraph=e,!e)throw new Error("Block() Cannot create a Block without a graph");Object.defineProperty(this,"blockType",{get:function(){return this._blockType}.bind(this)}),this._blockType=this.className,Object.defineProperty(this,"cgId",{get:function(){return this._cgId}.bind(this)}),this._cgId=t.cgId||e.nextBlockId(),Object.defineProperty(this,"cgName",{get:function(){return this._cgName}.bind(this),set:function(e){var t=this._cgName;this._cgName=e,this._cgGraph.emit("dude-graph-block-name-change",this,t,e)}.bind(this)}),this._cgName=t.cgName||this._blockType,Object.defineProperty(this,"cgTemplates",{get:function(){return this._cgTemplates}.bind(this)}),this._cgTemplates=t.cgTemplates||{},Object.defineProperty(this,"cgInputs",{get:function(){return this._cgInputs}.bind(this)}),this._cgInputs=[],Object.defineProperty(this,"cgOutputs",{get:function(){return this._cgOutputs}.bind(this)}),this._cgOutputs=[]},dudeGraph.Block.prototype=_.create(Object.prototype,{constructor:dudeGraph.Block,className:"Block"}),dudeGraph.Block.prototype.validate=function(){},dudeGraph.Block.prototype.addPoint=function(e){if(e.cgBlock!==this)throw new Error("Point `"+e.cgName+"` is not bound to this block `"+this._cgId+"`");if(e.isOutput&&this.outputByName(e.cgName)||!e.isOutput&&this.inputByName(e.cgName))throw new Error("Block `"+this._cgId+"` has already an "+(e.isOutput?"output":"input")+": `"+e.cgName+"`");return e.isOutput?this._cgOutputs.push(e):this._cgInputs.push(e),this._cgGraph.emit("cg-point-create",this,e),e},dudeGraph.Block.prototype.outputByName=function(e){return _.find(this._cgOutputs,function(t){return t.cgName===e})},dudeGraph.Block.prototype.inputByName=function(e){return _.find(this._cgInputs,function(t){return t.cgName===e})},dudeGraph.Block.prototype.updateTemplate=function(e,t){if(null===e.cgTemplate||!this.cgTemplates[e.cgTemplate]||-1===this.cgTemplates[e.cgTemplate].indexOf(t))return!1;e.cgValueType=t;var n=!1,o=function(o){if(n)return!0;if(o.cgTemplate===e.cgTemplate){if(0!==e.cgConnections.length)return n=!0,!0;o.cgValueType=t}};return _.forEach(this._cgInputs,o.bind(this)),_.forEach(this._cgOutputs,o.bind(this)),!n},dudeGraph.Block.prototype.clone=function(){var e=new this.constructor(this._cgGraph,{cgId:this._cgGraph.nextBlockId(),cgName:this._cgName});return _.forEach(this._cgOutputs,function(t){var n=t.clone(e);e.addPoint(n)}),_.forEach(this._cgInputs,function(t){var n=t.clone(e);e.addPoint(n)}),e},dudeGraph.Point=function(e,t,n,o){if(Object.defineProperty(this,"cgGraph",{get:function(){return this._cgGraph}.bind(this)}),this._cgGraph=e.cgGraph,Object.defineProperty(this,"pointType",{get:function(){return this._pointType}.bind(this)}),this._pointType=this.className,Object.defineProperty(this,"cgBlock",{get:function(){return this._cgBlock}.bind(this)}),this._cgBlock=e,Object.defineProperty(this,"cgName",{get:function(){return this._cgName}.bind(this)}),this._cgName=t.cgName||this._pointType,Object.defineProperty(this,"isOutput",{get:function(){return this._isOutput}.bind(this)}),this._isOutput=n,Object.defineProperty(this,"cgConnections",{get:function(){return this._cgConnections}.bind(this)}),this._cgConnections=[],Object.defineProperty(this,"singleConnection",{get:function(){return this._singleConnection}.bind(this),set:function(e){this._singleConnection=e}.bind(this)}),this._singleConnection=_.isUndefined(t.singleConnection)?!0:t.singleConnection,Object.defineProperty(this,"cgTemplate",{get:function(){return this._cgTemplate}.bind(this)}),this._cgTemplate=t.cgTemplate||null,Object.defineProperty(this,"cgValueType",{get:function(){return this._cgValueType}.bind(this),set:function(e){var t=this._cgValueType;this._cgValueType=e,this._cgGraph.emit("cg-point-value-type-change",this,t,e)}.bind(this)}),this._cgValueType=t.cgValueType,_.isUndefined(t.cgValueType))throw new Error("Cannot create the point `"+this._cgName+"` in block `"+this._cgBlock.cgId+"` without specifying a value type");if(Object.defineProperty(this,"cgValue",{configurable:!0,get:function(){return this._cgValue}.bind(this),set:function(e){if(null!==e&&!this.acceptValue(e))throw new Error("Cannot set `cgValue`: Point `"+this._cgName+"` cannot accept more than one connection");if(!this._cgGraph.canAssign(e,this._cgValueType))throw new Error("Invalid value `"+String(e)+"` for `"+this._cgValueType+"` in `"+this._cgName+"`");var t=this._cgValue;this._cgValue=e,this._cgGraph.emit("cg-point-value-change",this,t,e)}.bind(this)}),n&&null!==t.cgValue&&!_.isUndefined(t.cgValue))throw new Error("Cannot create output point `"+this._cgName+"` in block `"+this._cgBlock.cgId+"` with a value.");this._cgValue=t.cgValue||null},dudeGraph.Point.prototype=_.create(Object.prototype,{constructor:dudeGraph.Point,className:"Point"}),dudeGraph.Point.prototype.empty=function(){return null===this._cgValue},dudeGraph.Point.prototype.acceptConnect=function(e){return!this._singleConnection||0===this._cgConnections.length&&null===this._cgValue},dudeGraph.Point.prototype.acceptValue=function(e){return!this._singleConnection||0===this._cgConnections.length},dudeGraph.Point.prototype.connect=function(e){return this._isOutput?this._cgGraph.connectPoints(this,e):this._cgGraph.connectPoints(e,this)},dudeGraph.Point.prototype.disconnect=function(e){return this._isOutput?this._cgGraph.disconnectPoints(this,e):this._cgGraph.disconnectPoints(e,this)},dudeGraph.Point.prototype.clone=function(e){return new this.constructor(e,{cgName:this._cgName,cgValueType:this._cgValueType,cgValue:this._cgValue},this._isOutput)},dudeGraph.Connection=function(e,t){if(Object.defineProperty(this,"cgOutputPoint",{get:function(){return this._cgOutputPoint}.bind(this)}),this._cgOutputPoint=e,!e.isOutput)throw new Error("outputPoint is not an output");if(Object.defineProperty(this,"cgInputPoint",{get:function(){return this._cgInputPoint}.bind(this)}),this._cgInputPoint=t,t.isOutput)throw new Error("inputPoint is not an input")},dudeGraph.Connection.prototype.otherPoint=function(e){if(e===this._cgOutputPoint)return this._cgInputPoint;if(e===this._cgInputPoint)return this._cgOutputPoint;throw new Error("Point `"+e.cgName+"` is not in this connection")},dudeGraph.Connection.prototype.remove=function(){this._cgOutputPoint.disconnect(this._cgOutputPoint)},dudeGraph.Choice=function(e,t,n){if(dudeGraph.Point.call(this,e,_.merge(t,{cgValueType:"Choice"}),n),Object.defineProperty(this,"choice",{get:function(){return this._cgValue.choice}.bind(this),set:function(e){if(!this.validateChoice(e))throw new Error("Choice `"+e+"` is not in the possible choices");this.cgValue={choices:this._cgValue.choices,choice:e}}.bind(this)}),Object.defineProperty(this,"choices",{get:function(){return this._cgValue.choices}.bind(this)}),!this.validateChoice(this._cgValue.choice))throw new Error("Choice `"+this._cgValue.choice+"` is not in the possible choices")},dudeGraph.Choice.prototype=_.create(dudeGraph.Point.prototype,{constructor:dudeGraph.Choice,className:"Choice"}),dudeGraph.Choice.prototype.empty=function(){return null===this._cgValue||null===this._cgValue.choice},dudeGraph.Choice.prototype.validateChoice=function(e){return null===e||_.contains(this.cgValue.choices,e)},dudeGraph.Stream=function(e,t,n){dudeGraph.Point.call(this,e,_.merge(t,{cgName:t.cgName,cgValueType:"Stream"}),n,"Stream"),Object.defineProperty(this,"cgValue",{get:function(){throw new Error("Stream has no `cgValue`.")}.bind(this),set:function(){throw new Error("Stream has no `cgValue`.")}.bind(this)})},dudeGraph.Stream.prototype=_.create(dudeGraph.Point.prototype,{constructor:dudeGraph.Stream,className:"Stream"}),dudeGraph.Assignation=function(e,t){dudeGraph.Block.call(this,e,t)},dudeGraph.Assignation.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Assignation,className:"Assignation"}),dudeGraph.Assignation.prototype.validate=function(){if(!(this.inputByName("in")instanceof dudeGraph.Stream))throw new Error("Assignation `"+this.cgId+"` must have an input `in` of type `Stream`");if(!(this.inputByName("this")instanceof dudeGraph.Point))throw new Error("Assignation `"+this.cgId+"` must have an input `this` of type `Point`");if(!(this.inputByName("other")instanceof dudeGraph.Point))throw new Error("Assignation `"+this.cgId+"` must have an input `other` of type `Point`");if(this.inputByName("this")._cgValueType!==this.inputByName("other")._cgValueType)throw new Error("Assignation `"+this.cgId+"` inputs `this` and `other` must have the same cgValueType");if(!(this.outputByName("out")instanceof dudeGraph.Stream))throw new Error("Assignation `"+this.cgId+"` must have an output `out` of type `Stream`")},dudeGraph.Condition=function(e,t){dudeGraph.Block.call(this,e,t)},dudeGraph.Condition.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Condition,className:"Condition"}),dudeGraph.Condition.prototype.validate=function(){if(!(this.inputByName("in")instanceof dudeGraph.Stream))throw new Error("Condition `"+this.cgId+"` must have an input `in` of type `Stream`");if(!(this.inputByName("test")instanceof dudeGraph.Point)||"Boolean"!==this.inputByName("test").cgValueType)throw new Error("Condition `"+this.cgId+"` must have an input `test` of type `Point` of cgValueType `Boolean`");if(!(this.outputByName("true")instanceof dudeGraph.Stream))throw new Error("Condition `"+this.cgId+"` must have an output `true` of type `Stream`");if(!(this.outputByName("false")instanceof dudeGraph.Stream))throw new Error("Condition `"+this.cgId+"` must have an output `false` of type `Stream`")},dudeGraph.Delegate=function(e,t){dudeGraph.Block.call(this,e,t)},dudeGraph.Delegate.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Delegate,className:"Delegate"}),dudeGraph.Delegate.prototype.validate=function(){if(!(this.outputByName("out")instanceof dudeGraph.Stream))throw new Error("Delegate `"+this.cgId+"` must have an output `out` of type `Stream`")},dudeGraph.Each=function(e,t){dudeGraph.Block.call(this,e,t)},dudeGraph.Each.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Each,className:"Each"}),dudeGraph.Function=function(e,t){dudeGraph.Block.call(this,e,t)},dudeGraph.Function.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Function,className:"Function"}),dudeGraph.Getter=function(e,t){dudeGraph.Block.call(this,e,t)},dudeGraph.Getter.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Getter,className:"Getter"}),dudeGraph.Instruction=function(e,t){dudeGraph.Block.call(this,e,t)},dudeGraph.Instruction.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Instruction,className:"Instruction"}),dudeGraph.Instruction.prototype.validate=function(){if(!(this.inputByName("in")instanceof dudeGraph.Stream))throw new Error("Instruction `"+this.cgId+"` must have an input `in` of type `Stream`");if(!(this.outputByName("out")instanceof dudeGraph.Stream))throw new Error("Instruction `"+this.cgId+"` must have an output `out` of type `Stream`")},dudeGraph.Operator=function(e,t){dudeGraph.Block.call(this,e,t)},dudeGraph.Operator.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Operator,className:"Operator"}),dudeGraph.Operator.prototype.validate=function(){if(2!==this.cgInputs.length)throw new Error("Operator `"+this.cgId+"` must only take 2 inputs");if(1!==this.cgOutputs.length)throw new Error("Operator `"+this.cgId+"` must return one value")},dudeGraph.Range=function(e,t){dudeGraph.Block.call(this,e,t)},dudeGraph.Range.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Range,className:"Range"}),dudeGraph.Variable=function(e,t){dudeGraph.Block.call(this,e,t),Object.defineProperty(this,"cgValueType",{get:function(){return this._cgValueType}.bind(this)}),this._cgValueType=t.cgValueType,Object.defineProperty(this,"cgValue",{get:function(){return this._cgValue}.bind(this),set:function(e){this._cgValue=e,this.cgOutputs[0].cgValue=e}.bind(this)}),this._cgValue=t.cgValue},dudeGraph.Variable.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Variable,className:"Variable"}),dudeGraph.Variable.prototype.validate=function(){if(!(this.outputByName("value")instanceof dudeGraph.Point))throw new Error("Variable `"+this.cgId+"` must have an output `value` of type `Point`")},dudeGraph.GraphLoader=function(){this._blockTypes={Block:dudeGraph.Block},this._pointTypes={Point:dudeGraph.Point}},dudeGraph.GraphLoader.prototype.registerBlockType=function(e,t){this._blockTypes[e]=t},dudeGraph.GraphLoader.prototype.registerPointType=function(e,t){this._pointTypes[e]=t},dudeGraph.GraphLoader.prototype.load=function(e,t){var n=this;_.forEach(t.blocks,function(t){n.loadBlock(e,t)}),_.forEach(t.connections,function(t){n.loadConnection(e,t)})},dudeGraph.GraphLoader.prototype.loadBlock=function(e,t){var n=this;if(!t.hasOwnProperty("cgId"))throw new Error("Block property `cgId` is required");var o=this._blockTypes[t.cgType];if(_.isUndefined(o))throw new Error("Block type `"+t.cgType+"` not registered by the loader");var r=new o(e,t,t.cgType);return _.forEach(t.cgOutputs,function(e){n.loadPoint(r,e,!0)}),_.forEach(t.cgInputs,function(e){n.loadPoint(r,e,!1)}),e.addBlock(r),r},dudeGraph.GraphLoader.prototype.loadPoint=function(e,t,n){if(!t.cgName)throw new Error("Block `"+e.cgId+"`: Point property `cgName` is required");var o=t.cgType,r=this._pointTypes[o];if(!r)throw new Error("Point type `"+o+"` not registered by the loader");var i=new r(e,t,n);return e.addPoint(i),i},dudeGraph.GraphLoader.prototype.loadConnection=function(e,t){var n=t.cgOutputBlockId,o=t.cgOutputName,r=t.cgInputBlockId,i=t.cgInputName,d=e.blockById(n);if(!d)throw new Error("Output block not found for id `"+n+"`");var c=e.blockById(r);if(!c)throw new Error("Input block not found for id `"+r+"`");var u=d.outputByName(o);if(!u)throw new Error("Output point `"+o+"` not found in block `"+n+"`");var s=c.inputByName(i);if(!s)throw new Error("Input point `"+i+"` not found in block `"+r+"`");u.connect(s)},dudeGraph.GraphSaver=function(){},dudeGraph.GraphSaver.prototype.save=function(e){var t=this;return{blocks:_.map(e.cgBlocks,function(e){return t.saveBlock(e)}),connections:_.map(e.cgConnections,function(e){return t.saveConnection(e)})}},dudeGraph.GraphSaver.prototype.saveBlock=function(e){var t=this;return{cgType:e._blockType,cgId:e._cgId,cgName:e._cgName,cgInputs:_.map(e._cgInputs,function(e){return t.savePoint(e)}),cgOutputs:_.map(e._cgOutputs,function(e){return t.savePoint(e)})}},dudeGraph.GraphSaver.prototype.savePoint=function(e){var t={cgType:e.pointType,cgName:e._cgName,cgValueType:e._cgValueType,singleConnection:e._singleConnection};return e._isOutput||(t.cgValue=e._cgValue),t},dudeGraph.GraphSaver.prototype.saveConnection=function(e){return{cgOutputName:e._cgOutputPoint._cgName,cgOutputBlockId:e._cgOutputPoint._cgBlock._cgId,cgInputName:e._cgInputPoint._cgName,cgInputBlockId:e._cgInputPoint._cgBlock._cgId}},dudeGraph.Renderer=function(){this._graph=null,Object.defineProperty(this,"graph",{get:function(){return this._graph}.bind(this)}),this._config=null,Object.defineProperty(this,"config",{get:function(){return this._config}.bind(this)}),this._zoom=null,this._d3Svg=null,this._d3Root=null,this._d3Groups=null,this._d3Connections=null,this._d3Block=null,this._svgPoint=null,this._renderBlocks=null,this._renderGroups=null,this._renderConnections=null,this._selectedRenderNodes=null,this._renderBlockTypes=null,this._renderBlockIds=null,this._renderGroupIds=null,this._renderBlocksQuadtree=null,this._renderGroupsQuadtree=null,this._renderPointsQuadtree=null,Object.defineProperty(this,"d3Blocks",{get:function(){return this._d3Block.selectAll(".dude-graph-block")}.bind(this)}),Object.defineProperty(this,"d3Groups",{get:function(){return this._d3Groups.selectAll(".dude-graph-group")}.bind(this)}),Object.defineProperty(this,"d3Connections",{get:function(){return this._d3Connections.selectAll(".dude-graph-connection")}.bind(this)})},dudeGraph.Renderer.prototype=_.create(EventEmitter.prototype,{constructor:dudeGraph.Renderer}),dudeGraph.Renderer.prototype.initialize=function(e,t,n){var o=this;this._graph=e,this._d3Svg=d3.select(t),this._d3Root=this._d3Svg.append("svg:g").attr("id","dude-graph-renderer"),this._d3Groups=this._d3Root.append("svg:g").attr("id","dude-graph-groups"),this._d3Connections=this._d3Root.append("svg:g").attr("id","dude-graph-connections"),this._d3Block=this._d3Root.append("svg:g").attr("id","dude-graph-blocks"),this._svgPoint=t.createSVGPoint(),this._renderBlocks=[],this._renderGroups=[],this._renderConnections=[],this._selectedRenderNodes=[],this._renderBlockTypes={Block:dudeGraph.RenderBlock},this._renderBlockIds={},this._renderGroupIds={},this._renderBlocksQuadtree=null,this._renderGroupsQuadtree=null,this._renderPointsQuadtree=null,this._config=_.defaultsDeep(n||{},dudeGraph.Renderer.defaultConfig),this._zoom=dudeGraph.Renderer.defaultZoom,this._createSelectionBehavior(),this._createZoomBehavior(),this._graph.on("cg-point-value-change",function(e){var t=o.renderBlocksByBlock(e.cgBlock);_.forEach(t,function(e){e.update()})})},dudeGraph.Renderer.prototype.registerRenderBlock=function(e,t){this._renderBlockTypes[e]=t},dudeGraph.Renderer.defaultConfig={zoom:{min:.01,max:5,margin:[10,10],transitionSpeed:800},block:{padding:10,header:50,pointSpacing:10,borderRadius:5},grid:{active:!1,spacingX:20,spacingY:20},group:{padding:10,header:30,borderRadius:5,minSize:[200,150]},point:{height:20,padding:10,radius:3},connection:{step:50},typeColors:{Stream:"#aaaaaa",Boolean:"#cc99cd",Number:"#5990bd",String:"#aac563",Resource:"#ffa8c2",Object:"#d9b762",Entity:"#6a2c7b"},defaultColor:"#ffaaff"},dudeGraph.Renderer.defaultZoom={translate:[0,0],scale:1},dudeGraph.RenderNode=function(e,t){this._renderer=e,this._nodeId=t,Object.defineProperty(this,"nodeId",{configurable:!0,get:function(){return this._nodeId}.bind(this)}),this._nodeName=null,this._getNodeName=function(){return this._nodeName}.bind(this),this._setNodeName=function(e){this._nodeName=e,null!==this._d3Node&&(this.computePosition(),this.computeSize(),this.update())}.bind(this),Object.defineProperty(this,"nodeName",{configurable:!0,get:this._getNodeName,set:this._setNodeName}),this._nodeSize=[0,0],Object.defineProperty(this,"nodeSize",{configurable:!0,get:function(){return this._nodeSize}.bind(this),set:function(e){this._nodeSize=e}.bind(this)}),this._nodePosition=[0,0],Object.defineProperty(this,"nodePosition",{configurable:!0,get:function(){return this._nodePosition}.bind(this),set:function(e){this._nodePosition=e}.bind(this)}),this._movePosition=[0,0],Object.defineProperty(this,"movePosition",{configurable:!0,get:function(){return this._movePosition}.bind(this),set:function(e){this._movePosition=e}.bind(this)}),this._d3Node=null,Object.defineProperty(this,"d3Node",{configurable:!0,get:function(){return this._d3Node}.bind(this)}),Object.defineProperty(this,"nodeFancyName",{configurable:!0,get:function(){return this._nodeName+" (#"+this._nodeId+")"}.bind(this)})},dudeGraph.RenderNode.prototype.create=function(e){this._d3Node=e},dudeGraph.RenderNode.prototype.move=function(){this._d3Node.attr("transform","translate("+this._nodePosition+")")},dudeGraph.RenderNode.prototype.update=function(){this.move()},dudeGraph.RenderNode.prototype.remove=function(){},dudeGraph.RenderNode.prototype.select=function(){this._d3SelectStar=this._d3Node.append("svg:polygon").attr("fill",this._renderer.config.typeColors.Object),this._d3SelectStar.attr("points",function(){for(var e=[],t=5,n=Math.PI/t,o=0;2*t>o;o++){var r=o%2===0?5:10,i=5+Math.cos(o*n)*r,d=5+Math.sin(o*n)*r;e.push([i,d])}return e})},dudeGraph.RenderNode.prototype.unselect=function(){this._d3SelectStar.remove()},dudeGraph.RenderNode.prototype.computeSize=function(){},dudeGraph.RenderNode.prototype.computePosition=function(){},dudeGraph.RenderNode.prototype.moveEvent=function(){var e=this;this._d3Node.call(d3.behavior.drag().on("dragstart",function(){_.stopD3ImmediatePropagation(),_.preventD3Default(),d3.event.sourceEvent.shiftKey||e._renderer.clearSelection(),e._renderer.addToSelection([e]),this.parentNode.appendChild(this)}).on("drag",function(){_.preventD3Default();var t=function(t){e._renderer._config.grid.active?(t.movePosition[0]+=d3.event.dx,t.movePosition[1]+=d3.event.dy,t.nodePosition[0]=Math.round(t.movePosition[0]/e._renderer._config.grid.spacingX)*e._renderer._config.grid.spacingX,t.nodePosition[1]=Math.round(t.movePosition[1]/e._renderer._config.grid.spacingY)*e._renderer._config.grid.spacingY):(t.nodePosition[0]+=d3.event.dx,t.nodePosition[1]+=d3.event.dy),t.move(),_.forEach(t._renderPoints,function(e){_.forEach(e.renderConnections,function(e){e.update()})})};if(t(e),e instanceof dudeGraph.RenderGroup)_.forEach(e.renderBlocksChildren,function(e){t(e)});else{var n=e.renderGroupParent;null!==n&&(n.computePosition(),n.computeSize(),n.update())}}).on("dragend",function(e){if(_.preventD3Default(),e instanceof dudeGraph.RenderBlock&&null===e.renderGroupParent){var t=e._renderer.nearestRenderGroup(e);null!==t&&(e.renderGroupParent=t,t.computePosition(),t.computeSize(),t.update())}}))},dudeGraph.RenderBlock=function(e,t,n){dudeGraph.RenderNode.call(this,e,t),this._block=n,Object.defineProperty(this,"block",{get:function(){return this._block}.bind(this)}),Object.defineProperty(this,"nodeName",{configurable:!0,get:this._getNodeName,set:function(e){this._setNodeName(e),null!==this.renderGroupParent&&(this.renderGroupParent.computePosition(),this.renderGroupParent.computeSize(),this.renderGroupParent.update()),_.forEach(this._renderPoints,function(e){e.computePosition(),e.update(),_.forEach(e.renderConnections,function(e){e.update()})})}.bind(this)}),this._renderGroupParent=null,Object.defineProperty(this,"renderGroupParent",{configurable:!0,get:function(){return this._renderGroupParent}.bind(this),set:function(e){null!==this._renderGroupParent&&this._renderGroupParent.removeChild(this),null!==e&&e.addChild(this),this._renderGroupParent=e}.bind(this)}),this._renderPoints=[],Object.defineProperty(this,"renderPoints",{get:function(){return this._renderPoints}.bind(this),set:function(e){this._renderPoints=e}.bind(this)}),Object.defineProperty(this,"renderOutputPoints",{get:function(){return _.filter(this.renderPoints,function(e){return e.point.isOutput})}}),Object.defineProperty(this,"renderInputPoints",{get:function(){return _.filter(this.renderPoints,function(e){return!e.point.isOutput})}}),this._d3Points=null,Object.defineProperty(this,"d3Points",{get:function(){return this._d3Points.selectAll(".dude-graph-point")}.bind(this)})},dudeGraph.RenderBlock.prototype=_.create(dudeGraph.RenderNode.prototype,{constructor:dudeGraph.RenderBlock}),dudeGraph.RenderBlock.prototype.create=function(e){dudeGraph.RenderNode.prototype.create.call(this,e),this._d3Rect=this._d3Node.append("svg:rect").attr("rx",this._renderer.config.block.borderRadius).attr("ry",this._renderer.config.block.borderRadius),this._d3Title=this._d3Node.append("svg:text").attr("text-anchor","middle").attr("dominant-baseline","text-before-edge"),this._d3Points=this._d3Node.append("svg:g").classed("dude-graph-points",!0),this.createAndUpdateRenderPoints(),this.computeSize(),this.d3Points.each(function(e){e.computePosition()}),this.update()},dudeGraph.RenderBlock.prototype.update=function(){dudeGraph.RenderNode.prototype.update.call(this);var e=this;this._d3Rect.attr({width:this._nodeSize[0],height:this._nodeSize[1]}),this._d3Title.text(this._nodeName).attr({x:this._nodeSize[0]/2,y:this._renderer.config.block.padding}),_.browserIf(["IE","Edge"],function(){e._d3Title.attr("y",e._renderer.config.block.padding+e._renderer.measureText(e._d3Title)[1]/2)}),this.d3Points.each(function(e){e.update()}),this.move()},dudeGraph.RenderBlock.prototype.computeSize=function(){var e=_.max(this.renderOutputPoints,function(e){return e.pointSize[0]}),t=_.max(this.renderInputPoints,function(e){return e.pointSize[0]}),n=this._renderer.measureText(this._nodeName)[0],o=e!==-(1/0)?e.pointSize[0]:0,r=t!==-(1/0)?t.pointSize[0]:0,i=this.renderOutputPoints.length>this.renderInputPoints.length,d=_.sum(i?this.renderOutputPoints:this.renderInputPoints,function(e){return e.pointSize[1]}),c=Math.max(n+2*this._renderer.config.block.padding,o+r+this._renderer.config.block.pointSpacing);this._nodeSize=[c,d+this._renderer.config.block.header]},dudeGraph.RenderBlock.prototype.createAndUpdateRenderPoints=function(){var e=this.d3Points.data(this.renderPoints,function(e){return e.pointFancyName});e.enter().append("g").classed("dude-graph-point",!0),e.exit().each(function(e){e.remove()}).remove(),this.d3Points.each(function(e){e.create(d3.select(this)),e.removeConnectionsEvent(),e.dragConnectionEvent()})},dudeGraph.RenderNode.prototype.removeParentEvent=function(){var e=this;this._d3Node.call(d3.behavior.doubleClick().on("dblclick",function(){var t=e.renderGroupParent;null!==t&&(_.stopD3ImmediatePropagation(),e.renderGroupParent=null,t.computePosition(),t.computeSize(),t.update())}))},dudeGraph.RenderBlock.buildRenderBlock=function(e,t){var n=e.graph.blockById(t.cgBlock);
if(!n)throw new Error("Unknown block `"+t.cgBlock+"` for renderBlock `"+t.id+"`");var o=new this(e,t.id,n);o.nodeName=t.description||n.cgName||"",o.nodePosition=t.position||[0,0],o.movePosition=o.nodePosition.slice(),o.parentGroup=t.parent||null;var r=function(n,r){var i=t[n.isOutput?"outputs":"inputs"];return i=i&&i[n.cgName],e.createRenderPoint({renderBlock:o,renderPoint:i,point:n,index:r})};return o.renderPoints=Array.prototype.concat(_.map(n.cgOutputs,r),_.map(n.cgInputs,r)),o},dudeGraph.RenderConnection=function(e,t,n,o){this._renderer=e,this._connection=t,Object.defineProperty(this,"connection",{get:function(){return this._connection}.bind(this)}),Object.defineProperty(this,"connectionId",{get:function(){return this.outputRenderPoint.renderBlock.nodeId+":"+this.outputRenderPoint.point.cgName+","+this.inputRenderPoint.renderBlock.nodeId+":"+this.inputRenderPoint.point.cgName}.bind(this)}),this._outputRenderPoint=n,Object.defineProperty(this,"outputRenderPoint",{get:function(){return this._outputRenderPoint}.bind(this)}),this._inputRenderPoint=o,Object.defineProperty(this,"inputRenderPoint",{get:function(){return this._inputRenderPoint}.bind(this)}),this._dragging=!1,Object.defineProperty(this,"dragging",{get:function(){return this._dragging}.bind(this),set:function(e){this._dragging=e}.bind(this)}),Object.defineProperty(this,"draggingRenderPoint",{get:function(){if(!this.dragging)throw new Error("Cannot get the dragging renderPoint of a non dragging connection");return this._outputRenderPoint instanceof dudeGraph.RenderPoint?this._inputRenderPoint:this._outputRenderPoint}.bind(this)}),Object.defineProperty(this,"realRenderPoint",{get:function(){if(!this.dragging)throw new Error("Cannot get the real renderPoint of a non dragging connection");return this._outputRenderPoint instanceof dudeGraph.RenderPoint?this._outputRenderPoint:this._inputRenderPoint}.bind(this)}),this._d3Connection=null,Object.defineProperty(this,"d3Connection",{get:function(){return this._d3Connection}.bind(this)})},dudeGraph.RenderConnection.prototype.create=function(e){this._d3Connection=e,this._d3Line=d3.svg.line().interpolate("basis")},dudeGraph.RenderConnection.prototype.update=function(){var e=this._renderer.config.connection.step;this._outputRenderPoint.pointAbsolutePosition[0]>this._inputRenderPoint.pointAbsolutePosition[0]&&(e+=Math.max(-this._renderer.config.connection.step,Math.min(this._outputRenderPoint.pointAbsolutePosition[0]-this._inputRenderPoint.pointAbsolutePosition[0],this._renderer.config.connection.step)));var t=this._outputRenderPoint.pointAbsolutePosition,n=this._inputRenderPoint.pointAbsolutePosition,o=[[t[0],t[1]],[t[0]+e,t[1]],[n[0]-e,n[1]],[n[0],n[1]]],r=this._renderer.config.typeColors[this.inputRenderPoint.point.cgValueType],i=this._renderer.config.typeColors[this.outputRenderPoint.point.cgValueType];this._d3Connection.attr({d:this._d3Line(o),stroke:r||i||this._renderer.config.defaultColor,"stroke-linecap":"round"}),this._dragging&&this._d3Connection.attr("stroke-dasharray","5,5")},dudeGraph.RenderConnection.prototype.remove=function(){},dudeGraph.RenderConnection.buildRenderConnection=function(e,t){var n=t.connection||e._graph.cgConnections[t.cgConnectionIndex];if(!n)throw new Error("Connection at index `"+t.cgConnectionIndex+"` does not exist");var o=t.outputRenderBlock||e.renderBlockById(t.outputRendererBlockId),r=t.inputRenderBlock||e.renderBlockById(t.inputRendererBlockId);if(null===o)throw new Error("Connection at index `"+t.cgConnectionIndex+"`: Cannot find outputRenderBlock `"+t.outputRendererBlockId+"`");if(null===r)throw new Error("Connection at index `"+t.cgConnectionIndex+"`: Cannot find inputRenderBlock `"+t.inputRendererBlockId+"`");if(o.block!==n.cgOutputPoint.cgBlock)throw new Error("Connection at index `"+t.cgConnectionIndex+"`: output render block `"+o.nodeFancyName+"` is not holding a reference to the output block `"+n.cgOutputPoint.cgBlock.cgId+"`");if(r.block!==n.cgInputPoint.cgBlock)throw new Error("Connection at index `"+t.cgConnectionIndex+"`: input render block `"+r.nodeFancyName+"` is not holding a reference to the input block `"+n.cgInputPoint.cgBlock.cgId+"`");var i=e.renderPointByName(o,n.cgOutputPoint.cgName,!0),d=e.renderPointByName(r,n.cgInputPoint.cgName,!1);if(!i)throw new Error("Connection at index `"+t.cgConnectionIndex+"`: Cannot find outputRenderPoint `"+n.cgOutputPoint.cgName+"`");if(!d)throw new Error("Connection at index `"+t.cgConnectionIndex+"`: Cannot find inputRenderPoint `"+n.cgInputPoint.cgName+"`");return new this(e,n,i,d)},dudeGraph.RenderGroup=function(e,t){dudeGraph.RenderNode.call(this,e,t),this._renderBlocksChildren=[],Object.defineProperty(this,"renderBlocksChildren",{get:function(){return this._renderBlocksChildren}.bind(this)})},dudeGraph.RenderGroup.prototype=_.create(dudeGraph.RenderNode.prototype,{constructor:dudeGraph.RenderGroup}),dudeGraph.RenderGroup.prototype.create=function(e){dudeGraph.RenderNode.prototype.create.call(this,e),this._d3Rect=e.append("svg:rect").attr("rx",this._renderer.config.group.borderRadius).attr("ry",this._renderer.config.group.borderRadius),this._d3Title=e.append("svg:text").attr("text-anchor","middle").attr("dominant-baseline","text-before-edge"),this.update(),this.computePosition(),this.computeSize(),this.move()},dudeGraph.RenderGroup.prototype.update=function(){dudeGraph.RenderNode.prototype.update.call(this);var e=this;this._d3Rect.attr({width:this._nodeSize[0],height:this._nodeSize[1]}),this._d3Title.text(this._nodeName).attr({x:this._nodeSize[0]/2,y:e._renderer.config.group.padding}),_.browserIf(["IE","Edge"],function(){e._d3Title.attr("y",e._renderer.config.group.padding+e._renderer.measureText(e._d3Title)[1]/2)})},dudeGraph.RenderGroup.prototype.computeSize=function(){var e=this._renderer.renderNodesBoundingRect(this._renderBlocksChildren,!0);null!==e&&(this._nodeSize=[e[1][0]-e[0][0]+2*this._renderer.config.group.padding,e[1][1]-e[0][1]+2*this._renderer.config.group.padding+this._renderer.config.group.header]),this._nodeSize=[Math.max(this._nodeSize[0],this._renderer.config.group.minSize[0]+2*this._renderer.config.group.padding),Math.max(this._nodeSize[1],this._renderer.config.group.minSize[1]+2*this._renderer.config.group.padding+this._renderer.config.group.header)],this._nodeSize[0]=Math.max(this._nodeSize[0],this._renderer.measureText(this._d3Title)[0]+2*this._renderer.config.group.padding)},dudeGraph.RenderGroup.prototype.computePosition=function(){var e=this._renderer.renderNodesBoundingRect(this._renderBlocksChildren,!0);null!==e&&(this._nodePosition=[e[0][0]-this._renderer.config.group.padding,e[0][1]-this._renderer.config.group.padding-this._renderer.config.group.header])},dudeGraph.RenderGroup.prototype.addChild=function(e){var t=_.find(this._renderBlocksChildren,e);if(!_.isUndefined(t))throw new Error("`"+e.nodeFancyName+"` is already a child of `"+this.nodeFancyName+"`");this._renderBlocksChildren.push(e)},dudeGraph.RenderGroup.prototype.removeChild=function(e){var t=_.find(this._renderBlocksChildren,e);if(_.isUndefined(t))throw new Error("`"+e.nodeFancyName+"` is not a child of `"+this.nodeFancyName+"`");_.pull(this._renderBlocksChildren,e)},dudeGraph.RenderGroup.prototype.removeAllChildren=function(){var e=_.clone(this._renderBlocksChildren);_.forEach(e,function(e){e.renderGroupParent=null})},dudeGraph.RenderGroup.buildRenderGroup=function(e,t){var n=new this(e,t.id);return n.nodeName=t.description||"",n.nodePosition=t.position||[0,0],n.nodeSize=t.size||[0,0],n},dudeGraph.RenderPoint=function(e,t,n,o){this._renderer=e,this._point=n,Object.defineProperty(this,"point",{get:function(){return this._point}.bind(this)}),this._index=o,Object.defineProperty(this,"index",{get:function(){return this._index}.bind(this)}),this._renderBlock=t,Object.defineProperty(this,"renderBlock",{get:function(){return this._renderBlock}.bind(this)}),this._renderConnections=[],Object.defineProperty(this,"renderConnections",{get:function(){return this._renderConnections}.bind(this)}),this._pointHidden=!1,Object.defineProperty(this,"pointHidden",{set:function(e){this._pointHidden=e}.bind(this),get:function(){return this._pointHidden}.bind(this)}),this._pointSize=[0,0],Object.defineProperty(this,"pointSize",{get:function(){return this._pointSize}.bind(this)}),this._pointPosition=[0,0],Object.defineProperty(this,"pointPosition",{get:function(){return this._pointPosition}.bind(this)}),Object.defineProperty(this,"pointAbsolutePosition",{get:function(){var e=this._renderBlock.nodePosition;return[e[0]+this._pointPosition[0],e[1]+this._pointPosition[1]]}.bind(this)}),Object.defineProperty(this,"pointFancyName",{get:function(){return(this._point.isOutput?"Output ":"Input ")+this._point.cgName+" (#"+this._index+")"}.bind(this)}),this._d3Point=null,Object.defineProperty(this,"d3Point",{get:function(){return this._d3Point}.bind(this)})},dudeGraph.RenderPoint.prototype.create=function(e){var t=this._renderer.config.point.radius,n=this;this._d3Point=e,this._d3Circle=e.append("svg:path").attr("d",function(){return n._point instanceof dudeGraph.Stream?"M "+-t+" "+1.5*-t+" L "+-t+" "+1.5*t+" L "+t+" 0 Z":"M 0,0m "+-t+", 0a "+[t,t]+" 0 1,0 "+2*t+",0a "+[t,t]+" 0 1,0 "+-(2*t)+",0"}),this._d3Title=e.append("svg:text").attr({"text-anchor":this._point.isOutput?"end":"start","dominant-baseline":"middle",x:(this.point.isOutput?-1:1)*this._renderer.config.point.padding}),_.browserIf(["IE","Edge"],function(){n._d3Title.attr("y",n._pointPosition[1]+n._renderer.measureText(n._d3Title)[1]/4)}),this.computeSize()},dudeGraph.RenderPoint.prototype.update=function(){var e=this._renderer.config.typeColors[this.point.cgValueType]||this._renderer.config.defaultColor;this._d3Point.attr("transform","translate("+this.pointPosition+")"),this._d3Circle.attr({stroke:e,fill:this.empty()?"transparent":e}),this._d3Title.text(this._point.cgName)},dudeGraph.RenderPoint.prototype.remove=function(){},dudeGraph.RenderPoint.prototype.computeSize=function(){var e=this._renderer.measureText(this._point.cgName);this._pointSize=[e[0]+2*this._renderer.config.point.padding,this._renderer.config.point.height]},dudeGraph.RenderPoint.prototype.computePosition=function(){this.point.isOutput?this._pointPosition=[this._renderBlock.nodeSize[0]-this._renderer.config.point.padding,this._renderer.config.block.header+this._renderer.config.point.height*this._index]:this._pointPosition=[this._renderer.config.point.padding,this._renderer.config.block.header+this._renderer.config.point.height*this._index]},dudeGraph.RenderPoint.prototype.removeConnectionsEvent=function(){var e=this;this._d3Circle.call(d3.behavior.mousedown().on("mousedown",function(){d3.event.sourceEvent.altKey&&(_.preventD3Default(),_.stopD3ImmediatePropagation(),e._renderer.emptyRenderPoint(e,!0))}))},dudeGraph.RenderPoint.prototype.dragConnectionEvent=function(){var e=this,t=null,n={renderBlock:{nodeId:"drawing"},point:{cgName:"drawing"},pointAbsolutePosition:[0,0]};e._d3Circle.call(d3.behavior.drag().on("dragstart",function(){_.stopD3ImmediatePropagation(),n.pointAbsolutePosition=d3.mouse(e._renderer._d3Root.node()),t=e._point.isOutput?new dudeGraph.RenderConnection(e._renderer,null,e,n):new dudeGraph.RenderConnection(e._renderer,null,n,e),t.dragging=!0,e._renderer._renderConnections.push(t),e._renderer.createD3Connections()}).on("drag",function(){n.pointAbsolutePosition=d3.mouse(e._renderer._d3Root.node()),t.update()}).on("dragend",function(){var n=d3.mouse(e._renderer._d3Root.node()),o=e._renderer.nearestRenderPoint(n);if(o&&e!==o)try{var r=o.point.connect(e._point);e._renderer.createRenderConnection({cgConnectionIndex:e._renderer.graph.cgConnections.indexOf(r),outputRendererBlockId:e._point.isOutput?e._renderBlock.nodeId:o.renderBlock.nodeId,inputRendererBlockId:e._point.isOutput?o.renderBlock.nodeId:e._renderBlock.nodeId}),e._renderer.createD3Connections(),e.update(),o.update()}catch(i){e._renderer.emit("error",i)}else e._renderer.emit("drop-connection",t,d3.mouse(e._renderer._d3Root.node()),d3.mouse(document.body));_.pull(e._renderer._renderConnections,t),t=null,e._renderer.removeD3Connections()}))},dudeGraph.RenderPoint.prototype.empty=function(){return _.isEmpty(this.renderConnections)&&this._point.empty()},dudeGraph.RenderPoint.buildRenderPoint=function(e,t){var n=new this(e,t.renderBlock,t.point,t.index);return n.pointHidden=t.renderPoint&&t.renderPoint.hidden||!1,n},dudeGraph.RenderVariable=function(e,t,n){dudeGraph.RenderBlock.call(this,e,t,n)},dudeGraph.RenderVariable.prototype=_.create(dudeGraph.RenderBlock.prototype,{constructor:dudeGraph.RenderVariable}),dudeGraph.RenderVariable.prototype.create=function(e){dudeGraph.RenderBlock.prototype.create.call(this,e);var t=this.block.cgOutputs[0].cgValueType,n=this._renderer.config.typeColors[t];_.isUndefined(n)||this._d3Rect.attr("style","fill: "+n+"; stroke: "+n+";")},dudeGraph.RenderVariable.prototype.update=function(e){dudeGraph.RenderBlock.prototype.update.call(this,e)},dudeGraph.RenderVariable.buildRenderBlock=function(e,t){return dudeGraph.RenderBlock.buildRenderBlock.call(this,e,t)},dudeGraph.Renderer.prototype._createRenderBlocksCollisions=function(){this._renderBlocksQuadtree=d3.geom.quadtree().x(function(e){return e.nodePosition[0]}).y(function(e){return e.nodePosition[1]})(this._renderBlocks)},dudeGraph.Renderer.prototype._createRenderPointsCollisions=function(){var e=[];_.forEach(this._renderBlocks,function(t){e=e.concat(t.renderPoints)}),this._renderPointsQuadtree=d3.geom.quadtree().x(function(e){return e.pointAbsolutePosition[0]}).y(function(e){return e.pointAbsolutePosition[1]})(e)},dudeGraph.Renderer.prototype._createRenderGroupsCollisions=function(){this._renderGroupsQuadtree=d3.geom.quadtree().x(function(e){return e.nodePosition[0]}).y(function(e){return e.nodePosition[1]})(this._renderGroups)},dudeGraph.Renderer.prototype.nearestRenderBlocks=function(e){this._createRenderBlocksCollisions();var t=[];return this._renderBlocksQuadtree.visit(function(n,o,r,i,d){var c=n.point;if(c){var u=[c.nodePosition[0],c.nodePosition[1],c.nodePosition[0]+c.nodeSize[0],c.nodePosition[1]+c.nodeSize[1]];e[0][0]>u[2]||e[0][1]>u[3]||e[1][0]<u[0]||e[1][1]<u[1]||t.push(c)}return o-50>=e[1][0]||r-35>=e[1][1]||i+50<e[0][0]||d+35<e[0][1]}),t},dudeGraph.Renderer.prototype.nearestRenderGroup=function(e){this._createRenderGroupsCollisions();var t=[],n=e.nodePosition[0],o=e.nodePosition[1],r=e.nodePosition[0]+e.nodeSize[0],i=e.nodePosition[1]+e.nodeSize[1];this._renderGroupsQuadtree.visit(function(d){var c=d.point;if(c&&c!==e){var u=[c.nodePosition[0],c.nodePosition[1],c.nodePosition[0]+c.nodeSize[0],c.nodePosition[1]+c.nodeSize[1]];n>u[0]&&o>u[1]&&r<u[2]&&i<u[3]&&t.push(c)}return!1});var d=null;return _.forEach(t,function(t){return e.renderGroupParent&&t===e.renderGroupParent?(d=t,!1):void(null===d?d=t:t.nodeSize[0]<d.nodeSize[0]&&t.nodeSize[1]<d.nodeSize[1]&&(d=t))}),d},dudeGraph.Renderer.prototype.nearestRenderPoint=function(e){this._createRenderPointsCollisions();var t=this._renderPointsQuadtree.find(e);if(t){var n=t.pointAbsolutePosition;if(n[0]>e[0]-this._config.point.height&&n[0]<e[0]+this._config.point.height&&n[1]>e[1]-this._config.point.height&&n[1]<e[1]+this._config.point.height)return t}return null},dudeGraph.Renderer.prototype._createSelectionBehavior=function(){var e=this,t=null;this._d3Svg.call(d3.behavior.drag().on("dragstart",function(){d3.event.sourceEvent.shiftKey?(d3.event.sourceEvent.stopImmediatePropagation(),t=e._d3Svg.append("svg:rect").classed("dude-graph-select",!0).datum(d3.mouse(this))):e.clearSelection()}).on("drag",function(){if(t){var e=d3.mouse(this);t.attr({x:function(t){return Math.min(t[0],e[0])},y:function(t){return Math.min(t[1],e[1])},width:function(t){return Math.max(e[0]-t[0],t[0]-e[0])},height:function(t){return Math.max(e[1]-t[1],t[1]-e[1])}})}}).on("dragend",function(){if(null!==t){var n=function(e){return parseInt(t.attr(e))},o=e.screenToWorld([n("x"),n("y")]),r=e.screenToWorld([n("width")+n("x"),n("height")+n("y")]),i=e.nearestRenderBlocks([o,r]);d3.event.sourceEvent.altKey?e.removeFromSelection(i):e.addToSelection(i),t.remove(),t=null}}))},dudeGraph.Renderer.prototype.addToSelection=function(e){var t=this;_.forEach(e,function(e){_.includes(t._selectedRenderNodes,e)||(e.select(),e.d3Node.classed("dude-graph-selected",!0),t._selectedRenderNodes.push(e),t.emit("select",e))})},dudeGraph.Renderer.prototype.removeFromSelection=function(e){var t=this;_.remove(this._selectedRenderNodes,function(n){return _.includes(e,n)?(n.unselect(),n.d3Node.classed("dude-graph-selected",!1),t.emit("unselect",n),!0):!1})},dudeGraph.Renderer.prototype.clearSelection=function(){this.removeFromSelection(this._selectedRenderNodes),this.emit("unselect-all")},dudeGraph.Renderer.prototype.selectAll=function(e,t){this.clearSelection(),e||this.addToSelection(this._renderBlocks),t||this.addToSelection(this._renderGroups)},dudeGraph.Renderer.prototype.removeSelection=function(){var e=this;_.forEach(this._selectedRenderNodes,function(t){t instanceof dudeGraph.RenderBlock?e.removeRenderBlock(t,!0):e.removeRenderGroup(t,!0)}),this.clearSelection()},dudeGraph.Renderer.prototype.createRenderGroupForSelection=function(e){var t=this.createRenderGroup({id:_.uuid(),description:e});return _.forEach(this._selectedRenderNodes,function(e){e.renderGroupParent=t}),this.createD3Groups(),t},dudeGraph.Renderer.prototype._createZoomBehavior=function(){var e=this;this._zoomBehavior=d3.behavior.zoom().scaleExtent([this._config.zoom.min,this._config.zoom.max]).on("zoom",function(){d3.event.sourceEvent&&_.preventD3Default(),e._d3Root.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")"),e._zoom.translate=d3.event.translate,e._zoom.scale=d3.event.scale}.bind(this)),this._d3Svg.call(this._zoomBehavior),this._updateZoom()},dudeGraph.Renderer.prototype._updateZoom=function(){this._d3Svg.transition().duration(this._config.zoom.transitionSpeed).call(this._zoomBehavior.translate(this._zoom.translate).scale(this._zoom.scale).event)},dudeGraph.Renderer.prototype._zoomToBoundingBox=function(e){var t=this._d3Svg.node().getBoundingClientRect(),n=this._zoomBehavior.scaleExtent(),o=e.width-e.x,r=e.height-e.y,i=(e.x+e.width)/2,d=(e.y+e.height)/2,c=_.clamp(.9/Math.max(o/t.width,r/t.height),n[0],n[1]),u=[t.width/2-c*i,t.height/2-c*d];this._zoom.scale=c,this._zoom.translate=u,this._updateZoom()},dudeGraph.Renderer.prototype.zoomToFitRenderNodes=function(e){if(!_.isEmpty(e)){var t=this.renderNodesBoundingRect(e);this._zoomToBoundingBox({x:t[0][0]-this._config.zoom.margin[0]/2,y:t[0][1]-this._config.zoom.margin[1]/2,width:t[1][0]+this._config.zoom.margin[0],height:t[1][1]+this._config.zoom.margin[1]})}},dudeGraph.Renderer.prototype.panToFitRenderNodes=function(e){var t=this._zoomBehavior.scaleExtent();this._zoomBehavior.scaleExtent([1,1]),this.zoomToFitRenderNodes(e),this._zoomBehavior.scaleExtent(t)},dudeGraph.Renderer.prototype.zoomToFit=function(){this.zoomToFitRenderNodes(this._renderBlocks.concat(this._renderGroups))},dudeGraph.Renderer.prototype.zoomToFitSelection=function(){this.zoomToFitRenderNodes(this._selectedRenderNodes)},dudeGraph.Renderer.prototype.zoomReset=function(){this._zoom.translate=[0,0],this._zoom.scale=1,this._updateZoom()},dudeGraph.Renderer.prototype.renderBlockById=function(e){return this._renderBlockIds[e]||null},dudeGraph.Renderer.prototype.renderBlocksByBlock=function(e){return _.filter(this._renderBlocks,function(t){return t.block===e})},dudeGraph.Renderer.prototype.createRenderBlock=function(e,t){var n=this._graph.blockById(e.cgBlock);if(null===n)throw new Error("Unknown block `"+e.cgBlock+"` for renderBlock `"+e.id+"`");var o=this._renderBlockTypes[n.blockType];if(!o)throw new Error("Render block type `"+n.blockType+"` not registered in the renderer");var r=o.buildRenderBlock(this,e);if(null===r.nodeId||_.isUndefined(r.nodeId))throw new Error("Cannot create a renderBlock without an id");var i=this.renderBlockById(r.nodeId);if(null!==i)throw new Error("Duplicate renderBlocks for id `"+r.nodeId+"`: `"+i.nodeFancyName+"` was here before `"+r.nodeFancyName+"`");return this._renderBlocks.push(r),this._renderBlockIds[r.nodeId]=r,t&&this.createD3Blocks(),r},dudeGraph.Renderer.prototype.removeRenderBlock=function(e,t){var n=this;_.forEach(e.renderPoints,function(e){n.emptyRenderPoint(e,t)}),_.pull(this._renderBlocks,e),_.isEmpty(this.renderBlocksByBlock(e.block))&&this._graph.removeBlock(e.block),e.renderGroupParent&&e.renderGroupParent.removeChild(e),t&&(e.renderGroupParent&&(e.renderGroupParent.computePosition(),e.renderGroupParent.computeSize(),e.renderGroupParent.update()),this.removeD3Blocks())},dudeGraph.Renderer.prototype.createRenderConnection=function(e,t){var n=dudeGraph.RenderConnection.buildRenderConnection(this,e);return n.outputRenderPoint.renderConnections.push(n),n.inputRenderPoint.renderConnections.push(n),this._renderConnections.push(n),t&&(this.createD3Connections(),n.outputRenderPoint.update(),n.inputRenderPoint.update()),n},dudeGraph.Renderer.prototype.removeRenderConnection=function(e,t){e.outputRenderPoint.point.disconnect(e.inputRenderPoint.point),_.pull(e.outputRenderPoint.renderConnections,e),_.pull(e.inputRenderPoint.renderConnections,e),_.pull(this._renderConnections,e),t&&(e.outputRenderPoint.update(),e.inputRenderPoint.update(),this.removeD3Connections())},dudeGraph.Renderer.prototype.renderGroupById=function(e){return this._renderGroupIds[e]||null},dudeGraph.Renderer.prototype.createRenderGroup=function(e,t){var n=dudeGraph.RenderGroup.buildRenderGroup(this,e);if(null===n.nodeId||_.isUndefined(n.nodeId))throw new Error("Cannot create a renderGroup without an id");var o=this.renderGroupById(n.nodeId);if(null!==o)throw new Error("Duplicate renderGroups for id `"+n.nodeId+"`: `"+o.nodeFancyName+"` was here before `"+n.nodeFancyName+"`");return this._renderGroups.push(n),this._renderGroupIds[n.nodeId]=n,t&&this.createD3Groups(),n},dudeGraph.Renderer.prototype.removeRenderGroup=function(e,t){e.removeAllChildren(),_.pull(this._renderGroups,e),t&&this.removeD3Groups()},dudeGraph.Renderer.prototype.renderPointByName=function(e,t,n){return _.find(e.renderPoints,function(e){return e.point.cgName===t&&e.point.isOutput===n})||null},dudeGraph.Renderer.prototype.createRenderPoint=function(e){return dudeGraph.RenderPoint.buildRenderPoint(this,e)},dudeGraph.Renderer.prototype.emptyRenderPoint=function(e,t){var n=this,o=_.clone(e.renderConnections);_.forEach(o,function(e){n.removeRenderConnection(e,t)})},dudeGraph.Renderer.prototype.createD3Blocks=function(){this.d3Blocks.data(this._renderBlocks,function(e){return e.nodeId}).enter().append("svg:g").attr("id",function(e){return e.nodeId}).classed("dude-graph-block",!0).each(function(e){e.create(d3.select(this)),e.removeParentEvent(),e.moveEvent()}),this.updateD3Blocks()},dudeGraph.Renderer.prototype.updateD3Blocks=function(){this.d3Blocks.each(function(e){e.update()})},dudeGraph.Renderer.prototype.removeD3Blocks=function(){this.d3Blocks.data(this._renderBlocks,function(e){return e.nodeId}).exit().each(function(e){e.remove()}).remove()},dudeGraph.Renderer.prototype.createD3Connections=function(){this.d3Connections.data(this._renderConnections,function(e){return e.connectionId}).enter().append("svg:path").attr("id",function(e){return e.connectionId}).classed("dude-graph-connection",!0).each(function(e){e.create(d3.select(this))}),this.updateD3Connections()},dudeGraph.Renderer.prototype.updateD3Connections=function(){this.d3Connections.each(function(e){e.update()})},dudeGraph.Renderer.prototype.removeD3Connections=function(){this.d3Connections.data(this._renderConnections,function(e){return e.connectionId}).exit().each(function(e){e.remove()}).remove()},dudeGraph.Renderer.prototype.createD3Groups=function(){this.d3Groups.data(this._renderGroups,function(e){return e.nodeId}).enter().append("svg:g").attr("id",function(e){return e.nodeId}).classed("dude-graph-group",!0).each(function(e){e.create(d3.select(this)),e.moveEvent()}),this.updateD3Groups()},dudeGraph.Renderer.prototype.updateD3Groups=function(){this.d3Groups.each(function(e){e.update()})},dudeGraph.Renderer.prototype.removeD3Groups=function(){this.d3Groups.data(this._renderGroups,function(e){return e.nodeId}).exit().each(function(e){e.remove()}).remove()},dudeGraph.Renderer.prototype.load=function(e){var t=this;_.forEach(e.blocks,function(e){t.createRenderBlock(e)}),_.forEach(e.groups,function(e){t.createRenderGroup(e)}),_.forEach(e.connections,function(e){t.createRenderConnection(e)}),_.forEach(e.blocks,function(e){var n=t.renderBlockById(e.id);if(e.parent){var o=t.renderGroupById(e.parent);if(null===o)throw new Error("Cannot find renderBlock `"+n.nodeFancyName+"` parent id `"+e.parent+"`");n.renderGroupParent=o}}),this._zoom=_.defaultsDeep(e.zoom||e.config&&e.config.zoom||{},dudeGraph.Renderer.defaultZoom),this._updateZoom(),this.createD3Blocks(),this.createD3Groups(),this.createD3Connections()},dudeGraph.Renderer.prototype.save=function(){return{zoom:{translate:this._zoom.translate||[0,0],scale:this._zoom.scale||1},blocks:_.map(this._renderBlocks,function(e){return{id:e.nodeId,cgBlock:e.block.cgId,description:e.nodeName,position:e.nodePosition,parent:e.renderGroupParent?e.renderGroupParent.nodeId:null}}),groups:_.map(this._renderGroups,function(e){return{id:e.nodeId,description:e.nodeName,position:e.nodePosition}}),connections:_.map(this._renderConnections,function(e,t){return{cgConnectionIndex:t,outputName:e.outputRenderPoint.point.cgName,outputRendererBlockId:e.outputRenderPoint.renderBlock.nodeId,inputName:e.inputRenderPoint.point.cgName,inputRendererBlockId:e.inputRenderPoint.renderBlock.nodeId}})}},d3.behavior.mousedown=function(){function e(e){e.each(function(e){function n(){o({type:"mousedown"})}var o=t.of(this,arguments);d3.select(this).on("mousedown",n)})}var t=d3_eventDispatch(e,"mousedown");return d3.rebind(e,t,"on")},d3.behavior.doubleClick=function(){function e(e){e.each(function(e){function n(){o({type:"dblclick"})}var o=t.of(this,arguments);d3.select(this).on("dblclick",n)})}var t=d3_eventDispatch(e,"dblclick");return d3.rebind(e,t,"on")},function(){_.mixin({preventD3Default:function(){_.browserIf(["IE"],function(){d3.event.sourceEvent.defaultPrevented=!0},function(){d3.event.sourceEvent.preventDefault()})},stopD3ImmediatePropagation:function(){d3.event.sourceEvent.stopImmediatePropagation()}})}(),dudeGraph.Renderer.prototype.measureText=function(e){return e instanceof d3.selection&&(e=e.text()),[8*e.length,17]},dudeGraph.Renderer.prototype.renderNodesBoundingRect=function(e,t){var n=[1/0,1/0],o=[-(1/0),-(1/0)];return _.forEach(e,function(e){n[0]=Math.min(n[0],e.nodePosition[0]),n[1]=Math.min(n[1],e.nodePosition[1]),o[0]=Math.max(o[0],e.nodePosition[0]+e.nodeSize[0]),o[1]=Math.max(o[1],e.nodePosition[1]+e.nodeSize[1])}),n[0]===1/0||o[0]===-(1/0)?t?null:[[0,0],[0,0]]:[n,o]},dudeGraph.Renderer.prototype.screenToWorld=function(e){this._svgPoint.x=e[0],this._svgPoint.y=e[1];var t=this._svgPoint.matrixTransform(this._d3Root.node().getCTM().inverse());return[t.x,t.y]},dudeGraph.defaultBlocks=[{block:"Assignation",type:dudeGraph.Assignation},{block:"Condition",type:dudeGraph.Condition},{block:"Delegate",type:dudeGraph.Delegate},{block:"Each",type:dudeGraph.Each},{block:"Function",type:dudeGraph.Function},{block:"Getter",type:dudeGraph.Getter},{block:"Instruction",type:dudeGraph.Instruction},{block:"Operator",type:dudeGraph.Operator},{block:"Range",type:dudeGraph.Range},{block:"Variable",type:dudeGraph.Variable}],dudeGraph.defaultPoints=[{point:"Choice",type:dudeGraph.Choice},{point:"Stream",type:dudeGraph.Stream}],dudeGraph.defaultRenderBlocks=[{renderBlock:"Assignation",type:dudeGraph.RenderBlock},{renderBlock:"Condition",type:dudeGraph.RenderBlock},{renderBlock:"Delegate",type:dudeGraph.RenderBlock},{renderBlock:"Each",type:dudeGraph.RenderBlock},{renderBlock:"Function",type:dudeGraph.RenderBlock},{renderBlock:"Getter",type:dudeGraph.RenderBlock},{renderBlock:"Instruction",type:dudeGraph.RenderBlock},{renderBlock:"Operator",type:dudeGraph.RenderBlock},{renderBlock:"Range",type:dudeGraph.RenderBlock},{renderBlock:"Variable",type:dudeGraph.RenderVariable}];
//# sourceMappingURL=dude-graph.js.map
