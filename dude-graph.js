function d3_dispatch_event(e){function t(){for(var t,o=n,r=-1,i=o.length;++r<i;)t=o[r].on,t&&t.apply(this,arguments);return e}var n=[],o=d3.map();return t.on=function(t,r){var i,a=o.get(t);return arguments.length<2?a&&a.on:(a&&(a.on=null,n=n.slice(0,i=n.indexOf(a)).concat(n.slice(i+1)),o.remove(t)),r&&n.push(o.set(t,{on:r})),e)},t}function d3_eventDispatch(e){for(var t=d3.dispatch(),n=0,o=arguments.length;++n<o;)t[arguments[n]]=d3_dispatch_event(t);return t.of=function(n,o){return function(r){var i;try{i=r.sourceEvent=d3.event,r.target=e,d3.event=r,t[r.type].apply(n,o)}finally{d3.event=i}}},t}var dudeGraph=function(){var e={};return"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=e),exports.dudeGraph=e):window.dudeGraph=e,e}();dudeGraph.browser=function(){var e=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0;return e?"Opera":"undefined"!=typeof InstallTrigger?"Firefox":Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0?"Safari":-1!==navigator.userAgent.indexOf("Edge")?"Edge":window.chrome&&!e?"Chrome":document.documentMode?"IE":"Unknown"}(),dudeGraph.browserIf=function(e,t,n){_.includes(e,dudeGraph.browser)?(t&&t||function(){})():(n&&n||function(){})()},dudeGraph.clamp=function(e,t,n){return Math.min(Math.max(e,t),n)},dudeGraph.uuid=function(){var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},t=e();return function(){return t+"-"+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}},dudeGraph.Models={},dudeGraph.Models.query=function(e,t){var n=[];return!t.emptyValue()||t.pointSingleConnection&&!t.emptyConnection()?[]:(function o(e){_.forEach(e,function(e){if(_.isUndefined(e.item))_.isUndefined(e.group)||o(e.group.items);else{var r=t.pointOutput?e.item.data.blockInputs:e.item.data.blockOutputs,i=_.filter(r,function(e){return t.pointValueType===e.pointValueType});_.isEmpty(i)||n.push({model:e,modelPoints:_.map(i,function(e){return e.pointName})})}})}(e),n)},dudeGraph.Graph=function(){this._graphTypes=this._graphTypes={Number:{convert:function(e){return _.isNumber(e)?e:/^[0-9]+(\.[0-9]+)?$/.test(e)?_.toNumber(e):"true"===e||e===!0?1:"false"===e||e===!1?0:void 0},compatible:["Boolean"]},String:{convert:function(e){return _.isString(e)?e:_.isNumber(e)||_.isBoolean(e)?_.toString(e):void 0},compatible:["Number","Boolean"]},Boolean:{convert:function(e){return _.isBoolean(e)?e:1===e||"true"===e?!0:0===e||"false"===e?!1:void 0},compatible:["Number"]},Array:{convert:function(e){return _.isArray(e)?e:void 0},compatible:[]},Object:{convert:function(e){return _.isObject(e)?e:void 0},compatible:[]},Stream:{convert:function(){},compatible:[]},Resource:{convert:function(e){return _.isObject(e)?e:void 0},compatible:[]}},this._graphBlocks=[],Object.defineProperty(this,"graphBlocks",{get:function(){return this._graphBlocks}.bind(this)}),this._graphBlocksIds={},Object.defineProperty(this,"graphBlocksIds",{get:function(){return this._graphBlocksIds}.bind(this)}),this._graphConnections=[],Object.defineProperty(this,"graphConnections",{get:function(){return this._graphConnections}.bind(this)}),this._graphVariables=[],Object.defineProperty(this,"graphVariables",{get:function(){return this._graphVariables}.bind(this)}),Object.defineProperty(this,"graphFancyName",{get:function(){return"Graph"}}),this._graphGenerateBlockId=dudeGraph.uuid()},dudeGraph.Graph.prototype=_.create(EventEmitter.prototype,{constructor:dudeGraph.Graph,className:"Graph"}),dudeGraph.Graph.prototype.addType=function(e,t){if(!_.isUndefined(this._graphTypes[e]))throw new Error("`"+this.graphFancyName+"` cannot redefine value type`"+e+"`");this._graphTypes[e]={convert:t.convert||_.noop,compatible:t.compatible||[]}},dudeGraph.Graph.prototype.removeType=function(e){},dudeGraph.Graph.prototype.hasType=function(e){return!_.isUndefined(this._graphTypes[e])},dudeGraph.Graph.prototype.convertValue=function(e,t){if(null===t)return null;var n=this._graphTypes[e];if(_.isUndefined(n))throw new Error("`"+this.graphFancyName+"` has no value type `"+e+"`");if(_.isUndefined(n.convert))throw this._graphTypes;return n.convert(t)},dudeGraph.Graph.prototype.convertConnection=function(e,t){var n=this._graphTypes[t];if(_.isUndefined(n))throw new Error("`"+this.graphFancyName+"` cannot find compatible type to convert connection from `"+e+"` to `"+t+"`");return e===t||_.includes(n.compatible,e)},dudeGraph.Graph.prototype.addBlock=function(e){if(null!==e.blockGraph)throw new Error("`"+e.blockFancyName+"` cannot redefine `blockGraph`");if(null!==e.blockId&&!_.isUndefined(this._graphBlocksIds[e.blockId]))throw new Error("`"+this.graphFancyName+"` cannot redefine id `"+e.blockId+"`");e.blockGraph=this,null===e.blockId&&(e.blockId=this.nextBlockId()),e.added(),this._graphBlocks.push(e),this._graphBlocksIds[e.blockId]=e,this.emit("block-add",e)},dudeGraph.Graph.prototype.removeBlock=function(e){if(e.blockGraph!==this||!_.includes(this._graphBlocks,e))throw new Error("`"+this.graphFancyName+"` has no block `"+e.blockFancyName+"`");e.removeAllPoints(),e.removed(),_.pull(this._graphBlocks,e),delete this._graphBlocksIds[e.blockId],this.emit("block-remove",e)},dudeGraph.Graph.prototype.cloneBlocks=function(e){},dudeGraph.Graph.prototype.blockById=function(e){return this._graphBlocksIds[e]||null},dudeGraph.Graph.prototype.blocksByName=function(e){return _.filter(this._graphBlocks,function(t){return t.blockName===e})},dudeGraph.Graph.prototype.blocksByType=function(e){return _.filter(this._graphBlocks,function(t){return t.className===e||_.isFunction(e)&&t instanceof e})},dudeGraph.Graph.prototype.nextBlockId=function(){return this._graphGenerateBlockId()},dudeGraph.Graph.prototype.connectPoints=function(e,t){if(e===t)throw new Error("`"+this.graphFancyName+"` cannot connect `"+e.pointFancyName+"` to itself");if(!e.pointOutput)throw new Error("`"+e.pointFancyName+"` is not an output");if(t.pointOutput)throw new Error("`"+e.pointFancyName+"` is not an input");if(!e.acceptConnect(t))throw new Error("`"+e.pointFancyName+"` cannot accept to connect to `"+t.pointFancyName+"`");if(!t.acceptConnect(e))throw new Error("`"+t.pointFancyName+"` cannot accept to connect to `"+e.pointFancyName+"`");if(!this.convertConnection(e.pointValueType,t.pointValueType)){if(null===e.pointTemplate&&null===t.pointTemplate)throw new Error("`"+this.graphFancyName+"` cannot connect `"+e.pointFancyName+"` to `"+t.pointFancyName+"` because types `"+e.pointValueType+"` and `"+t.pointValueType+"` are incompatible");try{e.pointBlock.updateTemplate(e.pointTemplate,t.pointValueType)}catch(n){null!==t.pointTemplate&&t.pointBlock.updateTemplate(t.pointTemplate,e.pointValueType)}}_.forEach(this._graphConnections,function(n){if(n.connectionOutputPoint===e&&n.connectionInputPoint===t)throw new Error("`"+n.connectionFancyName+"` already exists")});var o=new dudeGraph.Connection(e,t);e.addConnection(o);try{t.addConnection(o)}catch(r){throw e.removeConnection(o),r}return this._graphConnections.push(o),this.emit("connection-add",o),o},dudeGraph.Graph.prototype.disconnectPoints=function(e,t){var n=_.find(this._graphConnections,function(n){return n.connectionOutputPoint===e&&n.connectionInputPoint===t})||null;if(null===n)throw new Error("`"+this.graphFancyName+"` cannot find a connection between `"+e.pointFancyName+"` and `"+t.pointFancyName+"`");e.removeConnection(n),t.removeConnection(n),_.pull(this._graphConnections,n),this.emit("connection-remove",n)},dudeGraph.Graph.prototype.addVariable=function(e){if(null!==e.variableGraph)throw new Error("`"+e.variableFancyName+"` cannot redefine `variableGraph`");if(null!==this.variableByName(e.variableName))throw new Error("`"+this.graphFancyName+"` cannot redefine variable name `"+e.variableName+"`");e.variableGraph=this,e.added(),this._graphVariables.push(e),this.emit("variable-add",e)},dudeGraph.Graph.prototype.removeVariable=function(e){if(e.variableGraph!==this||!_.includes(this._graphVariables,e))throw new Error("`"+this.graphFancyName+"` has no variable `"+e.variableFancyName+"`");null!==e.variableBlock&&this.removeBlock(e.variableBlock),_.pull(this._graphVariables,e),this.emit("variable-remove",e)},dudeGraph.Graph.prototype.variableByName=function(e){return _.find(this._graphVariables,function(t){return t.variableName===e})||null},dudeGraph.Block=function(e){this._blockGraph=null,Object.defineProperty(this,"blockGraph",{set:function(e){if(null!==this._blockGraph&&this._blockGraph!==e)throw new Error("`"+this.blockFancyName+"` cannot redefine `blockGraph`");this._blockGraph=e}.bind(this),get:function(){return this._blockGraph}.bind(this)}),this._blockType=this.className,Object.defineProperty(this,"blockType",{get:function(){return this._blockType}.bind(this)}),this._blockId=null,Object.defineProperty(this,"blockId",{set:function(e){if(null!==this._blockId)throw new Error("`"+this.blockFancyName+"` cannot redefine `blockId`");this._blockId=e}.bind(this),get:function(){return this._blockId}.bind(this)}),this._blockName=null,Object.defineProperty(this,"blockName",{get:function(){return this._blockName}.bind(this)}),this._blockTemplates={},Object.defineProperty(this,"blockTemplates",{get:function(){return this._blockTemplates}.bind(this)}),this._blockOutputs=[],Object.defineProperty(this,"blockOutputs",{get:function(){return this._blockOutputs}.bind(this)}),this._blockInputs=[],Object.defineProperty(this,"blockInputs",{get:function(){return this._blockInputs}.bind(this)}),Object.defineProperty(this,"blockFancyName",{get:function(){return this._blockName+" ("+this._blockId+")"}.bind(this)}),this.initialize(e||{})},dudeGraph.Block.prototype=_.create(EventEmitter.prototype,{constructor:dudeGraph.Block,className:"Block"}),dudeGraph.Block.prototype.initialize=function(e){this._blockId=e.blockId||null,this._blockName=e.blockName||this.className,this._blockTemplates=e.blockTemplates||{}},dudeGraph.Block.prototype.added=function(){var e=this;_.forOwn(this._blockTemplates,function(t,n){e.updateTemplate(n,t.valueType,!0)})},dudeGraph.Block.prototype.validatePoints=function(){},dudeGraph.Block.prototype.removed=function(){},dudeGraph.Block.prototype.pointValueChanged=function(e,t,n){},dudeGraph.Block.prototype.template=function(e){if(null===this._blockGraph)throw new Error("`"+this.blockFancyName+"` cannot manipulate templates when not bound to a graph");return this._blockTemplates[e]||null},dudeGraph.Block.prototype.updateTemplate=function(e,t,n){if(null===this._blockGraph)throw new Error("`"+this.blockFancyName+"` cannot manipulate templates when not bound to a graph");if(!this._blockGraph.hasType(t))throw new Error("`"+this.graphFancyName+"` has no value type `"+t+"`");var o=this.template(e);if(null===o)throw new Error("`"+this.blockFancyName+"` has no template `"+e+"`");if(!_.includes(o.templates,t))throw new Error("`"+this.blockFancyName+"` has no value type "+t+"` is its templates: ` "+o.templates.join(", ")+"`");if(o.valueType!==t){var r=o.valueType,i=_.map(this._blockOutputs,function(t){return t.pointTemplate===e?t.pointValue:void 0}),a=_.map(this._blockInputs,function(t){return t.pointTemplate===e?t.pointValue:void 0});try{_.forEach(this._blockOutputs,function(o){o.pointTemplate===e&&o.changeValueType(t,n)}),_.forEach(this._blockInputs,function(o){o.pointTemplate===e&&o.changeValueType(t,n)})}catch(d){throw _.forEach(this._blockOutputs,function(t,n){t.pointTemplate===e&&(t.changeValue(null),t.changeValueType(r,!0),t.changeValue(i[n]))}),_.forEach(this._blockInputs,function(t,n){t.pointTemplate===e&&(t.changeValue(null),t.changeValueType(r,!0),t.changeValue(a[n]))}),d}o.valueType=t,n||(this._blockGraph.emit("block-template-update",this,e,o.valueType,r),this.emit("template-update",e,o.valueType,r))}},dudeGraph.Block.prototype.addPoint=function(e,t){if(null===this._blockGraph)throw new Error("`"+this.blockFancyName+"` cannot add point when not bound to a graph");if(e.pointOutput&&null!==this.outputByName(e.pointName))throw new Error("`"+this.blockFancyName+"` cannot redefine `"+e.pointName+"`");if(!e.pointOutput&&null!==this.inputByName(e.pointName))throw new Error("`"+this.blockFancyName+"` cannot redefine `"+e.pointName+"`");e.pointBlock=this,e.validate(),_.isUndefined(t)&&(t=e.pointOutput?this._blockOutputs.length:this._blockInputs.length),e.pointOutput?this._blockOutputs.splice(t,0,e):this._blockInputs.splice(t,0,e),this.emit("point-add",e),this._blockGraph.emit("block-point-add",this,e)},dudeGraph.Block.prototype.removePoint=function(e){if(e.pointOutput&&null===this.outputByName(e.pointName))throw new Error("`"+this.blockFancyName+"` has not output `"+e.pointName+"`");if(!e.pointOutput&&null===this.inputByName(e.pointName))throw new Error("`"+this.blockFancyName+"` has no input `"+e.pointName+"`");e.disconnectAll(),e.pointBlock=null,e.pointOutput&&_.pull(this._blockOutputs,e),e.pointOutput||_.pull(this._blockInputs,e),this.emit("point-remove",e),this._blockGraph.emit("block-point-remove",this,e)},dudeGraph.Block.prototype.removeAllPoints=function(){var e=this;_.forEachRight(this._blockOutputs,function(t){e.removePoint(t)}),_.forEachRight(this._blockInputs,function(t){e.removePoint(t)})},dudeGraph.Block.prototype.connectPointTo=function(e,t){if(e.pointOutput&&_.isUndefined(_.find(this._blockOutputs,e)))throw new Error("`"+this.blockFancyName+"` has no output `"+e.pointFancyName+"`");if(!e.pointOutput&&_.isUndefined(_.find(this._blockInputs,e)))throw new Error("`"+this.blockFancyName+"` has no input `"+e.pointFancyName+"`");return e.pointOutput?this._blockGraph.connectPoints(e,t):this._blockGraph.connectPoints(t,e)},dudeGraph.Block.prototype.disconnectPointFrom=function(e,t){if(e.pointOutput&&_.isUndefined(_.find(this._blockOutputs,e)))throw new Error("`"+this.blockFancyName+"` has no output `"+e.pointFancyName+"`");if(!e.pointOutput&&_.isUndefined(_.find(this._blockInputs,e)))throw new Error("`"+this.blockFancyName+"` has no input `"+e.pointFancyName+"`");return e.pointOutput?this._blockGraph.disconnectPoints(e,t):this._blockGraph.disconnectPoints(t,e)},dudeGraph.Block.prototype.inputByName=function(e){return _.find(this._blockInputs,function(t){return t.pointName===e})||null},dudeGraph.Block.prototype.outputByName=function(e){return _.find(this._blockOutputs,function(t){return t.pointName===e})||null},dudeGraph.Block.prototype.clone=function(){},dudeGraph.Point=function(e,t){this._pointBlock=null,Object.defineProperty(this,"pointBlock",{set:function(e){if(null!==e&&null!==this._pointBlock)throw new Error("`"+this.pointFancyName+"` cannot redefine `pointBlock`");this._pointBlock=e}.bind(this),get:function(){return this._pointBlock}.bind(this)}),this._pointOutput=e,Object.defineProperty(this,"pointOutput",{get:function(){return this._pointOutput}.bind(this)}),this._pointType=this.className,Object.defineProperty(this,"pointType",{get:function(){return this._pointType}.bind(this)}),this._pointName=null,Object.defineProperty(this,"pointName",{get:function(){return this._pointName}.bind(this)}),this._pointTemplate=null,Object.defineProperty(this,"pointTemplate",{get:function(){return this._pointTemplate}.bind(this)}),this._pointValueType=null,Object.defineProperty(this,"pointValueType",{get:function(){return this._pointValueType}.bind(this),set:this.changeValueType}),this._pointValue=null,Object.defineProperty(this,"pointValue",{get:function(){return this._pointValue}.bind(this),set:this.changeValue}),this._pointConnections=[],Object.defineProperty(this,"pointConnections",{get:function(){return this._pointConnections}.bind(this)}),this._pointSingleConnection=!0,Object.defineProperty(this,"pointSingleConnection",{get:function(){return this._pointSingleConnection}.bind(this)}),Object.defineProperty(this,"pointFancyName",{get:function(){return this._pointName+" @"+(this._pointBlock?this._pointBlock.blockFancyName:"Unbound point")}.bind(this)}),this.initialize(t)},dudeGraph.Point.prototype=_.create(EventEmitter.prototype,{constructor:dudeGraph.Point,className:"Point"}),dudeGraph.Point.prototype.initialize=function(e){if(this._pointName=e.pointName,this._pointTemplate=e.pointTemplate||null,this._pointValueType=e.pointValueType,this._pointValue=_.isUndefined(e.pointValue)?null:e.pointValue,this._pointSingleConnection=_.isUndefined(e.pointSingleConnection)?!0:e.pointSingleConnection,!_.isString(this._pointName))throw new Error("`"+this.pointFancyName+"` `pointName` must be a non-null String");if(null===this._pointTemplate&&!_.isString(this._pointValueType))throw new Error("`"+this.pointFancyName+"` `pointValueType` must be a non-null String if no `pointTemplate` is provided")},dudeGraph.Point.prototype.validate=function(){if(null===this._pointTemplate)this.changeValueType(this._pointValueType,!0);else{var e=this._pointBlock.template(this._pointTemplate);if(null===e)throw new Error;this.changeValueType(e.valueType,!0)}this.changeValue(this._pointValue,!0)},dudeGraph.Point.prototype.emptyValue=function(){return null===this._pointValue},dudeGraph.Point.prototype.emptyConnection=function(){return 0===this._pointConnections.length},dudeGraph.Point.prototype.empty=function(){return this.emptyValue()&&this.emptyConnection()},dudeGraph.Point.prototype.changeValueType=function(e,t){if(null===this._pointBlock)throw new Error("`"+this.pointFancyName+"` cannot change value type when not bound to a block");if(!this._pointBlock.blockGraph.hasType(e))throw new Error("`"+this._pointBlock.blockGraph.graphFancyName+"` has no value type `"+e+"`");if(_.isUndefined(this._pointBlock.blockGraph.convertValue(e,this._pointValue)))throw new Error("`"+this._pointValue+"` is not compatible with value type `"+e+"`");var n=this._pointValueType;this._pointValueType=e,t||(this.emit("value-type-change",e,n),this._pointBlock.blockGraph.emit("point-value-type-change",this,e,n)),this.changeValue(this._pointValue,!!t)},dudeGraph.Point.prototype.changeValue=function(e,t){if(null===this._pointBlock)throw new Error("`"+this.pointFancyName+"` cannot change value when not bound to a block");if(null!==e&&!this.emptyConnection())throw new Error("`"+this.pointFancyName+"` cannot change value when connected to another point");var n=this._pointValue,o=this._pointBlock.blockGraph.convertValue(this._pointValueType,e);if(_.isUndefined(o))throw new Error("`"+this._pointBlock.blockGraph+"` "+e+"` is not compatible with type `"+this._pointValueType+"`");this._pointValue=o,t||(this.emit("value-change",o,n),this._pointBlock.blockGraph.emit("point-value-change",this,o,n),this._pointBlock.pointValueChanged(this,o,n))},dudeGraph.Point.prototype.acceptConnect=function(e){return this.emptyValue()&&(!this._pointSingleConnection||this.emptyConnection())},dudeGraph.Point.prototype.connect=function(e){if(null===this._pointBlock)throw new Error("`"+this.pointFancyName+"` cannot connect to another point when not bound to a block");return this._pointBlock.connectPointTo(this,e)},dudeGraph.Point.prototype.disconnect=function(e){if(null===this._pointBlock)throw new Error("`"+this.pointFancyName+"` cannot disconnect from another point when not bound to a block");return this.pointBlock.disconnectPointFrom(this,e)},dudeGraph.Point.prototype.disconnectAll=function(){var e=this;_.forEachRight(this._pointConnections,function(t){e.disconnect(t.other(e))})},dudeGraph.Point.prototype.addConnection=function(e){if(null===this.pointBlock)throw new Error("`"+this.pointFancyName+"` cannot be connected when the point is not bound to a block");if(e.connectionOutputPoint!==this&&e.connectionInputPoint!==this)throw new Error("`"+this.pointFancyName+"` is not involved in `"+e.connectionFancyName+"`");var t=_.find(e,this._pointConnections)||null;if(null!==t)throw new Error("`"+this.pointFancyName+"` cannot redefine `"+e.connectionFancyName+"`");this._pointConnections.push(e)},dudeGraph.Point.prototype.removeConnection=function(e){if(e.connectionOutputPoint!==this&&e.connectionInputPoint!==this)throw new Error("`"+this.pointFancyName+"` is not involved in `"+e.connectionFancyName+"`");var t=_.find(this._pointConnections,e)||null;if(null===t)throw new Error("`"+this.pointFancyName+"` has no connection `"+e.connectionFancyName+"`");_.pull(this._pointConnections,t)},dudeGraph.Point.prototype.clone=function(){},dudeGraph.Connection=function(e,t){this._connectionOutputPoint=e,Object.defineProperty(this,"connectionOutputPoint",{get:function(){return this._connectionOutputPoint}.bind(this)}),this._connectionInputPoint=t,Object.defineProperty(this,"connectionInputPoint",{get:function(){return this._connectionInputPoint}.bind(this)}),Object.defineProperty(this,"connectionFancyName",{get:function(){return this._connectionOutputPoint.pointFancyName+" => "+this._connectionInputPoint.pointFancyName}.bind(this)}),this.initialize()},dudeGraph.Connection.prototype.initialize=function(){if(!this._connectionOutputPoint.pointOutput)throw new Error("`"+this._connectionOutputPoint.pointFancyName+"` must be an output");if(this._connectionInputPoint.pointOutput)throw new Error("`"+this._connectionInputPoint.pointFancyName+"` must be an input")},dudeGraph.Connection.prototype.other=function(e){switch(e){case this._connectionOutputPoint:return this._connectionInputPoint;case this._connectionInputPoint:return this._connectionOutputPoint}throw new Error("`"+this.connectionFancyName+"` has no point `"+e.pointFancyName+"`")},dudeGraph.Connection.prototype.remove=function(){this._connectionOutputPoint.disconnect(this._connectionInputPoint)},dudeGraph.ResourcePoint=function(e,t){dudeGraph.Point.call(this,e,_.merge(t,{pointValueType:"Resource"}))},dudeGraph.ResourcePoint.prototype=_.create(dudeGraph.Point.prototype,{constructor:dudeGraph.ResourcePoint,className:"ResourcePoint"}),dudeGraph.ResourcePoint.prototype.emptyValue=function(){return null===this._pointValue||_.isUndefined(this._pointValue.resourceValue)||null===this._pointValue.resourceValue},dudeGraph.ResourcePoint.prototype.changeValueType=function(e,t){if("Resource"!==e)throw new Error("`"+this._pointValue+"` can only be of value type `Resource`");dudeGraph.Point.prototype.changeValueType.call(this,e,t)},dudeGraph.ResourcePoint.prototype.changeValue=function(e,t){dudeGraph.Point.prototype.changeValue.call(this,e,t)},dudeGraph.StreamPoint=function(e,t){dudeGraph.Point.call(this,e,t)},dudeGraph.StreamPoint.prototype=_.create(dudeGraph.Point.prototype,{constructor:dudeGraph.StreamPoint,className:"StreamPoint"}),dudeGraph.AssignationBlock=function(e){dudeGraph.Block.call(this,e)},dudeGraph.AssignationBlock.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.AssignationBlock,className:"AssignationBlock"}),dudeGraph.AssignationBlock.prototype.validatePoints=function(){if(dudeGraph.Block.prototype.validatePoints.call(this),!(this.inputByName("in")instanceof dudeGraph.StreamPoint))throw new Error("AssignationBlock `"+this.blockFancyName+"` must have an input `in` of type `Stream`");if(!(this.inputByName("variable")instanceof dudeGraph.Point))throw new Error("AssignationBlock `"+this.blockFancyName+"` must have an input `variable` of type `Point`");if(!(this.inputByName("value")instanceof dudeGraph.Point))throw new Error("AssignationBlock `"+this.blockFancyName+"` must have an input `value` of type `Point`");if(this.inputByName("variable").pointValueType!==this.inputByName("value").pointValueType)throw new Error("AssignationBlock `"+this.blockFancyName+"` inputs `variable` and `value` must have the same pointValueType");if(!(this.outputByName("out")instanceof dudeGraph.StreamPoint))throw new Error("AssignationBlock `"+this.blockFancyName+"` must have an output `out` of type `Stream`")},dudeGraph.ConditionBlock=function(e){dudeGraph.Block.call(this,e)},dudeGraph.ConditionBlock.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.ConditionBlock,className:"ConditionBlock"}),dudeGraph.ConditionBlock.prototype.validatePoints=function(){if(dudeGraph.Block.prototype.validatePoints.call(this),!(this.inputByName("in")instanceof dudeGraph.StreamPoint))throw new Error("ConditionBlock `"+this.blockFancyName+"` must have an input `in` of type `Stream`");if(!(this.inputByName("test")instanceof dudeGraph.Point)||"Boolean"!==this.inputByName("test").pointValueType)throw new Error("ConditionBlock `"+this.blockFancyName+"` must have an input `test` of type `Point` of pointValueType `Boolean`");if(!(this.outputByName("true")instanceof dudeGraph.StreamPoint))throw new Error("ConditionBlock `"+this.blockFancyName+"` must have an output `true` of type `Stream`");if(!(this.outputByName("false")instanceof dudeGraph.StreamPoint))throw new Error("ConditionBlock `"+this.blockFancyName+"` must have an output `false` of type `Stream`")},dudeGraph.DelegateBlock=function(e){dudeGraph.Block.call(this,e)},dudeGraph.DelegateBlock.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.DelegateBlock,className:"DelegateBlock"}),dudeGraph.DelegateBlock.prototype.validatePoints=function(){if(dudeGraph.Block.prototype.validatePoints.call(this),!(this.outputByName("out")instanceof dudeGraph.StreamPoint))throw new Error("DelegateBlock `"+this.blockFancyName+"` must have an output `out` of type `Stream`")},dudeGraph.EachBlock=function(e){dudeGraph.Block.call(this,e)},dudeGraph.EachBlock.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.EachBlock,className:"EachBlock"}),dudeGraph.ExpressionBlock=function(e){dudeGraph.Block.call(this,e),this._formatPointName="expression",this._parser=new dudeGraph.ExpressionParser},dudeGraph.ExpressionBlock.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.ExpressionBlock,className:"ExpressionBlock"}),dudeGraph.ExpressionBlock.prototype.validatePoints=function(){if(dudeGraph.Block.prototype.validatePoints.call(this),!(this.inputByName(this._formatPointName)instanceof dudeGraph.Point)||"String"!==this.inputByName(this._formatPointName).pointValueType)throw new Error("ExpressionBlock `"+this.blockId+"` must have an input `"+this._formatPointName+"` of type `Point` of pointValueType `String`");this._validateExpression()},dudeGraph.ExpressionBlock.prototype.pointValueChanged=function(e,t,n){e.pointName===this._formatPointName&&this._validateExpression()},dudeGraph.ExpressionBlock.prototype._validateExpression=function(){var e=this,t=this.inputByName(this._formatPointName).pointValue;if(""===t||null===t)_.forEachRight(this.blockInputs,function(t){t.pointName!==this._formatPointName&&e.removePoint(t)}.bind(this));else try{var n=this._parser.parse(t);_.forEach(n.variables,function(t){if(null===e.inputByName(t)){var n=new dudeGraph.Point(!1,{pointName:t,pointValueType:"Number"});e.addPoint(n)}}.bind(this)),_.forEachRight(this.blockInputs,function(t){t.pointName===this._formatPointName||_.includes(n.variables,t.pointName)||e.removePoint(t)}.bind(this))}catch(o){console.warn(o.message)}};var TypeRegex=/\{\{(\w+)}}/g;dudeGraph.FormatBlock=function(e){dudeGraph.Block.call(this,e),this._formatPointName="format"},dudeGraph.FormatBlock.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.FormatBlock,className:"FormatBlock"}),dudeGraph.FormatBlock.prototype.validatePoints=function(){if(dudeGraph.Block.prototype.validatePoints.call(this),!(this.inputByName(this._formatPointName)instanceof dudeGraph.Point)||"String"!==this.inputByName(this._formatPointName).pointValueType)throw new Error("FormatBlock `"+this.blockId+"` must have an input `"+this._formatPointName+"` of type `Point` of pointValueType `String`");this._validateFormat()},dudeGraph.FormatBlock.prototype.pointValueChanged=function(e,t,n){e.pointName===this._formatPointName&&this._validateFormat()},dudeGraph.FormatBlock.prototype._validateFormat=function(){for(var e=this,t=this.inputByName(this._formatPointName).pointValue,n=!0;n;)if(n=TypeRegex.exec(t),n&&null===e.inputByName(n[1])){var o=new dudeGraph.Point(!1,{pointName:n[1],pointValueType:"String"});e.addPoint(o)}var r=_.clone(e.blockInputs);_.forEachRight(r,function(n){n.pointName!==e._formatPointName&&-1===t.indexOf("{{"+n.pointName+"}}")&&e.removePoint(n)})},dudeGraph.FunctionBlock=function(e){dudeGraph.Block.call(this,e)},dudeGraph.FunctionBlock.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.FunctionBlock,className:"FunctionBlock"}),dudeGraph.GetterBlock=function(e){dudeGraph.Block.call(this,e)},dudeGraph.GetterBlock.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.GetterBlock,className:"GetterBlock"}),dudeGraph.InstructionBlock=function(e){dudeGraph.Block.call(this,e)},dudeGraph.InstructionBlock.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.InstructionBlock,className:"InstructionBlock"}),dudeGraph.InstructionBlock.prototype.validatePoints=function(){if(dudeGraph.Block.prototype.validatePoints.call(this),!(this.inputByName("in")instanceof dudeGraph.StreamPoint))throw new Error("InstructionBlock `"+this.blockFancyName+"` must have an input `in` of type `Stream`");if(!(this.outputByName("out")instanceof dudeGraph.StreamPoint))throw new Error("InstructionBlock `"+this.blockFancyName+"` must have an output `out` of type `Stream`")},dudeGraph.OperatorBlock=function(e){dudeGraph.Block.call(this,e)},dudeGraph.OperatorBlock.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.OperatorBlock,className:"OperatorBlock"}),dudeGraph.OperatorBlock.prototype.validatePoints=function(){if(dudeGraph.Block.prototype.validatePoints.call(this),1!==this.blockOutputs.length)throw new Error("OperatorBlock `"+this.blockFancyName+"` must return one value");if(2!==this.blockInputs.length)throw new Error("OperatorBlock `"+this.blockFancyName+"` must only take 2 inputs")},dudeGraph.RangeBlock=function(e){dudeGraph.Block.call(this,e)},dudeGraph.RangeBlock.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.RangeBlock,className:"RangeBlock"}),dudeGraph.VariableBlock=function(e){dudeGraph.Block.call(this,e),this._graphVariable=null},dudeGraph.VariableBlock.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.VariableBlock,className:"VariableBlock"}),dudeGraph.VariableBlock.prototype.added=function(){if(dudeGraph.Block.prototype.added.call(this),this._graphVariable=this._blockGraph.variableByName(this._blockName),null===this._graphVariable)throw new Error("VariableBlock `"+this.blockFancyName+"` must be linked to a graph variable");if(null!==this._graphVariable.variableBlock&&this._graphVariable.variableBlock!==this)throw new Error("`"+this._graphVariable.variableFancyName+"` cannot redefine variableBlock");this._graphVariable.variableBlock=this},dudeGraph.VariableBlock.prototype.validatePoints=function(){if(dudeGraph.Block.prototype.validatePoints.call(this),!(this.outputByName("value")instanceof dudeGraph.Point))throw new Error("VariableBlock `"+this.blockFancyName+"` must have an output `value` of type `Point`");if(this._graphVariable.variableValueType!==this.outputByName("value").pointValueType)throw new Error("VariableBlock `"+this.blockFancyName+"` must be of value type `"+this._graphVariable.variableValueType+"`")},dudeGraph.VariableBlock.prototype.removed=function(){dudeGraph.Block.prototype.removed.call(this),this._graphVariable.variableBlock=null},dudeGraph.ExpressionLexer=function(e){this._operators=e,this._expression="",this._length=0,this._index=0,this._marker=0},dudeGraph.ExpressionLexer.prototype.getChar=function(e){return this._expression[this._index+(e||0)]||"\x00"},dudeGraph.ExpressionLexer.prototype.nextChar=function(){var e=this.getChar();return"\x00"!==e&&++this._index,e},dudeGraph.ExpressionLexer.prototype.isWhiteSpace=function(e){return-1!=="	\n ".indexOf(e)},dudeGraph.ExpressionLexer.prototype.isLetter=function(e){return e>="a"&&"z">=e||e>="A"&&"Z">=e},dudeGraph.ExpressionLexer.prototype.isDecimalDigit=function(e){return e>="0"&&"9">=e},dudeGraph.ExpressionLexer.prototype.isIdentifierStart=function(e){return"_"===e||this.isLetter(e)},dudeGraph.ExpressionLexer.prototype.isIdentifierPart=function(e){return this.isIdentifierStart(e)||this.isDecimalDigit(e)},dudeGraph.ExpressionLexer.prototype.createToken=function(e,t){
return{type:e,value:t,start:this._marker,end:this._index-1}},dudeGraph.ExpressionLexer.prototype.skipSpaces=function(){for(;this._index<this._length;){var e=this.getChar();if(!this.isWhiteSpace(e))break;this.nextChar()}},dudeGraph.ExpressionLexer.prototype.scanOperator=function(){return-1!==this._operators.indexOf(this.getChar())?this.createToken("Operator",this.nextChar()):-1!==this._operators.indexOf(this.getChar()+this.getChar(1))?this.createToken("Operator",this.nextChar()+this.nextChar()):void 0},dudeGraph.ExpressionLexer.prototype.scanIdentifier=function(){var e=this.getChar();if(this.isIdentifierStart(e)){for(var t=this.nextChar();;){if(e=this.getChar(),!this.isIdentifierPart(e))break;t+=this.nextChar()}return this.createToken("Identifier",t)}},dudeGraph.ExpressionLexer.prototype.scanNumber=function(){var e=this.getChar();if(this.isDecimalDigit(e)||"."===e){var t="";if("."!==e)for(t=this.nextChar();;){if(e=this.getChar(),!this.isDecimalDigit(e))break;t+=this.nextChar()}if("."===e)for(t+=this.nextChar();;){if(e=this.getChar(),!this.isDecimalDigit(e))break;t+=this.nextChar()}if("e"===e||"E"===e){if(t+=this.nextChar(),e=this.getChar(),"+"!==e&&"-"!==e&&!this.isDecimalDigit(e))throw e="character "+e,this._index>=this._length&&(e="<end>"),new SyntaxError("Unexpected "+e+" after the exponent sign");for(t+=this.nextChar();;){if(e=this.getChar(),!this.isDecimalDigit(e))break;t+=this.nextChar()}}if("."===t)throw new SyntaxError("Expecting decimal digits after the dot sign");return this.createToken("Number",t)}},dudeGraph.ExpressionLexer.prototype.reset=function(e){this._expression=e,this._length=e.length,this._index=0},dudeGraph.ExpressionLexer.prototype.next=function(){if(this.skipSpaces(),!(this._index>=this._length)){this._marker=this._index;var e=this.scanNumber()||this.scanOperator()||this.scanIdentifier();if("undefined"!=typeof e)return e;throw new SyntaxError("Unknown token from character "+this.getChar())}},dudeGraph.ExpressionLexer.prototype.peek=function(){var e,t;t=this._index;try{e=this.next()}catch(n){e=void 0}return this._index=t,e},dudeGraph.ExpressionParser=function(){this._operators=[["&&","||"],["==","!=",">=","<=","<",">"],["+","-"],["*","/","%"]],this._unaryOperators=["+","-","!"],this._lexer=new dudeGraph.ExpressionLexer(_.flatten(this._operators).concat(this._unaryOperators).concat(["(",")"])),this._variables=[]},dudeGraph.ExpressionParser.prototype.isOperator=function(e,t){return!_.isUndefined(e)&&"Operator"===e.type&&-1!==t.indexOf(e.value)},dudeGraph.ExpressionParser.prototype.parseVariableOrValue=function(){var e,t;if(e=this._lexer.peek(),"undefined"==typeof e)throw new SyntaxError("Unexpected termination of expression");if("Identifier"===e.type)return e=this._lexer.next(),-1===this._variables.indexOf(e.value)&&this._variables.push(e.value),{type:"Variable",name:e.value};if("Number"===e.type)return e=this._lexer.next(),{type:"Value",value:e.value};if(this.isOperator(e,"(")){if(this._lexer.next(),t=this.parseOperator(0),e=this._lexer.next(),!this.isOperator(e,")"))throw new SyntaxError("Missing closing )");return t}throw new SyntaxError(e.start+": Cannot process token "+e.value)},dudeGraph.ExpressionParser.prototype.parseUnary=function(){var e,t;return e=this._lexer.peek(),this.isOperator(e,this._unaryOperators)?(e=this._lexer.next(),t=this.parseUnary(),{type:"Unary",operator:e.value,expression:t}):this.parseVariableOrValue()},dudeGraph.ExpressionParser.prototype.parseOperator=function(e){if(e>=this._operators.length)return this.parseUnary();for(var t=this.parseOperator(e+1),n=this._lexer.peek();this.isOperator(n,this._operators[e]);)n=this._lexer.next(),t={type:"Operator",operator:n.value,first:t,second:this.parseOperator(e+1)},n=this._lexer.peek();return t},dudeGraph.ExpressionParser.prototype.parse=function(e){this._lexer.reset(e),this._variables=[];var t=this.parseOperator(0),n=this._lexer.next();if("undefined"!=typeof n)throw new SyntaxError(n.start+": Unexpected token "+n.value);return{variables:this._variables,tree:t}},dudeGraph.Variable=function(e){this._variableGraph=null,Object.defineProperty(this,"variableGraph",{set:function(e){if(null!==this._variableGraph)throw new Error("`"+this.variableFancyName+"` cannot redefine `variableGraph`");this._variableGraph=e}.bind(this),get:function(){return this._variableGraph}.bind(this)}),this._variableName=null,Object.defineProperty(this,"variableName",{get:function(){return this._variableName}.bind(this),set:function(){throw new Error("not yet implemented")}}),this._variableValueType=null,Object.defineProperty(this,"variableValueType",{get:function(){return this._variableValueType}.bind(this),set:function(){throw new Error("not yet implemented")}}),this._variableValue=null,Object.defineProperty(this,"variableValue",{get:function(){return this._variableValue}.bind(this),set:function(){throw new Error("not yet implemented")}}),this._variableBlock=null,Object.defineProperty(this,"variableBlock",{get:function(){return this._variableBlock}.bind(this),set:function(e){this._variableBlock=e}.bind(this)}),Object.defineProperty(this,"variableFancyName",{get:function(){return this._variableName+" ("+this._variableType+")"}.bind(this)}),this.initialize(e)},dudeGraph.Variable.prototype.initialize=function(e){if(this._variableName=e.variableName,this._variableValueType=e.variableValueType,this._variableValue=e.variableValue,this._variableBlock=e.variableBlock||null,!_.isString(this._variableName))throw new Error("`"+this.variableFancyName+"` `variableName` must be a non-null String");if(null!==this._variableBlock&&!(this._variableBlock instanceof dudeGraph.VariableBlock))throw new Error("`"+this.variableFancyName+"` `variableBlock` must be of type `dudeGraph.VariableBlock`")},dudeGraph.Variable.prototype.added=function(){if(!this._variableGraph.hasType(this._variableValueType))throw new Error("`"+this._variableGraph.graphFancyName+"` has no value type `"+this._variableType+"`")},dudeGraph.GraphLoader=function(){this._blockTypes={Block:dudeGraph.Block},this._pointTypes={Point:dudeGraph.Point}},dudeGraph.GraphLoader.prototype.registerBlockType=function(e,t){this._blockTypes[e]=t},dudeGraph.GraphLoader.prototype.registerPointType=function(e,t){this._pointTypes[e]=t},dudeGraph.GraphLoader.prototype.load=function(e,t){var n=this;_.forEach(t.variables,function(t){n.loadVariable(e,t)}),_.forEach(t.blocks,function(t){n.loadBlock(e,t)}),_.forEach(t.connections,function(t){n.loadConnection(e,t)})},dudeGraph.GraphLoader.prototype.loadBlock=function(e,t){var n=this;if(!t.hasOwnProperty("blockId"))throw new Error("Block property `blockId` is required");var o=this._blockTypes[t.blockType];if(_.isUndefined(o))throw new Error("Block type `"+t.blockType+"` not registered by the loader");var r=new o(t);return e.addBlock(r),_.forEach(t.blockOutputs,function(e){n.loadPoint(r,!0,e)}),_.forEach(t.blockInputs,function(e){n.loadPoint(r,!1,e)}),r.validatePoints(),r},dudeGraph.GraphLoader.prototype.loadPoint=function(e,t,n){if(!n.pointName)throw new Error("Block `"+e.blockId+"`: Point property `pointName` is required");var o=n.pointType,r=this._pointTypes[o];if(!r)throw new Error("Point type `"+o+"` not registered by the loader");var i=new r(t,n);return e.addPoint(i),i},dudeGraph.GraphLoader.prototype.loadConnection=function(e,t){var n=t.connectionOutputBlock,o=t.connectionOutputPoint,r=t.connectionInputBlock,i=t.connectionInputPoint,a=e.blockById(n);if(!a)throw new Error("Output block not found for id `"+n+"`");var d=e.blockById(r);if(!d)throw new Error("Input block not found for id `"+r+"`");var p=a.outputByName(o);if(!p)throw new Error("Output point `"+o+"` not found in block `"+n+"`");var s=d.inputByName(i);if(!s)throw new Error("Input point `"+i+"` not found in block `"+r+"`");p.connect(s)},dudeGraph.GraphLoader.prototype.loadVariable=function(e,t){e.addVariable(new dudeGraph.Variable({variableName:t.variableName,variableValueType:t.variableValueType,variableValue:t.variableValue}))},dudeGraph.GraphSaver=function(){},dudeGraph.GraphSaver.prototype.save=function(e){var t=this;return{variables:_.map(e.graphVariables,function(e){return t.saveVariable(e)}),blocks:_.map(e.graphBlocks,function(e){return t.saveBlock(e)}),connections:_.map(e.graphConnections,function(e){return t.saveConnection(e)})}},dudeGraph.GraphSaver.prototype.saveBlock=function(e){var t=this;return{blockType:e.blockType,blockId:e.blockId,blockName:e.blockName,blockOutputs:_.map(e.blockOutputs,function(e){return t.savePoint(e)}),blockInputs:_.map(e.blockInputs,function(e){return t.savePoint(e)}),blockTemplates:e.blockTemplates}},dudeGraph.GraphSaver.prototype.savePoint=function(e){return{pointType:e.pointType,pointName:e.pointName,pointValueType:e.pointValueType,pointValue:e.pointValue,pointTemplate:e.pointTemplate,pointSingleConnection:e.pointSingleConnection}},dudeGraph.GraphSaver.prototype.saveConnection=function(e){return{connectionOutputPoint:e.connectionOutputPoint.pointName,connectionOutputBlock:e.connectionOutputPoint.pointBlock.blockId,connectionInputPoint:e.connectionInputPoint.pointName,connectionInputBlock:e.connectionInputPoint.pointBlock.blockId}},dudeGraph.GraphSaver.prototype.saveVariable=function(e){return{variableName:e.variableName,variableValueType:e.variableValueType,variableValue:e.variableValue}},dudeGraph.Renderer=function(){this._graph=null,Object.defineProperty(this,"graph",{get:function(){return this._graph}.bind(this)}),this._config=null,Object.defineProperty(this,"config",{get:function(){return this._config}.bind(this)}),this._zoom=null,this._d3Svg=null,this._d3Root=null,this._d3Groups=null,this._d3Connections=null,this._d3Blocks=null,this._svgPoint=null,this._renderBlocks=null,this._renderGroups=null,this._renderConnections=null,this._renderBlockTypes=null,this._renderPointTypes=null,this._renderBlockIds=null,this._renderGroupIds=null,this._renderBlocksQuadtree=null,this._renderGroupsQuadtree=null,this._renderPointsQuadtree=null,this._selectedRenderNodes=null,Object.defineProperty(this,"d3Blocks",{get:function(){return this._d3Blocks.selectAll(".dude-graph-block")}.bind(this)}),Object.defineProperty(this,"d3Groups",{get:function(){return this._d3Groups.selectAll(".dude-graph-group")}.bind(this)}),Object.defineProperty(this,"d3Connections",{get:function(){return this._d3Connections.selectAll(".dude-graph-connection")}.bind(this)})},dudeGraph.Renderer.prototype=_.create(EventEmitter.prototype,{constructor:dudeGraph.Renderer}),dudeGraph.Renderer.prototype.initialize=function(e,t,n){var o=this;this._graph=e,this._d3Svg=d3.select(t),this._d3Root=this._d3Svg.append("svg:g").attr("id","dude-graph-renderer"),this._d3Groups=this._d3Root.append("svg:g").attr("id","dude-graph-groups"),this._d3Connections=this._d3Root.append("svg:g").attr("id","dude-graph-connections"),this._d3Blocks=this._d3Root.append("svg:g").attr("id","dude-graph-blocks"),this._svgPoint=t.createSVGPoint(),this._renderBlocks=[],this._renderGroups=[],this._renderConnections=[],this._selectedRenderNodes=[],this._renderBlockTypes={Block:dudeGraph.RenderBlock},this._renderPointTypes={Point:dudeGraph.RenderPoint},this._renderBlockIds={},this._renderGroupIds={},this._renderBlocksQuadtree=null,this._renderGroupsQuadtree=null,this._renderPointsQuadtree=null,this._config=_.defaultsDeep(n||{},dudeGraph.Renderer.defaultConfig),this._zoom=dudeGraph.Renderer.defaultZoom,this._graph.on("block-point-remove",function(e,t){var n=o.renderBlocksByBlock(e);_.forEach(n,function(e){var n=o.renderPointByName(e,t.pointName,t.pointOutput);o.removeRenderPoint(n,!0),null!==e.renderGroupParent&&e.updateRenderGroupParent()})}),this._graph.on("block-point-add",function(e,t){var n=o.renderBlocksByBlock(e);_.forEach(n,function(e){o.createRenderPoint(e,{point:t},!0),null!==e.renderGroupParent&&e.updateRenderGroupParent()})}),this._graph.on("point-value-change",function(e){var t=o.renderBlocksByBlock(e.pointBlock);_.forEach(t,function(e){e.update()})}),this._createSelectionBehavior(),this._createZoomBehavior()},dudeGraph.Renderer.prototype.registerRenderBlock=function(e,t){this._renderBlockTypes[e]=t},dudeGraph.Renderer.prototype.registerRenderPoint=function(e,t){this._renderPointTypes[e]=t},dudeGraph.Renderer.defaultConfig={zoom:{min:.01,max:5,margin:[10,10],transitionSpeed:800},block:{padding:10,header:50,pointSpacing:10,borderRadius:5},grid:{active:!1,spacingX:20,spacingY:20},group:{padding:10,header:30,borderRadius:5,minSize:[200,150]},point:{height:20,padding:10,radius:3},connection:{step:50},typeColors:{Stream:"#aaaaaa",Boolean:"#cc99cd",Number:"#5990bd",String:"#aac563",Resource:"#ffa8c2",Object:"#d9b762",Array:"#667e7f",Choice:"#e5d092"},defaultColor:"#ff0000"},dudeGraph.Renderer.defaultZoom={translate:[0,0],scale:1},dudeGraph.RenderNode=function(e,t){this._renderer=e,Object.defineProperty(this,"renderer",{get:function(){return this._renderer}.bind(this)}),this._nodeId=t,Object.defineProperty(this,"nodeId",{configurable:!0,get:function(){return this._nodeId}.bind(this)}),this._nodeName=null,this._getNodeName=function(){return this._nodeName}.bind(this),this._setNodeName=function(e){this._nodeName=e,null!==this._d3Node&&(this.computePosition(),this.computeSize(),this.update())}.bind(this),Object.defineProperty(this,"nodeName",{configurable:!0,get:this._getNodeName,set:this._setNodeName}),this._nodeSize=[0,0],Object.defineProperty(this,"nodeSize",{configurable:!0,get:function(){return this._nodeSize}.bind(this),set:function(e){this._nodeSize=e}.bind(this)}),this._nodePosition=[0,0],Object.defineProperty(this,"nodePosition",{configurable:!0,get:function(){return this._nodePosition}.bind(this),set:function(e){this._nodePosition=e}.bind(this)}),this._movePosition=[0,0],Object.defineProperty(this,"movePosition",{configurable:!0,get:function(){return this._movePosition}.bind(this),set:function(e){this._movePosition=e}.bind(this)}),this._d3Node=null,Object.defineProperty(this,"d3Node",{configurable:!0,get:function(){return this._d3Node}.bind(this)}),Object.defineProperty(this,"nodeFancyName",{configurable:!0,get:function(){return this._nodeName+" (#"+this._nodeId+")"}.bind(this)})},dudeGraph.RenderNode.prototype.create=function(e){this._d3Node=e},dudeGraph.RenderNode.prototype.move=function(){this._d3Node.attr("transform","translate("+this._nodePosition+")")},dudeGraph.RenderNode.prototype.update=function(){this.move()},dudeGraph.RenderNode.prototype.remove=function(){},dudeGraph.RenderNode.prototype.select=function(){},dudeGraph.RenderNode.prototype.unselect=function(){},dudeGraph.RenderNode.prototype.computeSize=function(){},dudeGraph.RenderNode.prototype.computePosition=function(){},dudeGraph.RenderNode.prototype.moveEvent=function(){var e=this;this._d3Node.call(d3.behavior.drag().on("dragstart",function(){dudeGraph.stopD3ImmediatePropagation(),dudeGraph.preventD3Default(),d3.event.sourceEvent.shiftKey||e._renderer.clearSelection(),e._renderer.addToSelection([e]),this.parentNode.appendChild(this)}).on("drag",function(){dudeGraph.preventD3Default();var t=function(t){e._renderer._config.grid.active?(t.movePosition[0]+=d3.event.dx,t.movePosition[1]+=d3.event.dy,t.nodePosition[0]=Math.round(t.movePosition[0]/e._renderer._config.grid.spacingX)*e._renderer._config.grid.spacingX,t.nodePosition[1]=Math.round(t.movePosition[1]/e._renderer._config.grid.spacingY)*e._renderer._config.grid.spacingY):(t.nodePosition[0]+=d3.event.dx,t.nodePosition[1]+=d3.event.dy),t.move(),_.forEach(t._renderPoints,function(e){_.forEach(e.renderConnections,function(e){e.update()})})};if(t(e),e instanceof dudeGraph.RenderGroup)_.forEach(e.renderBlocksChildren,function(e){t(e)});else{var n=e.renderGroupParent;null!==n&&e.updateRenderGroupParent()}}).on("dragend",function(e){if(dudeGraph.preventD3Default(),e instanceof dudeGraph.RenderBlock&&null===e.renderGroupParent){var t=e._renderer.nearestRenderGroup(e);null!==t&&(e.renderGroupParent=t,e.updateRenderGroupParent())}}))},dudeGraph.RenderBlock=function(e,t,n,o){dudeGraph.RenderNode.call(this,e,t),this._block=n,Object.defineProperty(this,"block",{get:function(){return this._block}.bind(this)}),this._customPanel=o||null,Object.defineProperty(this,"customPanel",{get:function(){return this._customPanel}.bind(this)}),Object.defineProperty(this,"nodeName",{configurable:!0,get:this._getNodeName,set:function(e){this._setNodeName(e),null!==this.renderGroupParent&&this.updateRenderGroupParent(),_.forEach(this._renderPoints,function(e){e.computePosition(),e.update(),_.forEach(e.renderConnections,function(e){e.update()})})}.bind(this)}),this._renderGroupParent=null,Object.defineProperty(this,"renderGroupParent",{configurable:!0,get:function(){return this._renderGroupParent}.bind(this),set:function(e){null!==this._renderGroupParent&&this._renderGroupParent.removeChild(this),null!==e&&e.addChild(this),this._renderGroupParent=e}.bind(this)}),this._renderPoints=[],Object.defineProperty(this,"renderPoints",{get:function(){return this._renderPoints}.bind(this),set:function(e){this._renderPoints=e}.bind(this)}),Object.defineProperty(this,"renderOutputPoints",{get:function(){return _.filter(this.renderPoints,function(e){return e.point.pointOutput})}}),Object.defineProperty(this,"renderInputPoints",{get:function(){return _.filter(this.renderPoints,function(e){return!e.point.pointOutput})}}),this._d3Points=null,Object.defineProperty(this,"d3Points",{get:function(){return this._d3Points.selectAll(".dude-graph-point")}.bind(this)})},dudeGraph.RenderBlock.prototype=_.create(dudeGraph.RenderNode.prototype,{constructor:dudeGraph.RenderBlock}),dudeGraph.RenderBlock.prototype.create=function(e){dudeGraph.RenderNode.prototype.create.call(this,e),this._d3Rect=this._d3Node.append("svg:rect").attr("rx",this._renderer.config.block.borderRadius).attr("ry",this._renderer.config.block.borderRadius),this._d3Title=this._d3Node.append("svg:text").attr("class","dude-graph-title").attr("text-anchor","middle").attr("dominant-baseline","text-before-edge"),this._d3Points=this._d3Node.append("svg:g").classed("dude-graph-points",!0),this.computeSize(),this.update()},dudeGraph.RenderBlock.prototype.update=function(){dudeGraph.RenderNode.prototype.update.call(this);var e=this;this._d3Rect.attr({width:this._nodeSize[0],height:this._nodeSize[1]}),this._d3Title.text(this._nodeName).attr({x:this._nodeSize[0]/2,y:this._renderer.config.block.padding}),dudeGraph.browserIf(["IE","Edge"],function(){e._d3Title.attr("y",e._renderer.config.block.padding+e._renderer.measureText(e._d3Title)[1]/2)}),this.d3Points.each(function(e){e.update()}),this.move()},dudeGraph.RenderBlock.prototype.computeSize=function(){var e=_.maxBy(this.renderOutputPoints,function(e){return e.pointSize[0]}),t=_.maxBy(this.renderInputPoints,function(e){return e.pointSize[0]}),n=this._renderer.measureText(this._nodeName)[0],o=_.isUndefined(e)?0:e.pointSize[0],r=_.isUndefined(t)?0:t.pointSize[0],i=this.renderOutputPoints.length>this.renderInputPoints.length,a=_.sumBy(i?this.renderOutputPoints:this.renderInputPoints,function(e){return e.pointSize[1]}),d=Math.max(n+2*this._renderer.config.block.padding,o+r+this._renderer.config.block.pointSpacing);this._nodeSize=[d,a+this._renderer.config.block.header]},dudeGraph.RenderBlock.prototype.updatePoints=function(){var e=this.d3Points.data(this.renderPoints,function(e){return e.pointFancyName}),t=e.enter().append("g").classed("dude-graph-point",!0);e.exit().each(function(e){e.remove()}).remove(),t.each(function(e){e.create(d3.select(this)),e.removeConnectionsEvent(),e.dragConnectionEvent()}),this.computeSize(),this.d3Points.each(function(e){e.computePosition(),e.update()}),this.update()},dudeGraph.RenderBlock.prototype.updateRenderGroupParent=function(){this.renderGroupParent.computePosition(),this.renderGroupParent.computeSize(),this.renderGroupParent.update()},dudeGraph.RenderBlock.prototype.createRenderPoint=function(e){var t=e.point.pointType,n=this._renderer._renderPointTypes[t];if(_.isUndefined(n))throw new Error("Render point type `"+t+"` not registered in the renderer");return n.buildRenderPoint(this._renderer,this,e)},dudeGraph.RenderBlock.prototype.addRenderPoint=function(e){var t=_.find(this._renderPoints,e);if(!_.isUndefined(t))throw new Error("`"+e.pointFancyName+"` is already a renderPoint of `"+this.nodeFancyName+"`");this._renderPoints.push(e),this._updateRenderPointsIndexes(),this._renderer.emit("render-point-add",this,e)},dudeGraph.RenderBlock.prototype.removeRenderPoint=function(e){var t=_.find(this._renderPoints,e);if(_.isUndefined(t))throw new Error("`"+e.pointFancyName+"` is not a renderPoint of `"+this.nodeFancyName+"`");_.pull(this._renderPoints,e),this._updateRenderPointsIndexes(),this._renderer.emit("render-point-remove",this,e)},dudeGraph.RenderNode.prototype.removeParentEvent=function(){var e=this;this._d3Node.call(d3.behavior.doubleClick().on("dblclick",function(){var t=e.renderGroupParent;null!==t&&(dudeGraph.stopD3ImmediatePropagation(),e.renderGroupParent=null,t.computePosition(),t.computeSize(),t.update())}))},dudeGraph.RenderBlock.prototype._updateRenderPointsIndexes=function(){_.forEach(this.renderOutputPoints,function(e,t){e.index=t}),_.forEach(this.renderInputPoints,function(e,t){e.index=t})},dudeGraph.RenderBlock.buildRenderBlock=function(e,t){var n=e.graph.blockById(t.block);if(!n)throw new Error("Unknown block `"+t.block+"` for renderBlock `"+t.id+"`");var o=new this(e,t.id,n);return o.nodeName=t.description||n.blockName||"",o.nodePosition=t.position||[0,0],o.movePosition=o.nodePosition.slice(),o.parentGroup=t.parent||null,o},dudeGraph.RenderConnection=function(e,t,n,o){this._renderer=e,this._connection=t,Object.defineProperty(this,"connection",{get:function(){return this._connection}.bind(this)}),Object.defineProperty(this,"connectionId",{get:function(){return this.outputRenderPoint.renderBlock.nodeId+":"+this.outputRenderPoint.point.pointName+","+this.inputRenderPoint.renderBlock.nodeId+":"+this.inputRenderPoint.point.pointName}.bind(this)}),this._outputRenderPoint=n,Object.defineProperty(this,"outputRenderPoint",{get:function(){return this._outputRenderPoint}.bind(this)}),this._inputRenderPoint=o,Object.defineProperty(this,"inputRenderPoint",{get:function(){return this._inputRenderPoint}.bind(this)}),this._dragging=!1,Object.defineProperty(this,"dragging",{get:function(){return this._dragging}.bind(this),set:function(e){this._dragging=e}.bind(this)}),Object.defineProperty(this,"draggingRenderPoint",{get:function(){if(!this.dragging)throw new Error("Cannot get the dragging renderPoint of a non dragging connection");return this._outputRenderPoint instanceof dudeGraph.RenderPoint?this._inputRenderPoint:this._outputRenderPoint}.bind(this)}),Object.defineProperty(this,"realRenderPoint",{get:function(){if(!this.dragging)throw new Error("Cannot get the real renderPoint of a non dragging connection");return this._outputRenderPoint instanceof dudeGraph.RenderPoint?this._outputRenderPoint:this._inputRenderPoint}.bind(this)}),this._d3Connection=null,Object.defineProperty(this,"d3Connection",{get:function(){return this._d3Connection}.bind(this)})},dudeGraph.RenderConnection.prototype.create=function(e){this._d3Connection=e,this._d3Line=d3.svg.line().interpolate("basis")},dudeGraph.RenderConnection.prototype.update=function(){var e=this._renderer.config.connection.step;this._outputRenderPoint.pointAbsolutePosition[0]>this._inputRenderPoint.pointAbsolutePosition[0]&&(e+=Math.max(-this._renderer.config.connection.step,Math.min(this._outputRenderPoint.pointAbsolutePosition[0]-this._inputRenderPoint.pointAbsolutePosition[0],this._renderer.config.connection.step)));var t=this._outputRenderPoint.pointAbsolutePosition,n=this._inputRenderPoint.pointAbsolutePosition,o=[[t[0],t[1]],[t[0]+e,t[1]],[n[0]-e,n[1]],[n[0],n[1]]],r=this._renderer.config.typeColors[this.inputRenderPoint.point.pointValueType],i=this._renderer.config.typeColors[this.outputRenderPoint.point.pointValueType];this._d3Connection.attr({d:this._d3Line(o),stroke:r||i||this._renderer.config.defaultColor,"stroke-linecap":"round"}),this._dragging&&this._d3Connection.attr("stroke-dasharray","5,5")},dudeGraph.RenderConnection.prototype.remove=function(){},dudeGraph.RenderConnection.buildRenderConnection=function(e,t){var n=t.connection||e._graph.graphConnections[t.connectionIndex];if(!n)throw new Error("Connection at index `"+t.connectionIndex+"` does not exist");var o=t.outputRenderBlock||e.renderBlockById(t.outputRendererBlockId),r=t.inputRenderBlock||e.renderBlockById(t.inputRendererBlockId);if(null===o)throw new Error("Connection at index `"+t.connectionIndex+"`: Cannot find outputRenderBlock `"+t.outputRendererBlockId+"`");if(null===r)throw new Error("Connection at index `"+t.connectionIndex+"`: Cannot find inputRenderBlock `"+t.inputRendererBlockId+"`");if(o.block!==n.connectionOutputPoint.pointBlock)throw new Error("Connection at index `"+t.connectionIndex+"`: output render block `"+o.nodeFancyName+"` is not holding a reference to the output block `"+n.connectionOutputPoint.pointBlock.blockId+"`");if(r.block!==n.connectionInputPoint.pointBlock)throw new Error("Connection at index `"+t.connectionIndex+"`: input render block `"+r.nodeFancyName+"` is not holding a reference to the input block `"+n.connectionInputPoint.pointBlock.blockId+"`");var i=e.renderPointByName(o,n.connectionOutputPoint.pointName,!0),a=e.renderPointByName(r,n.connectionInputPoint.pointName,!1);if(!i)throw new Error("Connection at index `"+t.connectionIndex+"`: Cannot find outputRenderPoint `"+n.connectionOutputPoint.pointName+"`");if(!a)throw new Error("Connection at index `"+t.connectionIndex+"`: Cannot find inputRenderPoint `"+n.connectionInputPoint.pointName+"`");return new this(e,n,i,a)},dudeGraph.RenderGroup=function(e,t){dudeGraph.RenderNode.call(this,e,t),this._renderBlocksChildren=[],Object.defineProperty(this,"renderBlocksChildren",{get:function(){return this._renderBlocksChildren}.bind(this)})},dudeGraph.RenderGroup.prototype=_.create(dudeGraph.RenderNode.prototype,{constructor:dudeGraph.RenderGroup}),dudeGraph.RenderGroup.prototype.create=function(e){dudeGraph.RenderNode.prototype.create.call(this,e),this._d3Rect=e.append("svg:rect").attr("rx",this._renderer.config.group.borderRadius).attr("ry",this._renderer.config.group.borderRadius),this._d3Title=e.append("svg:text").attr("text-anchor","middle").attr("dominant-baseline","text-before-edge"),this.update(),this.computePosition(),this.computeSize(),this.move()},dudeGraph.RenderGroup.prototype.update=function(){dudeGraph.RenderNode.prototype.update.call(this);var e=this;this._d3Rect.attr({width:this._nodeSize[0],height:this._nodeSize[1]}),this._d3Title.text(this._nodeName).attr({x:this._nodeSize[0]/2,y:e._renderer.config.group.padding}),dudeGraph.browserIf(["IE","Edge"],function(){e._d3Title.attr("y",e._renderer.config.group.padding+e._renderer.measureText(e._d3Title)[1]/2)})},dudeGraph.RenderGroup.prototype.computeSize=function(){var e=this._renderer.renderNodesBoundingRect(this._renderBlocksChildren,!0);null!==e&&(this._nodeSize=[e[1][0]-e[0][0]+2*this._renderer.config.group.padding,e[1][1]-e[0][1]+2*this._renderer.config.group.padding+this._renderer.config.group.header]),this._nodeSize=[Math.max(this._nodeSize[0],this._renderer.config.group.minSize[0]+2*this._renderer.config.group.padding),Math.max(this._nodeSize[1],this._renderer.config.group.minSize[1]+2*this._renderer.config.group.padding+this._renderer.config.group.header)],this._nodeSize[0]=Math.max(this._nodeSize[0],this._renderer.measureText(this._d3Title)[0]+2*this._renderer.config.group.padding)},dudeGraph.RenderGroup.prototype.computePosition=function(){var e=this._renderer.renderNodesBoundingRect(this._renderBlocksChildren,!0);null!==e&&(this._nodePosition=[e[0][0]-this._renderer.config.group.padding,e[0][1]-this._renderer.config.group.padding-this._renderer.config.group.header])},dudeGraph.RenderGroup.prototype.addChild=function(e){var t=_.find(this._renderBlocksChildren,e);if(!_.isUndefined(t))throw new Error("`"+e.nodeFancyName+"` is already a child of `"+this.nodeFancyName+"`");this._renderBlocksChildren.push(e)},dudeGraph.RenderGroup.prototype.removeChild=function(e){var t=_.find(this._renderBlocksChildren,e);if(_.isUndefined(t))throw new Error("`"+e.nodeFancyName+"` is not a child of `"+this.nodeFancyName+"`");_.pull(this._renderBlocksChildren,e)},dudeGraph.RenderGroup.prototype.removeAllChildren=function(){var e=_.clone(this._renderBlocksChildren);_.forEach(e,function(e){e.renderGroupParent=null})},dudeGraph.RenderGroup.buildRenderGroup=function(e,t){var n=new this(e,t.id);return n.nodeName=t.description||"",n.nodePosition=t.position||[0,0],n.nodeSize=t.size||[0,0],n},dudeGraph.RenderPoint=function(e,t,n){this._renderer=e,Object.defineProperty(this,"renderer",{get:function(){return this._renderer}.bind(this)}),this._point=n,Object.defineProperty(this,"point",{get:function(){return this._point}.bind(this)}),this._index=0,Object.defineProperty(this,"index",{get:function(){return this._index}.bind(this),set:function(e){this._index=e}.bind(this)}),this._renderBlock=t,Object.defineProperty(this,"renderBlock",{get:function(){return this._renderBlock}.bind(this)}),this._renderConnections=[],Object.defineProperty(this,"renderConnections",{get:function(){return this._renderConnections}.bind(this)}),this._pointHidden=!1,Object.defineProperty(this,"pointHidden",{set:function(e){this._pointHidden=e}.bind(this),get:function(){return this._pointHidden}.bind(this)}),this._pointSize=[0,0],Object.defineProperty(this,"pointSize",{get:function(){return this._pointSize}.bind(this)}),this._pointPosition=[0,0],Object.defineProperty(this,"pointPosition",{get:function(){return this._pointPosition}.bind(this)}),Object.defineProperty(this,"pointAbsolutePosition",{get:function(){var e=this._renderBlock.nodePosition;return[e[0]+this._pointPosition[0],e[1]+this._pointPosition[1]]}.bind(this)}),Object.defineProperty(this,"pointFancyName",{get:function(){return(this._point.pointOutput?"Output ":"Input ")+this._point.pointName}.bind(this)}),this._d3Point=null,Object.defineProperty(this,"d3Point",{get:function(){return this._d3Point}.bind(this)})},dudeGraph.RenderPoint.prototype.create=function(e){var t=this._renderer.config.point.radius,n=this;this._d3Point=e,this._d3Circle=e.append("svg:path").attr("d",function(){return n._point instanceof dudeGraph.StreamPoint?"M "+-t+" "+1.5*-t+" L "+-t+" "+1.5*t+" L "+t+" 0 Z":"M 0,0m "+-t+", 0a "+[t,t]+" 0 1,0 "+2*t+",0a "+[t,t]+" 0 1,0 "+-(2*t)+",0"}),this._d3Title=e.append("svg:text").attr({"text-anchor":this._point.pointOutput?"end":"start","dominant-baseline":"middle",x:(this.point.pointOutput?-1:1)*this._renderer.config.point.padding}),dudeGraph.browserIf(["IE","Edge"],function(){n._d3Title.attr("y",n._pointPosition[1]+n._renderer.measureText(n._d3Title)[1]/4)}),this.computeSize()},dudeGraph.RenderPoint.prototype.update=function(){var e=this._renderer.config.typeColors[this.point.pointValueType]||this._renderer.config.defaultColor;this._d3Point.attr("transform","translate("+this.pointPosition+")"),this._d3Circle.attr({stroke:e,fill:this.empty()?"transparent":e}),this._d3Title.text(this._point.pointName)},dudeGraph.RenderPoint.prototype.remove=function(){},dudeGraph.RenderPoint.prototype.computeSize=function(){var e=this._renderer.measureText(this._point.pointName);this._pointSize=[e[0]+2*this._renderer.config.point.padding,this._renderer.config.point.height]},dudeGraph.RenderPoint.prototype.computePosition=function(){this.point.pointOutput?this._pointPosition=[this._renderBlock.nodeSize[0]-this._renderer.config.point.padding,this._renderer.config.block.header+this._renderer.config.point.height*this._index]:this._pointPosition=[this._renderer.config.point.padding,this._renderer.config.block.header+this._renderer.config.point.height*this._index]},dudeGraph.RenderPoint.prototype.addRenderConnection=function(e){this._renderConnections.push(e)},dudeGraph.RenderPoint.prototype.removeRenderConnection=function(e){_.pull(this._renderConnections,e)},dudeGraph.RenderPoint.prototype.removeConnectionsEvent=function(){
var e=this;this._d3Circle.call(d3.behavior.mousedown().on("mousedown",function(){d3.event.sourceEvent.altKey&&(dudeGraph.preventD3Default(),dudeGraph.stopD3ImmediatePropagation(),e._renderer.emptyRenderPoint(e,!0))}))},dudeGraph.RenderPoint.prototype.dragConnectionEvent=function(){var e=this,t=null,n={renderBlock:{nodeId:"drawing"},point:{pointName:"drawing"},pointAbsolutePosition:[0,0]};e._d3Circle.call(d3.behavior.drag().on("dragstart",function(){dudeGraph.stopD3ImmediatePropagation(),n.pointAbsolutePosition=d3.mouse(e._renderer._d3Root.node()),t=e._point.pointOutput?new dudeGraph.RenderConnection(e._renderer,null,e,n):new dudeGraph.RenderConnection(e._renderer,null,n,e),t.dragging=!0,e._renderer._renderConnections.push(t),e._renderer.createD3Connections()}).on("drag",function(){n.pointAbsolutePosition=d3.mouse(e._renderer._d3Root.node()),t.update()}).on("dragend",function(){var n=d3.mouse(e._renderer._d3Root.node()),o=e._renderer.nearestRenderPoint(n);if(o&&e!==o)try{var r=o.point.connect(e._point);e._renderer.createRenderConnection({connectionIndex:e._renderer.graph.graphConnections.indexOf(r),outputRendererBlockId:e._point.pointOutput?e._renderBlock.nodeId:o.renderBlock.nodeId,inputRendererBlockId:e._point.pointOutput?o.renderBlock.nodeId:e._renderBlock.nodeId}),e._renderer.createD3Connections(),e.update(),o.update()}catch(i){e._renderer.emit("error",i)}else e._renderer.emit("drop-connection",t,d3.mouse(e._renderer._d3Root.node()),d3.mouse(document.body));_.pull(e._renderer._renderConnections,t),t=null,e._renderer.removeD3Connections()}))},dudeGraph.RenderPoint.prototype.empty=function(){return _.isEmpty(this.renderConnections)&&this._point.emptyValue()},dudeGraph.RenderPoint.buildRenderPoint=function(e,t,n){var o=new this(e,t,n.point);return o.pointHidden=n.renderPoint&&n.renderPoint.hidden||!1,o},dudeGraph.Renderer.prototype.renderBlockById=function(e){return this._renderBlockIds[e]||null},dudeGraph.Renderer.prototype.renderBlocksByBlock=function(e){return _.filter(this._renderBlocks,function(t){return t.block===e})},dudeGraph.Renderer.prototype.createRenderBlock=function(e,t){var n=this,o=this._graph.blockById(e.block);if(null===o)throw new Error("Unknown block `"+e.block+"` for renderBlock `"+e.id+"`");var r=this._renderBlockTypes[o.blockType];if(_.isUndefined(r))throw new Error("Render block type `"+o.blockType+"` not registered in the renderer");var i=r.buildRenderBlock(this,e);if(null===i.nodeId||_.isUndefined(i.nodeId))throw new Error("Cannot create a renderBlock without an id");var a=this.renderBlockById(i.nodeId);if(null!==a)throw new Error("Duplicate renderBlocks for id `"+i.nodeId+"`: `"+a.nodeFancyName+"` was here before `"+i.nodeFancyName+"`");this._renderBlocks.push(i),this._renderBlockIds[i.nodeId]=i;var d=function(t){var o=e[t.pointOutput?"outputs":"inputs"];o=o&&o[t.pointName],n.createRenderPoint(i,{renderPoint:o,point:t})};return _.forEach(i.block.blockOutputs,d),_.forEach(i.block.blockInputs,d),t&&this.createD3Blocks(),i},dudeGraph.Renderer.prototype.removeRenderBlock=function(e,t){var n=this;_.forEach(e.renderPoints,function(e){n.emptyRenderPoint(e,t)}),_.pull(this._renderBlocks,e),_.isEmpty(this.renderBlocksByBlock(e.block))&&this._graph.removeBlock(e.block),e.renderGroupParent&&e.renderGroupParent.removeChild(e),t&&(e.renderGroupParent&&(e.renderGroupParent.computePosition(),e.renderGroupParent.computeSize(),e.renderGroupParent.update()),this.removeD3Blocks())},dudeGraph.Renderer.prototype.createRenderConnection=function(e,t){var n=dudeGraph.RenderConnection.buildRenderConnection(this,e);return n.outputRenderPoint.addRenderConnection(n),n.inputRenderPoint.addRenderConnection(n),this._renderConnections.push(n),t&&(this.createD3Connections(),n.outputRenderPoint.update(),n.inputRenderPoint.update()),this.emit("render-connection-add",this,n),n},dudeGraph.Renderer.prototype.removeRenderConnection=function(e,t){e.outputRenderPoint.point.disconnect(e.inputRenderPoint.point),e.outputRenderPoint.removeRenderConnection(e),e.inputRenderPoint.removeRenderConnection(e),_.pull(this._renderConnections,e),t&&(e.outputRenderPoint.update(),e.inputRenderPoint.update(),this.removeD3Connections()),this.emit("render-connection-remove",this,e)},dudeGraph.Renderer.prototype.renderGroupById=function(e){return this._renderGroupIds[e]||null},dudeGraph.Renderer.prototype.createRenderGroup=function(e,t){var n=dudeGraph.RenderGroup.buildRenderGroup(this,e);if(null===n.nodeId||_.isUndefined(n.nodeId))throw new Error("Cannot create a renderGroup without an id");var o=this.renderGroupById(n.nodeId);if(null!==o)throw new Error("Duplicate renderGroups for id `"+n.nodeId+"`: `"+o.nodeFancyName+"` was here before `"+n.nodeFancyName+"`");return this._renderGroups.push(n),this._renderGroupIds[n.nodeId]=n,t&&this.createD3Groups(),n},dudeGraph.Renderer.prototype.removeRenderGroup=function(e,t){e.removeAllChildren(),_.pull(this._renderGroups,e),t&&this.removeD3Groups()},dudeGraph.Renderer.prototype.renderPointByName=function(e,t,n){return _.find(e.renderPoints,function(e){return e.point.pointName===t&&e.point.pointOutput===n})||null},dudeGraph.Renderer.prototype.createRenderPoint=function(e,t,n){var o=e.createRenderPoint(t);return e.addRenderPoint(o),n&&e.updatePoints(),o},dudeGraph.Renderer.prototype.removeRenderPoint=function(e,t){e.renderBlock.removeRenderPoint(e),t&&e.renderBlock.updatePoints()},dudeGraph.Renderer.prototype.emptyRenderPoint=function(e,t){var n=this,o=_.clone(e.renderConnections);_.forEach(o,function(e){n.removeRenderConnection(e,t)})},dudeGraph.Renderer.prototype._createRenderBlocksCollisions=function(){this._renderBlocksQuadtree=d3.geom.quadtree().x(function(e){return e.nodePosition[0]}).y(function(e){return e.nodePosition[1]})(this._renderBlocks)},dudeGraph.Renderer.prototype._createRenderPointsCollisions=function(){var e=[];_.forEach(this._renderBlocks,function(t){e=e.concat(t.renderPoints)}),this._renderPointsQuadtree=d3.geom.quadtree().x(function(e){return e.pointAbsolutePosition[0]}).y(function(e){return e.pointAbsolutePosition[1]})(e)},dudeGraph.Renderer.prototype._createRenderGroupsCollisions=function(){this._renderGroupsQuadtree=d3.geom.quadtree().x(function(e){return e.nodePosition[0]}).y(function(e){return e.nodePosition[1]})(this._renderGroups)},dudeGraph.Renderer.prototype.nearestRenderBlocks=function(e){this._createRenderBlocksCollisions();var t=[];return this._renderBlocksQuadtree.visit(function(n,o,r,i,a){var d=n.point;if(d){var p=[d.nodePosition[0],d.nodePosition[1],d.nodePosition[0]+d.nodeSize[0],d.nodePosition[1]+d.nodeSize[1]];e[0][0]>p[2]||e[0][1]>p[3]||e[1][0]<p[0]||e[1][1]<p[1]||t.push(d)}return o-50>=e[1][0]||r-35>=e[1][1]||i+50<e[0][0]||a+35<e[0][1]}),t},dudeGraph.Renderer.prototype.nearestRenderGroup=function(e){this._createRenderGroupsCollisions();var t=[],n=e.nodePosition[0],o=e.nodePosition[1],r=e.nodePosition[0]+e.nodeSize[0],i=e.nodePosition[1]+e.nodeSize[1];this._renderGroupsQuadtree.visit(function(a){var d=a.point;if(d&&d!==e){var p=[d.nodePosition[0],d.nodePosition[1],d.nodePosition[0]+d.nodeSize[0],d.nodePosition[1]+d.nodeSize[1]];n>p[0]&&o>p[1]&&r<p[2]&&i<p[3]&&t.push(d)}return!1});var a=null;return _.forEach(t,function(t){return e.renderGroupParent&&t===e.renderGroupParent?(a=t,!1):void(null===a?a=t:t.nodeSize[0]<a.nodeSize[0]&&t.nodeSize[1]<a.nodeSize[1]&&(a=t))}),a},dudeGraph.Renderer.prototype.nearestRenderPoint=function(e){this._createRenderPointsCollisions();var t=this._renderPointsQuadtree.find(e);if(t){var n=t.pointAbsolutePosition;if(n[0]>e[0]-this._config.point.height&&n[0]<e[0]+this._config.point.height&&n[1]>e[1]-this._config.point.height&&n[1]<e[1]+this._config.point.height)return t}return null},dudeGraph.Renderer.prototype._createSelectionBehavior=function(){var e=this,t=null;this._d3Svg.call(d3.behavior.drag().on("dragstart",function(){d3.event.sourceEvent.shiftKey?(d3.event.sourceEvent.stopImmediatePropagation(),t=e._d3Svg.append("svg:rect").classed("dude-graph-select",!0).datum(d3.mouse(this))):e.clearSelection()}).on("drag",function(){if(t){var e=d3.mouse(this);t.attr({x:function(t){return Math.min(t[0],e[0])},y:function(t){return Math.min(t[1],e[1])},width:function(t){return Math.max(e[0]-t[0],t[0]-e[0])},height:function(t){return Math.max(e[1]-t[1],t[1]-e[1])}})}}).on("dragend",function(){if(null!==t){var n=function(e){return parseInt(t.attr(e))},o=e.screenToWorld([n("x"),n("y")]),r=e.screenToWorld([n("width")+n("x"),n("height")+n("y")]),i=e.nearestRenderBlocks([o,r]);d3.event.sourceEvent.altKey?e.removeFromSelection(i):e.addToSelection(i),t.remove(),t=null}}))},dudeGraph.Renderer.prototype.addToSelection=function(e){var t=this;_.forEach(e,function(e){_.includes(t._selectedRenderNodes,e)||(e.select(),e.d3Node.classed("dude-graph-selected",!0),t._selectedRenderNodes.push(e),t.emit("select",e))})},dudeGraph.Renderer.prototype.removeFromSelection=function(e){var t=this;_.remove(this._selectedRenderNodes,function(n){return _.includes(e,n)?(n.unselect(),n.d3Node.classed("dude-graph-selected",!1),t.emit("unselect",n),!0):!1})},dudeGraph.Renderer.prototype.clearSelection=function(){this.removeFromSelection(this._selectedRenderNodes),this.emit("unselect-all")},dudeGraph.Renderer.prototype.selectAll=function(e,t){this.clearSelection(),e||this.addToSelection(this._renderBlocks),t||this.addToSelection(this._renderGroups)},dudeGraph.Renderer.prototype.removeSelection=function(){var e=this,t=!1;return _.forEachRight(this._selectedRenderNodes,function(n){n instanceof dudeGraph.RenderBlock?e.removeRenderBlock(n,!0):e.removeRenderGroup(n,!0),t=!0}),this.clearSelection(),t},dudeGraph.Renderer.prototype.createRenderGroupForSelection=function(e){var t=this.createRenderGroup({id:this._graph.nextBlockId(),description:e});return _.forEach(this._selectedRenderNodes,function(e){e.renderGroupParent=t}),this.createD3Groups(),t},dudeGraph.Renderer.prototype._createZoomBehavior=function(){var e=this;this._zoomBehavior=d3.behavior.zoom().scaleExtent([this._config.zoom.min,this._config.zoom.max]).on("zoom",function(){d3.event.sourceEvent&&dudeGraph.preventD3Default(),e._d3Root.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")"),e._zoom.translate=d3.event.translate,e._zoom.scale=d3.event.scale}.bind(this)),this._d3Svg.call(this._zoomBehavior),this._updateZoom()},dudeGraph.Renderer.prototype._updateZoom=function(){this._d3Svg.transition().duration(this._config.zoom.transitionSpeed).call(this._zoomBehavior.translate(this._zoom.translate).scale(this._zoom.scale).event)},dudeGraph.Renderer.prototype._zoomToBoundingBox=function(e){var t=this._d3Svg.node().getBoundingClientRect(),n=this._zoomBehavior.scaleExtent(),o=e.width-e.x,r=e.height-e.y,i=(e.x+e.width)/2,a=(e.y+e.height)/2,d=dudeGraph.clamp(.9/Math.max(o/t.width,r/t.height),n[0],n[1]),p=[t.width/2-d*i,t.height/2-d*a];this._zoom.scale=d,this._zoom.translate=p,this._updateZoom()},dudeGraph.Renderer.prototype.zoomToFitRenderNodes=function(e){if(!_.isEmpty(e)){var t=this.renderNodesBoundingRect(e);this._zoomToBoundingBox({x:t[0][0]-this._config.zoom.margin[0]/2,y:t[0][1]-this._config.zoom.margin[1]/2,width:t[1][0]+this._config.zoom.margin[0],height:t[1][1]+this._config.zoom.margin[1]})}},dudeGraph.Renderer.prototype.panToFitRenderNodes=function(e){var t=this._zoomBehavior.scaleExtent();this._zoomBehavior.scaleExtent([1,1]),this.zoomToFitRenderNodes(e),this._zoomBehavior.scaleExtent(t)},dudeGraph.Renderer.prototype.zoomToFit=function(){this.zoomToFitRenderNodes(this._renderBlocks.concat(this._renderGroups))},dudeGraph.Renderer.prototype.zoomToFitSelection=function(){this.zoomToFitRenderNodes(this._selectedRenderNodes)},dudeGraph.Renderer.prototype.zoomReset=function(){this._zoom.translate=[0,0],this._zoom.scale=1,this._updateZoom()},dudeGraph.Renderer.prototype.createD3Blocks=function(){this.d3Blocks.data(this._renderBlocks,function(e){return e.nodeId}).enter().append("svg:g").attr("id",function(e){return e.nodeId}).classed("dude-graph-block",!0).each(function(e){e.create(d3.select(this)),e.removeParentEvent(),e.moveEvent(),e.updatePoints()}),this.updateD3Blocks()},dudeGraph.Renderer.prototype.updateD3Blocks=function(){this.d3Blocks.each(function(e){e.update()})},dudeGraph.Renderer.prototype.removeD3Blocks=function(){this.d3Blocks.data(this._renderBlocks,function(e){return e.nodeId}).exit().each(function(e){e.remove()}).remove()},dudeGraph.Renderer.prototype.createD3Connections=function(){this.d3Connections.data(this._renderConnections,function(e){return e.connectionId}).enter().append("svg:path").attr("id",function(e){return e.connectionId}).classed("dude-graph-connection",!0).each(function(e){e.create(d3.select(this))}),this.updateD3Connections()},dudeGraph.Renderer.prototype.updateD3Connections=function(){this.d3Connections.each(function(e){e.update()})},dudeGraph.Renderer.prototype.removeD3Connections=function(){this.d3Connections.data(this._renderConnections,function(e){return e.connectionId}).exit().each(function(e){e.remove()}).remove()},dudeGraph.Renderer.prototype.createD3Groups=function(){this.d3Groups.data(this._renderGroups,function(e){return e.nodeId}).enter().append("svg:g").attr("id",function(e){return e.nodeId}).classed("dude-graph-group",!0).each(function(e){e.create(d3.select(this)),e.moveEvent()}),this.updateD3Groups()},dudeGraph.Renderer.prototype.updateD3Groups=function(){this.d3Groups.each(function(e){e.update()})},dudeGraph.Renderer.prototype.removeD3Groups=function(){this.d3Groups.data(this._renderGroups,function(e){return e.nodeId}).exit().each(function(e){e.remove()}).remove()},dudeGraph.Renderer.prototype.load=function(e){var t=this;_.forEach(e.blocks,function(e){t.createRenderBlock(e)}),_.forEach(e.groups,function(e){t.createRenderGroup(e)}),_.forEach(e.connections,function(e){t.createRenderConnection(e)}),_.forEach(e.blocks,function(e){var n=t.renderBlockById(e.id);if(e.parent){var o=t.renderGroupById(e.parent);if(null===o)throw new Error("Cannot find renderBlock `"+n.nodeFancyName+"` parent id `"+e.parent+"`");n.renderGroupParent=o}}),this._zoom=_.defaultsDeep(e.zoom||e.config&&e.config.zoom||{},dudeGraph.Renderer.defaultZoom),this._updateZoom(),this.createD3Blocks(),this.createD3Groups(),this.createD3Connections()},dudeGraph.Renderer.prototype.save=function(){return{zoom:{translate:this._zoom.translate||[0,0],scale:this._zoom.scale||1},blocks:_.map(this._renderBlocks,function(e){var t={id:e.nodeId,block:e.block.blockId,description:e.nodeName,position:e.nodePosition,parent:e.renderGroupParent?e.renderGroupParent.nodeId:null},n=function(e){if(e.pointHidden){var n=t[e.point.pointOutput?"outputs":"inputs"]={};n[e.point.pointName]={hidden:e.pointHidden}}};return _.forEach(e.renderPoints,n),t}),groups:_.map(this._renderGroups,function(e){return{id:e.nodeId,description:e.nodeName,position:e.nodePosition}}),connections:_.map(this._renderConnections,function(e,t){return{connectionIndex:t,outputName:e.outputRenderPoint.point.pointName,outputRendererBlockId:e.outputRenderPoint.renderBlock.nodeId,inputName:e.inputRenderPoint.point.pointName,inputRendererBlockId:e.inputRenderPoint.renderBlock.nodeId}})}},d3.behavior.mousedown=function(){function e(e){e.each(function(e){function n(){o({type:"mousedown"})}var o=t.of(this,arguments);d3.select(this).on("mousedown",n)})}var t=d3_eventDispatch(e,"mousedown");return d3.rebind(e,t,"on")},d3.behavior.doubleClick=function(){function e(e){e.each(function(e){function n(){o({type:"dblclick"})}var o=t.of(this,arguments);d3.select(this).on("dblclick",n)})}var t=d3_eventDispatch(e,"dblclick");return d3.rebind(e,t,"on")},dudeGraph.preventD3Default=function(){dudeGraph.browserIf(["IE"],function(){d3.event.sourceEvent.defaultPrevented=!0},function(){d3.event.sourceEvent.preventDefault()})},dudeGraph.stopD3ImmediatePropagation=function(){d3.event.sourceEvent.stopImmediatePropagation()},dudeGraph.Renderer.prototype.measureText=function(e){return e instanceof d3.selection&&(e=e.text()),[8*e.length,17]},dudeGraph.Renderer.prototype.renderNodesBoundingRect=function(e,t){var n=[1/0,1/0],o=[-(1/0),-(1/0)];return _.forEach(e,function(e){n[0]=Math.min(n[0],e.nodePosition[0]),n[1]=Math.min(n[1],e.nodePosition[1]),o[0]=Math.max(o[0],e.nodePosition[0]+e.nodeSize[0]),o[1]=Math.max(o[1],e.nodePosition[1]+e.nodeSize[1])}),n[0]===1/0||o[0]===-(1/0)?t?null:[[0,0],[0,0]]:[n,o]},dudeGraph.Renderer.prototype.screenToWorld=function(e){this._svgPoint.x=e[0],this._svgPoint.y=e[1];var t=this._svgPoint.matrixTransform(this._d3Root.node().getCTM().inverse());return[t.x,t.y]},dudeGraph.RenderVariable=function(e,t,n){dudeGraph.RenderBlock.call(this,e,t,n,"dude-graph-edit-variable")},dudeGraph.RenderVariable.prototype=_.create(dudeGraph.RenderBlock.prototype,{constructor:dudeGraph.RenderVariable}),dudeGraph.RenderVariable.prototype.create=function(e){dudeGraph.RenderBlock.prototype.create.call(this,e);var t=this.block.blockOutputs[0].pointValueType,n=this._renderer.config.typeColors[t];_.isUndefined(n)||this._d3Title.attr("style","fill: "+n+";")},dudeGraph.RenderVariable.prototype.update=function(e){dudeGraph.RenderBlock.prototype.update.call(this,e)},dudeGraph.RenderVariable.prototype.computeSize=function(){this._nodeSize=[this._renderer.measureText(this._nodeName)[0]+4*this._renderer.config.point.padding,40]},dudeGraph.RenderVariable.prototype.createRenderPoint=function(e){return dudeGraph.RenderPointVariable.buildRenderPoint(this._renderer,this,e)},dudeGraph.RenderVariable.buildRenderBlock=function(e,t){return dudeGraph.RenderBlock.buildRenderBlock.call(this,e,t)},dudeGraph.RenderPointVariable=function(e,t,n){dudeGraph.RenderPoint.call(this,e,t,n)},dudeGraph.RenderPointVariable.prototype=_.create(dudeGraph.RenderPoint.prototype,{constructor:dudeGraph.RenderPointVariable}),dudeGraph.RenderPointVariable.prototype.create=function(e){dudeGraph.RenderPoint.prototype.create.call(this,e),this._d3Title.text("")},dudeGraph.RenderPointVariable.prototype.update=function(){var e=this._renderer.config.typeColors[this.point.pointValueType]||this._renderer.config.defaultColor;this._d3Point.attr("transform","translate("+this.pointPosition+")"),this._d3Circle.attr({stroke:e,fill:this.empty()?"transparent":e})},dudeGraph.RenderPointVariable.prototype.computeSize=function(){this._pointSize=[90+2*this._renderer.config.point.padding,this._renderer.config.point.height]},dudeGraph.RenderPointVariable.prototype.computePosition=function(){this._pointPosition=[this._renderBlock.nodeSize[0]-this._renderer.config.point.padding,this._renderBlock.nodeSize[1]/2]},dudeGraph.RenderPointVariable.buildRenderPoint=function(e,t,n){return dudeGraph.RenderPoint.buildRenderPoint.call(this,e,t,n)},dudeGraph.defaultBlocks=[{block:"AssignationBlock",type:dudeGraph.AssignationBlock},{block:"ConditionBlock",type:dudeGraph.ConditionBlock},{block:"DelegateBlock",type:dudeGraph.DelegateBlock},{block:"EachBlock",type:dudeGraph.EachBlock},{block:"ExpressionBlock",type:dudeGraph.ExpressionBlock},{block:"FormatBlock",type:dudeGraph.FormatBlock},{block:"FunctionBlock",type:dudeGraph.FunctionBlock},{block:"GetterBlock",type:dudeGraph.GetterBlock},{block:"InstructionBlock",type:dudeGraph.InstructionBlock},{block:"OperatorBlock",type:dudeGraph.OperatorBlock},{block:"RangeBlock",type:dudeGraph.RangeBlock},{block:"VariableBlock",type:dudeGraph.VariableBlock}],dudeGraph.defaultPoints=[{point:"ResourcePoint",type:dudeGraph.ResourcePoint},{point:"StreamPoint",type:dudeGraph.StreamPoint}],dudeGraph.defaultRenderBlocks=[{renderBlock:"AssignationBlock",type:dudeGraph.RenderBlock},{renderBlock:"ConditionBlock",type:dudeGraph.RenderBlock},{renderBlock:"DelegateBlock",type:dudeGraph.RenderBlock},{renderBlock:"EachBlock",type:dudeGraph.RenderBlock},{renderBlock:"ExpressionBlock",type:dudeGraph.RenderBlock},{renderBlock:"FormatBlock",type:dudeGraph.RenderBlock},{renderBlock:"FunctionBlock",type:dudeGraph.RenderBlock},{renderBlock:"GetterBlock",type:dudeGraph.RenderBlock},{renderBlock:"InstructionBlock",type:dudeGraph.RenderBlock},{renderBlock:"OperatorBlock",type:dudeGraph.RenderBlock},{renderBlock:"RangeBlock",type:dudeGraph.RenderBlock},{renderBlock:"VariableBlock",type:dudeGraph.RenderVariable}],dudeGraph.defaultRenderPoints=[{renderPoint:"ResourcePoint",type:dudeGraph.RenderPoint},{renderPoint:"StreamPoint",type:dudeGraph.RenderPoint}];
//# sourceMappingURL=dude-graph.js.map
