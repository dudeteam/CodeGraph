function d3_dispatch_event(e){function t(){for(var t,r=n,o=-1,i=r.length;++o<i;)t=r[o].on,t&&t.apply(this,arguments);return e}var n=[],r=d3.map();return t.on=function(t,o){var i,a=r.get(t);return arguments.length<2?a&&a.on:(a&&(a.on=null,n=n.slice(0,i=n.indexOf(a)).concat(n.slice(i+1)),r.remove(t)),o&&n.push(r.set(t,{on:o})),e)},t}function d3_eventDispatch(e){for(var t=d3.dispatch(),n=0,r=arguments.length;++n<r;)t[arguments[n]]=d3_dispatch_event(t);return t.of=function(n,r){return function(o){var i;try{i=o.sourceEvent=d3.event,o.target=e,d3.event=o,t[o.type].apply(n,r)}finally{d3.event=i}}},t}var pandora=function(){var e="undefined"==typeof Module?{}:Module;return"undefined"!=typeof exports&&("undefined"!=typeof module&&module.exports&&(exports=module.exports=e),exports.pandora=e),e}();pandora.typename=function(e){if(void 0!==e.constructor.typename)return e.constructor.typename;switch(typeof e){case"boolean":return"Boolean";case"number":return"Number";case"string":return"String";case"function":return"Function";case"object":if(e instanceof Array)return"Array";if(e instanceof Object)return"Object"}return null===e?"null":void 0===e?"undefined":"Unknown"},pandora.class_=function(){for(var e=arguments[0],t=arguments[arguments.length-1],n=1;n<arguments.length-1;++n){if("function"!=typeof arguments[n])throw new pandora.Exception("{0} is not a valid constructor type",pandora.typename(arguments[n]));var r=arguments[n].prototype;for(var o in r)r.hasOwnProperty(o)&&(t.prototype[o]=r[o])}return Object.defineProperty(t,"typename",{value:e,writable:!1}),t},pandora.polymorphic=function(e,t){var n=pandora.typename(e);if(void 0===t[n]){if(void 0===t._)throw new pandora.MissingOverloadError(n);return t._()}return t[n]()},pandora.polymorphicMethod=function(e,t,n){var r=pandora.typename(n),o=e["_"+t+r];if(void 0===o)throw new pandora.MissingOverloadError(t+r,pandora.typename(e));return o.apply(e,Array.prototype.slice.call(arguments,2))},pandora.preventCallback=function(e,t,n){void 0!==e.preventDefault&&void 0!==e.stopPropagation&&void 0!==e.stopImmediatePropagation&&(n=e),n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation()},pandora.defaultCallback=function(){},pandora.mouseWheel=function(e,t){var n=function(e){e||(e=event);var n=0;n=e.wheelDelta?e.wheelDelta/360:e.detail/-9,t(e,n)};e.addEventListener("DOMMouseScroll",n,!1),e.addEventListener("mousewheel",n,!1)},pandora.EventEmitter=function(){var e=pandora.class_("EventEmitter",function(){this._listeners={}});return e.prototype.on=function(e,t){void 0===this._listeners[e]&&(this._listeners[e]=[]),this._listeners[e].push(t)},e.prototype.off=function(e){this._listeners[e]=[]},e.prototype.emit=function(e){if(void 0!==this._listeners[e])for(var t=0;t<this._listeners[e].length;++t)this._listeners[e][t].apply(this,Array.prototype.slice.call(arguments,1))},e}(),pandora.formatString=function(){var e=arguments[0],t=arguments[1];return 1===arguments.length?e:t&&"object"==typeof t?pandora.formatDictionary.apply(this,arguments):pandora.formatArray.apply(this,arguments)},pandora.formatArray=function(){var e=Array.prototype.slice.call(arguments,1);return arguments[0].replace(/{(\d+)}/g,function(t,n){return e[n]})},pandora.formatDictionary=function(){var e=/\{([^\}]+)\}/g,t=/(?:(?:^|\.)(.+?)(?=\[|\.|$|\()|\[('|")(.+?)\2\])(\(\))?/g,n=function(e,n,r){var o=r;return n.replace(t,function(e,t,n,r,i){t=t||r,void 0!==o&&(t in o&&(o=o[t]),"function"==typeof o&&i&&(o=o()))}),o=(null===o||o===r?e:o)+""};return function(t,r){return String(t).replace(e,function(e,t){return n(e,t,r)})}}(),pandora.camelcase=function(e,t){return t=t||"-",e[0].toUpperCase()+e.replace(new RegExp("("+t+"[a-z])","g"),function(e){return e.toUpperCase().replace(t,"")}).substr(1)},pandora.uncamelcase=function(e,t){return e.replace(/([A-Z])/g,function(e){return t+e.toLowerCase()}).substr(1)},pandora.forEach=function(e,t){pandora.polymorphic(e,{Array:function(){for(var n=0;n<e.length;++n)if(t(e[n],n)===!0)return},Object:function(){for(var n in e)if(e.hasOwnProperty(n)&&t(e[n],n)===!0)return}})},pandora.mergeObjects=function(e,t,n,r){for(var o in t)t.hasOwnProperty(o)&&(n&&"object"==typeof t[o]?(e[o]=e[o]||{},pandora.mergeObjects(e[o],t[o],n)):(r||void 0===e[o])&&(e[o]=t[o]));return e},pandora.Exception=function(){return pandora.class_("Exception",function(){var e=new Error(pandora.formatString.apply(null,arguments));return e.name=pandora.typename(this),e})}(),pandora.MissingOverloadError=function(){return pandora.class_("MissingOverloadError",pandora.Exception,function(e,t){var n=void 0!==t?t+".prototype._":"_";return pandora.Exception.call(this,"{0}{1}() overload is missing",n,e)})}(),pandora.clamp=function(e,t,n){return Math.min(Math.max(e,t),n)},pandora.Box2=function(){var e=pandora.class_("Box2",function(e,t,n,r){this.assign(e,t,n,r)});return e.prototype.assign=function(){var e=arguments[0],t=arguments[1],n=arguments[2],r=arguments[3];return void 0===e?(this.x=0,this.y=0,this.width=0,this.height=0):"Number"===pandora.typename(e)&&void 0===t?(this.x=e,this.y=e,this.width=e,this.height=e):"Vec2"===pandora.typename(e)&&"Vec2"===pandora.typename(t)?(this.x=e.x,this.y=e.y,this.width=t.x,this.height=t.y):"Array"===pandora.typename(e)?(this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]):void 0!==e.x&&void 0!==e.y&&void 0!==e.width&&void 0!==e.height?(this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height):void 0!==e.left&&void 0!==e.right&&void 0!==e.top&&void 0!==e.bottom?(this.x=e.left,this.y=e.top,this.width=e.right-e.left,this.height=e.bottom-e.top):(this.x=e,this.y=t,this.width=n,this.height=r),this},e.prototype.clone=function(){return new e(this.x,this.y,this.width,this.height)},e.prototype.toArray=function(){return[this.x,this.y,this.width,this.height]},e.prototype.collide=function(e){return pandora.polymorphic(e,{Vec2:function(){return e.x>=this.x&&e.x<=this.x+this.width&&e.y>=this.y&&e.y<=this.y+this.height}.bind(this),Box2:function(){return this.x<e.x+e.width&&this.x+this.width>e.x&&this.y<e.y+e.height&&this.height+this.y>e.y}.bind(this)})},e.prototype.contain=function(e){return pandora.polymorphic(e,{Vec2:function(){return e.x>=this.x&&e.x<=this.x+this.width&&e.y>=this.y&&e.y<=this.y+this.height}.bind(this),Box2:function(){return e.x>this.x&&e.x+e.width<this.x+this.width&&e.y>this.y&&e.y+e.height<this.y+this.height}.bind(this)})},e}(),pandora.Vec2=function(){var e=pandora.class_("Vec2",function(e,t){this.assign(e,t)});return e.prototype.assign=function(){var e=arguments[0],t=arguments[1];return void 0===e?(this.x=0,this.y=0):"number"==typeof e&&void 0===t?(this.x=e,this.y=e):"Array"===pandora.typename(e)?(this.x=e[0],this.y=e[1]):"Vec2"===pandora.typename(e)||"number"==typeof e.x&&"number"==typeof e.y?(this.x=e.x,this.y=e.y):(this.x=e,this.y=t),this},e.prototype.clone=function(){return new e(this.x,this.y)},e.prototype.toArray=function(){return[this.x,this.y]},e.prototype.collideCircle=function(e,t){t=t||5;var n=this.x-e.x,r=this.y-e.y;return Math.sqrt(n*n+r*r)<2*t},e.prototype.add=function(e){return pandora.polymorphic(e,{Number:function(){this.x+=e,this.y+=e}.bind(this),Vec2:function(){this.x+=e.x,this.y+=e.y}.bind(this)}),this},e.prototype.subtract=function(e){return pandora.polymorphic(e,{Number:function(){this.x-=e,this.y-=e}.bind(this),Vec2:function(){this.x-=e.x,this.y-=e.y}.bind(this)}),this},e.prototype.multiply=function(e){return pandora.polymorphic(e,{Number:function(){this.x*=e,this.y*=e}.bind(this),Vec2:function(){this.x*=e.x,this.y*=e.y}.bind(this)}),this},e.prototype.divide=function(e){return pandora.polymorphic(e,{Number:function(){this.x/=e,this.y/=e}.bind(this),Vec2:function(){this.x/=e.x,this.y/=e.y}.bind(this)}),this},e}();var dudeGraph=function(){var e={};return"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=e),exports.dudeGraph=e):window.dudeGraph=e,e}();dudeGraph.ArrayMerger=function(e,t){return _.isArray(e)?(t||[]).concat(e):void 0},dudeGraph.Math=function(){var e={};return e.clamp=function(e,t,n){return Math.min(Math.max(e,t),n)},e}(),dudeGraph.UUID=function(){var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},t={salt:e()};return t.generate=function(){return t.salt+"-"+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},t}(),dudeGraph.Graph=function(e){pandora.EventEmitter.call(this),this.loader=new dudeGraph.JSONLoader(this,e),this._cgTypes={Stream:["Stream"],Array:["Array"],String:["String"],Number:["Number","Boolean"],Boolean:["Boolean","Number"],Vec2:["Vec2"],Vec3:["Vec3"],Vec4:["Vec4"],Color:["Color","Vec4"],Texture2D:["Texture2D"],Entity:["Entity"]},this._validators={Array:function(e){return _.isArray(e)},String:function(e){return _.isString(e)},Number:function(e){return _.isNumber(e)||/^[0-9]+(\.[0-9]+)?$/.test(e)},Boolean:function(e){return _.isBoolean(e)||/^(true|false)/.test(e)}},Object.defineProperty(this,"cgBlocks",{get:function(){return this._cgBlocks}.bind(this)}),this._cgBlocks=[],Object.defineProperty(this,"cgBlocksIds",{get:function(){return this._cgBlocksIds}.bind(this)}),this._cgBlocksIds={},Object.defineProperty(this,"cgConnections",{get:function(){return this._cgConnections}.bind(this)}),this._cgConnections=[]},dudeGraph.Graph.prototype=_.create(pandora.EventEmitter.prototype,{constructor:dudeGraph.Graph}),dudeGraph.Graph.prototype.addValidator=function(e,t){this._validators[e]=t},dudeGraph.Graph.prototype.canConvert=function(e,t){return e===t||this._cgTypes[e]&&-1!==this._cgTypes[e].indexOf(t)},dudeGraph.Graph.prototype.canAssign=function(e,t){return null===e||this._validators[t]&&this._validators[t](e)},dudeGraph.Graph.prototype.updateTemplate=function(e,t){return e.cgBlock.updateTemplate(e,t)},dudeGraph.Graph.prototype.addBlock=function(e,t){var n=e.cgId;if(e.cgGraph!==this)throw new Error("This block does not belong to this graph");if(null===n||void 0===n)throw new Error("Block id is null");if(this._cgBlocksIds[n])throw new Error("Block with id `"+n+"` already exists");return this._cgBlocks.push(e),this._cgBlocksIds[n]=e,t||this.emit("dude-graph-block-create",e),e},dudeGraph.Graph.prototype.removeBlock=function(e){var t=this._cgBlocks.indexOf(e);if(-1===t||e.cgGraph!==this)throw new Error("This block does not belong to this graph");var n=e.cgOutputs.concat(e.cgInputs);_.forEach(n,function(e){this.disconnectPoint(e)}.bind(this)),this._cgBlocks.splice(t,1),delete this._cgBlocksIds[e.cgId],this.emit("dude-graph-block-remove",e)},dudeGraph.Graph.prototype._connectPoints=function(e,t){if(null!==this.connectionByPoints(e,t))throw new Error("Connection already exists between these two points: `"+e.cgName+"` and `"+t.cgName+"`");if(e.isOutput===t.isOutput)throw new Error("Cannot connect either two inputs or two outputs: `"+e.cgName+"` and `"+t.cgName+"`");if(!e.acceptConnect(t))throw new Error("Point `"+e.cgName+"` does not accept to connect to `"+t.cgName+"` (too many connections)");if(!t.acceptConnect(e))throw new Error("Point `"+t.cgName+"` does not accept to connect to `"+e.cgName+"` (too many connections)");if(!this.canConvert(e.cgValueType,t.cgValueType)&&!this.updateTemplate(t,e.cgValueType))throw new Error("Cannot connect two points of different value types: `"+e.cgValueType+"` and `"+t.cgValueType+"`");var n=new dudeGraph.Connection(e,t);return this._cgConnections.push(n),e._cgConnections.push(n),t._cgConnections.push(n),this.emit("dude-graph-connection-create",n),n},dudeGraph.Graph.prototype._disconnectPoints=function(e,t){var n=this.connectionByPoints(e,t);if(null===n)throw new Error("No connections between these two points: `"+e.cgName+"` and `"+t.cgName+"`");return this._cgConnections.splice(this._cgConnections.indexOf(n),1),e._cgConnections.splice(e._cgConnections.indexOf(n),1),t._cgConnections.splice(t._cgConnections.indexOf(n),1),this.emit("dude-graph-connection-remove",n),n},dudeGraph.Graph.prototype.disconnectPoint=function(e){var t=e.cgConnections;_.forEach(t,function(e){this.disconnectPoints(e.cgOutputPoint,e.cgInputPoint)}.bind(this))},dudeGraph.Graph.prototype.blockById=function(e){var t=this._cgBlocksIds[e];if(!t)throw new Error("Block not found for id `"+e+"`");return t},dudeGraph.Graph.prototype.blockByName=function(e){var t=null;return _.forEach(this.cgBlocks,function(n){n.cgName===e&&(t=n)}),t},dudeGraph.Graph.prototype.blocksByType=function(e){var t=[];return _.forEach(this.cgBlocks,function(n){n.blockType===e&&t.push(n)}),t},dudeGraph.Graph.prototype.nextBlockId=function(){return dudeGraph.UUID.generate()},dudeGraph.Graph.prototype.connectionsByBlock=function(e){var t=[];return _.forEach(this._cgConnections,function(n){(n.cgOutputPoint.cgBlock===e||n.cgInputPoint.cgBlock===e)&&t.push(n)}),t},dudeGraph.Graph.prototype.connectionByPoints=function(e,t){return _.find(this._cgConnections,function(n){return n.cgOutputPoint===e&&n.cgInputPoint===t})||null},dudeGraph.Graph.prototype.connectionsByPoint=function(e){var t=[];return _.forEach(this._cgConnections,function(n){(n.cgOutputPoint===e||n.cgInputPoint===e)&&t.push(n)}),t},dudeGraph.Graph.prototype.cloneBlocks=function(e){var t=[],n=[],r=[];return _.forEach(e,function(o){var i=this.connectionsByBlock(o),a=o.clone(this);this.addBlock(a),n.push(a),t[o.cgId]=a,_.forEach(i,function(t){-1===r.indexOf(t)&&-1!==e.indexOf(t.cgOutputPoint.cgBlock)&&-1!==e.indexOf(t.cgInputPoint.cgBlock)&&r.push(t)})}.bind(this)),_.forEach(r,function(e){try{t[e.cgOutputPoint.cgBlock.cgId].outputByName(e.cgOutputPoint.cgName).connect(t[e.cgInputPoint.cgBlock.cgId].inputByName(e.cgInputPoint.cgName))}catch(n){throw new Error("Connection duplication silenced exception: "+n)}}),n},dudeGraph.Block=function(e,t,n){if(t=t||{},Object.defineProperty(this,"cgGraph",{get:function(){return this._cgGraph}.bind(this)}),this._cgGraph=e,!e)throw new Error("Block() Cannot create a Block without a graph");Object.defineProperty(this,"blockType",{get:function(){return this._blockType}.bind(this)}),this._blockType=n||"Block",Object.defineProperty(this,"cgId",{get:function(){return this._cgId}.bind(this)}),this._cgId=t.cgId||e.nextBlockId(),Object.defineProperty(this,"cgName",{get:function(){return this._cgName}.bind(this),set:function(e){var t=this._cgName;this._cgName=e,this._cgGraph.emit("dude-graph-block-name-change",this,t,e)}.bind(this)}),this._cgName=t.cgName||this._blockType,Object.defineProperty(this,"cgTemplates",{get:function(){return this._cgTemplates}.bind(this)}),this._cgTemplates=t.cgTemplates||{},Object.defineProperty(this,"cgInputs",{get:function(){return this._cgInputs}.bind(this)}),this._cgInputs=[],Object.defineProperty(this,"cgOutputs",{get:function(){return this._cgOutputs}.bind(this)}),this._cgOutputs=[],e.loader.loadPoints(this,t)},dudeGraph.Block.buildBlock=function(e,t){return new Block(e,t)},dudeGraph.Block.prototype.addPoint=function(e){if(e.cgBlock!==this)throw new Error("Point `"+e.cgName+"` is not bound to this block `"+this._cgId+"`");if(e.isOutput&&this.outputByName(e.cgName)||!e.isOutput&&this.inputByName(e.cgName))throw new Error("Block `"+this._cgId+"` has already an "+(e.isOutput?"output":"input")+": `"+e.cgName+"`");return e.isOutput?this._cgOutputs.push(e):this._cgInputs.push(e),this._cgGraph.emit("cg-point-create",this,e),e},dudeGraph.Block.prototype.outputByName=function(e){return _.find(this._cgOutputs,function(t){return t.cgName===e})},dudeGraph.Block.prototype.inputByName=function(e){return _.find(this._cgInputs,function(t){return t.cgName===e})},dudeGraph.Block.prototype.updateTemplate=function(e,t){if(null===e.cgTemplate||!this.cgTemplates[e.cgTemplate]||-1===this.cgTemplates[e.cgTemplate].indexOf(t))return!1;e.cgValueType=t;var n=!1,r=function(r){if(n)return!0;if(r.cgTemplate===e.cgTemplate){if(0!==e.cgConnections.length)return n=!0,!0;r.cgValueType=t}};return _.forEach(this._cgInputs,r.bind(this)),_.forEach(this._cgOutputs,r.bind(this)),!n},dudeGraph.Block.prototype.clone=function(e){if("Block"!==this._blockType)throw new Error("Method `clone` must be overridden by `"+this._blockType+"`");var t=new dudeGraph.Block(e);return t.cgName=this._cgName,_.forEach(this._cgOutputs,function(e){var n=e.clone(t);t.addPoint(n)}),_.forEach(this._cgInputs,function(e){var n=e.clone(t);t.addPoint(n)}),t},dudeGraph.Block.prototype.save=function(){return{cgType:this._blockType,cgId:this._cgId,cgName:this._cgName,cgInputs:_.map(this._cgInputs,function(e){return e.save()}),cgOutputs:_.map(this._cgOutputs,function(e){return e.save()})}},dudeGraph.Point=function(e,t,n,r){if(Object.defineProperty(this,"cgGraph",{get:function(){return this._cgGraph}.bind(this)}),this._cgGraph=e.cgGraph,Object.defineProperty(this,"pointType",{get:function(){return this._pointType}.bind(this)}),this._pointType=r||"Point",Object.defineProperty(this,"cgBlock",{get:function(){return this._cgBlock}.bind(this)}),this._cgBlock=e,Object.defineProperty(this,"cgName",{get:function(){return this._cgName}.bind(this)}),this._cgName=t.cgName||this._pointType,Object.defineProperty(this,"isOutput",{get:function(){return this._isOutput}.bind(this)}),this._isOutput=n,Object.defineProperty(this,"cgConnections",{get:function(){return this._cgConnections}.bind(this)}),this._cgConnections=[],Object.defineProperty(this,"singleConnection",{get:function(){return this._singleConnection}.bind(this),set:function(e){this._singleConnection=e}.bind(this)}),this._singleConnection=void 0===t.singleConnection?!0:t.singleConnection,Object.defineProperty(this,"cgTemplate",{get:function(){return this._cgTemplate}.bind(this)}),this._cgTemplate=t.cgTemplate||null,Object.defineProperty(this,"cgValueType",{get:function(){return this._cgValueType}.bind(this),set:function(e){var t=this._cgValueType;this._cgValueType=e,this._cgGraph.emit("cg-point-value-type-change",this,t,e)}.bind(this)}),this._cgValueType=t.cgValueType,void 0===t.cgValueType)throw new Error("Cannot create the point `"+this._cgName+"` in block `"+this._cgBlock.cgId+"` without specifying a value type");if(Object.defineProperty(this,"cgValue",{configurable:!0,get:function(){return this._cgValue}.bind(this),set:function(e){if(null!==e&&!this.acceptValue(e))throw new Error("Cannot set `cgValue`: Point `"+this._cgName+"` cannot accept more than one connection");if(!this._cgGraph.canAssign(e,this._cgValueType))throw new Error("Invalid value `"+String(e)+"` for `"+this._cgValueType+"` in `"+this._cgName+"`");var t=this._cgValue;this._cgValue=e,this._cgGraph.emit("cg-point-value-change",this,t,e)}.bind(this)}),this._cgValue=t.cgValue||null,void 0!==t.cgValue&&n)throw new Error("Shouldn't create output point `"+this._cgName+"` in block `"+this._cgBlock.cgId+"` with a value.")},dudeGraph.Point.prototype.empty=function(){return 0===this._cgConnections.length&&null===this._cgValue},dudeGraph.Point.prototype.acceptConnect=function(e){return!this._singleConnection||0===this._cgConnections.length&&null===this._cgValue},dudeGraph.Point.prototype.acceptValue=function(e){return!this._singleConnection||0===this._cgConnections.length},dudeGraph.Point.prototype.connect=function(e){return this._isOutput?this._cgGraph._connectPoints(this,e):this._cgGraph._connectPoints(e,this)},dudeGraph.Point.prototype.disconnect=function(e){return this._isOutput?this._cgGraph._disconnectPoints(this,e):this._cgGraph._disconnectPoints(e,this)},dudeGraph.Point.prototype.clone=function(e){if("Point"!==this._pointType)throw new Error("Method `clone` must be overridden by `"+this._pointType+"`");return new dudeGraph.Point(e,{cgName:this._cgName,cgValueType:this._cgValueType,cgValue:this._cgValue},this._isOutput)},dudeGraph.Point.prototype.save=function(){var e={cgType:this.pointType,cgName:this._cgName,cgValueType:this._cgValueType,singleConnection:this._singleConnection};return this._isOutput||(e.cgValue=this._cgValue),e},dudeGraph.Connection=function(e,t){if(Object.defineProperty(this,"cgOutputPoint",{get:function(){return this._cgOutputPoint}.bind(this)}),this._cgOutputPoint=e,!e.isOutput)throw new Error("outputPoint is not an output");if(Object.defineProperty(this,"cgInputPoint",{get:function(){return this._cgInputPoint}.bind(this)}),this._cgInputPoint=t,t.isOutput)throw new Error("inputPoint is not an input")},dudeGraph.Connection.prototype.otherPoint=function(e){if(e===this._cgOutputPoint)return this._cgInputPoint;if(e===this._cgInputPoint)return this._cgOutputPoint;throw new Error("Point `"+e.cgName+"` is not in this connection")},dudeGraph.Connection.prototype.remove=function(){},dudeGraph.Connection.prototype.save=function(){return{cgOutputName:this._cgOutputPoint._cgName,cgOutputBlockId:this._cgOutputPoint._cgBlock._cgId,cgInputName:this._cgInputPoint._cgName,cgInputBlockId:this._cgInputPoint._cgBlock._cgId}},dudeGraph.Stream=function(e,t,n){dudeGraph.Point.call(this,e,_.merge(t,{cgName:t.cgName,cgValueType:"Stream"}),n,"Stream"),Object.defineProperty(this,"cgValue",{get:function(){throw new Error("Stream has no `cgValue`.")}.bind(this),set:function(){throw new Error("Stream has no `cgValue`.")}.bind(this)})},dudeGraph.Stream.prototype=_.create(dudeGraph.Point.prototype,{constructor:dudeGraph.Assignation}),dudeGraph.Stream.prototype.clone=function(e){return new dudeGraph.Stream(e,this._cgName,this._isOutput)},dudeGraph.Assignation=function(e,t){if(dudeGraph.Block.call(this,e,t,"Assignation"),!(this.inputByName("in")instanceof dudeGraph.Stream))throw new Error("Assignation `"+this.cgId+"` must have an input `in` of type `Stream`");if(!(this.inputByName("this")instanceof dudeGraph.Point))throw new Error("Assignation `"+this.cgId+"` must have an input `this` of type `Point`");if(!(this.inputByName("other")instanceof dudeGraph.Point))throw new Error("Assignation `"+this.cgId+"` must have an input `other` of type `Point`");if(this.inputByName("this")._cgValueType!==this.inputByName("other")._cgValueType)throw new Error("Assignation `"+this.cgId+"` inputs `this` and `other` must have the same cgValueType");if(!(this.outputByName("out")instanceof dudeGraph.Stream))throw new Error("Assignation `"+this.cgId+"` must have an output `out` of type `Stream`")},dudeGraph.Assignation.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Assignation}),dudeGraph.Assignation.buildBlock=function(e,t){return new dudeGraph.Assignation(e,_.merge(t,{cgInputs:[{cgName:"in",cgType:"Stream"},{cgName:"this",cgType:"Point",cgValueType:t.cgValueType},{cgName:"other",cgType:"Point",cgValueType:t.cgValueType}],cgOutputs:[{cgName:"out",cgType:"Stream"}]},dudeGraph.ArrayMerger))},dudeGraph.Condition=function(e,t){if(dudeGraph.Block.call(this,e,t,"Condition"),!(this.inputByName("in")instanceof dudeGraph.Stream))throw new Error("Condition `"+this.cgId+"` must have an input `in` of type `Stream`");if(!(this.inputByName("test")instanceof dudeGraph.Point)||"Boolean"!==this.inputByName("test").cgValueType)throw new Error("Condition `"+this.cgId+"` must have an input `test` of type `Point` of cgValueType `Boolean`");if(!(this.outputByName("true")instanceof dudeGraph.Stream))throw new Error("Condition `"+this.cgId+"` must have an output `true` of type `Stream`");if(!(this.outputByName("false")instanceof dudeGraph.Stream))throw new Error("Condition `"+this.cgId+"` must have an output `false` of type `Stream`")},dudeGraph.Condition.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Condition}),dudeGraph.Condition.buildBlock=function(e,t){return new dudeGraph.Condition(e,_.merge(t,{cgInputs:[{cgName:"in",cgType:"Stream"},{cgType:"Point",cgName:"test",cgValueType:"Boolean"}],cgOutputs:[{cgName:"true",cgType:"Stream"},{cgName:"false",cgType:"Stream"}]},dudeGraph.ArrayMerger))},dudeGraph.Delegate=function(e,t){if(dudeGraph.Block.call(this,e,t,"Delegate"),!(this.outputByName("out")instanceof dudeGraph.Stream))throw new Error("Delegate `"+this.cgId+"` must have an output `out` of type `Stream`")},dudeGraph.Delegate.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Delegate}),dudeGraph.Delegate.buildBlock=function(e,t){return new dudeGraph.Delegate(e,_.merge(t,{cgOutputs:[{cgName:"out",cgType:"Stream"}]},dudeGraph.ArrayMerger))},dudeGraph.Each=function(e,t){dudeGraph.Block.call(this,e,t,"Each")},dudeGraph.Each.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Each}),dudeGraph.Each.buildBlock=function(e,t){return new dudeGraph.Each(e,_.merge(t,{cgInputs:[{cgName:"in",cgType:"Stream"},{cgType:"Point",cgName:"list",cgValueType:"List"}],cgOutputs:[{cgName:"current",cgType:"Stream"},{cgType:"Point",cgName:"index",cgValueType:"Number"},{cgName:"completed",cgType:"Stream"}]},dudeGraph.ArrayMerger))},dudeGraph.Function=function(e,t){dudeGraph.Block.call(this,e,t,"Function")},dudeGraph.Function.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Function}),dudeGraph.Function.buildBlock=function(e,t){return new dudeGraph.Function(e,_.merge(t,{cgOutputs:t.cgReturn?[{cgType:"Point",cgName:"value",cgValueType:t.cgReturn.cgValueType,cgTemplate:t.cgReturn.cgTemplate}]:null},dudeGraph.ArrayMerger))},dudeGraph.Getter=function(e,t){dudeGraph.Block.call(this,e,t,"Getter")},dudeGraph.Getter.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Getter}),dudeGraph.Getter.buildBlock=function(e,t){return new dudeGraph.Getter(e,_.merge(t,{cgInputs:[{cgType:"Point",cgName:"this",cgValueType:t.cgClassType}],cgOutputs:[{cgType:"Point",cgName:"value",cgValueType:t.cgValueType}]},dudeGraph.ArrayMerger))},dudeGraph.Instruction=function(e,t){if(dudeGraph.Block.call(this,e,t,"Instruction"),!(this.inputByName("in")instanceof dudeGraph.Stream))throw new Error("Instruction `"+this.cgId+"` must have an input `in` of type `Stream`");if(!(this.outputByName("out")instanceof dudeGraph.Stream))throw new Error("Instruction `"+this.cgId+"` must have an output `out` of type `Stream`")},dudeGraph.Instruction.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Instruction}),dudeGraph.Instruction.buildBlock=function(e,t){return new dudeGraph.Instruction(e,_.merge(t,{cgInputs:[{cgName:"in",cgType:"Stream"}],cgOutputs:t.cgReturn?[{cgName:"out",cgType:"Stream"},{cgType:"Point",cgName:"value",cgValueType:t.cgReturn.cgValueType,cgTemplate:t.cgReturn.cgTemplate}]:[{cgName:"out",cgType:"Stream"}]},dudeGraph.ArrayMerger))},dudeGraph.Operator=function(e,t){if(dudeGraph.Block.call(this,e,t,"Operator"),2!==this.cgInputs.length)throw new Error("Operator `"+this.cgId+"` must only take 2 inputs");if(1!==this.cgOutputs.length)throw new Error("Operator `"+this.cgId+"` must return one value")},dudeGraph.Operator.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Operator}),dudeGraph.Operator.buildBlock=function(e,t){return new dudeGraph.Operator(e,_.merge(t,{cgOutputs:t.cgReturn?[{cgType:"Point",cgName:"value",cgValueType:t.cgReturn.cgValueType,cgTemplate:t.cgReturn.cgTemplate}]:null},dudeGraph.ArrayMerger))},dudeGraph.Range=function(e,t){dudeGraph.Block.call(this,e,t,"Range")},dudeGraph.Range.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Range}),dudeGraph.Range.buildBlock=function(e,t){return new dudeGraph.Range(e,_.merge(t,{cgInputs:[{cgName:"in",cgType:"Stream"},{cgType:"Point",cgName:"start",cgValueType:"Number"},{cgType:"Point",cgName:"end",cgValueType:"Number"},{cgType:"Point",cgName:"delta",cgValueType:"Number"}],cgOutputs:[{cgName:"current",cgType:"Stream"},{cgType:"Point",cgName:"index",cgValueType:"Number"},{cgName:"completed",cgType:"Stream"}]},dudeGraph.ArrayMerger))},dudeGraph.Variable=function(e,t){if(dudeGraph.Block.call(this,e,t,"Variable"),!(this.outputByName("value")instanceof dudeGraph.Point))throw new Error("Variable `"+this.cgId+"` must have an output `value` of type `Point`");Object.defineProperty(this,"cgValueType",{get:function(){return this._cgValueType}.bind(this)}),this._cgValueType=t.cgValueType,Object.defineProperty(this,"cgValue",{get:function(){return this._cgValue}.bind(this),set:function(e){this._cgValue=e,this.cgOutputs[0].cgValue=e}.bind(this)}),this._cgValue=t.cgValue},dudeGraph.Variable.prototype=_.create(dudeGraph.Block.prototype,{constructor:dudeGraph.Variable}),dudeGraph.Variable.rendererBlockCreator=function(e){var t=d3.select(this);t.append("svg:rect").attr("rx",function(){return e._config.block.header/2}).attr("ry",function(){return e._config.block.header/2}),t.append("svg:text").classed("dude-graph-title",!0).attr("text-anchor","middle").attr("dominant-baseline","text-before-edge"),t.append("svg:g").classed("cg-points",!0),dudeGraph.Variable.rendererPointCreator.call(e,t)},dudeGraph.Variable.rendererPointCreator=function(e){var t=this,n=e.selectAll(".dude-graph-output, .dude-graph-input").data(function(e){return e.rendererPoints},function(e){return e.cgPoint.cgName}).enter().append("svg:g").attr("class",function(e){return e.isOutput?"dude-graph-output":"dude-graph-input"}).each(function(){t._createD3PointShapes(d3.select(this))});dudeGraph.Variable.rendererPointUpdater.call(t,n)},dudeGraph.Variable.rendererBlockUpdater=function(e){var t=d3.select(this);t.select("text").text(function(e){return e.cgBlock.cgName}),t.each(function(t){e._computeRendererBlockSize(t)}),t.attr("transform",function(e){return"translate("+e.position+")"}),t.select("rect").attr("width",function(e){return e.size[0]}).attr("height",function(t){return e._config.block.header}),t.select("text").attr("transform",function(t){return"translate("+[t.size[0]/2,e._config.block.padding]+")"}),dudeGraph.Variable.rendererPointUpdater.call(e,t.select(".cg-points").selectAll(".dude-graph-output, .dude-graph-input"))},dudeGraph.Variable.rendererPointUpdater=function(e){var t=this;e.classed("dude-graph-empty",function(e){return e.cgPoint.empty()}).classed("dude-graph-stream",function(e){return"Stream"===e.cgPoint.pointType}).attr("transform",function(e){return"translate("+t._getRendererPointPosition(e,!0)+")"})},dudeGraph.Variable.pointPositionGetter=function(e,t,n){return[t+e.rendererBlock.size[0]-this._config.block.padding,n+this._config.block.header/2]},dudeGraph.Variable.buildBlock=function(e,t){return new dudeGraph.Variable(e,_.merge(t,{cgOutputs:[{cgType:"Point",cgName:"value",cgValueType:t.cgValueType,singleConnection:!1}]},dudeGraph.ArrayMerger))},dudeGraph.GraphSaver=function(e){pandora.EventEmitter.call(this),this.config=e},dudeGraph.GraphSaver.prototype=_.create(pandora.EventEmitter.prototype,{constructor:dudeGraph.GraphSaver}),dudeGraph.GraphSaver.prototype.save=function(e){return{blocks:_.map(e.cgBlocks,function(e){return e.save()}),connections:_.map(e.cgConnections,function(e){return e.save()})}},dudeGraph.RendererSaver=function(e){pandora.EventEmitter.call(this),this.config=e},dudeGraph.RendererSaver.prototype=_.create(pandora.EventEmitter.prototype,{constructor:dudeGraph.RendererSaver}),dudeGraph.RendererSaver.prototype.save=function(e){var t={config:{zoom:{translate:e._config&&e._config.zoom&&e._config.zoom.translate||[0,0],scale:e._config&&e._config.zoom&&e._config.zoom.scale||1}},blocks:[],groups:[],connections:[]};return _.forEach(e._rendererBlocks,function(e){t.blocks.push({id:e.id,cgBlock:e.cgBlock.cgId,position:e.position,parent:e.parent?e.parent.id:null})}),_.forEach(e._rendererGroups,function(e){t.groups.push({id:e.id,description:e.description,position:e.position,parent:e.parent?e.parent.id:null})}),_.forEach(e._rendererConnections,function(e,n){t.connections.push({cgConnectionIndex:n,outputName:e.outputRendererPoint.cgPoint.cgName,outputRendererBlockId:e.outputRendererPoint.rendererBlock.id,inputName:e.inputRendererPoint.cgPoint.cgName,inputRendererBlockId:e.inputRendererPoint.rendererBlock.id})}),t},dudeGraph.JSONSaver=function(){pandora.EventEmitter.call(this)},dudeGraph.JSONSaver.prototype=_.create(pandora.EventEmitter.prototype,{constructor:dudeGraph.JSONSaver}),dudeGraph.JSONSaver.prototype.save=function(e,t){return{rendererData:(new dudeGraph.RendererSaver).save(e),graphData:(new dudeGraph.GraphSaver).save(t)}},dudeGraph.JSONLoader=function(e,t){pandora.EventEmitter.call(this),this._cgGraph=e,this._data=t,this._pointTypes={},this._blockTypes={},this.addPointType("Stream",dudeGraph.Stream),
this.addPointType("Point",dudeGraph.Point)},dudeGraph.JSONLoader.prototype=_.create(pandora.EventEmitter.prototype,{constructor:dudeGraph.JSONLoader}),dudeGraph.JSONLoader.prototype.addPointType=function(e,t){if(void 0!==this._pointTypes[e])throw new Error("Point type `"+e+"` already added to the loader");this._pointTypes[e]=function(e,n,r){var o=new t(e,n,r);return e.addPoint(o),o}},dudeGraph.JSONLoader.prototype.addBlockType=function(e,t){if(void 0!==this._blockTypes[e])throw new Error("Block type `"+e+"` already added to the loader");this._blockTypes[e]=function(e,n){var r=new t(e,n);return e.addBlock(r),r}},dudeGraph.JSONLoader.prototype.load=function(){this._loadBlocks(this._cgGraph,this._data.blocks),this._data.connections&&this._loadConnections(this._cgGraph,this._data.connections)},dudeGraph.JSONLoader.prototype.loadPoints=function(e,t){var n=this,r=function(e,t,r){if(!t.cgName)throw new Error("Block `"+e.cgId+"`: Point property `cgName` is required");var o=t.cgType||"Point",i=n._pointTypes[o];if(!i)throw new Error("Block `"+e.cgId+"`: Cannot deserialize point `"+t.cgName+"` of type `"+o+"`");i.call(n,e,t,r)};t.cgOutputs&&_.forEach(t.cgOutputs,function(t){r(e,t,!0)}),t.cgInputs&&_.forEach(t.cgInputs,function(t){r(e,t,!1)})},dudeGraph.JSONLoader.prototype.loadBlock=function(e){if(!e.hasOwnProperty("cgId"))throw new Error("Block property `cgId` is required");var t=this._blockTypes[e.cgType||"Block"];if(!t)throw new Error("JSONLoader::_loadBlocks() Type `"+e.cgType+"` not added to the loader");t.call(this,this._cgGraph,e)},dudeGraph.JSONLoader.prototype._loadBlocks=function(e,t){_.forEach(t,this.loadBlock.bind(this))},dudeGraph.JSONLoader.prototype._loadConnections=function(e,t){_.forEach(t,function(t){var n=t.cgOutputBlockId,r=t.cgOutputName,o=t.cgInputBlockId,i=t.cgInputName,a=e.blockById(n);if(!a)throw new Error("Output block not found for id `"+n+"`");var c=e.blockById(o);if(!c)throw new Error("Input block not found for id `"+o+"`");var d=a.outputByName(r);if(!d)throw new Error("Output point `"+r+"` not found in block `"+n+"`");var u=c.inputByName(i);if(!u)throw new Error("Input point `"+i+"` not found in block `"+o+"`");d.connect(u)})},dudeGraph.Renderer=function(e,t,n){pandora.EventEmitter.call(this),this._data=n,this._config=_.defaultsDeep(n.config||{},{zoom:{translate:[0,0],scale:1,min:.25,max:5,transitionSpeed:500},block:{padding:10,header:40,size:[80,100]},group:{padding:10,header:30,size:[200,150]},point:{height:20,radius:3,offset:20}}),this._rendererBlockCreators={},this._rendererBlockUpdaters={},this._pointPositionGetters={},this._d3Svg=d3.select(e),this._svgPoint=this._d3Svg.node().createSVGPoint(),this._d3Root=this._d3Svg.append("svg:g").attr("id","cg-root"),this._d3Groups=this._d3Root.append("svg:g").attr("id","dude-graph-groups"),this._d3Connections=this._d3Root.append("svg:g").attr("id","dude-graph-connections"),this._d3Block=this._d3Root.append("svg:g").attr("id","dude-graph-blocks"),this._cgGraph=t,this._rendererBlocks=[],this._rendererGroups=[],this._rendererConnections=[],this._rendererBlockIds=d3.map(),this._rendererGroupIds=d3.map(),this._rendererBlocksQuadtree=null,this._rendererGroupsQuadtree=null,this._rendererPointsQuadtree=null,Object.defineProperty(this,"d3Nodes",{get:function(){return this._d3Root.selectAll(".dude-graph-block, .dude-graph-group")}.bind(this)}),Object.defineProperty(this,"d3Blocks",{get:function(){return this._d3Block.selectAll(".dude-graph-block")}.bind(this)}),Object.defineProperty(this,"d3Groups",{get:function(){return this._d3Groups.selectAll(".dude-graph-group")}.bind(this)}),Object.defineProperty(this,"d3Connections",{get:function(){return this._d3Connections.selectAll(".dude-graph-connection")}.bind(this)}),Object.defineProperty(this,"d3Selection",{get:function(){return this._d3Root.selectAll(".dude-graph-selected")}.bind(this)}),Object.defineProperty(this,"d3GroupedSelection",{get:function(){var e=[];return this.d3Selection.each(function(t){!function n(t){e.push(t),"group"===t.type&&_.forEach(t.children,function(e){n(e)})}(t)}),this._getD3NodesFromRendererNodes(e)}.bind(this)})},dudeGraph.Renderer.prototype=_.create(pandora.EventEmitter.prototype,{constructor:dudeGraph.Renderer}),dudeGraph.Renderer.prototype.addBlockType=function(e,t){void 0!==t.rendererBlockCreator&&(this._rendererBlockCreators[e]=t.rendererBlockCreator),void 0!==t.rendererBlockUpdater&&(this._rendererBlockUpdaters[e]=t.rendererBlockUpdater),void 0!==t.pointPositionGetter&&(this._pointPositionGetters[e]=t.pointPositionGetter),this._cgGraph.loader.addBlockType(e,t)},dudeGraph.Renderer.prototype.initialize=function(){this._initialize(),this._createSelectionBehavior(),this._createZoomBehavior(),this._createD3Blocks(),this._createD3Connections(),this._createD3Groups()},dudeGraph.Renderer.prototype.createRendererGroupFromSelection=function(e){var t=this,n=this.d3Selection.data(),r=this._createRendererGroup({id:dudeGraph.UUID.generate(),description:e});return _.forEach(n,function(e){t._removeRendererNodeParent(e),t._addRendererNodeParent(e,r)}),this._createD3Groups(),this._updateD3Groups(),r},dudeGraph.Renderer.prototype.createRendererBlock=function(e){var t=this,n=t._createRendererBlock({id:dudeGraph.UUID.generate(),cgBlock:e.cgId,position:[100,100],size:[100,100]});t._createD3Blocks();var r=t._getD3NodesFromRendererNodes([n]);return t._rendererBlockDragPositionBehavior(r),n},dudeGraph.Renderer.prototype.removeSelection=function(){var e=this;_.forEach(this.d3Selection.data(),function(t){e._removeRendererNode(t)}),this._clearSelection(),this._removeD3Blocks(),this._removeD3Groups(),this._removeD3Connections(),this._updateD3Nodes()},dudeGraph.Renderer.prototype.zoomToFit=function(){this._zoomToFit()},dudeGraph.Renderer.prototype._dragRendererNodeBehavior=function(){var e=this;return d3.behavior.drag().on("dragstart",function(){d3.event.sourceEvent.preventDefault(),d3.event.sourceEvent.stopPropagation(),e._addToSelection(d3.select(this),!d3.event.sourceEvent.shiftKey),e._d3MoveToFront(e.d3GroupedSelection)}).on("drag",function(){var t=e.d3GroupedSelection;t.each(function(e){e.position[0]+=d3.event.dx,e.position[1]+=d3.event.dy}),e._updateSelectedD3Nodes(t),e.d3Nodes.classed("dude-graph-active",!1);var n=e._getNearestRendererGroup(d3.select(this).datum());n&&e._getD3NodesFromRendererNodes([n]).classed("dude-graph-active",!0)}).on("dragend",function(){e.d3Nodes.classed("dude-graph-active",!1);var t=e.d3Selection,n=e._getNearestRendererGroup(d3.select(this).datum());n&&t.each(function(t){e._addRendererNodeParent(t,n)}),e._updateSelectedD3Nodes(t)})},dudeGraph.Renderer.prototype._removeRendererNodeFromParentBehavior=function(){var e=this;return d3.behavior.doubleClick().on("dblclick",function(){var t=d3.select(this),n=t.datum(),r=n.parent;r&&(d3.event.sourceEvent.preventDefault(),d3.event.sourceEvent.stopPropagation(),e._removeRendererNodeParent(n),e._updateSelectedD3Nodes(e.d3Nodes))})},dudeGraph.Renderer.prototype._rendererBlockDragPositionBehavior=function(e){var t=this,n=".placement-behavior",r=function(){t._d3Svg.on("mousemove"+n,null),t._d3Svg.on("mousedown"+n,null),t.d3Blocks.classed("dude-graph-non-clickable",!1),t.d3Groups.classed("dude-graph-non-clickable",!1)};r(),this.d3Blocks.classed("dude-graph-non-clickable",!0),this.d3Groups.classed("dude-graph-non-clickable",!0),this._d3Svg.on("mousemove"+n,function(){e.datum().position=t._getRelativePosition(d3.mouse(this)),t._updateSelectedD3Nodes(e)}),this._d3Svg.on("mousedown"+n,function(){d3.event.preventDefault(),d3.event.stopPropagation(),e.datum().position=t._getRelativePosition(d3.mouse(this)),t._updateSelectedD3Nodes(e),r()})},dudeGraph.Renderer.prototype._removeRendererConnectionBehavior=function(){var e=this;return d3.behavior.mousedown().on("mousedown",function(t){d3.event.sourceEvent.altKey&&(d3.event.sourceEvent.preventDefault(),d3.event.sourceEvent.stopImmediatePropagation(),e._removeRendererPointRendererConnections(t),e._removeD3Connections(),e._updateD3Blocks())})},dudeGraph.Renderer.prototype._dragRendererConnectionBehavior=function(){var e=this,t=null,n=function(t){var n=e._getRendererPointPosition(t,!1);return t.isOutput?e._computeConnectionPath(n,d3.mouse(this)):e._computeConnectionPath(d3.mouse(this),n)};return d3.behavior.drag().on("dragstart",function(r){d3.event.sourceEvent.preventDefault(),d3.event.sourceEvent.stopPropagation(),t=e._d3Connections.append("svg:path").classed("dude-graph-connection",!0).classed("dude-graph-stream",function(){return"Stream"===r.cgPoint.pointType}).attr("d",function(){return n.call(this,r)})}).on("drag",function(e){t.attr("d",function(){return n.call(this,e)})}).on("dragend",function(n){var r=d3.mouse(e._d3Root.node()),o=e._getNearestRendererPoint(r);if(o&&n!==o)try{n.isOutput?e._createRendererConnection({outputRendererPoint:n,inputRendererPoint:o}):e._createRendererConnection({outputRendererPoint:o,inputRendererPoint:n}),e._createD3Connections(),e._updateD3Blocks()}catch(i){e.emit("error",i)}else e.emit("warning","Renderer::_createD3PointShapes() No point found for creating connection");t.remove()})},dudeGraph.Renderer.prototype._createSelectionBehavior=function(){var e=this,t=null;this._d3Svg.call(d3.behavior.drag().on("dragstart",function(){d3.event.sourceEvent.shiftKey?(d3.event.sourceEvent.stopImmediatePropagation(),t=e._d3Svg.append("svg:rect").classed("dude-graph-selection",!0).datum(d3.mouse(this))):e._clearSelection()}).on("drag",function(){if(t){var e=d3.mouse(this);t.attr({x:function(t){return Math.min(t[0],e[0])},y:function(t){return Math.min(t[1],e[1])},width:function(t){return Math.max(e[0]-t[0],t[0]-e[0])},height:function(t){return Math.max(e[1]-t[1],t[1]-e[1])}})}}).on("dragend",function(){if(t){var n=e._getRelativePosition([parseInt(t.attr("x")),parseInt(t.attr("y"))]),r=e._getRelativePosition([parseInt(t.attr("x"))+parseInt(t.attr("width")),parseInt(t.attr("y"))+parseInt(t.attr("height"))]),o=e._getNearestRendererBlocks(n[0],n[1],r[0],r[1]);o.length>0?e._addToSelection(e._getD3NodesFromRendererNodes(o),!0):e._clearSelection(),t.remove(),t=null}}))},dudeGraph.Renderer.prototype._addToSelection=function(e,t){t&&this._clearSelection(!0),e.classed("dude-graph-selected",!0),this.emit("cg-select",e.data()[e.data().length-1])},dudeGraph.Renderer.prototype._clearSelection=function(e){this.d3Selection.classed("dude-graph-selected",!1),e||this.emit("cg-unselect")},dudeGraph.Renderer.prototype._createZoomBehavior=function(){var e=this;this._zoom=d3.behavior.zoom().scaleExtent([this._config.zoom.min,this._config.zoom.max]).on("zoom",function(){d3.event.sourceEvent&&d3.event.sourceEvent.preventDefault(),e._d3Root.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")"),e._config.zoom.translate=e._zoom.translate(),e._config.zoom.scale=e._zoom.scale()}.bind(this)),this._d3Svg.call(this._zoom),this._d3Svg.transition().duration(this._config.zoom.transitionSpeed).call(this._zoom.translate(this._config.zoom.translate).scale(this._config.zoom.scale).event)},dudeGraph.Renderer.prototype._zoomToFit=function(){var e=this._d3Svg.node().getBoundingClientRect(),t=this._getBBox(this._d3Root.node()),n=this._zoom.scaleExtent(),r=t.width-t.x,o=t.height-t.y,i=(t.x+t.width)/2,a=(t.y+t.height)/2,c=dudeGraph.Math.clamp(.9/Math.max(r/e.width,o/e.height),n[0],n[1]),d=[e.width/2-c*i,e.height/2-c*a];this._d3Svg.transition().duration(this._config.zoom.transitionSpeed).call(this._zoom.translate(d).scale(c).event)},dudeGraph.Renderer.prototype._initialize=function(){this._initializeRendererBlocks(),this._initializeRendererConnections(),this._initializeRendererGroups(),this._initializeRendererGroupParents(),this._initializeListeners()},dudeGraph.Renderer.prototype._initializeRendererBlocks=function(){var e=this;_.forEach(this._data.blocks,function(t){e._createRendererBlock(t)})},dudeGraph.Renderer.prototype._initializeRendererConnections=function(){var e=this;_.forEach(this._data.connections,function(t){var n=e._cgGraph.cgConnections[t.cgConnectionIndex];if(!n)throw new Error("Connection at index `"+t.cgConnectionIndex+"` does not exists");var r=e._getRendererBlockById(t.outputRendererBlockId),o=e._getRendererBlockById(t.inputRendererBlockId);if(!r)throw new Error("Connection at index `"+t.cgConnectionIndex+"`: Cannot find outputRendererBlock `"+t.outputRendererBlockId+"`");if(!o)throw new Error("Connection at index `"+t.cgConnectionIndex+"`: Cannot find inputRendererBlock `"+t.inputRendererBlockId+"`");if(r.cgBlock!==n.cgOutputPoint.cgBlock)throw new Error("Connection at index `"+t.cgConnectionIndex+"`: OutputRendererBlock `"+r.id+"` is not holding a reference to the outputCgBlock `"+n.cgOutputPoint.cgBlock.cgId+"`");if(o.cgBlock!==n.cgInputPoint.cgBlock)throw new Error("Connection at index `"+t.cgConnectionIndex+"`: InputRendererBlock `"+o.id+"` is not holding a reference to the inputCgBlock `"+n.cgInputPoint.cgBlock.cgId+"`");var i=e._getRendererPointByName(r,n.cgOutputPoint.cgName),a=e._getRendererPointByName(o,n.cgInputPoint.cgName);if(!i)throw new Error("Connection at index `"+t.cgConnectionIndex+"`: Cannot find outputRendererPoint `"+n.cgOutputPoint.cgName+"`");if(!a)throw new Error("Connection at index `"+t.cgConnectionIndex+"`: Cannot find inputRendererPoint `"+n.cgInputPoint.cgName+"`");e._createRendererConnection({cgConnection:n,outputRendererPoint:i,inputRendererPoint:a},!0)})},dudeGraph.Renderer.prototype._initializeRendererGroups=function(){var e=this;_.forEach(this._data.groups,function(t){e._createRendererGroup(t)})},dudeGraph.Renderer.prototype._initializeRendererGroupParents=function(){var e=this;_.forEach(this._data.blocks,function(t){var n=e._getRendererBlockById(t.id);if(t.parent){var r=e._getRendererGroupById(t.parent);if(!r)throw new Error("Cannot find rendererBlock parent id `"+t.parent+"`");e._addRendererNodeParent(n,r)}}),_.forEach(this._data.groups,function(t){var n=e._getRendererGroupById(t.id);if(t.parent){var r=e._getRendererGroupById(t.parent);if(!r)throw new Error("Cannot find rendererGroup parent id `"+t.parent+"`");e._addRendererNodeParent(n,r)}})},dudeGraph.Renderer.prototype._initializeListeners=function(){var e=this;this._cgGraph.on("dude-graph-block-create",function(t){e.createRendererBlock(t)}),this._cgGraph.on("dude-graph-block-remove",function(){e._removeD3Blocks()}),this._cgGraph.on("dude-graph-block-name-change",function(t){e._updateSelectedD3Nodes(e._getD3NodesFromRendererNodes(e._getRendererBlocksByCgBlock(t)))}),this.on("dude-graph-renderer-group-description-change",function(t){e._updateSelectedD3Nodes(e._getD3NodesFromRendererNodes([t]))}),this._cgGraph.on("cg-point-value-change",function(t){e._updateSelectedD3Nodes(e._getD3NodesFromRendererNodes(e._getRendererBlocksByCgBlock(t._cgBlock)))})},dudeGraph.Renderer.prototype._getRendererBlockById=function(e){return this._rendererBlockIds.get(e)||null},dudeGraph.Renderer.prototype._getRendererBlocksByCgBlock=function(e){var t=[];return _.forEach(this._rendererBlocks,function(n){n.cgBlock===e&&t.push(n)}),t},dudeGraph.Renderer.prototype._createRendererBlock=function(e){if(!e.id)throw new Error("Cannot create a rendererBlock without an id");if(null!==this._getRendererBlockById(e.id))throw new Error("Multiple rendererBlocks for id `"+e.id+"`");var t=this._cgGraph.blockById(e.cgBlock);if(!t)throw new Error("Cannot link cgBlock `"+e.cgBlock+"` to rendererBlock `"+e.id+"`");var n=_.merge({},e);return n.type="block",n.parent=null,n.cgBlock=t,n.id=e.id,n.rendererPoints=[],n.position=e.position||[0,0],n.size=e.size||this._config.block.size,this._createRendererPoints(n),this._rendererBlocks.push(n),this._rendererBlockIds.set(n.id,n),n},dudeGraph.Renderer.prototype._removeRendererBlock=function(e){var t=this,n=this._rendererBlocks.indexOf(e);if(-1===n)throw new Error("Cannot find rendererBlock `"+e.id+"`");_.forEach(e.rendererPoints,function(e){t._removeRendererPointRendererConnections(e)}),this._removeRendererNodeParent(e),this._rendererBlocks.splice(n,1),0===this._getRendererBlocksByCgBlock(e.cgBlock).length&&this._cgGraph.removeBlock(e.cgBlock)},dudeGraph.Renderer.prototype._createRendererConnection=function(e,t){var n=e.outputRendererPoint||this._getRendererPointByName(this._getRendererBlockById(e.outputBlockId),e.outputName),r=e.inputRendererPoint||this._getRendererPointByName(this._getRendererBlockById(e.inputBlockId),e.inputName),o=e.cgConnection;if(!n)throw new Error("Cannot find the outputRendererPoint");if(!r)throw new Error("Cannot find the inputRendererPoint");if(t?_.forEach(this._rendererConnections,function(e){if(e.cgConnection===o)throw new Error("Connections `"+o+"` is already handled in the renderer by the rendererConnection `"+e+"`")}):o=n.cgPoint.connect(r.cgPoint),!o)throw new Error("Cannot create a rendererConnection without a cgConnection");var i={cgConnection:o,outputRendererPoint:n,inputRendererPoint:r};this._rendererConnections.push(i)},dudeGraph.Renderer.prototype._removeRendererConnection=function(e){var t=this._rendererConnections.indexOf(e);if(-1===t)throw new Error("Connection not found");e.outputRendererPoint.cgPoint.disconnect(e.inputRendererPoint.cgPoint),this._rendererConnections.splice(t,1)},dudeGraph.Renderer.prototype._getRendererGroupById=function(e){return this._rendererGroupIds.get(e)||null},dudeGraph.Renderer.prototype._createRendererGroup=function(e){var t=this;if(!e.id)throw new Error("Cannot create a rendererGroup without an id");if(this._getRendererGroupById(e.id))throw new Error("Duplicate rendererGroup for id `"+e.id+"`");var n=_.merge({},e);return n.type="group",n.id=e.id,n.parent=null,n.children=[],n.position=e.position||[0,0],n.size=e.size||this._config.group.size,n._cgDescription=n.description,Object.defineProperty(n,"description",{set:function(e){this._cgDescription=e,t.emit("dude-graph-renderer-group-description-change",this)},get:function(){return this._cgDescription}}),this._rendererGroups.push(n),this._rendererGroupIds.set(n.id,n),n},dudeGraph.Renderer.prototype._removeRendererGroup=function(e){var t=this._rendererGroups.indexOf(e);if(-1===t)throw new Error("RendererGroup not found and thus cannot be removed");this._removeRendererNodeParent(e),this._rendererGroups.splice(t,1)},dudeGraph.Renderer.prototype._removeRendererNode=function(e){"block"===e.type?this._removeRendererBlock(e):this._removeRendererGroup(e)},dudeGraph.Renderer.prototype._getRendererNodeParents=function(e){for(var t=[],n=e.parent;n;)t.push(n),n=n.parent;return t},dudeGraph.Renderer.prototype._addRendererNodeParent=function(e,t){e.parent!==t&&(!function n(r){if(r===e)throw new Error("Cannot add `"+e.id+"` as a child of `"+t.id+"`, because `"+e.id+"` is equal or is a parent of `"+t.id+"`");r.parent&&n(r.parent)}(t),this._removeRendererNodeParent(e),t.children.push(e),e.parent=t)},dudeGraph.Renderer.prototype._removeRendererNodeParent=function(e){e.parent&&(e.parent.children.splice(e.parent.children.indexOf(e),1),e.parent=null)},dudeGraph.Renderer.prototype._getRendererPointByName=function(e,t){return _.find(e.rendererPoints,function(e){return e.cgPoint.cgName===t})},dudeGraph.Renderer.prototype._createRendererPoints=function(e){e.rendererPoints=[],_.forEach(e.cgBlock.cgOutputs,function(t){e.rendererPoints.push({type:"point",rendererBlock:e,index:e.cgBlock.cgOutputs.indexOf(t),cgPoint:t,isOutput:!0})}),_.forEach(e.cgBlock.cgInputs,function(t){e.rendererPoints.push({type:"point",rendererBlock:e,index:e.cgBlock.cgInputs.indexOf(t),cgPoint:t,isOutput:!1})})},dudeGraph.Renderer.prototype._getRendererPointRendererConnections=function(e){var t=[];return _.forEach(this._rendererConnections,function(n){(n.outputRendererPoint===e||n.inputRendererPoint===e)&&t.push(n)}),t},dudeGraph.Renderer.prototype._removeRendererPointRendererConnections=function(e){var t=this,n=t._getRendererPointRendererConnections(e);_.forEach(n,function(e){t._removeRendererConnection(e)})},dudeGraph.Renderer.prototype._createD3Points=function(e){var t=this,n=e.selectAll(".dude-graph-output, .dude-graph-input").data(function(e){return e.rendererPoints},function(e){return e.cgPoint.cgName}).enter().append("svg:g").attr("class",function(e){return e.isOutput?"dude-graph-output":"dude-graph-input"}).each(function(){t._createD3PointShapes(d3.select(this))});n.append("svg:text").attr("alignment-baseline","middle").attr("text-anchor",function(e){return e.isOutput?"end":"start"}).text(function(e){return e.cgPoint.cgName}),this._updateSelectedD3Points(n)},dudeGraph.Renderer.prototype._updateSelectedD3Points=function(e){var t=this;e.classed("dude-graph-empty",function(e){return e.cgPoint.empty()}).classed("dude-graph-stream",function(e){return"Stream"===e.cgPoint.pointType}).attr("transform",function(e){return"translate("+t._getRendererPointPosition(e,!0)+")"}),e.select("text").attr("transform",function(e){return e.isOutput?"translate("+[2*-t._config.point.radius-t._config.block.padding]+")":"translate("+[2*t._config.point.radius+t._config.block.padding]+")"})},dudeGraph.Renderer.prototype._createD3PointShapes=function(e){var t=this;e.selectAll(".cg-point-shape").data(e.data(),function(e){return e.cgPoint.cgName}).enter().append("svg:path").classed("cg-point-shape",!0).attr("d",function(e){var n=t._config.point.radius;return"Stream"===e.cgPoint.pointType?"M "+-n+" "+1.5*-n+" L "+-n+" "+1.5*n+" L "+n+" 0 Z":"M 0,0m "+-n+", 0a "+[n,n]+" 0 1,0 "+2*n+",0a "+[n,n]+" 0 1,0 "+-(2*n)+",0"}).call(t._removeRendererConnectionBehavior()).call(t._dragRendererConnectionBehavior())},dudeGraph.Renderer.prototype._createD3Blocks=function(){var e=this;this.d3Blocks.data(this._rendererBlocks,function(t){var n=Math.max(t.cgBlock.cgInputs.length,t.cgBlock.cgOutputs.length);return t.size=[e._config.block.size[0],n*e._config.point.height+e._config.block.header],t.id}).enter().append("svg:g").attr("id",function(t){return e._getRendererNodeUniqueID(t)}).classed("dude-graph-block",!0).call(this._dragRendererNodeBehavior()).call(this._removeRendererNodeFromParentBehavior()).each(function(t){d3.select(this).classed("cg-"+_.kebabCase(t.cgBlock.blockType),!0);var n=e._rendererBlockCreators[t.cgBlock.blockType];void 0!==n?n.call(this,e):e._defaultBlockCreator.call(this,e)}),this._updateD3Blocks()},dudeGraph.Renderer.prototype._defaultBlockCreator=function(e){var t=d3.select(this);t.append("svg:rect").attr("rx",function(){return e._config.block.borderRadius||0}).attr("ry",function(){return e._config.block.borderRadius||0}),t.append("svg:text").classed("dude-graph-title",!0).attr("text-anchor","middle").attr("dominant-baseline","text-before-edge"),t.append("svg:g").classed("cg-points",!0),e._createD3Points(t.select(".cg-points"))},dudeGraph.Renderer.prototype._updateD3Blocks=function(){this._updateSelectedD3Blocks(this.d3Blocks)},dudeGraph.Renderer.prototype._updateSelectedD3Blocks=function(e){var t=this;e.each(function(e){var n=t._rendererBlockUpdaters[e.cgBlock.blockType];void 0!==n?n.call(this,t):t._defaultBlockUpdater.call(this,t)})},dudeGraph.Renderer.prototype._defaultBlockUpdater=function(e){var t=d3.select(this);t.select("text").text(function(e){return e.cgBlock.cgName}),t.each(function(t){e._computeRendererBlockSize(t)}),t.attr("transform",function(e){return"translate("+e.position+")"}),t.select("rect").attr("width",function(e){return e.size[0]}).attr("height",function(e){return e.size[1]}),t.select("text").attr("transform",function(t){return"translate("+[t.size[0]/2,e._config.block.padding]+")"}),e._updateSelectedD3Points(t.select(".cg-points").selectAll(".dude-graph-output, .dude-graph-input"))},dudeGraph.Renderer.prototype._removeD3Blocks=function(){this.d3Blocks.data(this._rendererBlocks,function(e){return e.id}).exit().remove()},dudeGraph.Renderer.prototype._createD3Connections=function(){var e=this.d3Connections.data(this._rendererConnections,function(e){return e?e.outputRendererPoint.rendererBlock.id+":"+e.outputRendererPoint.cgPoint.cgName+","+e.inputRendererPoint.rendererBlock.id+":"+e.inputRendererPoint.cgPoint.cgName:void 0}).enter().append("svg:path").classed("dude-graph-connection",!0).classed("dude-graph-stream",function(e){return"Stream"===e.inputRendererPoint.cgPoint.pointType});this._updateSelectedD3Connections(e)},dudeGraph.Renderer.prototype._updateD3Connections=function(){this._updateSelectedD3Connections(this.d3Connections)},dudeGraph.Renderer.prototype._updateSelectedD3Connections=function(e){var t=this;e.attr("d",function(e){var n=this._getRendererPointPosition(e.outputRendererPoint,!1),r=this._getRendererPointPosition(e.inputRendererPoint,!1);return t._computeConnectionPath(n,r)}.bind(this))},dudeGraph.Renderer.prototype._removeD3Connections=function(){this.d3Connections.data(this._rendererConnections,function(e){return e?e.outputRendererPoint.rendererBlock.id+":"+e.outputRendererPoint.cgPoint.cgName+","+e.inputRendererPoint.rendererBlock.id+":"+e.inputRendererPoint.cgPoint.cgName:void 0}).exit().remove()},dudeGraph.Renderer.prototype._createD3Groups=function(){var e=this.d3Groups.data(this._rendererGroups,function(e){return e.id}).enter().append("svg:g").attr("id",function(e){return this._getRendererNodeUniqueID(e)}.bind(this)).attr("class","dude-graph-group").call(this._dragRendererNodeBehavior()).call(this._removeRendererNodeFromParentBehavior());e.append("svg:rect").attr("rx",this._config.group.borderRadius||0).attr("ry",this._config.group.borderRadius||0),e.append("svg:text").attr("class","dude-graph-title").attr("text-anchor","middle").attr("dominant-baseline","text-before-edge"),this._updateD3Groups()},dudeGraph.Renderer.prototype._updateD3Groups=function(){this._updateSelectedD3Groups(this.d3Groups)},dudeGraph.Renderer.prototype._updateSelectedD3Groups=function(e){var t=this;e.select("text").text(function(e){return e.description}),e.each(function(e){t._computeRendererGroupPositionAndSize(e)}),e.attr("transform",function(e){return"translate("+e.position+")"}),e.select("rect").attr("width",function(e){return e.size[0]}).attr("height",function(e){return e.size[1]}),e.select("text").attr("transform",function(e){return"translate("+[e.size[0]/2,t._config.group.padding]+")"})},dudeGraph.Renderer.prototype._removeD3Groups=function(){this.d3Groups.data(this._rendererGroups,function(e){return e.id}).exit().remove()},dudeGraph.Renderer.prototype._updateD3Nodes=function(){this._updateD3Blocks(),this._updateD3Groups(),this._updateD3Connections()},dudeGraph.Renderer.prototype._updateSelectedD3Nodes=function(e){var t=this,n=[],r=[],o=[];e.each(function(e){o=o.concat(t._getRendererNodeParents(e)),"block"===e.type?n.push(e):"group"===e.type&&r.push(e)}),n.length>0&&this._updateSelectedD3Blocks(this._getD3NodesFromRendererNodes(n)),r.length>0&&this._updateSelectedD3Groups(this._getD3NodesFromRendererNodes(r)),o.length>0&&this._updateSelectedD3Groups(this._getD3NodesFromRendererNodes(o)),this._updateD3Connections()},dudeGraph.Renderer.prototype._createRendererBlocksCollisions=function(){this._rendererBlocksQuadtree=d3.geom.quadtree().x(function(e){return e.position[0]}).y(function(e){return e.position[1]})(this._rendererBlocks)},dudeGraph.Renderer.prototype._createRendererGroupsCollisions=function(){this._rendererGroupsQuadtree=d3.geom.quadtree().x(function(e){return e.position[0]}).y(function(e){return e.position[1]})(this._rendererGroups)},dudeGraph.Renderer.prototype._createRendererPointsCollisions=function(){var e=this,t=[];_.forEach(this._rendererBlocks,function(e){t=t.concat(e.rendererPoints)}),this._rendererPointsQuadtree=d3.geom.quadtree().x(function(t){return e._getRendererPointPosition(t)[0]}).y(function(t){return e._getRendererPointPosition(t)[1]})(t)},dudeGraph.Renderer.prototype._getNearestRendererBlocks=function(e,t,n,r){this._createRendererBlocksCollisions();var o=[];return this._rendererBlocksQuadtree.visit(function(i,a,c,d,u){var s=i.point;if(s){var p=[s.position[0],s.position[1],s.position[0]+s.size[0],s.position[1]+s.size[1]];e>p[2]||t>p[3]||n<p[0]||r<p[1]||o.push(s)}return a-50>=n||c-35>=r||e>d+50||t>u+35}),o},dudeGraph.Renderer.prototype._getNearestRendererGroup=function(e){this._createRendererGroupsCollisions();var t=[],n=e.position[0],r=e.position[1],o=e.position[0]+e.size[0],i=e.position[1]+e.size[1];this._rendererGroupsQuadtree.visit(function(a,c,d,u,s){var p=a.point;if(p&&p!==e){var h=[p.position[0],p.position[1],p.position[0]+p.size[0],p.position[1]+p.size[1]];n>h[0]&&r>h[1]&&o<h[2]&&i<h[3]&&t.push(p)}return!1});var a=null;return _.forEach(t,function(t){return e.parent&&t===e.parent?(a=t,!1):void(null===a?a=t:t.size[0]<a.size[0]&&t.size[1]<a.size[1]&&(a=t))}),a},dudeGraph.Renderer.prototype._getNearestRendererPoint=function(e){this._createRendererPointsCollisions();var t=this._rendererPointsQuadtree.find(e);if(t){var n=this._getRendererPointPosition(t);if(n[0]>e[0]-this._config.point.height&&n[0]<e[0]+this._config.point.height&&n[1]>e[1]-this._config.point.height&&n[1]<e[1]+this._config.point.height)return t}return null},d3.behavior.mousedown=function(){function e(e){e.each(function(e){function n(){r({type:"mousedown"})}var r=t.of(this,arguments);d3.select(this).on("mousedown",n)})}var t=d3_eventDispatch(e,"mousedown");return d3.rebind(e,t,"on")},d3.behavior.doubleClick=function(){function e(e){e.each(function(e){function n(){r({type:"dblclick"})}var r=t.of(this,arguments);d3.select(this).on("dblclick",n)})}var t=d3_eventDispatch(e,"dblclick");return d3.rebind(e,t,"on")},dudeGraph.Renderer.prototype._getBBox=function(e){var t={x:0,y:0,width:0,height:0};try{var n=e.getBBox();t={x:n.x,y:n.y,width:n.width,height:n.height}}catch(r){var o=e.getBoundingClientRect();t={x:o.left,y:o.top,width:o.right-o.left,height:o.bottom-o.top}}return t},dudeGraph.Renderer.prototype._getTextBBox=function(e){var t=this._getBBox(e);return 0===t.width&&0===t.height&&(t.width=8*e.textContent.length,t.height=24),t},dudeGraph.Renderer.prototype._getAbsolutePosition=function(e){this._svgPoint.x=e[0],this._svgPoint.y=e[1];var t=this._svgPoint.matrixTransform(this._d3Root.node().getCTM().inverse());return[t.x,t.y]},dudeGraph.Renderer.prototype._getRelativePosition=function(e){this._svgPoint.x=e[0],this._svgPoint.y=e[1];var t=this._svgPoint.matrixTransform(this._d3Root.node().getScreenCTM().inverse());return[t.x,t.y]},dudeGraph.Renderer.prototype._getRendererNodesBoundingBox=function(e){var t=null,n=null;return _.forEach(e,function(e){null===t&&(t=[e.position[0],e.position[1]]),null===n&&(n=[t[0]+e.size[0],t[1]+e.size[1]]),t[0]=Math.min(t[0],e.position[0]),t[1]=Math.min(t[1],e.position[1]),n[0]=Math.max(n[0],e.position[0]+e.size[0]),n[1]=Math.max(n[1],e.position[1]+e.size[1])}),[t,n]},dudeGraph.Renderer.prototype._computeRendererBlockSize=function(e){var t=this,n=this._getD3NodesFromRendererNodes([e]),r=t._getTextBBox(n.select("text").node()),o=n.select(".cg-points").selectAll(".dude-graph-output, .dude-graph-input"),i=0,a=0;e.size[0]=Math.max(e.size[0],r.width+2*this._config.block.padding),o.each(function(e){var n=d3.select(this),r=t._getTextBBox(n.select("text").node());e.isOutput?i=Math.max(i,r.width):a=Math.max(a,r.width)}),e.size[0]=Math.max(e.size[0],i+a+4*this._config.block.padding+2*this._config.point.radius+this._config.point.offset)},dudeGraph.Renderer.prototype._computeRendererGroupPositionAndSize=function(e){var t=this;if(e.children.length>0){var n=t._getRendererNodesBoundingBox(e.children);e.position=[n[0][0]-t._config.group.padding,n[0][1]-t._config.group.padding-t._config.group.header],e.size=[n[1][0]-n[0][0]+2*t._config.group.padding,n[1][1]-n[0][1]+2*t._config.group.padding+t._config.group.header]}e.size=[Math.max(e.size[0],t._config.group.size[0]+2*t._config.group.padding),Math.max(e.size[1],t._config.group.size[1]+2*t._config.group.padding+t._config.group.header)];var r=this._getD3NodesFromRendererNodes([e]);e.size[0]=Math.max(e.size[0],this._getBBox(r.select("text").node()).width+2*t._config.group.padding),function o(e){e&&(t._computeRendererGroupPositionAndSize(e),o(e.parent))}(e.parent)},dudeGraph.Renderer.prototype._getRendererPointPosition=function(e,t){var n=t?0:e.rendererBlock.position[0],r=t?0:e.rendererBlock.position[1],o=this._pointPositionGetters[e.rendererBlock.cgBlock.blockType];
return o?o.call(this,e,n,r):e.isOutput?[n+e.rendererBlock.size[0]-this._config.block.padding,r+this._config.block.header+this._config.point.height*e.index]:[n+this._config.block.padding,r+this._config.block.header+this._config.point.height*e.index]},dudeGraph.Renderer.prototype._computeConnectionPath=function(e,t){var n=150;return e[0]-t[0]<0&&(n+=Math.max(-100,e[0]-t[0])),pandora.formatString("M{x},{y}C{x1},{y1} {x2},{y2} {x3},{y3}",{x:e[0],y:e[1],x1:e[0]+n,y1:e[1],x2:t[0]-n,y2:t[1],x3:t[0],y3:t[1]})},dudeGraph.Renderer.prototype._getRendererNodeUniqueID=function(e,t){return pandora.formatString("{0}cg-{1}-{2}",t?"#":"",e.type,e.id)},dudeGraph.Renderer.prototype._getD3NodesFromRendererNodes=function(e){var t=d3.set();return _.forEach(e,function(e){t.add(this._getRendererNodeUniqueID(e,!0))}.bind(this)),this._d3Root.selectAll(t.values().join(", "))},dudeGraph.Renderer.prototype._d3MoveToFront=function(e){return e.each(function(){this.parentNode.appendChild(this)})};