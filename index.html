<!doctype html>
<html>
<head>
    <title>CodeGraph</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../webcomponentsjs/webcomponents.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Indie+Flower' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Varela+Round' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Varela' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Cherry+Cream+Soda' rel='stylesheet' type='text/css'>
    <link rel="import" href="../core-drawer-panel/core-drawer-panel.html">
    <link rel="import" href="../core-header-panel/core-header-panel.html">
    <link rel="import" href="../core-toolbar/core-toolbar.html">
    <link rel="import" href="../core-ajax/core-ajax.html">
    <link rel="import" href="../paper-dialog/paper-dialog.html">
    <link rel="import" href="audigame-preview.html">
    <link rel="import" href="cg-app.html">
    <link rel="stylesheet" href="themes/base.css" shim-shadowdom>
    <link rel="stylesheet" href="themes/dude/theme.css" shim-shadowdom>
    <style>
        html /deep/ #previewDialog {
            background: #222222;
            border-radius: 10px;
        }
        html /deep/ #homeButton {
            margin-top: 10px;
        }
        body {
            background: #111111;
        }
        .dude-panel {
            margin: 5px;
            background: #2b2b2b;
        }
    </style>
</head>
<body fullbleed unresolved>
    <template id="codegraph-demo" is="auto-binding">
        <core-drawer-panel forceNarrow>
            <core-header-panel main>
                <!--<core-toolbar>-->
                    <!--<paper-icon-button id="menu-btn" icon="menu" core-drawer-toggle></paper-icon-button>-->
                    <!--<div id="title" flex><img height="20" src="images/audigame_logo.png"></div>-->
                    <!--<paper-button class="dark" on-click="{{save}}">Save</paper-button>-->
                <!--</core-toolbar>-->
                    <core-ajax id="loader"
                               url="examples/audigame_tutorial.json"
                               handleAs="json"
                               on-core-response="{{graphLoaded}}"
                               auto>
                    </core-ajax>
                    <div layout horizontal fit style="margin: 5px">
                        <cg-app class="dude-panel" flex id="codegraph" logo="images/dude_logo_dark.png"
                                layout horizontal>
                        </cg-app>
                        <div class="dude-panel" flex>
                            PREVIEW
                        </div>
                    </div>
                    <paper-dialog id="previewDialog"
                                  backdrop
                                  transition="core-transition-top"
                                  autoCloseDisabled>
                        <audigame-preview id="preview"></audigame-preview>
                        <paper-button id="homeButton" class="primary full" on-click="{{quitPreview}}">Back to editor</paper-button>
                    </paper-dialog>
            </core-header-panel>
            <div drawer>
                <core-menu selected="2">
                    <core-item label="Dashboard" icon="dashboard"></core-item>
                    <core-item label="Shop" icon="shopping-cart"></core-item>
                    <core-item label="Editor" icon="create"></core-item>
                    <core-item label="Get the app!" icon="android"></core-item>
                    <core-item label="Contact" icon="send"></core-item>
                </core-menu>
            </div>
        </core-drawer-panel>
    </template>
    <script src="../d3/d3.js"></script>
    <script src="../pandora/lib/pandora.js"></script>
    <script src="codegraph.js"></script>
    <script src="build-saver.js"></script>
    <script>
        var demo = document.querySelector("#codegraph-demo");
        var jsonSaver = new cg.JSONSaver();
        var buildSaver = new BuildSaver();
        demo.isLoading = true;
        demo.save = function () {
//            console.log(JSON.stringify(this.$.codegraph.save(buildSaver), null, 2));
//            console.log(JSON.stringify(this.$.codegraph.save(jsonSaver), null, 2));
//            console.log(this.$.codegraph.save(buildSaver));
            this.$.previewDialog.open();
//            this.$.preview.game = this.$.codegraph.save(buildSaver);
            this.$.preview.game = {
                "variables": {
                    "gameover.mp3": {
                        "type": "sound",
                        "value": {
                            "file_name": "audigame_assets/gameover.mp3"
                        }
                    },
                    "success.mp3": {
                        "type": "sound",
                        "value": {
                            "file_name": "audigame_assets/success.mp3"
                        }
                    },
                    "intro.mp3": {
                        "type": "sound",
                        "value": {
                            "file_name": "audigame_assets/intro.mp3"
                        }
                    },
                    "default time": {
                        "type": "number",
                        "value": 5
                    }
                },
                "story": {
                    "name": "step",
                    "sound": {
                        "type": "sound",
                        "name": "intro.mp3"
                    },
                    "duration": {
                        "type": "number",
                        "name": "default time"
                    },
                    "firstChoice": {
                        "name": "end",
                        "description": {
                            "type": "string",
                            "value": "I'm ready to write awesome stories!"
                        },
                        "sound": {
                            "type": "sound",
                            "name": "success.mp3"
                        }
                    },
                    "secondChoice": {
                        "name": "end",
                        "description": {
                            "type": "string",
                            "value": "I'm not ready at all, I'll gonna read the tutorial..."
                        },
                        "sound": {
                            "type": "sound",
                            "name": "gameover.mp3"
                        }
                    }
                }
            };
            this.$.preview.play();
        };
        demo.quitPreview = function () {
            this.$.preview.reset();
            this.$.previewDialog.opened = false;
        };
        demo.graphLoaded = function () {
            demo.isLoading = false;
            this.$.codegraph.graph = this.$.loader.response;
            this.$.codegraph.addEventListener("ready", function () {
                console.log("Code graph is ready! :)");
            }.bind(this));
            this.$.codegraph.addEventListener("variable.create", function (e) {
                if (this.createVariable(
                        e.detail.variable.data.valueType,
                        e.detail.variable.name,
                        e.detail.variable.data.value
                )) {
                    this.showSuccess("Variable \"" + e.detail.variable.name + "\" successfully created!");
                    this.resetPicker();
                }
            });
            this.$.codegraph.addEventListener("variable.edit", function (e) {
                if (this.editVariable(
                        e.detail.variable.previousName,
                        e.detail.variable.data.valueType,
                        e.detail.variable.name,
                        e.detail.variable.data.value
                )) {
                    this.showSuccess("Variable \"" + e.detail.variable.name + "\" successfully updated!");
                    this.resetPicker();
                }
            });
        };
    </script>
</body>
</html>