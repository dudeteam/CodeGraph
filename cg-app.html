<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-splitter/core-splitter.html">
<link rel="import" href="../core-icons/av-icons.html">
<link rel="import" href="../core-icons/image-icons.html">
<link rel="import" href="../core-dropdown-menu/core-dropdown-menu.html">
<link rel="import" href="../core-dropdown/core-dropdown.html">
<link rel="import" href="../core-collapse/core-collapse.html">
<link rel="import" href="../core-menu/core-menu.html">
<link rel="import" href="../core-item/core-item.html">
<link rel="import" href="../dude-gui/dude-panel.html">
<link rel="import" href="../dude-gui/dude-sidebar.html">
<link rel="import" href="../dude-gui/dude-toolbar.html">
<link rel="import" href="../dude-gui/dude-toolbar-command.html">
<link rel="import" href="../dude-gui/dude-toolbar-input.html">
<link rel="import" href="../dude-gui/dude-picker.html">
<link rel="import" href="../dude-gui/dude-dropdown.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-dropdown/paper-dropdown.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-dialog/paper-action-dialog.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../paper-input/paper-input-decorator.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="cg-renderer.html">
<link rel="import" href="cg-variable-inspector.html">
<link rel="import" href="cg-type-dropdown.html">
<polymer-element name="cg-app">
    <template>
        <style>
            #add-variable-btn {
                margin-bottom: 10px;
            }
        </style>
        <dude-panel id="panel"
                    name="story-editor"
                    config="{{config.panel}}"
                    on-dude-reset="{{_reset}}"
                    flex>
            <dude-toolbar id="toolbar">
                <div data-state="root" layout horizontal justified>
                    <template repeat="{{name in keys(_commands)}}">
                        <dude-toolbar-command name="{{name}}"
                                              label="{{_commands[name].label}}"
                                              icon="{{_commands[name].icon}}"
                                              on-dude-trigger="{{runCommand}}"
                                              disable="{{_commands[name].disabled}}">
                        </dude-toolbar-command>
                    </template>
                </div>
                <dude-toolbar-input name="createGroup"
                                    data-state="group"
                                    label="Group title"
                                    icon="check"
                                    on-dude-submit="{{runCommand}}">
                </dude-toolbar-input>
                <dude-toolbar-input name="editGroup"
                                    data-state="editGroup"
                                    label="Group title"
                                    icon="check"
                                    on-dude-submit="{{runCommand}}">
                </dude-toolbar-input>
                <dude-toolbar-input
                        id="createAction"
                        name="createAction"
                        value="{{_actionName}}"
                        data-state="action"
                        label="Search action..."
                        icon="check"
                        on-dude-submit="{{runCommand}}"
                        on-close="{{hideSidebar}}">
                </dude-toolbar-input>
                <dude-toolbar-input id="createProperty"
                                    name="createProperty"
                                    value="{{_propertyPattern}}"
                                    data-state="property"
                                    label="Type getter's name or value..."
                                    icon="check"
                                    on-dude-submit="{{runCommand}}"
                                    on-close="{{hideSidebar}}">
                </dude-toolbar-input>
                <dude-toolbar-input id="editProperty"
                                    name="editProperty"
                                    value="{{_propertyPattern}}"
                                    data-state="editProperty"
                                    label="Type getter's name or value..."
                                    icon="check"
                                    on-dude-submit="{{runCommand}}"
                                    on-close="{{hideSidebar}}">
                </dude-toolbar-input>
            </dude-toolbar>
            <dude-sidebar id="sidebar" noroot>
                <div data-state="action">
                    <template if="{{_actionList.length === 0}}">
                        <div>No results.</div>
                    </template>
                    <core-menu on-core-activate="{{selectAction}}">
                        <template repeat="{{action in _actionList}}">
                            <div class="search-result" name="{{action.name}}">
                                <core-icon class="type-filter-stroke type-stream" icon="check-box-outline-blank"></core-icon>
                                <span>{{action.name}}</span>
                            </div>
                        </template>
                    </core-menu>
                </div>
                <div data-state="property" id="property-panel">
                    <div id="property-header">
                        <paper-button on-click="{{_showCreateVariable}}"
                                      class="primary full"
                                      id="add-variable-btn">Add variable</paper-button>
                        <cg-type-dropdown type="{{_propertyType}}"
                                          types="{{_propertyTypes}}"
                                          on-change="{{_resetPropertyPattern}}"
                                          hidden?="{{_editMode}}">
                        </cg-type-dropdown>
                    </div>
                    <dude-picker id="pickerElement"
                                 type="{{_propertyType}}"
                                 pattern="{{_propertyPattern}}"
                                 noVariable>
                    </dude-picker>
                    <template if="{{_propertyList.length === 0}}">
                        <div class="search-not-found">No results.</div>
                    </template>
                    <core-menu id="searchList" on-core-activate="{{selectProperty}}">
                        <template repeat="{{prop in _propertyList}}">
                            <div class="search-result" name="{{prop.name}}">
                                <core-icon class="type-filter-stroke type-{{prop.data.valueType}}"
                                           icon="radio-button-off">
                                </core-icon>
                                <span>{{prop.name}}</span>
                            </div>
                        </template>
                    </core-menu>
                </div>
                <div data-state="editAction" style="position: relative">
                    <paper-icon-button on-click="{{_cancelAction}}"
                                       icon="close"
                                       style="position: absolute; left: 0">
                    </paper-icon-button>
                    <h1 style="padding-top: 20px">{{_currentAction.name}}</h1>
                    <p>{{_currentAction.data.description}}</p>
                </div>
                <cg-variable-inspector data-state="editVariable"
                                       variable="{{_currentVariable}}"
                                       types="{{graph.types}}"
                                       on-submit="{{_editVariable}}"
                                       on-delete="{{_deleteVariable}}"
                                       on-cancel="{{_cancelVariable}}"
                                       editMode>
                </cg-variable-inspector>
                <cg-variable-inspector data-state="createVariable"
                                       variable="{{_currentVariable}}"
                                       types="{{graph.types}}"
                                       on-submit="{{_createVariable}}"
                                       on-cancel="{{_cancelVariable}}">
                </cg-variable-inspector>
            </dude-sidebar>
            <cg-renderer id="renderer"
                         config="{{config.graph}}"
                         graph="{{graph}}"
                         content>
            </cg-renderer>
        </dude-panel>
        <paper-toast class="error" id="error"></paper-toast>
        <paper-toast class="success" id="success"></paper-toast>
    </template>
    <script>
        Polymer({
            publish: {
                config: {
                    "panel": {
                        "toolbar": { "position": "top" },
                        "sidebar": { "position": "left" }
                    },
                    "graph": {
                        "group": { "borderRadius": 5 },
                        "action": { "borderRadius": 5 },
                        "value": { "borderRadius": 20 },
                        "variable": { "borderRadius": 20 },
                        "background-grid": {
                            "line": {
                                "stroke": "rgba(0, 0, 0, 0.1)",
                                "stroke-width": 1
                            },
                            "big-line": {
                                "stroke": "rgba(0, 0, 0, 0.8)",
                                "stroke-width": 1
                            }
                        }
                    },
                    "shortcuts": {
                        "S": "openSave",
                        "G": "openGroup",
                        "A": "openAction",
                        "P": "openProperty",
                        "X": "removeSelection",
                        "E": "editEntity"
                    }
                },
                graph: null
            },
            searchLimit: 200,
            _commands: {
                "openSave": {label: "save the graph", "icon": "save"},
                "openGroup": {label: "add a group", icon: "av:my-library-add"},
                "openAction": {label: "add an action", icon: "add-box"},
                "openProperty": {label: "add a property", icon: "add-circle"},
                "editEntity": {label: "edit the selection", icon: "create", disabled: true},
                "removeSelection": {label: "remove the selection", icon: "delete", disabled: true}//,
//                "zoomToFit": {label: "zoom to best fit all objects", icon: "image:crop-free"}//,
                //"undo": {label: "undo last action", icon: "undo", disabled: true},
                //"redo": {label: "redo last action", icon: "redo", disabled: true}
            },
            _propertyTypes: [{"label": "all types", "name": "all types"}],
            _propertyList: [],
            _propertyType: "all types",
            _propertyLabel: "all types",
            _propertyPattern: "",
            _actionList: [],
            _actionName: null,
            _editMode: false,
            attached: function () {
                this.$.renderer.addEventListener("error", function (e) {
                    this.showError(e.detail.error);
                }.bind(this));
                this.$.renderer.addEventListener("ready", function () {
                    this._propertyPatternChanged();
                    this._actionNameChanged();
                }.bind(this));
                this.$.renderer.addEventListener("mouseup", this._updateDisabled.bind(this));
                var keyModifier = navigator.platform.indexOf("Mac") !== -1 ? "cmd" : "ctrl";
                pandora.forEach(this.config.shortcuts, function (functionName, shortcut) {
                    jwerty.key(keyModifier + "+" + shortcut, function (e) {
                        this[functionName]();
                        pandora.preventCallback(e);
                    }.bind(this));
                }.bind(this));
            },
            keys: function(input) {
                return Object.keys(input);
            },
            runCommand: function (event, detail) {
                if (this[detail.name] === undefined) {
                    console.warn("Command " + detail.name + " doesn't exist");
                    return;
                }
                this[detail.name](detail);
            },
            root: function () {
                this.$.toolbar.reset();
            },
            hideSidebar: function () {
                this.$.sidebar.reset();
            },
            openSave: function () {
                this.fire("save");
            },
            openGroup: function () {
                this.$.toolbar.state = "group";
            },
            openAction: function () {
                this.$.toolbar.state = "action";
                this.$.sidebar.state = "action";
            },
            openProperty: function () {
                this.$.toolbar.state = "property";
                this.$.sidebar.state = "property";
            },
            openSettings: function () {
                this.$.settings.open();
            },
            removeSelection: function () {
                this.$.renderer.removeSelection();
                this.$.success.text = "Entities successfully removed!";
                this.$.success.show();
                this._updateDisabled();
            },
            zoomToFit: function () {
                this.$.renderer.zoomToFit();
            },
            createGroup: function (detail) {
                this.$.renderer.createGroup(detail.value);
                this.$.success.text = "Group \"" + detail.value + "\" successfully created!";
                this.$.success.show();
            },
            createAction: function () {
                if (this._actionList.length === 0) {
                    this.showError(new pandora.Exception("Action {0} doesn't exist", this._actionName));
                } else {
                    this.$.renderer.createAction(this._actionList[0].data, new pandora.Vec2(100, 100));
                    this.$.success.text = "Action \"" + this._actionList[0].name + "\" successfully created!";
                    this.$.success.show();
                }
            },
            createProperty: function () {
                if (!this.$.renderer.createProperty(this._propertyPattern, this._getBestModel(), new pandora.Vec2(100, 100))) {
                    this.showError(new pandora.Exception("Variable {0} doesn't exist", this._propertyPattern));
                }
                this.$.pickerElement.reset();
            },
            editEntity: function () {
                var selection = this.$.renderer.getLastSelectedEntity();
                var entity = selection ? selection.datum() : null;
                if (entity instanceof cg.Group) {
                    this.$.toolbar.state = "editGroup";
                } else if (entity instanceof cg.Block) {
                    if (entity.model.type === "action") {
                        this.$.error.text = "Actions are read only.";
                        this.$.error.show();
                    } else if (entity.model.type === "value" || entity.model.type === "variable") {
                        this.$.toolbar.state = "editProperty";
                        this.$.sidebar.state = "property";
                        this._propertyType = entity.model.valueType;
                        this._editMode = true;
                    }
                }
            },
            editGroup: function (event) {
                var selection = this.$.renderer.getLastSelectedEntity();
                var entity = selection ? selection.datum() : null;
                entity.description = event.value;
                entity.emit("update");
            },
            editProperty: function () {
                var selection = this.$.renderer.getLastSelectedEntity();
                var entity = selection ? selection.datum() : null;
                this._editMode = false;
                if (!this.$.renderer.replaceProperty(this._propertyPattern, this._getBestModel(), entity)) {
                    this.showError(new pandora.Exception("Variable {0} doesn't exist", this._propertyPattern));
                }
                this.$.pickerElement.reset();
            },
            createVariable: function (type, name, value) {
                var result = this.$.renderer.createVariable(type, name, value);
                this._updatePropertyList();
                return result;
            },
            editVariable: function (previous, type, name, value) {
                var result = this.$.renderer.editVariable(previous, type, name, value);
                this._updatePropertyList();
                return result;
            },
            deleteVariable: function (name) {
                this.$.renderer.deleteVariable(name);
            },
            _showCreateVariable: function () {
                this._currentVariable = null;
                this.$.sidebar.state = "createVariable";
            },
            _createVariable: function () {
                // Note: if it's a sound the variable is created outside of cg (upload...)
                if (this._currentVariable.data.valueType === "sound") {
                    this.fire("variable.create", {"variable": this._currentVariable});
                } else if (this.createVariable(
                                this._currentVariable.data.valueType,
                                this._currentVariable.name,
                                this._currentVariable.data.value
                        )) {
                    this.showSuccess("Variable \"" + this._currentVariable.name + "\" successfully created!");
                    this.resetPicker();
                }
            },
            _cancelVariable: function () {
                this.$.sidebar.state = "property";
                this._propertyPattern = "";
            },
            _editVariable: function () {
                // Note: if it's a sound the variable is created outside of cg (upload...)
                if (this._currentVariable.data.valueType === "sound") {
                    this.fire("variable.edit", {"variable": this._currentVariable});
                } else if (this.editVariable(
                                this._currentVariable.previousName,
                                this._currentVariable.data.valueType,
                                this._currentVariable.name,
                                this._currentVariable.data.value)) {
                    this.showSuccess("Variable \"" + this._currentVariable.name + "\" successfully updated!");
                    this.resetPicker();
                }
            },
            _deleteVariable: function () {
                this.$.renderer.deleteVariable(this._currentVariable.name);
                this.showSuccess("Variable \"" + this._currentVariable.name + "\" successfully deleted!");
                this.resetPicker();
            },
            _cancelAction: function () {
                this.$.sidebar.state = "action";
                this.$.createAction.value = "";
            },
            showSuccess: function (message) {
                this.$.success.text = message;
                this.$.success.show();
            },
            showError: function (error) {
                this.$.error.text = error.message;
                this.$.error.show();
            },
            selectAction: function (event, detail) {
                this.$.createAction.value = detail.item.getAttribute("name");
                this.$.sidebar.state = "editAction";
                this._currentAction = this._getBestModel(true, this.$.createAction.value);
            },
            selectProperty: function (event, detail) {
                this.$.createProperty.value = detail.item.getAttribute("name");
                this.$.sidebar.state = "editVariable";
                this._currentVariable = this._getBestModel();
            },
            _getBestModel: function (isAction, pattern) {
                var models = this.$.renderer.findModels({
                    limit: this.searchLimit,
                    modelType: isAction ? 'action' : 'variable',
                    pattern: pattern || this._propertyPattern,
                    isInput: false
                });
                var model = models[0];
                pandora.forEach(models, function (m) {
                    if (m.name === this._propertyPattern) {
                        model = m;
                    }
                }.bind(this));
                return model;
            },
            _reset: function() {
                this._currentVariable = null;
                this._propertyPattern = "";
                this.$.pickerElement.reset();
            },
            resetPicker: function () {
                this.$.sidebar.state = "property";
                this._propertyPattern = "";
                this.$.pickerElement.reset();
            },
            save: function (saver) {
                return this.$.renderer.save(saver);
            },
            _resetPropertyPattern: function () {
                this._propertyPattern = "";
            },
            _updateDisabled: function () {
                this._commands.editEntity.disabled = !this.$.renderer.hasSelectedEntities();
                this._commands.removeSelection.disabled = !this.$.renderer.hasSelection();
            },
            _actionNameChanged: function () {
                this._actionList = this.$.renderer.findModels({
                    limit: this.searchLimit,
                    modelType: 'action',
                    pattern: this._actionName
                });
            },
            _propertyPatternChanged: function () {
                this._updatePropertyList();
            },
            graphChanged: function () {
                this._propertyTypes = [{"label": "all types", "name": "all types"}].concat(this.graph.types);
            },
            _propertyTypeChanged: function (event) {
                if (this.$.renderer.isReady) {
                    this._updatePropertyList();
                }
            },
            _updatePropertyList: function () {
                if (this._propertyType === "all types") {
                    this._propertyList = this.$.renderer.findModels({
                        limit: this.searchLimit,
                        modelType: 'variable',
                        pattern: this._propertyPattern
                    });
                } else {
                    this._propertyList = this.$.renderer.findModels({
                        limit: this.searchLimit,
                        modelType: 'variable',
                        pattern: this._propertyPattern,
                        isInput: false,
                        type: this._propertyType
                    });
                }
            }
        });
    </script>
</polymer-element>