<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
-->
<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../dude-property/dude-property.html">
<!--
`dude-graph-edit-block` is a panel used to edit an existing block.

@group dude-graph
@element dude-graph-edit-block
@demo demo/index.html
-->
<dom-module id="dude-graph-edit-block">
    <style>
        :host {
            @apply(--layout-vertical);
            @apply(--layout-flex);
            overflow: auto;
            padding: 10px;
        }
    </style>
    <template>
        <dude-property property-name="Block name"
                       property-type="String"
                       property-value="{{ data.nodeName }}"
                       no-menu>
        </dude-property>
        <template is="dom-repeat" items="[[ _getEditablePoints(data, refresh) ]]" as="renderPoint">
            <template is="dom-if" if="[[ !_isPointType(renderPoint, 'Choice') ]]">
                <dude-property property-type="{{ renderPoint.point.pointValueType }}"
                               property-name="{{ renderPoint.point.pointName }}"
                               property-value="{{ renderPoint.point.pointValue }}"
                               property-resources="{{ editor.resources }}"
                               no-reference>
                </dude-property>
            </template>
            <template is="dom-if" if="[[ _isPointType(renderPoint, 'Choice') ]]">
                <dude-property property-type="Choice"
                               property-name="{{ renderPoint.point.pointName }}"
                               property-value="{{ renderPoint.point.choice }}"
                               property-choices="{{ renderPoint.point.choices }}"
                               no-reference>
                </dude-property>
            </template>
        </template>
    </template>
    <script>
        Polymer({
            is: "dude-graph-edit-block",

            properties: {
                "data": {
                    "type": dudeGraph.RenderBlock,
                    "observer": "_dataChanged"
                },
                "refresh": {
                    "type": Boolean,
                    "value": false
                }
            },

            /**
             * @param {dudeGraph.RenderBlock|null} newData
             * @param {dudeGraph.RenderBlock|null} oldData
             * @private
             */
            _dataChanged(newData, oldData) {
                if (newData !== null && oldData === null) {
                    var refreshRenderBlock = function () {
                        this.set("refresh", true);
                        this.set("refresh", false);
                    }.bind(this);
                    newData.renderer.on("render-point-add", refreshRenderBlock);
                    newData.renderer.on("render-point-remove", refreshRenderBlock);
                }
            },

            /**
             * Returns whether the renderPoint is of the given type
             * @param {dudeGraph.RenderPoint} renderPoint
             * @param {String} pointValueType
             * @returns {Boolean}
             * @private
             */
            _isPointType: function (renderPoint, pointValueType) {
                return renderPoint.point.pointValueType === pointValueType;
            },

            /**
             *
             * @param {dudeGraph.RenderBlock} renderBlock
             * @returns {Array<dudeGraph.RenderPoint>|null}
             * @private
             */
            _getEditablePoints: function (renderBlock) {
                if (renderBlock === null) {
                    return null;
                }
                return _.filter(renderBlock.renderPoints, function (renderPoint) {
                    return _.isEmpty(renderPoint.renderConnections) && !(renderPoint.point instanceof dudeGraph.Stream) && !renderPoint.point.pointOutput;
                });
            }
        });
    </script>
</dom-module>