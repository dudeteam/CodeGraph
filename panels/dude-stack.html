<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
-->
<!--suppress HtmlUnknownTarget -->
<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<!--
`dude-stack`

@group dude-graph
@element dude-stack
@demo demo/index.html
-->
<dom-module id="dude-stack">
    <style>
        :host {
            position: relative;
            @apply(--layout-vertical);
            @apply(--layout-flex);
        }
        #panel {
            background: var(--dude-secondary-background-color);
            @apply(--layout-vertical);
            @apply(--layout-flex);
        }
        .title {
            font-family: var(--dude-primary-text-font);
            text-align: center;
            padding: 10px;
            font-weight: bold;
            color: var(--dude-content-text-color);
            border-bottom: 2px solid var(--dude-primary-background-color);
        }
        #panel i {
            z-index: 10;
            cursor: pointer;
            position: absolute;
            top: 10px;
            left: 10px;
            color: var(--dude-secondary-text-color);
        }
        #button {
            /*width: 50px;*/
            /*height: 50px;*/
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--dude-secondary-background-color);
            color: var(--dude-secondary-text-color);
            cursor: pointer;
            /*position: absolute;*/
            /*top: 10px;*/
            /*right: 10px;*/
        }
        #button i {
            position: absolute;
            margin: 8px 12px;
            top: 10px;
            left: 10px;
        }

        /* closing */
        :host(.closed) {
            width: 50px;
            height: 50px;
            position: absolute;
            top: 10px;
            right: 10px;
        }
        :host(.closed) #panel {
            display: none;
        }
        :host(:not(.closed)) #button {
            display: none;
        }
        @keyframes open-panel {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        @keyframes close-panel {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        :host(:not(.closed)) #panel {
            animation: open-panel 1s;
        }
        :host(.closed) #panel {
            animation: close-panel 1s;
        }
    </style>
    <template>
        <div id="button" on-click="_openPanel">
            <i class="fa fa-info"></i>
        </div>
        <div id="panel">
            <i on-click="popStack" class="fa fa-close"></i>
            <div class="title">Panel title</div>
            <div id="stack"></div>
        </div>
    </template>
    <script>
        Polymer({
            is: "dude-stack",
            listeners: {
                "dude-stack-attached": "_stackReady",
                "dude-stack-close": "_stackClose"
            },

            /**
             * The stack of opened elements
             * @type {Array<DudeStackItemElement>}
             * @private
             */
            _stack: [],

            /**
             * The element on the top of the stack
             * @type {DudeStackItemElement|null}
             * @private
             */
            _currentElement: null,

            ready: function () {
                this._openPanel();
            },

            /**
             * Pushes an element on the stack
             * @param {String} stackElementName
             * @returns {DudeStackItemElement}
             */
            pushStack: function (stackElementName) {
                if (this._currentElement !== null) {
                    this._currentElement.setAttribute("hidden", "true");
                    if (typeof this._currentElement.paused === "function") {
                        this._currentElement.paused();
                    }
                }
                this._currentElement = document.createElement(stackElementName);
                this._stack.push(this._currentElement);
                this.$.stack.appendChild(this._currentElement);
                return this._currentElement;
            },

            /**
             * Pops the current element and shows the previous element
             * @returns {DudeStackItemElement|null}
             */
            popStack: function () {
                if (this._currentElement !== null) {
                    var currentElement = this._stack.pop();
                    if (typeof currentElement.closed === "function") {
                        currentElement.closed();
                    }
                    this.$.stack.removeChild(currentElement);
                    this._currentElement = this._stack[this._stack.length - 1] || null;
                    if (this._currentElement !== null) {
                        this._currentElement.removeAttribute("hidden");
                        if (typeof this._currentElement.resumed === "function") {
                            this._currentElement.resumed();
                        }
                    } else {
                        this._closePanel();
                    }
                    return currentElement;
                }
                return null;
            },

            /**
             * Called when a pushed stack element wants to be closed
             * @param {DudeStackItemElement} stackElement
             */
            removeStack: function (stackElement) {
                if (this._currentElement === stackElement) {
                    this.popStack();
                } else {
                    var stackIndex = this._safeStackIndex(stackElement);
                    if (typeof stackElement.closed === "function") {
                        stackElement.closed();
                    }
                    this.$.stack.removeChild(stackElement);
                    this._stack.splice(stackIndex, 1);
                }
            },

            /**
             * Returns the stacked element index if it exists, throws otherwise
             * @param {DudeStackItemElement} stackElement
             * @returns {Number}
             * @private
             */
            _safeStackIndex: function (stackElement) {
                var index = this._stack.indexOf(stackElement);
                if (index === -1) {
                    throw new Error("`" + stackElement + "` not found in the stack");
                }
                return index;
            },

            /**
             * Called when a pushed stack element is ready
             * @param {CustomEvent} e
             * @param {DudeStackItemElement} e.target
             * @private
             */
            _stackReady: function (e) {
                var stackElement = e.target;
                this._safeStackIndex(stackElement);
                stackElement.set("stack", this);
                stackElement.set("data", this.get("data"));
                if (typeof stackElement.opened === "function") {
                    stackElement.opened();
                }
                if (this._currentElement === stackElement && typeof stackElement.resumed === "function") {
                    stackElement.resumed();
                }
            },

            /**
             * Called when a pushed stack element wants to be closed
             * @param {CustomEvent} e
             * @param {DudeStackItemElement} e.target
             * @private
             */
            _stackClose: function (e) {
                this.removeStack(e.target);
            },

            _openPanel: function () {
                this.toggleClass("closed", false);
            },

            _closePanel: function () {
                this.toggleClass("closed", true);
            }
        });

        /**
         * @typedef {Element} DudeStackElement
         * @property {Function} pushStack
         * @property {Function} popStack
         * @property {Function} removeStack
         */

        /**
         * @typedef {Element} DudeStackItemElement
         * @property {Function} opened
         * @property {Function} resumed
         * @property {Function} paused
         * @property {Function} closed
         */
    </script>
</dom-module>