<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
-->
<!--suppress HtmlUnknownTarget -->
<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../dude-style/dude-style.html">
<!--
`dude-inspector` is a Polymer element which creates a closable stack of panels.

@group dude-graph
@element dude-inspector
-->
<dom-module id="dude-inspector">
    <style>
        :host {
            position: relative;
            @apply(--layout-vertical);
            @apply(--layout-flex);
        }

        #inspector-panel {
            @apply(--layout-vertical);
            @apply(--layout-flex);
            background-color: var(--dude-background2-color);
        }

        #inspector-panel > i {
            z-index: 10;
            cursor: pointer;
            position: absolute;
            top: 10px;
            left: 10px;
        }

        #panel-title {
            border-bottom: 2px solid var(--dude-background1-color);
            font-family: var(--dude-font-primary);
            font-weight: bold;
            text-align: center;
            padding: 10px;
            color: var(--dude-dark1-color);
        }

        #show-button {
            border-radius: 50%;
            background: var(--dude-background2-color);
            position: relative;
            cursor: pointer;
            width: 100%;
            height: 100%;
            color: var(--dude-dark1-color);
        }

        #show-button i {
            position: absolute;
            margin: 8px 12px;
            top: 10px;
            left: 10px;
        }

        /* closing */
        :host(.closed) {
            position: absolute;
            width: 50px;
            height: 50px;
            top: 10px;
            right: 10px;
        }

        :host(.closed) #inspector-panel {
            display: none;
        }

        :host(:not(.closed)) #show-button {
            display: none;
        }

        @keyframes open-panel {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes close-panel {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        :host(:not(.closed)) #inspector-panel {
            animation: open-panel 1s;
        }

        :host(.closed) #inspector-panel {
            animation: close-panel 1s;
        }

        #panel {
            overflow: auto;
        }
    </style>
    <template>
        <div id="show-button" on-click="_openInspector">
            <i class="fa fa-info"></i>
        </div>
        <div id="inspector-panel">
            <i class="fa fa-close" on-click="popStack"></i>
            <div id="panel-title">[[ _panelTitle(topPanel, topPanel.panelTitle) ]]</div>
            <div id="panel"></div>
        </div>
    </template>
    <script>
        Polymer({
            is: "dude-inspector",
            properties: {
                /**
                 * The DudeGraphElement
                 */
                "data": {
                   "type": "DudeGraphElement"
                },
                /**
                 * The first panel to create
                 */
                "rootPanel": {
                    "type": "String"
                },
                /**
                 * The top panel
                 */
                "topPanel": {
                    "type": "DudeInspectorItemElement",
                    "readonly": true,
                    "value": null
                }
            },
            listeners: {
                "dude-inspector-attached": "_panelAttached"
            },

            /**
             * The panels stack
             * @type {Array<DudeInspectorItemElement>}
             * @private
             */
            _panels: [],

            /**
             * Creates the rootPanel
             */
            ready: function () {
                if (!this.get("rootPanel")) {
                    throw new Error("`dude-inspector` must have a rootPanel");
                }
                this.pushStack(this.get("rootPanel"));
                this._openInspector();
            },

            /**
             * Pushes a panel on the stack, becoming the top panel
             * The previous top panel will be hidden and paused
             * @param {String} panelElementName
             * @returns {DudeInspectorItemElement}
             */
            pushStack: function (panelElementName) {
                if (this.get("topPanel") !== null) {
                    this.get("topPanel").setAttribute("hidden", "true");
                    if (typeof this.get("topPanel").paused === "function") {
                        this.get("topPanel").paused();
                    }
                }
                this.set("topPanel", document.createElement(panelElementName));
                this._panels.push(this.get("topPanel"));
                this.$.panel.appendChild(this.get("topPanel"));
                return this.get("topPanel");
            },

            /**
             * Pops the top panel and shows the previous one
             * If the top panel is the root panel, the inspector will be closed instead
             * @returns {DudeInspectorItemElement|null}
             */
            popStack: function () {
                if (this._panels.length === 1) {
                    this._closeInspector();
                    return null;
                }
                if (this.get("topPanel") !== null) {
                    var currentElement = this._panels.pop();
                    if (typeof currentElement.closed === "function") {
                        currentElement.closed();
                    }
                    this.$.panel.removeChild(currentElement);
                    this.set("topPanel", this._panels[this._panels.length - 1] || null);
                    if (this.get("topPanel") !== null) {
                        this.get("topPanel").removeAttribute("hidden");
                        if (typeof this.get("topPanel").resumed === "function") {
                            this.get("topPanel").resumed();
                        }
                    }
                    return currentElement;
                }
                return null;
            },

            /**
             * Clears all but the root element
             */
            clearStack: function () {
                while (this._panels.length > 1) {
                    this.popStack();
                }
            },

            /**
             * Updates the dudeGraphElement
             * @param {Boolean} [force=false]
             */
            updateDudeGraphElement: function (force) {
                for (var i = 0; i < this._panels.length; i++) {
                    if (force) {
                        this._panels[i].set("data", null);
                    }
                    this._panels[i].set("data", this.get("data"));
                }
            },

            /**
             * Returns the stacked element index if it exists, throws otherwise
             * @param {DudeInspectorItemElement} stackElement
             * @returns {Number}
             * @private
             */
            _safePanelIndex: function (stackElement) {
                var index = this._panels.indexOf(stackElement);
                if (index === -1) {
                    throw new Error("`" + stackElement + "` not found in the stack");
                }
                return index;
            },

            /**
             * Called when a panel is attached to the DOM
             * @param {CustomEvent} e
             * @param {DudeInspectorItemElement} e.target
             * @private
             */
            _panelAttached: function (e) {
                var stackElement = e.target;
                this._safePanelIndex(stackElement);
                stackElement.set("inspector", this);
                stackElement.set("data", this.get("data"));
                if (typeof stackElement.opened === "function") {
                    stackElement.opened();
                }
                if (this.get("topPanel") === stackElement && typeof stackElement.resumed === "function") {
                    stackElement.resumed();
                }
            },

            /**
             * Opens the inspector and shows the current panel
             * @private
             */
            _openInspector: function () {
                this.toggleClass("closed", false);
            },

            /**
             * Closes the inspector
             * @private
             */
            _closeInspector: function () {
                this.toggleClass("closed", true);
            },

            /**
             * Returns the panel title
             * @returns {String}
             * @private
             */
            _panelTitle: function (topPanel, panelTitle) {
                return panelTitle || "None";
            }
        });

        /**
         * @typedef {Element} DudeInspectorElement
         * @property {Function} pushStack
         * @property {Function} popStack
         * @property {Function} removeStack
         */

        /**
         * @typedef {Element} DudeInspectorItemElement
         * @property {Function} opened
         * @property {Function} resumed
         * @property {Function} paused
         * @property {Function} closed
         * @property {Function} get
         * @property {Function} set
         * @property {Object} $
         */
    </script>
</dom-module>