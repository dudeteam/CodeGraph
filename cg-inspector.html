<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../magnet-hierarchy/magnet-hierarchy.html">
<link rel="import" href="../magnet-state/magnet-state.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">

<!--
`cg-inspector` is a Polymer element which creates the inspector for codegraph. In other words, it creates the sidebar
that will be used 
methods and properties.
@group Codegraph
@element cg-inspector
@demo demo/index.html
-->
<dom-module id="cg-inspector">
    <style>
        :host {
            background: var(--cg-background-color);
            overflow: auto;
        }
        div {
            font-family: var(--cg-display-font);
            color: var(--cg-text-color);
        }
        .title {
            color: var(--cg-title-color);
            padding-bottom: 10px;
        }
        .box {
            padding: 10px;
            border-bottom: 3px solid #222222;
        }
        .row {
            padding: 5px;
        }
        label {
            width: 30%;
            display: inline-block;
            padding: 5px;
        }
        input, select {
            width: 50%;
            display: inline-block;
        }
        input[type="text"] {
            padding: 5px;
            outline: none;
            border: none;
            background: transparent;
            border-bottom: 2px solid #555555;
            color: var(--cg-text-color);
            font-family: var(--cg-display-font);
            font-size: 1em;
        }
        input[type="text"]:focus {
            border-bottom: 2px solid var(--cg-primary-color);
        }
        #state :not(.active-state) {
            display: none;
        }
        #compileResult > div {
            width: 800px;
        }
    </style>
    <template>
        <div class="layout vertical flex">
            <!--<magnet-state id="state" root-state="root" current-state="{{_currentState}}">-->
                <!--<div data-state="root">-->
                    <!--coucou-->
                <!--</div>-->
                <!--<div data-state="editGroup">Edit group</div>-->
                <!--<div data-state="editBlock">Edit variable</div>-->
            <!--</magnet-state>-->
            <div>
                <div class="box">
                    <div class="title">Tools</div>
                    <paper-button class="primary" on-click="_compile">Compile</paper-button>
                    <paper-button class="primary">Add group</paper-button>
                    <paper-button class="primary">Remove selection</paper-button>
                </div> <!-- .box -->
                <div class="box">
                    <div class="title">Add block</div>
                    <magnet-hierarchy id="blocks"></magnet-hierarchy>
                </div> <!-- .box -->
                <div class="box">
                    <div class="title">Create variable</div>
                    <div class="row">
                        <label>Type: </label>
                        <select>
                            <option>boolean</option>
                            <option>number</option>
                            <option>string</option>
                        </select>
                    </div>
                    <div class="row">
                        <label>Name: </label>
                        <input is="iron-input" bind-value="{{_name}}" placeholder="my_custom_variable" type="text">
                    </div>
                    <div class="row">
                        <label>Value: </label>
                        <input is="iron-input" bind-value="{{_value}}" type="text">
                    </div>
                    <div class="row">
                        <label>Folder: </label>
                        <input is="iron-input" bind-value="{{_folder}}" placeholder="my_custom_folder" type="text">
                    </div>
                    <paper-button class="primary" on-click="_createVariableClicked">Create</paper-button>
                </div> <!-- .box -->
            </div>
        </div>
        <paper-dialog id="compileResult">
            <h2>Code</h2>
            <paper-dialog-scrollable>
                <pre><code>{{_compiledCode}}</code></pre>
            </paper-dialog-scrollable>
        </paper-dialog>
    </template>
    <script>
        Polymer({
            is: "cg-inspector",
            properties: {
                models: {
                    type: Object,
                    value: {}
                },
                element: {
                    type: CgElement
                }
            },
            behaviors: [Polymer.IronA11yKeysBehavior],
            ready: function () {
                this._models = [];
                this._folders = {};
                this._currentState = "root";
                this._compiledCode = "";
                pandora.forEach(this.models, function (value, key) {
                    if (value.cgFolder) {
                        if (this._folders[value.cgFolder] === undefined) {
                            this._folders[value.cgFolder] = {group: {name: value.cgFolder, items: []}};
                            this._models.push(this._folders[value.cgFolder]);
                        }
                        this._folders[value.cgFolder].group.items.push({item: {name: key, data: value}});
                    } else {
                        this._models.push({item: {name: key, data: value}});
                    }
                }.bind(this));
                this.$.blocks.loadItems(this._models);
                this.addOwnKeyBinding("enter", "_createBlock");
            },
            bindBuilder: function (builder) {
                this._builder = builder;
            },
            bindElement: function (element) {
                this.element = element;
                this.element.renderer.on("cg-select", function (node) {
                    if (node.type === "block") {
                        this._currentState = "editBlock";
                    } else if (node.type === "group") {
                        this._currentState = "editGroup";
                    }
                }.bind(this));
                this.element.renderer.on("cg-unselect", function () {
                    this._currentState = "root";
                }.bind(this));
            },
            _createBlock: function () {
                if (this.$.blocks.selectItem !== null) {
                    var data = Object.create(this.$.blocks.selectItem.data);
                    data.cgName = this.$.blocks.selectItem.name;
                    data.cgId = cg.UUID.generate();
                    this.element.graph.loader.loadBlock(data);
                }
            },
            _createVariableClicked: function () {
                console.log(this._name);
                console.log(this._value);
                console.log(this._folder);
            },
            _compile: function () {
                this._compiledCode = this._builder.save(this.element.graph);
                this.$.compileResult.open();
            }
        });
    </script>
</dom-module>