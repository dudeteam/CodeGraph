<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../magnet-hierarchy/magnet-hierarchy.html">
<link rel="import" href="../magnet-state/magnet-state.html">

<!--
`cg-inspector` is a Polymer element which creates the inspector for codegraph. In other words, it creates the sidebar
that will be used 
methods and properties.
@group Codegraph
@element cg-inspector
@demo demo/index.html
-->
<dom-module id="cg-inspector">
    <style>
        :host {
            background: var(--cg-background-color);
            overflow: auto;
        }

        div {
            font-family: var(--cg-display-font);
            color: var(--cg-text-color);
        }

        .title {
            color: var(--cg-title-color);
            padding-bottom: 10px;
        }

        .box {
            padding: 10px;
            border-bottom: 3px solid #222222;
        }

        .row {
            padding: 5px;
        }

        label {
            width: 20%;
            display: inline-block;
            padding: 5px;
            text-align: right;
        }

        input, paper-dropdown-menu {
            width: 70%;
            display: inline-block;
        }

        input[type="text"] {
            padding: 5px;
            outline: none;
            border: none;
            background: transparent;
            border-bottom: 2px solid #555555;
            color: var(--cg-text-color);
            font-family: var(--cg-display-font);
            font-size: 1em;
        }

        input[type="text"]:focus {
            border-bottom: 2px solid var(--cg-primary-color);
        }

        #state > div:not(.active-state) {
            display: none;
        }

        #compileResult > div {
            width: 800px;
        }

        paper-button {
            margin: 2px 0;
        }

    </style>
    <template>
        <div class="layout vertical flex">
            <div class="box">
                <div class="title">Tools</div>
                <paper-button class="primary" on-click="_compile">Compile</paper-button>
                <paper-button class="primary" on-click="_addGroup">Add group</paper-button>
                <paper-button class="primary" on-click="_removeSelection">Remove selection</paper-button>
                <paper-button class="primary" on-click="_save">Save</paper-button>
            </div>
            <!-- .box -->
            <magnet-state id="state" class="layout vertical flex" root-state="root" current-state="{{_currentState}}">
                <div class="layout vertical flex" data-state="root">
                    <div class="box">
                        <div class="title">Add block</div>
                        <magnet-hierarchy id="blocks" on-submit="_createBlock"></magnet-hierarchy>
                    </div>
                    <!-- .box -->
                    <div class="box">
                        <div class="title">Create variable</div>
                        <div class="row">
                            <label>type</label>
                            <paper-dropdown-menu label="Choose..." selected-item-label="{{_varType}}" no-label-float>
                                <paper-menu class="dropdown-content">
                                    <paper-item>Boolean</paper-item>
                                    <paper-item>Number</paper-item>
                                    <paper-item>String</paper-item>
                                </paper-menu>
                            </paper-dropdown-menu>
                        </div>
                        <div class="row">
                            <label>name</label>
                            <input is="iron-input" bind-value="{{_varName}}" placeholder="my_custom_variable"
                                   type="text">
                        </div>
                        <div class="row">
                            <label>value</label>
                            <input is="iron-input" bind-value="{{_varValue}}" type="text">
                        </div>
                        <paper-button class="primary" on-click="_createVariableClicked">Create</paper-button>
                    </div>
                    <!-- .box -->
                </div>
                <!-- root -->
                <div data-state="editGroup">
                    <div class="box">
                        <div class="title">Edit group</div>
                        <div class="row">
                            <label>description</label>
                            <input is="iron-input" bind-value="{{_groupDescription}}" placeholder="Group description..."
                                   type="text">
                        </div>
                        <paper-button class="primary" on-click="_editGroupClicked">Edit</paper-button>
                    </div>
                    <!-- .box -->

                </div>
                <!-- Edit group -->
                <div data-state="editBlock">
                    <div class="box">
                        <div class="title">Edit block</div>
                        <div class="row">
                            <label>name</label>
                            <input is="iron-input" bind-value="{{_blockName}}" placeholder="my_custom_variable"
                                   type="text">
                        </div>
                        <div class="title" hidden$="{{_blockNoInput}}">Inputs</div>
                        <div class="row">
                            <template is="dom-repeat" id="menu" items="{{_blockInputs}}">
                                <label>{{item.cgName}}</label>
                                <input is="iron-input" bind-value="{{item.cgValue}}" type="text">
                            </template>
                        </div>
                        <paper-button class="primary" on-click="_editBlockClicked">Edit</paper-button>
                    </div>
                    <!-- .box -->
                </div>
                <!-- Edit block -->
                <div data-state="editValue">
                    <div class="box">
                        <div class="title">Edit value</div>
                        <div class="row">
                            <label>value</label>
                            <input is="iron-input" bind-value="{{_value}}" type="text">
                        </div>
                        <paper-button class="primary" on-click="_editValueClicked">Edit</paper-button>
                    </div>
                    <!-- .box -->
                </div>
                <!-- Edit value -->
                <div data-state="editVariable">
                    <div class="box">
                        <div class="title">Edit variable</div>
                        <div class="row">
                            <label>name</label>
                            <input is="iron-input" bind-value="{{_varName}}" placeholder="my_custom_variable"
                                   type="text">
                        </div>
                        <div class="row">
                            <label>value</label>
                            <input is="iron-input" bind-value="{{_varValue}}" type="text">
                        </div>
                        <paper-button class="primary" on-click="_editVariableClicked">Edit</paper-button>
                    </div>
                    <!-- .box -->
                </div>
                <!-- Edit variable -->
            </magnet-state>
        </div>
    </template>
    <script>
        Polymer({
            is: "cg-inspector",
            properties: {
                models: {
                    type: Object,
                    value: {}
                },
                element: {
                    type: CgElement
                }
            },
            ready: function () {
                this._models = [];
                this._folders = {};
                this._selectedNode = null;
                this._currentState = "root";
                this._varType = "";
                this._varName = "";
                this._varValue = "";
                this._varFolder = "";
                pandora.forEach(this.models, function (value, key) {
                    var icon = ["Value", "Variable"].indexOf(value.cgType) === -1 ? "fa fa-square" : "fa fa-circle";
                    if (value.cgFolder) {
                        if (this._folders[value.cgFolder] === undefined) {
                            this._folders[value.cgFolder] = {
                                group: {
                                    name: value.cgFolder,
                                    icon: "fa fa-folder",
                                    items: []
                                }
                            };
                            this._models.push(this._folders[value.cgFolder]);
                        }
                        this._folders[value.cgFolder].group.items.push({item: {name: key, icon: icon, data: value}});
                    } else {
                        this._models.push({item: {name: key, icon: icon, data: value}});
                    }
                }.bind(this));
                this._customVariables = {group: {name: "custom variables", icon: "fa fa-folder", items: []}};
                this._models.unshift(this._customVariables);
                this.$.blocks.loadItems(this._models);
            },
            bindBuilder: function (builder) {
                this._builder = builder;
            },
            bindElement: function (element) {
                this.element = element;
                this.element.renderer.on("cg-select", function (node) {
                    this._selectedNode = node;
                    if (node.type === "block") {
                        switch (pandora.typename(node.cgBlock)) {
                            case "Variable":
                                this._currentState = "editVariable";
                                this._varName = node.cgBlock.cgName;
                                this._varValue = node.cgBlock.cgValue;
                                break;
                            case "Value":
                                this._currentState = "editValue";
                                this._value = node.cgBlock.cgValue;
                                break;
                            default:
                                this._currentState = "editBlock";
                                this._blockName = node.cgBlock.cgName;
                                this._blockInputs = node.cgBlock.cgInputs.filter(function (point) {
                                    return pandora.typename(point) === "Point";
                                }).map(function (point) {
                                    return {
                                        cgName: point.cgName,
                                        cgValue: point.cgValue
                                    };
                                });
                                this._blockNoInput = this._blockInputs.length === 0;
                        }
                    } else if (node.type === "group") {
                        this._currentState = "editGroup";
                        this._groupDescription = node.description;
                    }
                }.bind(this));
                this.element.renderer.on("cg-unselect", function () {
                    this._currentState = "root";
                }.bind(this));
            },
            _createBlock: function (e) {
                if (e.detail.item.group) {
                    return;
                }
                if (e.detail.item !== null) {
                    var data = Object.create(e.detail.item.data);
                    data.cgName = e.detail.item.name;
                    data.cgId = cg.UUID.generate();
                    this.element.graph.loader.loadBlock(data);
                }
            },
            _createVariableClicked: function () {
                if (!this._varType) {
                    this.fire("error", {message: "A `type` is required to create a variable"});
                    return;
                }
                if (!this._varName) {
                    this.fire("error", {message: "A `name` is required to create a variable"});
                    return;
                }
                this._customVariables.group.items.push({
                    item: {
                        name: this._varName, icon: "fa fa-circle",
                        data: {
                            cgType: "Variable",
                            cgValueType: this._varType,
                            cgValue: this._varValue
                        }
                    }
                });
                this.$.blocks.loadItems(this._models); // Refresh the list
            },
            _editVariableClicked: function () {
                this._selectedNode.cgBlock.cgName = this._varName;
                this._selectedNode.cgBlock.cgValue = this._varValue;
            },
            _editValueClicked: function () {
                this._selectedNode.cgBlock.cgValue = this._varValue;
            },
            _editBlockClicked: function () {
                this._selectedNode.cgBlock.cgName = this._blockName;
                pandora.forEach(this._blockInputs, function (input) {
                    console.log(this._selectedNode.cgBlock.inputByName(input.cgName));
                    this._selectedNode.cgBlock.inputByName(input.cgName).cgValue = input.cgValue;
                }.bind(this));
            },
            _editGroupClicked: function () {
                this._selectedNode.description = this._groupDescription;
                this.element.renderer._updateD3Groups(); // TODO: Public API
            },
            _compile: function () {
                try {
                    this.fire("compile", this._builder.save(this.element.graph));
                } catch (e) {
                    this.fire("error", {error: e, message: e.message});
                }
            },
            _addGroup: function () {
                this.element.renderer.createGroupFromSelection(prompt("Group name:"));
            },
            _removeSelection: function () {
                this.element.renderer.removeSelection();
                this._currentState = "root";
            },
            _save: function () {
                try {
                    this.fire("save", new cg.JSONSaver().save(this.element.renderer, this.element.graph));
                } catch (e) {
                    this.fire("error", {error: e, message: e.message});
                }
            }
        });
    </script>
</dom-module>