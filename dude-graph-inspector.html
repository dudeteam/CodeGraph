<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../dude-collapse/dude-collapse.html">
<link rel="import" href="../dude-hierarchy/dude-hierarchy.html">
<link rel="import" href="../dude-property/dude-property.html">
<!--
`dude-graph-inspector` is a Polymer element which creates the inspector for a dudeGraphEditor.

@group dude-graph
@element dude-graph-inspector
@demo demo/index.html
-->
<dom-module id="dude-graph-inspector">
    <style>
        :root {
            --default-primary-color: var(--dude-primary-color);
            --text-primary-color: var(--dude-primary-text-color);
            --paper-input-container-focus-color: var(--dude-primary-color);
            --paper-input-container-input-color: var(--dude-content-text-color);
        }

        :host {
            background: var(--dude-secondary-background-color);
            overflow: auto;
            padding: 10px 5px 5px;
        }

        dude-collapse {
            padding-top: 5px;
        }
    </style>
    <template>
        <div class="layout vertical flex">
            <dude-collapse heading="Create">
                <!-- Create a new block from hierarchy -->
                <dude-hierarchy
                        items="[[ editor.models ]]"
                        placeholder="Create a block..."
                        on-dude-hierarchy-item-submit="_createBlockFromModel">
                </dude-hierarchy>
                <!-- End Create a new block from hierarchy -->
            </dude-collapse>
            <template is="dom-if" if="[[ _selectedRenderBlock ]]">
                <dude-collapse heading="Edit block">
                    <!-- Edit block name -->
                    <dude-property property-name="Block name"
                                   property-type="String"
                                   property-value="{{ _selectedRenderBlock.nodeName }}"
                                   no-menu>
                    </dude-property>
                    <!-- End Edit block name -->
                    <!-- Edit block points -->
                    <template is="dom-repeat" items="[[ _getEditablePoints(_selectedRenderBlock) ]]" as="renderPoint">
                        <template is="dom-if" if="[[ !_isPointType(renderPoint, 'Choice') ]]">
                            <dude-property property-type="{{ renderPoint.point.cgValueType }}"
                                           property-name="{{ renderPoint.point.cgName }}"
                                           property-value="{{ renderPoint.point.cgValue }}"
                                           property-resources="{{ editor.resources }}"
                                           no-reference>
                            </dude-property>
                        </template>
                        <template is="dom-if" if="[[ _isPointType(renderPoint, 'Choice') ]]">
                            <dude-property property-type="Choice"
                                           property-name="{{ renderPoint.point.cgName }}"
                                           property-value="{{ renderPoint.point.choice }}"
                                           property-choices="{{ renderPoint.point.choices }}"
                                           no-reference>
                            </dude-property>
                        </template>
                    </template>
                    <!-- End Edit block points -->
                </dude-collapse>
            </template>
            <template is="dom-if" if="[[ _selectedRenderGroup ]]">
                <dude-collapse heading="Edit group">
                    <!-- Edit group name -->
                    <dude-property property-name="Group name"
                                   property-type="String"
                                   property-value="{{ _selectedRenderGroup.nodeName }}"
                                   no-menu>
                    </dude-property>
                    <!-- End Edit group name -->
                </dude-collapse>
            </template>
            <template is="dom-if" if="[[ _showCreateRenderGroup ]]">
                <dude-collapse heading="Create group">
                    <!-- Create group name -->
                    <dude-property property-name="Group name"
                                   property-type="String"
                                   property-value="{{ _createRenderGroupName }}"
                                   no-menu>
                    </dude-property>
                    <br />
                    <paper-button on-click="_createRenderGroup">Create</paper-button>
                    <!-- End Create group name -->
                </dude-collapse>
            </template>
        </div>
    </template>
    <script>
        var DudeGraphInspector = Polymer({
            is: "dude-graph-inspector",
            behaviors: [Polymer.IronA11yKeysBehavior],
            properties: {
                /**
                 *
                 */
                "editor": {
                    "type": DudeGraphEditor,
                    "value": null
                }

            },

            _selectedRenderBlock: null,
            _selectedRenderGroup: null,
            _createRenderGroupName: null,
            _showCreateRenderGroup: false,

            /**
             *
             * @param {DudeGraphEditor} editor
             */
            start: function (editor) {
                var inspector = this;
                this.set("editor", editor);
                this.get("editor").get("renderer").on("select", function (renderNode) {
                    inspector.set("_selectedRenderBlock", renderNode instanceof dudeGraph.RenderBlock ? renderNode : null);
                    inspector.set("_selectedRenderGroup", renderNode instanceof dudeGraph.RenderGroup ? renderNode : null);
                });
                this.get("editor").get("renderer").on("unselect", function (renderNode) {
                    inspector.set("_selectedRenderBlock", renderNode instanceof dudeGraph.RenderBlock ? null : inspector.get("_selectedRenderBlock"));
                    inspector.set("_selectedRenderGroup", renderNode instanceof dudeGraph.RenderGroup ? null : inspector.get("_selectedRenderGroup"));
                });
                this.get("editor").get("renderer").on("unselect-all", function () {
                    inspector.set("_selectedRenderBlock", null);
                    inspector.set("_selectedRenderGroup", null);
                });
                var updateRenderPoints = function () {
                  var saveRenderBlock = inspector.get("_selectedRenderBlock");
                    inspector.set("_selectedRenderBlock", null);
                    inspector.set("_selectedRenderBlock", saveRenderBlock);
                };
                this.get("editor").get("renderer").on("render-point-add", updateRenderPoints);
                this.get("editor").get("renderer").on("render-point-remove", updateRenderPoints);
                this.get("editor").get("renderer").on("render-connection-add", updateRenderPoints);
                this.get("editor").get("renderer").on("render-connection-remove", updateRenderPoints);
            },

            /**
             * @param {CustomEvent} e
             */
            shortcutSave: function (e) {
                this.fire("dude-graph-inspector-save", this.get("editor").save());
            },

            /**
             * @param {CustomEvent} e
             */
            shortcutBuild: function (e) {
                this.fire("dude-graph-inspector-build");
            },


            /**
             * @param {CustomEvent} e
             */
            shortcutRemoveSelection: function (e) {
                this.get("editor").get("renderer").removeSelection();
            },

            /**
             * @param {CustomEvent} e
             */
            shortcutCreateRenderGroup: function (e) {
                this.set("_showCreateRenderGroup", true);
            },

            /**
             * @param {CustomEvent} e
             */
            shortcutZoomToFit: function (e) {
                if (e.detail.shiftKey) {
                    this.get("editor").get("renderer").zoomToFitSelection();
                } else {
                    this.get("editor").get("renderer").zoomToFit();
                }
            },

            /**
             *
             * @param {CustomEvent} e
             */
            shortcutSelectAll: function (e) {
                this.get("editor").get("renderer").selectAll(!e.detail.shiftKey, !e.detail.altKey);
            },

            /**
             * @private
             */
            _createRenderGroup: function () {
                this.get("editor").get("renderer").createRenderGroupForSelection(this.get("_createRenderGroupName"));
                this.set("_showCreateRenderGroup", false);
                this.set("_createRenderGroupName", null);
            },

            /**
             *
             * @param {CustomEvent} e
             * @private
             */
            _createBlockFromModel: function (e) {
                if (e.detail.item.data) {
                    this.get("editor").createBlock(e.detail.item.data);
                }
            },

            /**
             * Returns whether the renderPoint is of the given type
             * @param {dudeGraph.RenderPoint} renderPoint
             * @param {String} cgValueType
             * @returns {Boolean}
             * @private
             */
            _isPointType: function (renderPoint, cgValueType) {
                return renderPoint.point.cgValueType === cgValueType;
            },

            /**
             *
             * @param {dudeGraph.RenderBlock} renderBlock
             * @returns {Array<dudeGraph.RenderPoint>|null}
             * @private
             */
            _getEditablePoints: function (renderBlock) {
                if (renderBlock === null) {
                    return null;
                }
                return _.filter(renderBlock.renderPoints, function (renderPoint) {
                    return _.isEmpty(renderPoint.renderConnections) && !(renderPoint.point instanceof dudeGraph.Stream) && !renderPoint.point.isOutput;
                });
            }
        })
    </script>
</dom-module>