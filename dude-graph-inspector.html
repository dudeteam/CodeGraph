<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../dude-collapse/dude-collapse.html">
<link rel="import" href="../dude-property/dude-property.html">
<link rel="import" href="../dude-hierarchy/dude-hierarchy.html">
<link rel="import" href="dude-graph-tool.html">
<link rel="stylesheet" href="../font-awesome/css/font-awesome.css">
<!--
`dude-graph-inspector` is a Polymer element which creates the inspector for dude-graph. In other words, it creates the sidebar that will be used for setting methods and properties.

@group dude-graph
@element dude-graph-inspector
@demo demo/index.html
-->
<dom-module id="dude-graph-inspector">
    <style>
        :root {
            --default-primary-color: var(--dude-primary-color);
            --text-primary-color: var(--dude-primary-text-color);
            --paper-input-container-focus-color: var(--dude-primary-color);
            --paper-input-container-input-color: var(--dude-content-text-color);
        }

        :host {
            background: var(--dude-secondary-background-color);
            overflow: auto;
            padding: 10px 5px 5px;
        }

        dude-collapse {
            padding-top: 5px;
        }
    </style>
    <template>
        <template is="dom-if" if="[[ _loaded ]]">
            <div class="layout vertical flex">
                <dude-collapse heading="Tools">
                    <div class="layout horizontal">
                        <dude-graph-tool class="flex"
                                         icon="fa fa-save"
                                         description="Save"
                                         on-click="_saveGraph">
                        </dude-graph-tool>
                        <dude-graph-tool class="flex"
                                         icon="fa fa-play"
                                         description="Play"
                                         on-click="_playGraph">
                        </dude-graph-tool>
                        <dude-graph-tool class="flex"
                                         icon="fa fa-remove"
                                         description="Remove selection"
                                         on-click="_removeSelection">
                        </dude-graph-tool>
                        <dude-graph-tool class="flex"
                                         icon="fa fa-square-o"
                                         description="Create group for selection"
                                         on-click="_showCreateGroup">
                        </dude-graph-tool>
                        <dude-graph-tool class="flex"
                                         icon="fa fa-compress"
                                         description="Zoom to fit"
                                         on-click="_zoomToFit">
                        </dude-graph-tool>
                    </div>
                </dude-collapse>
                <template is="dom-if" if="[[ _createGroupState ]]">
                    <dude-collapse heading="Create group">
                        <dude-property property-type="string"
                                       property-name="group name"
                                       property-value="{{ _groupName }}"
                                       no-menu>
                        </dude-property>
                        <paper-button on-click="_createGroup">Create</paper-button>
                        <paper-button on-click="_hideCreateGroup">Cancel</paper-button>
                    </dude-collapse>
                </template>
                <dude-collapse heading="Add Block">
                    <dude-hierarchy
                            items="[[ modelData ]]"
                            placeholder="Search blocks to create..."
                            on-dude-hierarchy-item-submit="_createBlockFromModel">
                    </dude-hierarchy>
                </dude-collapse>
                <template is="dom-if" if="[[ _rendererBlock ]]" restamp>
                    <dude-collapse heading="Edit Block">
                        <dude-property property-type="string"
                                       property-name="block name"
                                       property-value="{{ _rendererBlock.cgBlock.cgName }}"
                                       no-menu>
                        </dude-property>
                        <template is="dom-repeat" items="[[Â _getInputs(_rendererBlock) ]]" as="cgPoint">
                            <dude-property property-type="{{ _getType(cgPoint) }}"
                                           property-name="{{ cgPoint.cgName }}"
                                           property-value="{{ cgPoint.cgValue }}"
                                           property-resources="{{ resources }}"
                                           no-reference>
                            </dude-property>
                        </template>
                    </dude-collapse>
                </template>
                <template is="dom-if" if="[[ _rendererGroup ]]" restamp>
                    <dude-collapse heading="Edit Group">
                        <dude-property property-type="string"
                                       property-name="group name"
                                       property-value="{{ _rendererGroup.description }}"
                                       no-menu>
                        </dude-property>
                    </dude-collapse>
                </template>
            </div>
        </template>
    </template>
    <script>
        var DudeGraphInspector = Polymer({

            is: "dude-graph-inspector",

            properties: {
                /**
                 * The DudeGraph element to inspect
                 */
                "dudeGraphEditor": {
                    "type": DudeGraphEditor,
                    "value": null
                },

                /**
                 * The list of blocks that can be added to the dudeGraph
                 */
                "modelData": {
                    "type": Array,
                    "value": []
                },

                /**
                 * The resources list for point cgValue properties
                 */
                "resources": {
                    "type": Array,
                    "value": []
                }
            },

            behaviors: [Polymer.IronA11yKeysBehavior],

            /**
             * Whether the inspector is ready to inspect the dudeGraphEditor
             * @type {Boolean}
             */
            _loaded: false,

            /**
             * The current selected rendererBlock
             * @type {dudeGraph.RenderBlock}
             */
            _rendererBlock: null,

            /**
             * The current selected rendererBlock
             * @type {dudeGraph.RenderGroup}
             */
            _rendererGroup: null,

            /**
             * Whether the createGroup should be displayed
             * @type {Boolean}
             */
            _createGroupState: false,

            /**
             * The group name to be created
             * @type {String}
             */
            _groupName: null,

            /**
             * Call this when the inspected dudeGraphEditor is loaded
             */
            load: function () {
                this.dudeGraphEditor.renderer.on("cg-select", function (rendererNode) {
                    if (rendererNode.type === "block") {
                        this.set("_rendererBlock", rendererNode);
                        this.set("_rendererGroup", null);
                    } else if (rendererNode.type === "group") {
                        this.set("_rendererGroup", rendererNode);
                        this.set("_rendererBlock", null);
                    }
                }.bind(this));
                this.dudeGraphEditor.renderer.on("cg-unselect", function () {
                    this.set("_rendererBlock", null);
                    this.set("_rendererGroup", null);
                }.bind(this));
                this.set("_loaded", true);
                this.keyEventTarget = document.body;
                if (navigator.platform.toUpperCase().indexOf("MAC") !== -1) {
                    this.addOwnKeyBinding("meta+s", "_saveGraph");
                    this.addOwnKeyBinding("meta+b", "_playGraph");
                    this.addOwnKeyBinding("meta+g", "_showCreateGroup");
                    this.addOwnKeyBinding("meta+a", "_selectAll");
                    this.addOwnKeyBinding("meta+alt+a", "_selectAll");
                    this.addOwnKeyBinding("meta+shift+a", "_selectAll");
                    this.addOwnKeyBinding("meta+0", "_zoomToFit");
                    this.addOwnKeyBinding("meta+shift+0", "_zoomToSelection");
                } else {
                    this.addOwnKeyBinding("ctrl+s", "_saveGraph");
                    this.addOwnKeyBinding("ctrl+b", "_playGraph");
                    this.addOwnKeyBinding("ctrl+g", "_showCreateGroup");
                    this.addOwnKeyBinding("ctrl+a", "_selectAll");
                    this.addOwnKeyBinding("ctrl+alt+a", "_selectAll");
                    this.addOwnKeyBinding("ctrl+shift+a", "_selectAll");
                    this.addOwnKeyBinding("ctrl+0", "_zoomToFit");
                    this.addOwnKeyBinding("ctrl+alt+0", "_zoomToSelection");
                }
                this.addOwnKeyBinding("del", "_removeSelection");
            },

            /**
             * Called when clicking on the save button
             * @param {CustomEvent} e
             * @delegate
             * @private
             */
            _saveGraph: function (e) {
                this.fire("dude-graph-inspector-save", this.dudeGraphEditor.save());
                if (e && e.detail && e.detail.keyboardEvent) {
                    e.detail.keyboardEvent.preventDefault();
                }
            },

            /**
             * Called when clicking on the play button
             * @param {CustomEvent} e
             * @delegate
             * @private
             */
            _playGraph: function (e) {
                this.fire("dude-graph-inspector-play");
                if (e && e.detail && e.detail.keyboardEvent) {
                    e.detail.keyboardEvent.preventDefault();
                }
            },

            /**
             * Called when clicking on the remove selection button
             * Removes the selected rendererNodes
             * @param {CustomEvent} e
             * @delegate
             * @private
             */
            _removeSelection: function (e) {
                this.dudeGraphEditor.removeSelection();
                if (e && e.detail && e.detail.keyboardEvent) {
                    e.detail.keyboardEvent.preventDefault();
                }
            },

            /**
             * Called when pressing (cmd+a/ctrl+a)
             * Select all blocks and groups
             * @param {CustomEvent} e
             * @delegate
             * @private
             */
            _selectAll: function (e) {
                var shift = false;
                var alt = false;
                if (e && e.detail && e.detail.keyboardEvent) {
                    shift = e.detail.keyboardEvent.shiftKey;
                    alt = e.detail.keyboardEvent.altKey;
                    e.detail.keyboardEvent.preventDefault();
                }
                this.dudeGraphEditor.selectAll(shift, alt);
            },

            /**
             * Called when clicking on the show create group button
             * Shows the group creation popup
             * @param {CustomEvent} e
             * @delegate
             * @private
             */
            _showCreateGroup: function (e) {
                this.set("_createGroupState", true);
                if (e && e.detail && e.detail.keyboardEvent) {
                    e.detail.keyboardEvent.preventDefault();
                }
            },

            /**
             * Called when clicking on the zoom to fit button
             * @param {CustomEvent} e
             * @delegate
             * @private
             */
            _zoomToFit: function (e) {
                this.dudeGraphEditor.zoomToFit();
                if (e && e.detail && e.detail.keyboardEvent) {
                    e.detail.keyboardEvent.preventDefault();
                }
            },

            /**
             * Called when clicking on the zoom to fit button
             * @param {CustomEvent} e
             * @delegate
             * @private
             */
            _zoomToSelection: function (e) {
                this.dudeGraphEditor.zoomToSelection();
                if (e && e.detail && e.detail.keyboardEvent) {
                    e.detail.keyboardEvent.preventDefault();
                }
            },

            /**
             * Called when clicking on the cancel create group button
             * Hides the group creation popup
             * @delegate
             * @private
             */
            _hideCreateGroup: function () {
                this.set("_createGroupState", false);
            },

            /**
             * Called when clicking on the create group button
             * Creates a rendererGroup
             * @delegate
             * @private
             */
            _createGroup: function () {
                this.dudeGraphEditor.createGroup(this._groupName);
                this.set("_groupName", null);
                this.set("_createGroupState", false);
            },

            /**
             * Called when an item is submitted in dude-hierarchy
             * Creates a block in dudeGraph
             * @param {CustomEvent} e
             * @private
             */
            _createBlockFromModel: function (e) {
                if (e.detail.item.data) {
                    this.dudeGraphEditor.createBlock(e.detail.item.data);
                }
            },

            /**
             * Returns the list of cgInputs that accept property
             * @param {dudeGraph.RendererBlock} rendererBlock
             * @returns {Array<dudeGraph.cgPoint>}
             * @private
             */
            _getInputs: function (rendererBlock) {
                if (rendererBlock === null) {
                    return null;
                }
                return _.filter(rendererBlock.cgBlock.cgInputs, function (cgPoint) {
                    return cgPoint.acceptValue() && cgPoint.cgValueType !== "Stream";
                });
            },

            /**
             * Returns lowercase type of cgPoint
             * @param {dudeGraph.Point} cgPoint
             * @returns {String}
             * @private
             */
            _getType: function (cgPoint) {
                return cgPoint.cgValueType.toLowerCase();
            }
        })
    </script>
</dom-module>