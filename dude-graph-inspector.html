<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
-->
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../dude-hierarchy/dude-hierarchy.html">
<!--
`dude-graph-inspector` is a Polymer element which creates the inspector for dude-graph. In other words, it creates the sidebar that will be used for setting methods and properties.

@group dude-graph
@element dude-graph-inspector
@demo demo/index.html
-->
<dom-module id="dude-graph-inspector">
    <style>
        :root {
            --default-primary-color: var(--dude-primary-color);
            --text-primary-color: var(--dude-primary-text-color);
            --paper-input-container-focus-color: var(--dude-primary-color);
            --paper-input-container-input-color: var(--dude-content-text-color);

            --paper-button: {
                @apply(--dude-button);
            };

            --paper-dialog: {
                @apply(--dude-dialog);
            };
        }

        :host {
            background: var(--dude-secondary-background-color);
            overflow: auto;
            padding: 5px;
        }

        div {
            font-family: var(--dude-primary-text-font);
            color: var(--dude-content-text-color);
        }

        .title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--dude-title-text-color);
            padding-bottom: 10px;
            border-bottom: 2px solid #222222;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .title i {
            color: var(--dude-content-text-color);
            font-size: .8em;
            padding-right: 5px;
        }

        .subtitle {
            color: var(--dude-title-text-color);
            padding-bottom: 10px;
        }

        .box {
            padding: 10px;
        }

        #addGroupDialog {
            min-width: 350px;
        }

        .box paper-button {
            margin: 2px 0;
        }
    </style>
    <template>
        <paper-dialog id="addGroupDialog" modal>
            <div class="title">Add a new group</div>
            <paper-input label="Group description" value="{{_newGroupDescription}}"></paper-input>
            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button on-click="_confirmAddGroup" dialog-confirm>Accept</paper-button>
            </div>
        </paper-dialog>
        <div class="layout vertical flex">
            <div class="box">
                <div class="title">
                    <i class="fa fa-chevron-down"></i>
                    Tools
                </div>
                <paper-button class="primary" on-click="_compile">Compile</paper-button>
                <paper-button class="primary" on-click="_addGroup">Add group</paper-button>
                <paper-button class="primary" on-click="_removeSelection">Remove selection</paper-button>
                <paper-button class="primary" on-click="_save">Save</paper-button>
                <paper-button class="primary" on-click="_zoomToFit">Fit to screen</paper-button>
            </div>
            <!-- .box -->
            <iron-pages class="layout vertical flex" attr-for-selected="data-state" selected="[[ _currentState ]]">
                <div class="layout vertical flex" data-state="root">
                    <div class="box">
                        <div class="title">
                            <i class="fa fa-chevron-down"></i>
                            Add block
                        </div>
                        <dude-hierarchy id="blocks" on-submit="_createBlock"></dude-hierarchy>
                    </div>
                    <!-- .box -->
                    <div class="box">
                        <div class="title">
                            <i class="fa fa-chevron-down"></i>
                            Create variable
                        </div>
                        <div class="row">
                            <label>type</label>
                            <paper-dropdown-menu label="Choose..." selected-item-label="{{_varType}}" no-label-float>
                                <paper-menu class="dropdown-content">
                                    <paper-item>Boolean</paper-item>
                                    <paper-item>Number</paper-item>
                                    <paper-item>String</paper-item>
                                </paper-menu>
                            </paper-dropdown-menu>
                        </div>
                        <div class="row">
                            <label>name</label>
                            <input is="iron-input" bind-value="{{_varName}}" type="text">
                        </div>
                        <div class="row">
                            <label>value</label>
                            <input is="iron-input" bind-value="{{_varValue}}" type="text">
                        </div>
                        <paper-button class="primary" on-click="_createVariableClicked">Create</paper-button>
                    </div>
                    <!-- .box -->
                </div>
                <!-- root -->
                <div data-state="editGroup">
                    <div class="box">
                        <div class="title">
                            <i class="fa fa-chevron-down"></i>
                            Edit group
                        </div>
                        <div class="row">
                            <label>description</label>
                            <input is="iron-input" bind-value="{{_groupDescription}}" placeholder="Group description..."
                                   type="text">
                        </div>
                        <paper-button class="primary" on-click="_editGroupClicked">Edit</paper-button>
                    </div>
                    <!-- .box -->

                </div>
                <!-- Edit group -->
                <div data-state="editBlock">
                    <div class="box">
                        <div class="title">
                            <i class="fa fa-chevron-down"></i>
                            Edit block
                        </div>
                        <div class="row">
                            <label>name</label>
                            <input is="iron-input" bind-value="{{_blockName}}" type="text">
                        </div>
                        <div class="subtitle" hidden$="{{_blockNoInput}}">Inputs</div>
                        <div class="row">
                            <template is="dom-repeat" id="menu" items="{{_blockInputs}}">
                                <label>{{item.cgName}}</label>
                                <input is="iron-input" bind-value="{{item.cgValue}}" type="text">
                            </template>
                        </div>
                        <paper-button class="primary" on-click="_editBlockClicked">Edit</paper-button>
                    </div>
                    <!-- .box -->
                </div>
                <!-- Edit block -->
                <div data-state="editValue">
                    <div class="box">
                        <div class="title">
                            <i class="fa fa-chevron-down"></i>
                            Edit value
                        </div>
                        <div class="row">
                            <label>value</label>
                            <input is="iron-input" bind-value="{{_value}}" type="text">
                        </div>
                        <paper-button class="primary" on-click="_editValueClicked">Edit</paper-button>
                    </div>
                    <!-- .box -->
                </div>
                <!-- Edit value -->
                <div data-state="editVariable">
                    <div class="box">
                        <div class="title">
                            <i class="fa fa-chevron-down"></i>
                            Edit variable
                        </div>
                        <div class="row">
                            <label>name</label>
                            <input is="iron-input" bind-value="{{_varName}}" type="text">
                        </div>
                        <div class="row">
                            <label>value</label>
                            <input is="iron-input" bind-value="{{_varValue}}" type="text">
                        </div>
                        <paper-button class="primary" on-click="_editVariableClicked">Edit</paper-button>
                    </div>
                    <!-- .box -->
                </div>
                <!-- Edit variable -->
            </iron-pages>
        </div>
    </template>
    <script>
        var CgInspector = Polymer({

            is: "dude-graph-inspector",

            properties: {
                models: {
                    type: Object,
                    value: {}
                },
                element: {
                    type: CgElement
                }
            },
            ready: function () {
                this._blocksTree = [];
                this._folders = {};
                this._selectedNode = null;
                this._currentState = "root";
                this._varType = "";
                this._varName = "";
                this._varValue = "";
                this._varFolder = "";
                _.forEach(this.models, function (value, key) {
                    var icon = ["Value", "Variable"].indexOf(value.cgType) === -1 ? "fa fa-square" : "fa fa-circle";
                    if (value.cgFolder) {
                        if (this._folders[value.cgFolder] === undefined) {
                            this._folders[value.cgFolder] = {
                                group: {
                                    name: value.cgFolder,
                                    icon: "fa fa-folder",
                                    items: []
                                }
                            };
                            this._blocksTree.push(this._folders[value.cgFolder]);
                        }
                        this._folders[value.cgFolder].group.items.push({item: {name: key, icon: icon, data: value}});
                    } else {
                        this._blocksTree.push({item: {name: key, icon: icon, data: value}});
                    }
                }.bind(this));
                this._blocksTree.unshift({
                    group: {
                        name: "control", icon: "fa fa-folder", items: [
                            {item: {name: "Condition", icon: "fa fa-square", data: {"cgType": "Condition"}}},
                            {item: {name: "Each", icon: "fa fa-square", data: {"cgType": "Each"}}},
                            {item: {name: "Range", icon: "fa fa-square", data: {"cgType": "Range"}}}
                        ]
                    }
                });
                this._customVariables = {group: {name: "custom variables", icon: "fa fa-folder", items: []}};
                this._blocksTree.unshift(this._customVariables);
                this._blocksTree.unshift({
                    item: {
                        name: "Assignation", icon: "fa fa-plus-square", data: {
                            "cgType": "Assignation"
                        }
                    }
                });
                this.$.blocks.loadItems(this._blocksTree);
            },
            getHierarchy: function () {
                return this.$.blocks;
            },
            bindBuilder: function (builder) {
                this._builder = builder;
            },
            bindElement: function (element) {
                this.element = element;
                _.forEach(this.element.graph.blocksByType("Variable"), this.addVariable.bind(this));
                this.$.blocks.loadItems(this._blocksTree);
                this.element.renderer.on("cg-select", function (node) {
                    this._selectedNode = node;
                    if (node.type === "block") {
                        switch (node.cgBlock.blockType) {
                            case "Variable":
                                this._currentState = "editVariable";
                                this._varName = node.cgBlock.cgName;
                                this._varValue = node.cgBlock.cgValue;
                                break;
                            case "Value":
                                this._currentState = "editValue";
                                this._value = node.cgBlock.cgValue;
                                break;
                            default:
                                this._currentState = "editBlock";
                                this._blockName = node.cgBlock.cgName;
                                this._blockInputs = node.cgBlock.cgInputs.filter(function (point) {
                                    return point.pointType === "Point";
                                }).map(function (point) {
                                    return {
                                        cgName: point.cgName,
                                        cgValue: point.cgValue
                                    };
                                });
                                this._blockNoInput = this._blockInputs.length === 0;
                        }
                    } else if (node.type === "group") {
                        this._currentState = "editGroup";
                        this._groupDescription = node.description;
                    }
                }.bind(this));
                this.element.renderer.on("cg-unselect", function () {
                    this._currentState = "root";
                }.bind(this));
            },
            addVariable: function (variable) {
                this._customVariables.group.items.push({
                    item: {
                        name: variable.cgName,
                        icon: "fa fa-circle",
                        data: variable
                    }
                });
            },
            _createBlock: function (e) {
                if (e.detail.item.group) {
                    return;
                }
                if (e.detail.item !== null) {
                    if (e.detail.item.data.blockType === "Variable") {
                        this.element.renderer.createRendererBlock(e.detail.item.data);
                    } else {
                        var data = Object.create(e.detail.item.data);
                        if (e.detail.item.data.cgType === "Assignation") {
                            data.cgValueType = "Boolean"; // TODO: replace hard-coded value
                        } else {
                            data.cgName = e.detail.item.name;
                        }
                        data.cgId = dudeGraph.UUID.generate();
                        this.element.graph.loader.loadBlock(data);
                    }
                }
            },
            _createVariableClicked: function () {
                if (!this._varType) {
                    this.fire("error", {message: "A `type` is required to create a variable"});
                    return;
                }
                if (!this._varName) {
                    this.fire("error", {message: "A `name` is required to create a variable"});
                    return;
                }
                var variable = new dudeGraph.Variable(this.element.graph, {
                    cgId: dudeGraph.UUID.generate(),
                    cgName: this._varName,
                    cgValueType: this._varType,
                    cgValue: this._varValue
                });
                this.element.graph.addBlock(variable, true);
                this.addVariable(variable);
                this.$.blocks.loadItems(this._blocksTree); // Refresh the list
                this._varName = "";
                this._varValue = "";
            },
            _editVariableClicked: function () {
                this._selectedNode.cgBlock.cgName = this._varName;
                this._selectedNode.cgBlock.cgValue = this._varValue;
            },
            _editValueClicked: function () {
                this._selectedNode.cgBlock.cgValue = this._varValue;
            },
            _editBlockClicked: function () {
                this._selectedNode.cgBlock.cgName = this._blockName;
                _.forEach(this._blockInputs, function (input) {
                    if (input.cgValue && input.cgValue !== "") {
                        // TODO: Handle difference between "" and null
                        this._selectedNode.cgBlock.inputByName(input.cgName).cgValue = input.cgValue;
                    } else {
                        this._selectedNode.cgBlock.inputByName(input.cgName).cgValue = null;
                    }
                }.bind(this));
            },
            _editGroupClicked: function () {
                this._selectedNode.description = this._groupDescription;
                this.element.renderer._updateD3Groups(); // TODO: Public API
            },
            _compile: function () {
                try {
                    this.fire("compile", this._builder.save(this.element.graph));
                } catch (e) {
                    this.fire("error", {error: e, message: e.message});
                }
            },
            _addGroup: function () {
                this.$.addGroupDialog.open();
            },
            _confirmAddGroup: function () {
                this.element.renderer.createGroupFromSelection(this._newGroupDescription);
                this._newGroupDescription = "";
            },
            _removeSelection: function () {
                this.element.renderer.removeSelection();
                this._currentState = "root";
            },
            _save: function () {
                try {
                    this.fire("save", new dudeGraph.JSONSaver().save(this.element.renderer, this.element.graph));
                } catch (e) {
                    this.fire("error", {error: e, message: e.message});
                }
            },
            _zoomToFit: function () {
                this.element.renderer.zoomToFit();
            }
        });
    </script>
</dom-module>