<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../dude-collapse/dude-collapse.html">
<link rel="import" href="../dude-property/dude-property.html">
<link rel="import" href="../dude-hierarchy/dude-hierarchy.html">
<link rel="stylesheet" href="../font-awesome/css/font-awesome.css">
<link rel="import" href="dude-graph-tool.html">
<!--
`dude-graph-inspector` is a Polymer element which creates the inspector for dude-graph. In other words, it creates the sidebar that will be used for setting methods and properties.

@group dude-graph
@element dude-graph-inspector
@demo demo/index.html
-->
<dom-module id="dude-graph-inspector">
    <style>
        :root {
            --default-primary-color: var(--dude-primary-color);
            --text-primary-color: var(--dude-primary-text-color);
            --paper-input-container-focus-color: var(--dude-primary-color);
            --paper-input-container-input-color: var(--dude-content-text-color);

            --paper-button: {
                @apply(--dude-button);
            };

            --paper-dialog: {
                @apply(--dude-dialog);
            };
        }

        :host {
            background: var(--dude-secondary-background-color);
            overflow: auto;
            padding: 10px 5px 5px;
        }
    </style>
    <template>
        <div class="layout vertical flex">
            <dude-collapse title="Tools">
                <div class="layout horizontal">
                    <dude-graph-tool class="flex"
                                     icon="fa fa-play"
                                     description="Build"
                                     on-click="_buildGraph">
                    </dude-graph-tool>
                    <dude-graph-tool class="flex"
                                     icon="fa fa-square-o"
                                     description="Add group"
                                     on-click="_showCreateGroup">
                    </dude-graph-tool>
                    <dude-graph-tool class="flex"
                                     icon="fa fa-remove"
                                     description="Remove selection"
                                     on-click="_removeSelection">
                    </dude-graph-tool>
                    <dude-graph-tool class="flex"
                                     icon="fa fa-save"
                                     description="Save"
                                     on-click="_saveGraph">
                    </dude-graph-tool>
                    <dude-graph-tool class="flex"
                                     icon="fa fa-compress"
                                     description="Zoom to fit"
                                     on-click="_zoomToFit">
                    </dude-graph-tool>
                </div>
            </dude-collapse>
            <dude-collapse title="Add Block">
                <dude-hierarchy
                        items="[[ modelData ]]"
                        placeholder="Search block to create..."
                        on-dude-hierarchy-item-submit="_createBlockFromModel">
                </dude-hierarchy>
            </dude-collapse>
            <template is="dom-if" if="[[ _rendererBlock ]]" restamp>
                <dude-collapse title="Edit Block">
                    <input
                            is="input"
                            type="text"
                            value="{{ _rendererBlock.cgBlock.cgName::input }}"
                            bind-value="[[ _rendererBlock.cgBlock.cgName ]]" />
                    <template is="dom-repeat" items="[[Â _getInputs(_rendererBlock) ]]" as="cgPoint">
                        <dude-property property-type="{{ _getType(cgPoint) }}"
                                       property-name="{{ cgPoint.cgName }}"
                                       property-value="{{ cgPoint.cgValue }}"
                                       no-reference>
                        </dude-property>
                    </template>
                </dude-collapse>
            </template>
            <template is="dom-if" if="[[ _rendererGroup ]]" restamp>
                <dude-collapse title="Edit Group">
                    <input
                            is="input"
                            type="text"
                            value="{{ _rendererGroup.description::input }}"
                            bind-value="[[ _rendererGroup.description ]]"/>
                </dude-collapse>
            </template>
            <template is="dom-if" if="[[ _createGroupState ]]">
                <dude-collapse title="Create group">
                    <input
                            is="input"
                            type="text"
                            value="{{ _groupName::input }}"
                            bind-value="[[ _groupName ]]"/>
                    <paper-button on-click="_createGroup">Create</paper-button>
                </dude-collapse>
            </template>
        </div>
    </template>
    <script>
        var DudeGraphInspector = Polymer({
            is: "dude-graph-inspector",

            properties: {
                /**
                 * The DudeGraph element to inspect
                 */
                "dudeGraphEditor": {
                    "type": DudeGraphEditor,
                    "value": null
                },

                /**
                 * The list of blocks that can be added to the dudeGraph
                 */
                "modelData": {
                    "type": Array,
                    "value": []
                },

                /**
                 * The graph saver
                 */
                "saver": {
                    "type": Function,
                    "value": null
                }
            },

            /**
             * The current selected rendererBlock
             * @type {dudeGraph.RendererBlock}
             */
            _rendererBlock: null,

            /**
             * The current selected rendererBlock
             * @type {dudeGraph.RendererGroup}
             */
            _rendererGroup: null,

            /**
             * Whether the createGroup should be displayed
             * @type {Boolean}
             */
            _createGroupState: false,

            /**
             * The group name to be created
             * @type {String}
             */
            _groupName: null,

            /**
             * Called when the dudeGraphInspector element is ready and attached
             * @delegate
             */
            attached: function () {
                this.dudeGraphEditor.renderer.on("cg-select", function (rendererNode) {
                    if (rendererNode.type === "block") {
                        this.set("_rendererBlock", rendererNode);
                        this.set("_rendererGroup", null);
                    } else if (rendererNode.type === "group") {
                        this.set("_rendererGroup", rendererNode);
                        this.set("_rendererBlock", null);
                    }
                }.bind(this));
                this.dudeGraphEditor.renderer.on("cg-unselect", function () {
                    this.set("_rendererBlock", null);
                    this.set("_rendererGroup", null);
                }.bind(this));
            },

            /**
             * Called when an item is submitted in dude-hierarchy
             * Creates a block in dudeGraph
             * @param {CustomEvent} e
             * @private
             */
            _createBlockFromModel: function (e) {
                if (e.detail.item.data) {
                    this.dudeGraphEditor.createBlock(e.detail.item.data);
                }
            },

            /**
             * Called when clicking on the show create group button
             * Shows the group creation popup
             * @delegate
             * @private
             */
            _showCreateGroup: function () {
                this.set("_createGroupState", true);
            },

            /**
             * Called when clicking on the create group button
             * Creates a rendererGroup
             * @delegate
             * @private
             */
            _createGroup: function () {
                this.dudeGraphEditor.createGroup(this._groupName);
                this.set("_groupName", null);
                this.set("_createGroupState", false);
            },

            /**
             * Called when clicking on the remove selection button
             * Removes the selected rendererNodes
             * @delegate
             * @private
             */
            _removeSelection: function () {
                this.dudeGraphEditor.removeSelection();
            },

            /**
             * Called when clicking on the zoom to fit button
             * @delegate
             * @private
             */
            _zoomToFit: function () {
                this.dudeGraphEditor.zoomToFit();
            },

            /**
             * Returns the list of cgInputs that accept property
             * @param {dudeGraph.RendererBlock} rendererBlock
             * @returns {Array<dudeGraph.cgPoint>}
             * @private
             */
            _getInputs: function (rendererBlock) {
                if (rendererBlock === null) {
                    return null;
                }
                return _.filter(rendererBlock.cgBlock.cgInputs, function (cgPoint) {
                    return cgPoint.acceptValue() && cgPoint.cgValueType !== "Stream";
                });
            },

            /**
             * Returns lowercase type of cgPoint
             * @param {dudeGraph.Point} cgPoint
             * @returns {String}
             * @private
             */
            _getType: function (cgPoint) {
                return cgPoint.cgValueType.toLowerCase();
            }
        })
    </script>
</dom-module>