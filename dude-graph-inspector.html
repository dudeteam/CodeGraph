<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../dude-collapse/dude-collapse.html">
<link rel="import" href="../dude-property/dude-property.html">
<link rel="import" href="../dude-hierarchy/dude-hierarchy.html">
<link rel="import" href="../dude-popup/dude-popup.html">
<link rel="import" href="dude-graph-tool.html">
<link rel="stylesheet" href="../font-awesome/css/font-awesome.css">
<!--
`dude-graph-inspector` is a Polymer element which creates the inspector for dude-graph. In other words, it creates the sidebar that will be used for setting methods and properties.

@group dude-graph
@element dude-graph-inspector
@demo demo/index.html
-->
<dom-module id="dude-graph-inspector">
    <style>
        :root {
            --default-primary-color: var(--dude-primary-color);
            --text-primary-color: var(--dude-primary-text-color);
            --paper-input-container-focus-color: var(--dude-primary-color);
            --paper-input-container-input-color: var(--dude-content-text-color);
        }

        :host {
            background: var(--dude-secondary-background-color);
            overflow: auto;
            padding: 10px 5px 5px;
        }

        dude-collapse {
            padding-top: 5px;
        }

        #completionHierarchy {
            padding: 10px;
            background: rgba(30, 30, 30, .8);
        }
    </style>
    <template>
        <template is="dom-if" if="[[ _loaded ]]">
            <div class="layout vertical flex">
                <dude-collapse heading="Tools">
                    <div class="layout horizontal">
                        <dude-graph-tool class="flex"
                                         icon="fa fa-save"
                                         description="Save"
                                         on-click="_saveGraph">
                        </dude-graph-tool>
                        <dude-graph-tool class="flex"
                                         icon="fa fa-play"
                                         description="Play"
                                         on-click="_playGraph">
                        </dude-graph-tool>
                        <dude-graph-tool class="flex"
                                         icon="fa fa-remove"
                                         description="Remove selection"
                                         on-click="_removeSelection">
                        </dude-graph-tool>
                        <dude-graph-tool class="flex"
                                         icon="fa fa-square-o"
                                         description="Create group for selection"
                                         on-click="_showCreateGroup">
                        </dude-graph-tool>
                        <dude-graph-tool class="flex"
                                         icon="fa fa-compress"
                                         description="Zoom to fit"
                                         on-click="_zoomToFit">
                        </dude-graph-tool>
                    </div>
                </dude-collapse>
                <template is="dom-if" if="[[ _createGroupState ]]">
                    <dude-collapse heading="Create group">
                        <dude-property property-type="string"
                                       property-name="group name"
                                       property-value="{{ _groupName }}"
                                       no-menu>
                        </dude-property>
                        <paper-button on-click="_createGroup">Create</paper-button>
                        <paper-button on-click="_hideCreateGroup">Cancel</paper-button>
                    </dude-collapse>
                </template>
                <dude-collapse heading="Add Block">
                    <dude-hierarchy
                            items="[[ modelData ]]"
                            placeholder="Search blocks to create..."
                            on-dude-hierarchy-item-submit="_createBlockFromModel">
                    </dude-hierarchy>
                </dude-collapse>
                <template is="dom-if" if="[[ _renderBlock ]]" restamp>
                    <dude-collapse heading="Edit Block">
                        <dude-property property-type="string"
                                       property-name="block name"
                                       property-value="{{ _renderBlock.nodeName }}"
                                       no-menu>
                        </dude-property>
                        <template is="dom-repeat" items="[[Â _getPointInputs(_renderBlock) ]]" as="renderPoint">
                            <template is="dom-if" if="[[ _isPointType(renderPoint, 'Choice') ]]">
                                <dude-property property-type="choice"
                                               property-name="{{ renderPoint.point.cgName }}"
                                               property-value="{{ renderPoint.point.value }}"
                                               property-choice="{{ renderPoint.point.choices }}"
                                               no-reference>
                                </dude-property>
                            </template>
                            <template is="dom-if" if="[[ !_isPointType(renderPoint, 'Choice') ]]">
                                <dude-property property-type="{{ _getPointType(renderPoint) }}"
                                               property-name="{{ renderPoint.point.cgName }}"
                                               property-value="{{ renderPoint.point.cgValue }}"
                                               property-resources="{{ resources }}"
                                               no-reference>
                                </dude-property>
                            </template>
                        </template>
                    </dude-collapse>
                </template>
                <template is="dom-if" if="[[ _renderGroup ]]" restamp>
                    <dude-collapse heading="Edit Group">
                        <dude-property property-type="string"
                                       property-name="group name"
                                       property-value="{{ _renderGroup.nodeName }}"
                                       no-menu>
                        </dude-property>
                    </dude-collapse>
                </template>
            </div>
        </template>
        <dude-popup id="completionPopup">
            <dude-hierarchy id="completionHierarchy"
                            items="{{ _completionItems }}"
                            on-dude-hierarchy-item-submit="_createBlockFromModelAndPoint">
            </dude-hierarchy>
        </dude-popup>
    </template>
    <script>
        var DudeGraphInspector = Polymer({


            is: "dude-graph-inspector",

            properties: {
                /**
                 * The DudeGraph element to inspect
                 */
                "editor": {
                    "type": DudeGraphEditor,
                    "value": null
                },
                /**
                 * The list of blocks that can be added to the dudeGraph
                 */
                "modelData": {
                    "type": Array,
                    "value": []
                },

                /**
                 * The resources list for point cgValue properties
                 */
                "resources": {
                    "type": Array,
                    "value": []
                },

            },

            behaviors: [Polymer.IronA11yKeysBehavior],
            /**
             * Whether the inspector is ready to inspect the editor
             * @type {Boolean}
             */
            _loaded: false,

            /**
             * The current selected renderBlock
             * @type {dudeGraph.RenderBlock}
             */
            _renderBlock: null,

            /**
             * The current selected renderGroup
             * @type {dudeGraph.RenderGroup}
             */
            _renderGroup: null,

            /**
             * Whether the createGroup should be displayed
             * @type {Boolean}
             */
            _createGroupState: false,

            /**
             * The group name to be created
             * @type {String}
             */
            _groupName: null,

            /**
             * Call this when the inspected editor is loaded
             */
            load: function () {
                this.editor.renderer.on("drop-connection", function (renderConnection, position) {
                    this._lastConnectionPoint = renderConnection.outputRenderPoint.point;
                    var blocks = _.filter(this.editor.graph.cgBlocks, function (block) {
                        return _.find(block.cgInputs, function (input) {
                            return input.cgValueType === renderConnection.outputRenderPoint.point.cgValueType;
                        });
                    });
                    this.set("_completionItems", _.map(blocks, function (block) {
                        return {item: {name: block.cgName}};
                    }));
                    this.$["completionPopup"].open(position[0], position[1]);
                    this.$["completionHierarchy"].focus();
                }.bind(this));
                this.editor.renderer.on("select", function (renderNode) {
                    if (renderNode instanceof dudeGraph.RenderBlock) {
                        this.set("_renderBlock", renderNode);
                        this.set("_renderGroup", null);
                    } else if (renderNode instanceof dudeGraph.RenderGroup) {
                        this.set("_renderGroup", renderNode);
                        this.set("_renderBlock", null);
                    }
                }.bind(this));
                this.editor.renderer.on("unselect", function (renderNode) {
                    if (this.get("_renderBlock") === renderNode) {
                        this.set("_renderBlock", null);
                    } else if (this.get("_renderGroup") === renderNode) {
                        this.set("_renderGroup", null);
                    }
                }.bind(this));
                this.editor.renderer.on("unselect-all", function () {
                    this.set("_renderBlock", null);
                    this.set("_renderGroup", null);
                }.bind(this));
                var resetRenderBlockPoints = function () {
                    var renderBlock = this.get("_renderBlock");
                    var renderGroup = this.get("_renderGroup");
                    this.set("_renderBlock", null);
                    this.set("_renderGroup", null);
                    this.set("_renderBlock", renderBlock);
                    this.set("_renderGroup", renderGroup);
                }.bind(this);
                this.editor.graph.on("dude-graph-connection-create", resetRenderBlockPoints);
                this.editor.graph.on("dude-graph-connection-remove", resetRenderBlockPoints);
                this.keyEventTarget = document.body;
                if (navigator.platform.toUpperCase().indexOf("MAC") !== -1) {
                    this.addOwnKeyBinding("meta+s", "_saveGraph");
                    this.addOwnKeyBinding("meta+b", "_playGraph");
                    this.addOwnKeyBinding("meta+g", "_showCreateGroup");
                    this.addOwnKeyBinding("meta+a", "_selectAll");
                    this.addOwnKeyBinding("meta+alt+a", "_selectAll");
                    this.addOwnKeyBinding("meta+shift+a", "_selectAll");
                    this.addOwnKeyBinding("meta+0", "_zoomToFit");
                    this.addOwnKeyBinding("meta+shift+0", "_zoomToSelection");
                } else {
                    this.addOwnKeyBinding("ctrl+s", "_saveGraph");
                    this.addOwnKeyBinding("ctrl+b", "_playGraph");
                    this.addOwnKeyBinding("ctrl+g", "_showCreateGroup");
                    this.addOwnKeyBinding("ctrl+a", "_selectAll");
                    this.addOwnKeyBinding("ctrl+alt+a", "_selectAll");
                    this.addOwnKeyBinding("ctrl+shift+a", "_selectAll");
                    this.addOwnKeyBinding("ctrl+0", "_zoomToFit");
                    if (navigator.platform.toUpperCase().indexOf("WIN") !== -1) {
                        this.addOwnKeyBinding("ctrl+alt+0", "_zoomToSelection");
                    } else {
                        this.addOwnKeyBinding("ctrl+shift+0", "_zoomToSelection");
                    }
                }
                this.addOwnKeyBinding("del", "_removeSelection");
                this.addOwnKeyBinding("esc", "_closePopup");
                this.set("_loaded", true);
            },

            /**
             * Closes the completion popup if open.
             */
            _closePopup: function () {
                this.$["completionPopup"].close();
            },

            /**
             * Called when clicking on the save button
             * @param {CustomEvent} e
             * @delegate
             * @private
             */
            _saveGraph: function (e) {
                this.fire("dude-graph-inspector-save", this.editor.save());
                if (e && e.detail && e.detail.keyboardEvent) {
                    e.detail.keyboardEvent.preventDefault();
                }
            },

            /**
             * Called when clicking on the play button
             * @param {CustomEvent} e
             * @delegate
             * @private
             */
            _playGraph: function (e) {
                this.fire("dude-graph-inspector-play");
                if (e && e.detail && e.detail.keyboardEvent) {
                    e.detail.keyboardEvent.preventDefault();
                }
            },

            /**
             * Called when clicking on the remove selection button
             * Removes the selected renderNodes
             * @param {CustomEvent} e
             * @delegate
             * @private
             */
            _removeSelection: function (e) {
                this.editor.removeSelection();
                if (e && e.detail && e.detail.keyboardEvent) {
                    e.detail.keyboardEvent.preventDefault();
                }
            },

            /**
             * Called when pressing (cmd+a/ctrl+a)
             * Select all blocks and groups
             * @param {CustomEvent} e
             * @delegate
             * @private
             */
            _selectAll: function (e) {
                var shift = false;
                var alt = false;
                if (e && e.detail && e.detail.keyboardEvent) {
                    shift = e.detail.keyboardEvent.shiftKey;
                    alt = e.detail.keyboardEvent.altKey;
                    e.detail.keyboardEvent.preventDefault();
                }
                this.editor.selectAll(alt, shift);
            },

            /**
             * Called when clicking on the show create group button
             * Shows the group creation popup
             * @param {CustomEvent} e
             * @delegate
             * @private
             */
            _showCreateGroup: function (e) {
                this.set("_createGroupState", true);
                if (e && e.detail && e.detail.keyboardEvent) {
                    e.detail.keyboardEvent.preventDefault();
                }
            },

            /**
             * Called when clicking on the zoom to fit button
             * @param {CustomEvent} e
             * @delegate
             * @private
             */
            _zoomToFit: function (e) {
                this.editor.zoomToFit();
                if (e && e.detail && e.detail.keyboardEvent) {
                    e.detail.keyboardEvent.preventDefault();
                }
            },

            /**
             * Called when clicking on the zoom to fit button
             * @param {CustomEvent} e
             * @delegate
             * @private
             */
            _zoomToSelection: function (e) {
                this.editor.zoomToFitSelection();
                if (e && e.detail && e.detail.keyboardEvent) {
                    e.detail.keyboardEvent.preventDefault();
                }
            },

            /**
             * Called when clicking on the cancel create group button
             * Hides the group creation popup
             * @delegate
             * @private
             */
            _hideCreateGroup: function () {
                this.set("_createGroupState", false);
            },

            /**
             * Called when clicking on the create group button
             * Creates a renderGroup
             * @delegate
             * @private
             */
            _createGroup: function () {
                this.editor.createGroup(this._groupName);
                this.set("_groupName", null);
                this.set("_createGroupState", false);
            },

            /**
             * Called when an item is submitted in dude-hierarchy
             * Creates a block in dudeGraph
             * @param {CustomEvent} e
             * @private
             */
            _createBlockFromModel: function (e) {
                if (e.detail.item.data) {
                    this.editor.createBlock(e.detail.item.data);
                }
            },

            /**
             * Called when an item is submitted in dude-hierarchy
             * Creates a block in dudeGraph
             * @param {CustomEvent} e
             * @private
             */
            _createBlockFromModelAndPoint: function (e) {
                if (e.detail.item.data) {
                    this.editor.createBlock(e.detail.item.data);
                }
//                console.log(this._lastConnectionPoint);
//                var connection = renderPointFound.point.connect(renderPoint._point);
//                renderPoint._renderer.createRenderConnection({
//                    "cgConnectionIndex": renderPoint._renderer.graph.cgConnections.indexOf(connection),
//                    "outputRendererBlockId": renderPoint._point.isOutput ? renderPoint._renderBlock.nodeId : renderPointFound.renderBlock.nodeId,
//                    "inputRendererBlockId": renderPoint._point.isOutput ? renderPointFound.renderBlock.nodeId : renderPoint._renderBlock.nodeId
//                });
            },

            /**
             * Returns the list of renderPoints og the given renderBlock that accept properties
             * @param {dudeGraph.RenderBlock} renderBlock
             * @returns {Array<dudeGraph.RenderPoint>}
             * @private
             */
            _getPointInputs: function (renderBlock) {
                if (renderBlock === null) {
                    return null;
                }
                return _.filter(renderBlock.renderPoints, function (renderPoint) {
                    return _.isEmpty(renderPoint.renderConnections) && !(renderPoint.point instanceof dudeGraph.Stream) && !renderPoint.point.isOutput;
                });
            },

            /**
             * Returns lowercase type of renderPoint
             * @param {dudeGraph.RenderPoint} renderPoint
             * @returns {String}
             * @private
             */
            _getPointType: function (renderPoint) {
                return renderPoint.point.cgValueType.toLowerCase();
            },

            /**
             * Returns whether the renderPoint is of the given type
             * @param {dudeGraph.RenderPoint} renderPoint
             * @param {String} cgValueType
             * @returns {Boolean}
             * @private
             */
            _isPointType: function (renderPoint, cgValueType) {
                return renderPoint.point.cgValueType === cgValueType;
            }
        })
    </script>
</dom-module>