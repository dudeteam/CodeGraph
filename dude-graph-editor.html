<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
-->
<link rel="import" href="../polymer/polymer.html">
<script src="../d3/d3.js"></script>
<script src="../lodash/lodash.min.js"></script>
<script src="../eventEmitter/EventEmitter.min.js"></script>
<script src="dude-graph.js"></script>
<!--
`dude-graph-editor` is a Polymer element which creates a dudeGraph svg renderer which can be manipulated using several methods and properties.

@group dude-graph-editor
@element dude-graph
@demo demo/index.html
-->
<dom-module id="dude-graph-editor">
    <style>
        /**
         * SVG viewport
         */
        #svg {
            background: var(--dude-secondary-background-color);
        }

        /**
         * Non clickable
         */
        ::content .dude-graph-non-clickable {
            pointer-events: none;
        }

        /**
         * Typography
         */
        ::content text {
            fill: var(--dude-content-text-color);
            font-family: var(--dude-primary-text-font);
        }

        ::content .dude-graph-title {
            fill: var(--dude-title-text-color);
            font-weight: bold;
        }

        /**
         * Selection brush
         */
        ::content .dude-graph-selection {
            fill: hsla(0, 0%, 80%, 0.1);
            stroke: hsla(0, 0%, 80%, 0.2);
        }

        /**
         * Groups
         */
        ::content .dude-graph-group > rect {
            @apply(--dude-graph-group);
        }

        ::content .dude-graph-group:hover > rect {
            @apply(--dude-graph-group-hover)
        }

        ::content .dude-graph-group.dude-graph-selected > rect,
        ::content .dude-graph-group.dude-graph-active > rect {
            @apply(--dude-graph-group-selected);
        }

        /**
         * Blocks
         */
        ::content .dude-graph-block > rect {
            @apply(--dude-graph-block);
        }

        ::content .dude-graph-block:hover > rect {
            @apply(--dude-graph-block-hover);
        }

        ::content .dude-graph-block.dude-graph-selected > rect {
            @apply(--dude-graph-block-selected);
        }

        /**
         * Blocks and groups
         */
        ::content .dude-graph-block,
        ::content .dude-graph-group {
            cursor: move;
        }

        /**
         * Points
         */
        ::content .dude-graph-input,
        ::content .dude-graph-output {
            cursor: pointer;
        }

        ::content .dude-graph-input path,
        ::content .dude-graph-output path {
            stroke-width: 1;
            stroke: var(--dude-type-color);
            fill: var(--dude-type-color);
        }

        ::content .dude-graph-input.dude-graph-empty path,
        ::content .dude-graph-output.dude-graph-empty path {
            fill: transparent !important;
        }

        /**
         * Connections
         */
        ::content .dude-graph-connection {
            stroke-width: 2px;
            stroke: var(--dude-type-color);
            fill: transparent;
        }
    </style>
    <template>
        <div class="layout flex horizontal">
            <svg id="svg" class="flex"></svg>
        </div>
    </template>
</dom-module>
<script>
    var DudeGraphEditor = Polymer({

        is: "dude-graph-editor",

        properties: {
            /**
             * Holds a reference on the graph.
             */
            "graph": {
                "type": dudeGraph.Graph,
                "value": null
            },

            /**
             * Holds a reference on the renderer.
             */
            "renderer": {
                "type": dudeGraph.Renderer,
                "value": null
            },

            /**
             * Holds a reference on the loader.
             */
            "loader": {
                "type": dudeGraph.Loader,
                "value": null
            },

            /**
             * Holds a reference on the saver.
             */
            "saver": {
                "type": dudeGraph.Saver,
                "value": null
            },

            /**
             * This JSON represents the graph data for a given dudeGraph.
             */
            "graphData": {
                "type": Object,
                "value": null
            },

            /**
             * This JSON represents the graphical blocks to render.
             */
            "rendererData": {
                "type": Object,
                "value": null
            },

            /**
             * This JSON contains some config for the renderer style.
             */
            "rendererConfig": {
                "type": Object,
                "value": {}
            },

            /**
             * The block types
             */
            "blockTypes": {
                "type": Array,
                "value": [
                    {"block": "Assignation", "type": dudeGraph.Assignation},
                    {"block": "Condition", "type": dudeGraph.Condition},
                    {"block": "Delegate", "type": dudeGraph.Delegate},
                    {"block": "Each", "type": dudeGraph.Each},
                    {"block": "Function", "type": dudeGraph.Function},
                    {"block": "Getter", "type": dudeGraph.Getter},
                    {"block": "Instruction", "type": dudeGraph.Instruction},
                    {"block": "Operator", "type": dudeGraph.Operator},
                    {"block": "Range", "type": dudeGraph.Range},
                    {"block": "Variable", "type": dudeGraph.Variable}
                ]
            },

            /**
             * The renderer block types
             */
            "renderBlockTypes": {
                "type": Array,
                "value": [
                    {"rendererBlock": "Assignation", "type": dudeGraph.RenderBlock},
                    {"rendererBlock": "Condition", "type": dudeGraph.RenderBlock},
                    {"rendererBlock": "Delegate", "type": dudeGraph.RenderBlock},
                    {"rendererBlock": "Each", "type": dudeGraph.RenderBlock},
                    {"rendererBlock": "Function", "type": dudeGraph.RenderBlock},
                    {"rendererBlock": "Getter", "type": dudeGraph.RenderBlock},
                    {"rendererBlock": "Instruction", "type": dudeGraph.RenderBlock},
                    {"rendererBlock": "Operator", "type": dudeGraph.RenderBlock},
                    {"rendererBlock": "Range", "type": dudeGraph.RenderBlock},
                    {"rendererBlock": "Variable", "type": dudeGraph.RenderVariable}
                ]
            },

            /**
             * The point types
             */
            "pointTypes": {
                "type": Array,
                "value": [
                    {"point": "Stream", "type": dudeGraph.Stream}
                ]
            }
        },

        /**
         * Loads the graph and the renderer
         */
        load: function () {
            this.graph = new dudeGraph.Graph();
            this.renderer = new dudeGraph.Renderer();
            this.loader = new dudeGraph.Loader();
            this.saver = new dudeGraph.Saver();
            _.forEach(this.blockTypes, function (blockType) {
                this.loader.registerBlockType(blockType.block, blockType.type);
            }.bind(this));
            _.forEach(this.pointTypes, function (pointType) {
                this.loader.registerPointType(pointType.point, pointType.type);
            }.bind(this));
            this.loader.load(this.graph, this.graphData);
            this.renderer.initialize(this.graph, this.$.svg, this.rendererConfig);
            _.forEach(this.renderBlockTypes, function (renderBlockType) {
                this.renderer.registerRenderBlock(renderBlockType.rendererBlock, renderBlockType.type);
            }.bind(this));
            this.renderer.load(this.rendererData);
            this.renderer.on("error", function (error) {
                this.fire("dude-graph-editor-error", {"error": error, "message": error.message});
            }.bind(this));
        },

        /**
         * Saves the current renderer and the graph
         * @return {Object}
         */
        save: function () {
            return {
                "rendererData": this.renderer.save(),
                "graphData": this.saver.save(this.graph)
            };
        },

        /**
         * Creates a block from data
         * @param {Object} cgBlockData
         */
        createBlock: function (cgBlockData) {
            this.loader.loadBlock(this.graph, _.merge(cgBlockData, {
                "cgId": _.uuid()
            }));
        },

        /***
         * Creates a group for the selected blocks
         * @param {String} name - the rendererGroup name
         */
        createGroup: function (name) {
            this.renderer.createRendererGroupFromSelection(name);
        },

        /**
         * Removes the selected blocks and groups
         */
        removeSelection: function () {
            this.renderer.removeSelection();
        },

        /**
         * Removes the selected blocks and groups
         * @param {Boolean?} ignoreBlocks - Whether to not select all blocks
         * @param {Boolean?} ignoreGroups - Whether to not select all groups
         */
        selectAll: function (ignoreBlocks, ignoreGroups) {
            this.renderer.selectAll(ignoreBlocks, ignoreGroups);
        },

        /**
         * Zoom to best fit all blocks and groups
         */
        zoomToFit: function () {
            this.renderer.zoomToFit();
        },

        /**
         * Zoom to best fit all blocks and groups
         */
        zoomToSelection: function () {
            this.renderer.zoomToSelection();
        }
    });
</script>